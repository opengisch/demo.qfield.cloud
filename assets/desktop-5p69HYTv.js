var cs=Object.defineProperty;var ai=c=>{throw TypeError(c)};var hs=(c,t,e)=>t in c?cs(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var o=(c,t,e)=>hs(c,typeof t!="symbol"?t+"":t,e),li=(c,t,e)=>t.has(c)||ai("Cannot "+e);var _=(c,t,e)=>(li(c,t,"read from private field"),e?e.call(c):t.get(c)),be=(c,t,e)=>t.has(c)?ai("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(c):t.set(c,e),de=(c,t,e,i)=>(li(c,t,"write to private field"),i?i.call(c,e):t.set(c,e),e);var Mt=(c,t,e,i)=>({set _(s){de(c,t,s,e)},get _(){return _(c,t,i)}});import{G as Ei,S as W,a as ie,T as J,b as P,h as v,c as U,d as Wt,n as Ot,I as ae,e as Yt,C as Pi,M as xt,f as ds,L as Y,g as rt,i as F,j as He,W as Ti,x as gs,k as us,v as Ct,l as kt,H as ps,m as S,E as _t,J as ci,o as ot,p as Re,q as Ii,r as re,s as pe,t as ms,P as fs,u as Fi,w as Et,y as je,z as bs,A as ys,B as vs,D as Ai,F as ws,K as Xt,N as Pt,O as xs,Q as Cs,R as ks,U as Ss,V as Ls,X as Ms}from"./component-DmEB9E06.js";import{P as Kt,F as Ri,T as Di,C as Be,f as I,s as le,V as me,a as Pe,n as _s,b as Ht,c as Es,I as Ps,E as at,M as j,d as Ts,e as B,g as lt,h as N,i as q,L as G,j as hi,k as $i,l as ct,m as Jt,o as zi,p as Qt,q as Is,B as Zt,r as Ie,G as Fs,t as As,u as Bi,v as Rs,w as di,x as Ds,y as $s,z as zs,A as Bs,D as ht,S as ce,H as De,R as jt,J as te,K as E,N as Vs,O as Vi,Q as Ue,U as Ns,W as gi,X as ui,Y as Ut,Z as ei,_ as Gs,$ as ti,a0 as Os,a1 as Hs,a2 as js,a3 as Ni,a4 as dt,a5 as gt,a6 as Tt,a7 as K,a8 as ge,a9 as ut,aa as Us,ab as Gi,ac as Oi,ad as qs,ae as Hi,af as Ws,ag as Ys,ah as Fe,ai as It,aj as Xs,ak as pt,al as Ks,am as ji,an as Js,ao as Qs,ap as Zs,aq as en,ar as tn,as as sn,at as nn,au as rn,av as on,aw as an,ax as ln,ay as cn,az as hn,aA as Ui,aB as pi,aC as Ft,aD as mi,aE as qe,aF as dn,aG as gn,aH as un,aI as pn,aJ as mn,aK as fn,aL as Ve,aM as fi,aN as bn,aO as yn,aP as st,aQ as vn,aR as wn,aS as xn}from"./lazy-CNpw-HpO.js";import{S as Cn,a as ye,E as $,b as kn,e as Sn,C as Ne}from"./ScreenSpaceEventHandler-BV10dpGX.js";class Ln extends Ei{constructor(e){super(e);o(this,"stateManager");o(this,"timeoutId");this.stateManager=W.getInstance(),this.registerEvents()}get state(){return this.stateManager.state}registerEvents(){this.stateManager.subscribe("layers.layersList",()=>{this.reorderLayers()}),this.stateManager.subscribe(/layers\.layersList\..*\.order/,()=>this.reorderLayers())}reorderLayers(){this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{const e=this.getSortedLayers(this.state.layers.layersList),i={index:1e3};this.reorderLayersRecursively(e,i)})}reorderLayersRecursively(e,i){for(const s of e)if(console.log(`Setting layer ${s.name} to order=${i.index}`),s.order=i.index++,s instanceof ie||s instanceof J){const n=this.getSortedLayers(s.children);this.reorderLayersRecursively(n,i)}}getSortedLayers(e){return e.slice().sort((s,n)=>s.order-n.order)}}class St extends P{constructor(e){super(e);o(this,"button");o(this,"div");o(this,"header");o(this,"closeButton");o(this,"pos1",0);o(this,"pos2",0);o(this,"pos3",0);o(this,"pos4",0)}get host(){return this.shadow.getRootNode().host}makeDraggable(){this.div=this.shadow.querySelector("#draggable"),this.header=this.shadow.querySelector("#header"),this.setDefaultPosition(),this.header.onmousedown=e=>this.dragMouseDown(this,e),this.closeButton=this.shadow.getElementById("close"),this.isNullOrUndefined(this.closeButton)||(this.closeButton.onclick=()=>this.closeWindow())}setDefaultPosition(){const e=getComputedStyle(this.host);this.host.style.top=e.top,this.host.style.left=e.left}closeWindow(){throw new Error("This function must be overriden to close the associated window")}dragMouseDown(e,i){i.preventDefault(),e.pos3=i.clientX,e.pos4=i.clientY,document.onmouseup=()=>e.closeDragElement(),document.onmousemove=s=>e.elementDrag(e,s)}elementDrag(e,i){i.preventDefault();const s=e.host.getBoundingClientRect(),n=e.pos3-i.clientX,r=e.host.offsetLeft-n,a=r+s.width;r<0?e.host.style.left="0px":a>this.getBodyWidth()?e.host.style.left=this.getBodyWidth()-s.width+"px":(e.pos1=n,e.pos3=i.clientX,e.host.style.left=r+"px");const l=e.pos4-i.clientY,h=e.host.offsetTop-l,d=h+s.height;h<0?e.host.style.top="0px":d>this.getBodyHeight()?e.host.style.top=this.getBodyHeight()-s.height+"px":(e.pos2=l,e.pos4=i.clientY,e.host.style.top=h+"px")}getBodyWidth(){return Math.max(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}getBodyHeight(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight)}closeDragElement(){document.onmouseup=null,document.onmousemove=null}}const Mn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIQAAAAtCAMAAABYiTOzAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAKsUExURZGRkYKCglFRUTk5OePj4ykpKR0dHampqRMTEwAAABISElpaWl5eXgEBARkZGTIyMnZ2dsPDwyIiIjs7OwkJCQICAqOjo3t7ewMDA0lJSeDg4GJiYgUFBQgICMnJydjY2DU1NSoqKtPT01lZWb+/v5aWlgwMDNra2ufn50xMTAYGBru7u7a2thcXF5WVlX9/f2tra9zc3ERERKqqqh4eHicnJ9bW1tfX13Jycrm5uaSkpBoaGpOTk9LS0kJCQmhoaJubmyQkJCMjI1tbWwoKCgsLC5eXl8vLy5CQkNzb3Hd3d93d3be3t5qamr29vbCwsIODg29vb3Fxcd7e3oqKioSEhNvb29/f3y8vLw4ODrW1tVhYWEdHR2xsbDAwMGdnZ4mJiYyMjG1tbTw8PKysrAQEBFxcXIGBgbOzs0ZGRo6Ojnp6enh4eCUlJeHh4TMzM6urq7Kyss7OzlZWVj8/P3l5ecLCwuLi4hYWFqGhoVNTU+Tk5JycnKKioqWlpby8vDY2NsHBwcrKyrS0tOjo6J6enp2dndnZ2SEhIRAQEBsbG6+vr0BAQBgYGLGxsU1NTenp6cXFxRQUFC0tLTExMVVVVUVFRRwcHD4+PlBQUD09PTQ0NICAgDg4OEFBQcHAwaCgoMzMzMfHx3V1dWFhYa6urs3NzdXV1dTU1FRUVHx8fMjIyK2trRUVFeXl5SgoKLi4uJKSkn5+foaGhkNDQ8bGxmpqanBwcCYmJkhISNDQ0Obm5mVlZWNjY6enpw0NDS4uLk5OToeHh9HR0Tc3N11dXcDAwIuLix8fH3R0dFdXV5mZmSwsLL6+vqioqM/Pzzo6OmRkZBEREY2NjV9fXysrK0pKSpSUlJiYmIiIiAcHB6ampiAgIG5ubsTExLq6uk9PT2BgYEtLSwAAAIP+fpMAAADkdFJOU///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AIqL/3IAAAAJcEhZcwAADsAAAA7AAWrWiQkAAAXaSURBVFhHzZj7W5RFFMdRJDnkgoCrKwIGqShIIhJeCGRBwhQ18wKirigRqZiJgJdEBQzxQmiQipZJhWiKlnfMyAuZmYlR2VWt5h/pnDPnpQ0Be3qefevzw8z3nPfdd787M2feATf1P6BbE249RLiYbk30dBfhYroz0cvjMVEuphsTvT3B63HRrqVrE30sAN4+fSVyKV2Z8PUDAP9+YO0vCVfShYkBNvQwUAUMCgwKlpQL6dTE4CfQAoSQDH1yCKdcSmcmhg4jD15hErqeh00MH0EWIDxCYhN4yMTISPYAT0lsBh1NjLJqD1ESm0IHE6MDtYdoic3h7ybGxGgPT0tsEs4mYqO1BfAaKxmTcDIxLlw8BI6XjFm0m5gQJxYAnpGUaYiJ+AQxgEzUKRPRJhKlKIgEzpiKNmEXA0gkJ8yFTQwRA0QSp82FTSSLAWISp82FTaSIAcIynPOmQiaele8HsOKRLlVfMBMyMVksMJbn9AWXMcV7kr9IAzIxVd6cfknYdDzlp01zS5wu+hHMeH7mC26zSM1O40RnzPGfq9JFG/CayGAP8+IzcTbmc1rwXaA3kH9ywFnoWJS1eEn2i6RzXuJUZ9h9RTjBJnLpi3JeVmopwDJOa5ZbLT5LeuTNX/GKJLomdeWroohVo0U8TD/pnWET+TgCMBvFaoACSmgKIalI5KMYmzFV1CNYs1aEM2xiHXpYT8IdxQwSRITV+zWRBtM3FIeKxDP5xsRNItXmEhFO4GiUbijbgg5XvV6eKcmtFSKUmjYlVz5FJgK24UaZSofr7WiCT/pEBvQWJezgF200PhYZu5OGr7KYgzequDPYZcMR3P2mGlQ9ouYttWfvvtrajJRcHIaabPdJe/YfeBvvmZBUuG7yO/pzZOIgHiHedaf9wRMKADbwBVUKlVoYzLD5HapLWwrZFLy3bVhWfvD7ORZeQ8kd/k4LxIftsn1QLyFRF4dL9nBDWczWI/m4xDJX8m85ymdZNHEIf1HWh3AMo0g4PhBiKI9lBj21MGhsPEHdScAVrGIsH1HwMYQPxm7FEQr+Ym08Nv1O6UBYxhUTa+dAhehpDeB1iiZOA5wpyYGzGMXBptgcG+WVioJzWgiTQT90AJynTXYBB+oCFGI7r5eODOx0PtybrwNhZBO1sfoFWWSs/wu0WLSJ1DIAqt8YuIiv9U/48iX4lHtk8ew1SjXB4pKIsvrmPrSVVME0famQD+afdSjJyxSHXNQBsqWoeeigK6SO6IV5tapec3IjRmzCgo+BkRjZYZZaD9f4vuXQwj3iBXXOZ47PlfIw9q9iqMHWfl1HiAc91YdMOAwT5RkVR/O+iOL/dcTf4NTCgvPjxn05ZcCp3FiM2ESKUjfhK4xuWZXqAV/zfcfBxlsw4gcNSt2A26WtDWHpJ3Zh5gbIxrwR7mC7+rSOEMdxbA6QiYxWTqiZ1bupi/iG2lb9Woiaw53AJlYoVQ80Wi1BWIjQrC+1QbIW+LuxfvcbZUPUwLda5MJ32I75XkfIHZpkH6r3ahw+pCFFT28En11T4zhYdpc7gU0cRLFtGDZ3GpVKt/zAV1QWWH7UykEmfiKvBouMuXLozaRa7lQqm952IThyyqOUE/25pNHEImrP6h1z6880DQZsAidZ9aFFsY/WriftJUQ0WLEQkDNABbUXCnB9akptsI76crjFcaj3L9wrtZN2wQoqDD+qNxzZy9ypRPoWdb2NA3XJoXuGTVCVZVJFJmxG5d9emusBUqoKr+b9CocxOtYGQXfv3Us+cBuDURCed9+3b3gl/WYk1HHlAYum+9hEUqltl9XqfRWbuX1buKjH04ATTX68wfGAsAkefy9ctwuo3s7dpJBJ+20elUNQ9lyK0n/nqI3rv7wSpbW2fWzU7dqKky0r7e506xly8oeeDhV7t60y0r85jA8JRTs5hxQneK6NbNxHEk20JnIVpOG6e0CFd42KtZ2AumCnf9mEBae2n0iKJuzosEcpKpx/AZr4r1HqT8S1EHcsZ6nQAAAAAElFTkSuQmCC";class _n extends St{constructor(){super("about");o(this,"template",()=>v`<style>
#draggable{border-radius:1px;box-shadow:var(--bx-shdw)}#header{padding:.5rem;cursor:grabbing;z-index:10;background:var(--bkg-color-grad2);color:var(--text-color);text-align:center}#content{padding:0 2rem;width:23rem;height:13rem}#close{cursor:pointer;float:right;width:12px;color:var(--text-color)}img.logo{margin-top:1rem;margin-bottom:1rem;filter:var(--svg-filter)}h3{font-size:1rem;font-weight:400;margin:.2rem;color:var(--text-color)}a:link{color:var(--lnk)}a:visited{color:var(--lnk-visited)}a:hover{color:var(--lnk-hover)}a:active{color:var(--lnk-active);text-decoration:none;font-weight:400}
</style>
<div id="draggable">
  <div id="header">
    About
    <img id="close" alt="close-icon" src="icons/close.svg" />
  </div>
  <div id="content">
    <img class="logo" alt="GeoGirafe logo" src="${this.logo}" />
    <h3>Version: ${this.version}</h3>
    <h3>Build: ${this.build}</h3>

    <h3>Date: ${this.date}</h3>
    <h3>
      Source:
      <a href="https://gitlab.com/geogirafe/gg-viewer" rel="noopener" target="_blank"
        >https://gitlab.com/geogirafe/gg-viewer</a
      >
    </h3>
  </div>
</div>
`);o(this,"loaded",!1);o(this,"version");o(this,"build");o(this,"date");o(this,"logo",Mn)}async loadVersionInfos(){if(!this.loaded){const i=await(await fetch("about.json")).json();this.version=i.version,this.build=i.build,this.date=i.date,this.loaded=!0,console.log(this.version),console.log(this.build),console.log(this.date)}this.render()}registerEvents(){this.stateManager.subscribe("interface.aboutVisible",(e,i)=>this.toggleAbout(i))}toggleAbout(e){e?this.loadVersionInfos().then(()=>{this.shadow.getRootNode().host.style.display="block"}):this.shadow.getRootNode().host.style.display="none"}closeWindow(){this.state.interface.aboutVisible=!1}connectedCallback(){this.loadConfig().then(()=>{this.render(),this.girafeTranslate(),this.makeDraggable(),this.registerEvents()})}}class En extends P{constructor(){super("basemap");o(this,"template",()=>v`<style>
#container{display:inline-flex;flex-direction:column;width:max-content}
</style>
<link rel="stylesheet" href="styles/common.css" />

<girafe-menu-button open="up">
  <button slot="menu-button" class="girafe-button-small">
    <img alt="menu-icon" src="icons/layer-group.svg" />
  </button>

  <div slot="menu-content" id="container">
    ${Object.values(this.state.basemaps).map(e=>U(e,e.id)`
    <button class="girafe-button-large" onclick="${()=>this.changeBasemap(e)}">
      <img alt="basemap-icon" src="images/basemap.png" />
      <span i18n="${e.name}">${e.name}</span></button
    >`)}
  </div>
</girafe-menu-button>
`);o(this,"servers",{});o(this,"basemapJson",{});o(this,"shareManager");this.shareManager=Wt.getInstance(),this.configManager.loadConfig().then(()=>{this.configManager.Config.basemaps.show||this.hide()})}onBasemapsLoaded(e){if(super.render(),!this.shareManager.hasSharedState()){for(const i of Object.values(e))if(i.name===this.configManager.Config.basemaps.defaultBasemap){this.state.activeBasemap=i;break}}}changeBasemap(e){console.log("change basemap",e),e.projection&&(this.state.projection=e.projection),this.state.activeBasemap=e}registerEvents(){this.stateManager.subscribe("basemaps",(e,i)=>this.onBasemapsLoaded(i))}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}}class Pn extends P{constructor(){super("colorswitcher");o(this,"template",()=>v`<style>
.container{display:flex;flex-direction:column;height:4rem}.switch{position:relative;display:flex;flex-direction:column;vertical-align:middle;border-right:solid 1px var(--bkg-color);width:4rem;height:50%;text-align:center;background-color:transparent}.switch input{opacity:0;width:0;height:0}.slider{position:relative;cursor:pointer;width:3rem;height:1.5rem;vertical-align:middle;background-color:var(--bkg-color-grad2);-webkit-transition:.4s;transition:.4s;margin:0 auto;border-radius:1rem}.slider:before{position:absolute;content:'';height:1.3rem;width:1.3rem;left:4px;bottom:.1rem;background-color:var(--text-color-grad1);-webkit-transition:.4s;transition:.4s;border-radius:50%}.checked .slider{background-color:var(--bkg-color-grad2)}.checked .slider:before{-webkit-transform:translateX(18px);-ms-transform:translateX(18px);transform:translateX(18px)}
</style>
<div class="container">
  <label class="${this.state.interface.darkFrontendMode?"switch checked":"switch"}">
    Dark mode on interface
    <input
      type="checkbox"
      onclick="${()=>this.darkFrontendModeToggled()}"
      onkeydown="${e=>this.simulateClick(e)}"
      ?checked="${this.state.interface.darkFrontendMode}" />

    <span tip="Dark mode on interface" class="slider"></span>
  </label>
  <label class="${this.state.interface.darkMapMode?"switch checked":"switch"}">
    Dark mode on map
    <input
      type="checkbox"
      onclick="${()=>this.state.interface.darkMapMode=!this.state.interface.darkMapMode}"
      onkeydown="${e=>this.simulateClick(e)}"
      ?checked="${this.state.interface.darkMapMode}" />
    <span tip="Dark mode on map" class="slider"></span>
  </label>
</div>
`);o(this,"currentTheme")}registerEvents(){this.stateManager.subscribe("interface.darkFrontendMode",()=>this.onChangeDarkFrontendMode()),this.stateManager.subscribe("interface.darkMapMode",()=>super.render())}onChangeDarkFrontendMode(){this.currentTheme=this.state.interface.darkFrontendMode?"dark":"light",this.activateTheme(this.currentTheme),super.render()}darkFrontendModeToggled(){this.state.interface.darkFrontendMode=!this.state.interface.darkFrontendMode,localStorage.setItem("theme",this.currentTheme)}initValue(){if(this.currentTheme=localStorage.getItem("theme")??void 0,!this.currentTheme){const e=window.matchMedia("(prefers-color-scheme: dark)");this.currentTheme=e.matches?"dark":"light"}this.state.interface.darkFrontendMode=this.currentTheme==="dark"}activateTheme(e){const i=e==="dark"?"light":"dark";document.body.classList.remove(`${i}-theme`),document.body.classList.add(`${e}-theme`)}connectedCallback(){this.loadConfig().then(()=>{super.render(),this.girafeTranslate(),this.registerEvents(),this.activateTooltips(!1,[800,0],"top-end"),this.initValue()})}}var _e;class Tn extends P{constructor(){super("coordinate");o(this,"template",()=>v`<style>
#content{background:var(--t-bkg);color:var(--text-color);width:-moz-fit-content;width:fit-content;white-space:nowrap;padding:0 .5rem;font-size:1rem;height:2.3rem;line-height:2.3rem}span{font-weight:700}
</style>
<div id="content">
  <span id="coords">E ${this.east} / N ${this.north}</span>
</div>
`);be(this,_e);o(this,"east",null);o(this,"north",null)}get locale(){if(!_(this,_e))throw new Error("You called locale before render");return _(this,_e)}render(){super.render(),de(this,_e,this.configManager.Config.general.locale)}registerEvents(){this.stateManager.subscribe("mouseCoordinates",(e,i)=>this.onChangeCoordinates(i))}onChangeCoordinates(e){[this.east,this.north]=Ot(e,this.locale),this.render()}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}}_e=new WeakMap;const In=""+new URL("map-2d-BTLTmzli.svg",import.meta.url).href,Fn=""+new URL("map-3d-khhrH_5c.svg",import.meta.url).href,An=""+new URL("map-split-CE2nWtiH.svg",import.meta.url).href,Rn=""+new URL("globe-CPa6yA7H.svg",import.meta.url).href;class Dn extends P{constructor(){super("globe");o(this,"template",()=>v`
<link rel="stylesheet" href="styles/common.css" />

<girafe-menu-button icon-style="fa-xl fa-solid fa-globe" text="Layout" open="left">
  <button slot="menu-button" class="girafe-button-medium">
    <img alt="menu-icon" src="${this.iconGlobe}" />
    <span>Layout</span>
  </button>

  <button slot="menu-content" class="girafe-button-medium" onclick="${()=>this.state.globe.display="none"}">
    <img alt="help-icon" src="${this.icon2D}" />
    <span>2D</span>
  </button>
  <button slot="menu-content" class="girafe-button-medium" onclick="${()=>this.state.globe.display="side"}">
    <img alt="help-icon" src="${this.iconSplit}" />
    <span>Dual</span>
  </button>
  <button slot="menu-content" class="girafe-button-medium" onclick="${()=>this.state.globe.display="full"}">
    <img alt="help-icon" src="${this.icon3D}" />
    <span>3D</span>
  </button>
</girafe-menu-button>
`);o(this,"icon2D",In);o(this,"icon3D",Fn);o(this,"iconSplit",An);o(this,"iconGlobe",Rn)}render(){super.render()}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate()})}}const $n="data:image/webp;base64,UklGRtAJAABXRUJQVlA4WAoAAAAQAAAAywEAMgEAQUxQSHgIAAABsAMBtNpazl3WzF/wzIe3/HFGxYKWN5ySE5UKK+wwM7l8pcIqAioWXLoLM7n4oGJBweegP7wZvTDHZ0a690i6vjrnKOSIkOi2jSVJcYzyelKp2UFv9WP37gPUoMTG/9j4Hxv/49/Bcal36XAM77swGYzuMwHggzzHtscPv1vx74rnANi+lJd4Zk14MtPxVYDvPpObMoAvKKbjyQCcmF7lah7b+AJAZXpcuDqfrPjG36HGM1lYDSfblp7bl/KwmrYW6/ggVCB/sVECBmaKecxAR0J3Sy801Z8rSiHnI6rdOcL7lZJAUm56CeAURc5DemfNEZYVhZGQjMhVeH8x5J/BROiRrP78ViUJ3I/lPPTIVTCrymSRJWBi5FGo2rmiqCJTjJqU6QrEpLDNKIF2SiQmecILWyuZmI1iRE/vVko2AnAkI7p6l2/tprwRijBZM0YY6BVvLf/cIKho7YVdnZGGxMQcHEVSI3TwYPJGNqC8Nbahp/V7kWeE5Qx3POPAgb4hWdex0nqDmtv5Tudd9yqvg2gup0C81YBqQDiHPqIsS+u30sZh4/aHNG84rFoYJWAIyToRzcryzz2JP5c1ZtphbB/PgP5BPwd5DT+DpVlaknaZ+NYas1KHC8dUieOtJu5f7yejfSrQQ8yf3nJTVQTElddee+2VygruHnfBdGwDylmMayw1/H5lwsFY6VhWqD5CqpCeBICTaZrWU+nH3dhBvWzGah1YopgaPwi0YQkITqbRtYoxjNcBm1uqBgo+2+nvAQW1Bg1nxihNT+q7/3No2BCXqwZDUOLaSK/V+fu7qdj3msuvFNH8KAVA1dQgCeXTJS5Oykdci86H1WqJKSrKm8S1slFN9Uv9spocsZLRctda6E3SCTu6UiiqsTdpt/m4OCmQvDLCldGbNoGvKQ73ZFdF03J4lSzcFopG8Xu0ShJuN0XcGvJIzDUUqWIpjRYRevejMBA8SQJ5ZYrMan33Q+iV9HP458nmWZSbJ69kn9gsyhFkoCEfsR6j3NA7gSIeWakn62GwzBT9CHagRsx4xAYNl3pTrwq5Zxaw8TGWnFsj3eVkOwx2GB/ydqsxsFjOuGesxomZ7fD8/7zrZQMRobbaUIwgi9WgxMb/2PgfG/9j439s/I+N/0FxPGFQBrx4UMZPBkPc+EUH4oHhMHwGHIjJYBhuhF86EUNh+AxMHIjjMBCGG8GJUFANw2CEV7kQD1TDMBirSjdegBsHwfiAE3G8is8MgLF+xQn8sh4GwAjH3YjJABiOAMCOciMOVwFHZB+Z9rUj2KkiE/8Ih12JWPxDpn3tDOpYSH+cuHVAQiz40fzapeKF4EfXLpN2tO1F9GPsUsQg+Ckx6NXODZnMY+HgNVIMYp8yMUYHh4XI5xhXSC4OE4nP0Ts7OcARkc+BzNVvZyFtb2GOjg4TiXsTN/cZ3ZK3t+Py0bmQtxe7GYdB2lbm8qjURNg5AXyOi1NEXXMC6lh9RjkbN+jxqxMi5q+0+PENyl28V88HJBwP6OOLlcv4sZ7b8o1t1HPZEnK+ClDPfQtOSLfI8Nz/M3yzgWyJeo5bPxZwGqy8HiSIN7dBD4M9qXlAunyvUr3KbSHT/QZmSpY/Vkb0oYGZguUNqo8pVELNXqY4iTyc6GfObS/6zBOyIdahbwlrur/9zK843UFOkEml3vtjJG3vI/MTXKr5N9fK/sn15a+eyeNG/avVDetjv9Pyfv1iHq/U/BzgrbbfpxFvVX3FVgEGEmUTb63fp89chGet8yxKAjL3rWYBcJa3TKwfDCFOEvJsqCwi0t4nY2X2mQDKfucMkCrbEhK2eNb2weAjLFyl5dPuWqq2tJQBw7MIt5QiILGqxHbmPkf9rTOBVux5C9S0+mZZap+AZfo51qMiEflWwEzryTuTs236k1C1FnNrRuWKtn+6i8C+i75ZMswZavp2L9cSTvrbPdv6qDvTy2gxcWE3eWaIqcIoI8uEs6HdZJh+Di1cykzIbYmg4CKTszavgf2kq0vIhTQurN7gMrGkPdXgUoZg1iBsrssC7anGy2ZCReJb2US0JJ/FW9eg3lq7tIqziY1yPann1roUkaKhtW/nN6kh3U8mbDHMUQW6IlQ0lVtpQXTesgsA4/3d311aAIZHpuRufv74Edwo0kh1wv76TaZ0s/vv/ItdXFVHHMHY70/BorF/XCfNfKQro4Z6mKKK3vIWxi2qNbQkmfs7O+16U240bPK7Hdr6j1RJL6cdeEvtdK4nepNvbFtEUbsW1GZUcdyl726jw8mviP3qJQsXYfunpGYKrRlFRQGNW7qv2MH+qhSfWrRskRLKR3wrG3r1GralczQVgWqZxS00smX/dBffBabjah/gHf4jsEthpm37+1MdfoX9SgLYXyeFHCsZYf+YvkzrBxNiQp3U0fbGzX4L0jKFqUkpVVVJGMeyUlEUvfGbVOUthZh6RFGUFhX0+8JPEPXoV0I9bqkfuBXYQ5oxWfeFu7BbaEijKJLJa/gD8Eeoe0jj48+zq3ZcT7Xzi4zpmMinNNccPpxl+Qp0LBZZHAgggnixMP87nVWeHT6sTBBZGmemAXv1S8w7e7hzjaIY1TI5+lIcSMShty3vRpztAaJqh3xUBjBtBNkCdeLDigkcznLcYLg+z1o5pG/y2EqwyGIGVUN9iz2dg5VywIyYO9W2nrNyts7YAa7wet7K95gS8V7L3lyVxxlrIl6gtz6KRVStUcGUyuNGxVxrjkRgqFWb0zODrbkRQbbX6rkSo+WoYEOtkN4si5yL+9xYV7m9esZudRkQwaL7rQ/D1190r5HttdjTJVC+lxHtGr8PFQS2ohQA4OzdBMdz0mhrnxIHttLK+MNUEQ9hTD/5TjUgsW+fGpTY+B8b/2Pjf2z8j43/sVk1FFZQOCAyAQAAcCIAnQEqzAEzAT6RSKFNJaQjIiAIALASCWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOFAAA/v/eCKwuAAAAAAAAAAAAAAAAAAAA",zn=""+new URL("arrow_white-hww14erJ.webp",import.meta.url).href;class Bn extends P{constructor(){super("help");o(this,"template",()=>v`<style>
#content{z-index:10000;position:fixed;top:0;left:0;bottom:0;right:0;display:none}#themes{position:absolute;top:4.5rem;left:0;width:150px;height:120px;background-repeat:no-repeat;transform:rotateY(0) rotateX(0) rotateZ(90deg);background-position:bottom -50px left -60px}#search{position:absolute;top:8rem;left:45%;width:180px;height:70px;background-repeat:no-repeat;transform:rotateY(0) rotateX(0) rotateZ(90deg);background-position:-60px -30px}#menu{position:absolute;top:4.5rem;right:0;width:150px;height:120px;background-repeat:no-repeat;transform:rotateY(180deg) rotateX(0) rotateZ(90deg);background-position:bottom -50px left -60px}#basemap{position:absolute;bottom:3rem;left:21rem;width:150px;height:120px;background-repeat:no-repeat;transform:rotateY(0) rotateX(180deg) rotateZ(90deg);background-position:bottom -50px left -60px}#themes-descr{position:absolute;top:10rem;left:10rem;color:var(--bkg-color);font-size:1.2rem;width:12rem}#search-descr{position:absolute;top:16rem;left:45%;color:var(--bkg-color);font-size:1.2rem;width:12rem}#menu-descr{position:absolute;top:10rem;right:10rem;color:var(--bkg-color);font-size:1.2rem;width:12rem;text-align:right}#basemap-descr{position:absolute;bottom:9rem;left:31rem;color:var(--bkg-color);font-size:1.2rem;width:12rem}
</style>
<div id="content">
  <div id="themes"></div>
  <div id="themes-descr">
    Clicking the Topics button opens the topic overview. After selecting the desired topic, all assigned maps are
    loaded.
  </div>

  <div id="search"></div>
  <div id="search-descr">Search for a place, an address, a map or a geographical data.</div>

  <div id="menu"></div>
  <div id="menu-descr">This menu contains advanced functions such as printing, drawing, language, 3D view, etc...</div>

  <div id="basemap"></div>
  <div id="basemap-descr">Here, you can choose which background layers you want to use.</div>
</div>
`);o(this,"content");o(this,"themes");o(this,"search");o(this,"menu");o(this,"basemap");o(this,"darkFrontendMode",!1);o(this,"arrowBlack",$n);o(this,"arrowWhite",zn);o(this,"currentArrow")}render(){super.render(),this.content=this.shadow.querySelector("#content"),this.themes=this.shadow.querySelector("#themes"),this.search=this.shadow.querySelector("#search"),this.menu=this.shadow.querySelector("#menu"),this.basemap=this.shadow.querySelector("#basemap"),this.configManager.Config.basemaps.show||(this.shadow.querySelector("#basemap").style.display="none",this.shadow.querySelector("#basemap-descr").style.display="none")}registerEvents(){this.stateManager.subscribe("interface.helpVisible",(e,i)=>this.toggleHelp(i)),this.stateManager.subscribe("interface.darkFrontendMode",(e,i)=>{this.darkFrontendMode=i}),this.content.addEventListener("click",()=>{this.state.interface.helpVisible=!1})}changeArrowColor(){this.darkFrontendMode=this.stateManager.state.interface.darkFrontendMode,this.currentArrow=this.darkFrontendMode?this.arrowBlack:this.arrowWhite,this.themes.style.backgroundImage=`url(${this.currentArrow})`,this.search.style.backgroundImage=`url(${this.currentArrow})`,this.menu.style.backgroundImage=`url(${this.currentArrow})`,this.basemap.style.backgroundImage=`url(${this.currentArrow})`,this.content.style.backgroundColor=this.darkFrontendMode?"rgba(255, 255, 255, 0.65)":"rgba(0, 0, 0, 0.65)"}toggleHelp(e){e?(this.changeArrowColor(),this.content.style.display="block"):this.content.style.display="none"}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}}class Vn extends St{constructor(){super("metadatawindow");o(this,"template",()=>v`<style>
#draggable{border-radius:1px;box-shadow:var(--bx-shdw);height:100%;width:100%}#header{height:2rem;line-height:2rem;cursor:grabbing;z-index:10;background:var(--bkg-color-grad2);color:var(--text-color);text-align:center}#content{padding-left:1rem;width:calc(100% - 1rem);height:calc(100% - 2rem)}#close{cursor:pointer;float:right;width:12px;color:var(--text-color);padding:.45rem}iframe{border:none;width:100%;height:100%}
</style>
<div id="draggable">
  <div id="header">
    <span i18n="${this.state.metadata.title}"></span>
    <img id="close" alt="close-icon" src="icons/close.svg" />
  </div>
  <div id="content">
    <iframe title="iframe content" src="${this.state.metadata.url}"></iframe>
  </div>
</div>
`);o(this,"initialized",!1)}registerEvents(){this.stateManager.subscribe("interface.metadataVisible",(e,i)=>this.toggleMetadata(i)),this.stateManager.subscribe(/metadata.*/,()=>this.render())}render(){if(!this.initialized){const e=this.shadow.getRootNode().host;e.style.width=this.configManager.Config.metadata.defaultWindowWidth,e.style.height=this.configManager.Config.metadata.defaultWindowHeight,this.initialized=!0}super.render(),this.girafeTranslate(),this.makeDraggable()}toggleMetadata(e){e?this.render():this.renderEmpty()}closeWindow(){this.state.interface.metadataVisible=!1}connectedCallback(){this.loadConfig().then(()=>{this.render(),this.girafeTranslate(),this.makeDraggable(),this.registerEvents()})}}class Nn extends P{constructor(){super("infobox");o(this,"template",()=>v`<style>
.content{display:flex;flex-direction:column-reverse;align-items:flex-start}.content div{position:relative;border:solid 1px #000;width:24rem;line-height:1.5rem;flex:1;margin:5px;padding:10px;color:var(--text-color)}.content div.info{background-color:var(--bkg-color)}.content div.warning{background-color:var(--warning-color);color:#fff}.content div.error{background-color:var(--error-color);color:#fff}.close-icon{border:none;color:var(--text-color-grad2);padding:0;margin:.5rem;position:absolute;top:0;right:0;width:.8rem;background-color:transparent;cursor:pointer}.content div.error .close-icon,.content div.warning .close-icon{filter:invert(1)}span{word-wrap:break-word}.content div.error i{background-color:var(--error-color);color:#fff}.content div.warning i{background-color:var(--warning-color);color:#fff}a{color:#fff}
</style>
<div class="content">
  ${(this.state.infobox.elements??[]).map(e=>v`
  <div class="${e.type}">
    <span>${this.htmlUnsafe(e.text)}</span>
    <button class="close-icon" onclick="${()=>this.closeMessage(e)}" tip="Close message">
      <img alt="close-icon" src="icons/close.svg" />
    </button>
  </div>
  `)}
</div>
`);o(this,"infos",[])}registerEvents(){this.stateManager.subscribe("infobox.elements",()=>super.render())}closeMessage(e){this.state.infobox.elements.splice(this.state.infobox.elements.findIndex(i=>i.id===e.id),1)}connectedCallback(){this.loadConfig().then(()=>{super.render(),super.girafeTranslate(),this.registerEvents()})}}const Gn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20640%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M0%20128C0%2092.7%2028.7%2064%2064%2064H256h48%2016H576c35.3%200%2064%2028.7%2064%2064V384c0%2035.3-28.7%2064-64%2064H320%20304%20256%2064c-35.3%200-64-28.7-64-64V128zm320%200V384H576V128H320zM178.3%20175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1%204.7-18.3%2011.9l-64%20144c-4.5%2010.1%20.1%2021.9%2010.2%2026.4s21.9-.1%2026.4-10.2l8.9-20.1h73.6l8.9%2020.1c4.5%2010.1%2016.3%2014.6%2026.4%2010.2s14.6-16.3%2010.2-26.4l-64-144zM160%20233.2L179%20276H141l19-42.8zM448%20164c11%200%2020%209%2020%2020v4h44%2016c11%200%2020%209%2020%2020s-9%2020-20%2020h-2l-1.6%204.5c-8.9%2024.4-22.4%2046.6-39.6%2065.4c.9%20.6%201.8%201.1%202.7%201.6l18.9%2011.3c9.5%205.7%2012.5%2018%206.9%2027.4s-18%2012.5-27.4%206.9l-18.9-11.3c-4.5-2.7-8.8-5.5-13.1-8.5c-10.6%207.5-21.9%2014-34%2019.4l-3.6%201.6c-10.1%204.5-21.9-.1-26.4-10.2s.1-21.9%2010.2-26.4l3.6-1.6c6.4-2.9%2012.6-6.1%2018.5-9.8l-12.2-12.2c-7.8-7.8-7.8-20.5%200-28.3s20.5-7.8%2028.3%200l14.6%2014.6%20.5%20.5c12.4-13.1%2022.5-28.3%2029.8-45H448%20376c-11%200-20-9-20-20s9-20%2020-20h52v-4c0-11%209-20%2020-20z'/%3e%3c/svg%3e";class On extends P{constructor(){super("language");o(this,"template",()=>v`
<link rel="stylesheet" href="styles/common.css" />

<girafe-menu-button open="left">
  <button slot="menu-button" class="girafe-button-medium">
    <img alt="menu-icon" src="${this.languageIcon}" />
    <span>Lang</span>
  </button>

  ${this.languages.map(e=>v`
  <button slot="menu-content" class="girafe-button-medium" onclick="${()=>this.changeLanguage(e)}">
    <img alt="help-icon" src="${this.languageIcon}" />
    <span>${e.toUpperCase()}</span></button
  >`)}
</girafe-menu-button>
`);o(this,"languageIcon",Gn);o(this,"languages",[])}render(){for(const e in this.configManager.Config.languages.translations)this.languages.push(e);super.render(),this.languages.length==1&&this.shadow.host.hide()}changeLanguage(e){console.log("change language",e),this.state.language=e}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate()})}}class Hn{constructor(t){o(this,"pytreeLidarProfileJsonUrl");o(this,"serverConfig");o(this,"clientConfig");this.pytreeLidarProfileJsonUrl=t,this.clientConfig={autoWidth:!0,margin:{left:40,top:10,right:200,bottom:40},pointAttributes:{},pointSum:0,tolerance:5}}async initProfileConfig(){const t=`${this.pytreeLidarProfileJsonUrl}/profile/config`;return fetch(t).then(e=>e.json().then(i=>{this.setupConfig(i)})).catch(e=>{console.error("Can not load lidar config",e)})}setupConfig(t){this.serverConfig={classification_colors:t.classification_colors,debug:!!t.debug,default_attribute:t.default_attribute??"",default_color:t.default_color??"",default_point_attribute:t.default_point_attribute??"",default_point_cloud:t.default_point_cloud??"",initialLOD:t.initialLOD??0,max_levels:t.max_levels,max_point_number:t.max_point_number??5e4,minLOD:t.minLOD??0,point_attributes:t.point_attributes??{},point_size:t.point_size??0,vertical_pan_tolerance:t.vertical_pan_tolerance??0,width:t.width??0};const e=[];for(const s in this.serverConfig.point_attributes)this.serverConfig.point_attributes[s].visible===1&&e.push(this.serverConfig.point_attributes[s]);const i=this.serverConfig.point_attributes[this.serverConfig.default_point_attribute];this.clientConfig.pointAttributes={availableOptions:e,selectedOption:i}}}const We={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class Ye extends Zt{constructor(t,e){super(t),this.feature=e}}function jn(c,t){const e=[];for(let i=0;i<t.length;++i){const n=t[i].getGeometry();qi(c,n,e)}return e}function Xe(c,t){return Bi(c[0],c[1],t[0],t[1])}function xe(c,t){const e=c.length;return t<0?c[t+e]:t>=e?c[t-e]:c[t]}function Ke(c,t,e){let i,s;t<e?(i=t,s=e):(i=e,s=t);const n=Math.ceil(i),r=Math.floor(s);if(n>r){const l=Ce(c,i),h=Ce(c,s);return Xe(l,h)}let a=0;if(i<n){const l=Ce(c,i),h=xe(c,n);a+=Xe(l,h)}if(r<s){const l=xe(c,r),h=Ce(c,s);a+=Xe(l,h)}for(let l=n;l<r-1;++l){const h=xe(c,l),d=xe(c,l+1);a+=Xe(h,d)}return a}function qi(c,t,e){if(t instanceof G){Je(c,t.getCoordinates(),!1,e);return}if(t instanceof ct){const i=t.getCoordinates();for(let s=0,n=i.length;s<n;++s)Je(c,i[s],!1,e);return}if(t instanceof Ie){const i=t.getCoordinates();for(let s=0,n=i.length;s<n;++s)Je(c,i[s],!0,e);return}if(t instanceof Jt){const i=t.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length;a<l;++a)Je(c,r[a],!0,e)}return}if(t instanceof Fs){const i=t.getGeometries();for(let s=0;s<i.length;++s)qi(c,i[s],e);return}}const At={index:-1,endIndex:NaN};function Un(c,t,e,i){const s=c[0],n=c[1];let r=1/0,a=-1,l=NaN;for(let g=0;g<t.targets.length;++g){const p=t.targets[g],u=p.coordinates;let m=1/0,f;for(let b=0;b<u.length-1;++b){const w=u[b],y=u[b+1],k=Wi(s,n,w,y);k.squaredDistance<m&&(m=k.squaredDistance,f=b+k.along)}m<r&&(r=m,p.ring&&t.targetIndex===g&&(p.endIndex>p.startIndex?f<p.startIndex&&(f+=u.length):p.endIndex<p.startIndex&&f>p.startIndex&&(f-=u.length)),l=f,a=g)}const h=t.targets[a];let d=h.ring;if(t.targetIndex===a&&d){const g=Ce(h.coordinates,l),p=e.getPixelFromCoordinate(g);lt(p,t.startPx)>i&&(d=!1)}if(d){const g=h.coordinates,p=g.length,u=h.startIndex,m=l;if(u<m){const f=Ke(g,u,m);Ke(g,u,m-p)<f&&(l-=p)}else{const f=Ke(g,u,m);Ke(g,u,m+p)<f&&(l+=p)}}return At.index=a,At.endIndex=l,At}function Je(c,t,e,i){const s=c[0],n=c[1];for(let r=0,a=t.length-1;r<a;++r){const l=t[r],h=t[r+1],d=Wi(s,n,l,h);if(d.squaredDistance===0){const g=r+d.along;i.push({coordinates:t,ring:e,startIndex:g,endIndex:g});return}}}const Rt={along:0,squaredDistance:0};function Wi(c,t,e,i){const s=e[0],n=e[1],r=i[0],a=i[1],l=r-s,h=a-n;let d=0,g=s,p=n;return(l!==0||h!==0)&&(d=Bs(((c-s)*l+(t-n)*h)/(l*l+h*h),0,1),g+=l*d,p+=h*d),Rt.along=d,Rt.squaredDistance=As(Bi(c,t,g,p),10),Rt}function Ce(c,t){const e=c.length;let i=Math.floor(t);const s=t-i;i>=e?i-=e:i<0&&(i+=e);let n=i+1;n>=e&&(n-=e);const r=c[i],a=r[0],l=r[1],h=c[n],d=h[0]-a,g=h[1]-l;return[a+d*s,l+g*s]}class Yi extends Kt{constructor(t){const e=t;e.stopDown||(e.stopDown=Ri),super(e),this.on,this.once,this.un,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=t.source?t.source:null,this.features_=t.features?t.features:null,this.snapTolerance_=t.snapTolerance?t.snapTolerance:12,this.type_=t.type,this.mode_=Xn(this.type_),this.stopClick_=!!t.stopClick,this.minPoints_=t.minPoints?t.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:t.maxPoints?t.maxPoints:1/0,this.finishCondition_=t.finishCondition?t.finishCondition:Di,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY";let i=t.geometryFunction;if(!i){const s=this.mode_;if(s==="Circle")i=function(n,r,a){const l=r||new Be([NaN,NaN]),h=I(n[0]),d=le(h,I(n[n.length-1]));return l.setCenterAndRadius(h,Math.sqrt(d),this.geometryLayout_),l};else{let n;s==="Point"?n=q:s==="LineString"?n=G:s==="Polygon"&&(n=Ie),i=function(r,a,l){return a?s==="Polygon"?r[0].length?a.setCoordinates([r[0].concat([r[0][0]])],this.geometryLayout_):a.setCoordinates([],this.geometryLayout_):a.setCoordinates(r,this.geometryLayout_):a=new n(r,this.geometryLayout_),a}}}this.geometryFunction_=i,this.dragVertexDelay_=t.dragVertexDelay!==void 0?t.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=t.clickTolerance?t.clickTolerance*t.clickTolerance:36,this.overlay_=new me({source:new Pe({useSpatialIndex:!1,wrapX:t.wrapX?t.wrapX:!1}),style:t.style?t.style:qn(),updateWhileInteracting:!0}),this.geometryName_=t.geometryName,this.condition_=t.condition?t.condition:_s,this.freehandCondition_,t.freehand?this.freehandCondition_=Ht:this.freehandCondition_=t.freehandCondition?t.freehandCondition:Es,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSource_=t.traceSource||t.source||null,this.addChangeListener(Ps.ACTIVE,this.updateState_)}setTrace(t){let e;t?t===!0?e=Ht:e=t:e=Rs,this.traceCondition_=e}setMap(t){super.setMap(t),this.updateState_()}getOverlay(){return this.overlay_}handleEvent(t){t.originalEvent.type===at.CONTEXTMENU&&t.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(t);let e=t.type===j.POINTERMOVE,i=!0;return!this.freehand_&&this.lastDragTime_&&t.type===j.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=t.pixel,this.shouldHandle_=!this.freehand_,e=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&t.type===j.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(t.coordinate),i=!1):this.freehand_&&t.type===j.POINTERDOWN?i=!1:e&&this.getPointerCount()<2?(i=t.type===j.POINTERMOVE,i&&this.freehand_?(this.handlePointerMove_(t),this.shouldHandle_&&t.originalEvent.preventDefault()):(t.originalEvent.pointerType==="mouse"||t.type===j.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(t)):t.type===j.DBLCLICK&&(i=!1),super.handleEvent(t)&&i}handleDownEvent(t){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=t.pixel,this.finishCoordinate_||this.startDrawing_(t.coordinate),!0):this.condition_(t)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new Ts(j.POINTERMOVE,t.map,t.originalEvent,!1,t.frameState))},this.dragVertexDelay_),this.downPx_=t.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_();return}const e=this.getMap(),i=e.getCoordinateFromPixel([t.pixel[0]-this.snapTolerance_,t.pixel[1]+this.snapTolerance_]),s=e.getCoordinateFromPixel([t.pixel[0]+this.snapTolerance_,t.pixel[1]-this.snapTolerance_]),n=B([i,s]),r=this.traceSource_.getFeaturesInExtent(n);if(r.length===0)return;const a=jn(t.coordinate,r);a.length&&(this.traceState_={active:!0,startPx:t.pixel.slice(),targets:a,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,e){const i=t.startIndex<=t.endIndex,s=t.startIndex<=e;i===s?i&&e>t.endIndex||!i&&e<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,e):(i&&e<t.endIndex||!i&&e>t.endIndex)&&this.removeTracedCoordinates_(e,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,e))}removeTracedCoordinates_(t,e){if(t===e)return;let i=0;if(t<e){const s=Math.ceil(t);let n=Math.floor(e);n===e&&(n-=1),i=n-s+1}else{const s=Math.floor(t);let n=Math.ceil(e);n===e&&(n+=1),i=s-n+1}i>0&&this.removeLastPoints_(i)}addTracedCoordinates_(t,e,i){if(e===i)return;const s=[];if(e<i){const n=Math.ceil(e);let r=Math.floor(i);r===i&&(r-=1);for(let a=n;a<=r;++a)s.push(xe(t.coordinates,a))}else{const n=Math.floor(e);let r=Math.ceil(i);r===i&&(r+=1);for(let a=n;a>=r;--a)s.push(xe(t.coordinates,a))}s.length&&this.appendCoordinates(s)}updateTrace_(t){const e=this.traceState_;if(!e.active||e.targetIndex===-1&&lt(e.startPx,t.pixel)<this.snapTolerance_)return;const i=Un(t.coordinate,e,this.getMap(),this.snapTolerance_);if(e.targetIndex!==i.index){if(e.targetIndex!==-1){const l=e.targets[e.targetIndex];this.removeTracedCoordinates_(l.startIndex,l.endIndex)}const a=e.targets[i.index];this.addTracedCoordinates_(a,a.startIndex,i.endIndex)}else{const a=e.targets[e.targetIndex];this.addOrRemoveTracedCoordinates_(a,i.endIndex)}e.targetIndex=i.index;const s=e.targets[e.targetIndex];s.endIndex=i.endIndex;const n=Ce(s.coordinates,s.endIndex),r=this.getMap().getPixelFromCoordinate(n);t.coordinate=n,t.pixel=[Math.round(r[0]),Math.round(r[1])]}handleUpEvent(t){let e=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(t);const i=this.traceState_.active;if(this.toggleTraceState_(t),this.shouldHandle_){const s=!this.finishCoordinate_;s&&this.startDrawing_(t.coordinate),!s&&this.freehand_?this.finishDrawing():!this.freehand_&&(!s||this.mode_==="Point")&&(this.atFinish_(t.pixel,i)?this.finishCondition_(t)&&this.finishDrawing():this.addToDrawing_(t.coordinate)),e=!1}else this.freehand_&&this.abortDrawing()}return!e&&this.stopClick_&&t.preventDefault(),e}handlePointerMove_(t){if(this.pointerType_=t.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const e=this.downPx_,i=t.pixel,s=e[0]-i[0],n=e[1]-i[1],r=s*s+n*n;if(this.shouldHandle_=this.freehand_?r>this.squaredClickTolerance_:r<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(t.coordinate.slice());return}this.updateTrace_(t),this.modifyDrawing_(t.coordinate)}atFinish_(t,e){let i=!1;if(this.sketchFeature_){let s=!1,n=[this.finishCoordinate_];const r=this.mode_;if(r==="Point")i=!0;else if(r==="Circle")i=this.sketchCoords_.length===2;else if(r==="LineString")s=!e&&this.sketchCoords_.length>this.minPoints_;else if(r==="Polygon"){const a=this.sketchCoords_;s=a[0].length>this.minPoints_,n=[a[0][0],a[0][a[0].length-2]],e?n=[a[0][0]]:n=[a[0][0],a[0][a[0].length-2]]}if(s){const a=this.getMap();for(let l=0,h=n.length;l<h;l++){const d=n[l],g=a.getPixelFromCoordinate(d),p=t[0]-g[0],u=t[1]-g[1],m=this.freehand_?1:this.snapTolerance_;if(i=Math.sqrt(p*p+u*u)<=m,i){this.finishCoordinate_=d;break}}}}return i}createOrUpdateSketchPoint_(t){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(t):(this.sketchPoint_=new N(new q(t)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(t){this.sketchLine_||(this.sketchLine_=new N);const e=t.getLinearRing(0);let i=this.sketchLine_.getGeometry();i?(i.setFlatCoordinates(e.getLayout(),e.getFlatCoordinates()),i.changed()):(i=new G(e.getFlatCoordinates(),e.getLayout()),this.sketchLine_.setGeometry(i))}startDrawing_(t){const e=this.getMap().getView().getProjection(),i=hi(this.geometryLayout_);for(;t.length<i;)t.push(0);this.finishCoordinate_=t,this.mode_==="Point"?this.sketchCoords_=t.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[t.slice(),t.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[t.slice(),t.slice()],this.sketchLineCoords_&&(this.sketchLine_=new N(new G(this.sketchLineCoords_)));const s=this.geometryFunction_(this.sketchCoords_,void 0,e);this.sketchFeature_=new N,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(s),this.updateSketchFeatures_(),this.dispatchEvent(new Ye(We.DRAWSTART,this.sketchFeature_))}modifyDrawing_(t){const e=this.getMap(),i=this.sketchFeature_.getGeometry(),s=e.getView().getProjection(),n=hi(this.geometryLayout_);let r,a;for(;t.length<n;)t.push(0);this.mode_==="Point"?a=this.sketchCoords_:this.mode_==="Polygon"?(r=this.sketchCoords_[0],a=r[r.length-1],this.atFinish_(e.getPixelFromCoordinate(t))&&(t=this.finishCoordinate_.slice())):(r=this.sketchCoords_,a=r[r.length-1]),a[0]=t[0],a[1]=t[1],this.geometryFunction_(this.sketchCoords_,i,s),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(t),i.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(i):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(t){const e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection();let s,n;const r=this.mode_;return r==="LineString"||r==="Circle"?(this.finishCoordinate_=t.slice(),n=this.sketchCoords_,n.length>=this.maxPoints_&&(this.freehand_?n.pop():s=!0),n.push(t.slice()),this.geometryFunction_(n,e,i)):r==="Polygon"&&(n=this.sketchCoords_[0],n.length>=this.maxPoints_&&(this.freehand_?n.pop():s=!0),n.push(t.slice()),s&&(this.finishCoordinate_=n[0]),this.geometryFunction_(this.sketchCoords_,e,i)),this.createOrUpdateSketchPoint_(t.slice()),this.updateSketchFeatures_(),s?this.finishDrawing():this.sketchFeature_}removeLastPoints_(t){if(!this.sketchFeature_)return;const e=this.sketchFeature_.getGeometry(),i=this.getMap().getView().getProjection(),s=this.mode_;for(let n=0;n<t;++n){let r;if(s==="LineString"||s==="Circle"){if(r=this.sketchCoords_,r.splice(-2,1),r.length>=2){this.finishCoordinate_=r[r.length-2].slice();const a=this.finishCoordinate_.slice();r[r.length-1]=a,this.createOrUpdateSketchPoint_(a)}this.geometryFunction_(r,e,i),e.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(e)}else if(s==="Polygon"){r=this.sketchCoords_[0],r.splice(-2,1);const a=this.sketchLine_.getGeometry();if(r.length>=2){const l=r[r.length-2].slice();r[r.length-1]=l,this.createOrUpdateSketchPoint_(l)}a.setCoordinates(r),this.geometryFunction_(this.sketchCoords_,e,i)}if(r.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const t=this.abortDrawing_();if(!t)return null;let e=this.sketchCoords_;const i=t.getGeometry(),s=this.getMap().getView().getProjection();return this.mode_==="LineString"?(e.pop(),this.geometryFunction_(e,i,s)):this.mode_==="Polygon"&&(e[0].pop(),this.geometryFunction_(e,i,s),e=i.getCoordinates()),this.type_==="MultiPoint"?t.setGeometry(new $i([e])):this.type_==="MultiLineString"?t.setGeometry(new ct([e])):this.type_==="MultiPolygon"&&t.setGeometry(new Jt([e])),this.dispatchEvent(new Ye(We.DRAWEND,t)),this.features_&&this.features_.push(t),this.source_&&this.source_.addFeature(t),t}abortDrawing_(){this.finishCoordinate_=null;const t=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),t}abortDrawing(){const t=this.abortDrawing_();t&&this.dispatchEvent(new Ye(We.DRAWABORT,t))}appendCoordinates(t){const e=this.mode_,i=!this.sketchFeature_;i&&this.startDrawing_(t[0]);let s;if(e==="LineString"||e==="Circle")s=this.sketchCoords_;else if(e==="Polygon")s=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;i&&s.shift(),s.pop();for(let r=0;r<t.length;r++)this.addToDrawing_(t[r]);const n=t[t.length-1];this.sketchFeature_=this.addToDrawing_(n),this.modifyDrawing_(n)}extend(t){const i=t.getGeometry();this.sketchFeature_=t,this.sketchCoords_=i.getCoordinates();const s=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=s.slice(),this.sketchCoords_.push(s.slice()),this.sketchPoint_=new N(new q(s)),this.updateSketchFeatures_(),this.dispatchEvent(new Ye(We.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const t=[];this.sketchFeature_&&t.push(this.sketchFeature_),this.sketchLine_&&t.push(this.sketchLine_),this.sketchPoint_&&t.push(this.sketchPoint_);const e=this.overlay_.getSource();e.clear(!0),e.addFeatures(t)}updateState_(){const t=this.getMap(),e=this.getActive();(!t||!e)&&this.abortDrawing(),this.overlay_.setMap(e?t:null)}}function qn(){const c=zi();return function(t,e){return c[t.getGeometry().getType()]}}function Wn(c,t){return function(e,i,s){const n=I(e[0]),r=I(e[e.length-1]),a=Math.sqrt(le(n,r));i=i||Qt(new Be(n),c);let l=t;if(!t&&t!==0){const h=r[0]-n[0],d=r[1]-n[1];l=Math.atan2(d,h)}return Is(i,n,a,l),i}}function Yn(){return function(c,t,e){const i=B([c[0],c[c.length-1]].map(function(n){return I(n)})),s=[[di(i),Ds(i),$s(i),zs(i),di(i)]];return t?t.setCoordinates(s):t=new Ie(s),t}}function Xn(c){switch(c){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+c)}}class Kn{constructor(t){o(this,"features");o(this,"interaction");o(this,"vectorLayer");o(this,"storeLineChangeFn");o(this,"storeDrawActiveFn");o(this,"map");o(this,"state");this.state=t,this.features=new ht;const e=new Pe({useSpatialIndex:!1,features:this.features}),i=new ce({stroke:new De({color:"#ffcc33",width:2})});this.vectorLayer=new me({source:e,style:i}),this.interaction=new Yi({type:"LineString",features:this.features}),this.storeLineChangeFn=s=>this.state.lidar.line=s,this.storeDrawActiveFn=s=>this.state.lidar.drawActive=s}setLine(t){t?this.storeLineChangeFn(t):this.clear()}setMap(t){t&&(this.map=t,this.map.getLayers().getArray().find(i=>i===this.vectorLayer)||this.map.addLayer(this.vectorLayer))}setActive(t){var e,i;this.storeDrawActiveFn(t),t?((e=this.map)==null||e.addInteraction(this.interaction),this.interaction.setActive(!0),this.initInteraction()):((i=this.map)==null||i.removeInteraction(this.interaction),this.clear())}initInteraction(){this.interaction.on("drawstart",()=>{this.features.clear()}),this.interaction.on("drawend",t=>{this.setLine(t.feature.getGeometry()??null),setTimeout(()=>{this.interaction.setActive(!1),this.storeDrawActiveFn(!1)},0)})}clear(){this.features.clear(),this.storeLineChangeFn(null)}}const fe=()=>{var c,t;return(t=(c=document.querySelector("#lidar-footer"))==null?void 0:c.shadowRoot)==null?void 0:t.querySelector("#gmf-lidarprofile-container")},oe=()=>{var c;return(c=fe())==null?void 0:c.querySelector(".lidar-canvas")},Se=()=>{var c;return(c=fe())==null?void 0:c.querySelector("svg.lidar-svg")},bi=()=>{var c;return(c=fe())==null?void 0:c.querySelector(".lidar-error")},yi=()=>{var c;return(c=fe())==null?void 0:c.querySelector(".lod-info")},Jn=()=>{var c;return(c=fe())==null?void 0:c.querySelector(".width-info")};class Qn{clipLineByMeasure(t,e,i){const s=new G([]);let n=0,r=0;const a=t.getLength(),l=e/a,h=i/a;let d=t.getCoordinates().length-1,g=0;t.forEachSegment((C,L)=>{g+=1;const M=new G([C,L]);r+=M.getLength(),e==n?s.appendCoordinate(C):e>n&&e<r&&s.appendCoordinate(t.getCoordinateAt(l)),n>e&&n<i&&s.appendCoordinate(C),i==r?s.appendCoordinate(L):(i>n&&i<r||i>n&&i>r&&g===d)&&s.appendCoordinate(t.getCoordinateAt(h)),n+=M.getLength()});const p=new N({geometry:s}),u=new ce({stroke:new De({color:"rgba(255,0,0,1)",width:2,lineCap:"square"})});let m=0,f=0;d=s.getCoordinates().length-1;let b=1;s.forEachSegment((C,L)=>{if(b==1){const M=L[0]-C[0],T=L[1]-C[1];m=Math.atan2(M,T)}if(b==d){const M=L[0]-C[0],T=L[1]-C[1];f=Math.atan2(M,T)}b+=1});const w=[u],y=s.getLastCoordinate(),k=s.getFirstCoordinate();return w.push(new ce({geometry:new q(k),image:new jt({fill:new te({color:"rgba(255, 0, 0, 1)"}),stroke:new De({color:"rgba(255,0,0,1)",width:1,lineCap:"square"}),points:3,radius:5,rotation:m,angle:Math.PI/3})}),new ce({geometry:new q(y),image:new jt({fill:new te({color:"rgba(255, 0, 0, 1)"}),stroke:new De({color:"rgba(255,0,0,1)",width:1,lineCap:"square"}),points:3,radius:5,rotation:f,angle:4*Math.PI/3})})),{clippedLine:s.getCoordinates(),distanceOffset:e,bufferGeom:p,bufferStyle:w}}getNiceLOD(t,e){let i=0,s=0;for(const n in e){const r=parseInt(n,10),a=e[r].max??0;t<r&&a>i&&(i=a,s=e[r].width??0)}return{maxLOD:i,width:s}}downloadProfileAsImageFile(t){const e=E(Se()),i=parseInt(e.attr("width"),10),s=parseInt(e.attr("height"),10),n=t.margin,r=document.createElement("canvas");r.style.display="none",r.width=i,r.height=s;const a=r.getContext("2d");if(!a)throw new Error("Missing ctx");a.fillStyle="white",a.fillRect(0,0,i,s);const h=E(oe()).node();a.drawImage(h,(n==null?void 0:n.left)??0,(n==null?void 0:n.top)??0);const d=new Image,g=new XMLSerializer,p=e.node(),u=g.serializeToString(p),m="lidare_profile_for_export_uid";d.id=m;const f=Vs.Buffer.from(u);d.src=`data:image/svg+xml;base64, ${f.toString("base64")}`,d.style.setProperty("display","none");const b=document.getElementsByTagName("body")[0];d.onload=()=>{a.drawImage(d,0,0,i,s);const w=document.getElementById(m);if(!w)throw new Error("Missing elImg");b.removeChild(w),r.toBlob(y=>{if(!y){window.alert(ae.getInstance().getTranslation("No graph to export in PNG!"));return}Vi.saveAs(y,"LIDAR_profile.png")})},b.appendChild(d)}getFlatPointsByDistance(t){const e=[],i=t.distance??[],s=t.altitude??[],n=t.color_packed??[],r=t.intensity??[],a=t.classification??[],l=t.coords??[];for(let h=0;h<i.length;h++){const d={distance:i[h],altitude:s[h],color_packed:n[h],intensity:r[h],classification:a[h],coords:l[h]};e.push(d)}return e.sort((h,d)=>h.distance-d.distance),e}getCSVData(t){return t.map(e=>{const i={};return Object.keys(e).forEach(s=>{if(s==="altitude"){const n=e==null?void 0:e.altitude;i[s]=n?n.toFixed(4):NaN}else s==="color_packed"?i[s]=(e.color_packed??[]).join(" "):s==="coords"?i[s]=(e.coords??[]).join(" "):i[s]=e[s]}),i})}arrayMax(t){return t.reduce((e,i)=>Math.max(e,i),0)}arrayMin(t){let e=1/0;for(const i of t)i<e&&(e=i);return e}getPytreeLinestring(t){const e=t.getCoordinates();let i="";for(const s of e){const n=s[0],r=s[1];i+=`{${Math.round(100*n)/100}, ${Math.round(100*r)/100}},`}return i.substring(0,i.length-1)}getClosestPoint(t,e,i,s,n,r,a){const l=s,h=[],d=[],g=t.distance??[],p=t.altitude??[],u=t.color_packed??[],m=t.intensity??[],f=t.classification??[],b=t.coords??[];for(let y=0;y<g.length;y++)if(n(g[y])<e+l&&n(g[y])>e-l&&r(p[y])<i+l&&r(p[y])>i-l){const k=Math.sqrt(Math.pow(n(g[y])-e,2)+Math.pow(r(p[y])-i,2)),C=a[f[y]];C&&C.visible==1&&(d.push({distance:g[y],altitude:p[y],classification:f[y],color_packed:u[y],intensity:m[y],coords:b[y]}),h.push(k))}let w=null;if(d.length>0){const y=Math.min(...h),k=h.indexOf(y);k!=-1?w=d[k]:w=d[0]}return w??void 0}}class Zn{constructor(t){o(this,"scaleX");o(this,"updateScaleX");o(this,"scaleY");o(this,"updateScaleY");o(this,"material");o(this,"previousDomainX");o(this,"manager");o(this,"width");o(this,"height");o(this,"moved");o(this,"i18nManager");this.i18nManager=ae.getInstance(),this.manager=t,this.scaleX=null,this.updateScaleX=e=>e,this.scaleY=null,this.updateScaleY=e=>e,this.material=null,this.width=0,this.height=0,this.previousDomainX=[],this.moved=!1}drawPoints(t){var f,b,w;if(!this.manager.config)throw new Error("Missing manager.config");if(!this.manager.config.serverConfig)throw new Error("Missing manager_.config.serverConfig");let e=-1;const i=((f=t.distance)==null?void 0:f.length)??0;let s,n;const r=E(oe()),a=r==null?void 0:r.node(),l=a==null?void 0:a.getContext("2d");if(!l)throw new Error("Missing ctx");const h=this.manager.config.serverConfig,d=t.distance??[],g=t.altitude??[],p=t.color_packed??[],u=t.intensity??[],m=t.classification??[];for(;++e<i;){const y=d[e],k=g[e],C=p[e],L=u[e],M=m[e];(w=(b=h==null?void 0:h.classification_colors)==null?void 0:b[M])!=null&&w.visible&&(s=this.updateScaleX(y),n=this.updateScaleY(k),l.beginPath(),l.moveTo(s,n),this.material=="COLOR_PACKED"?l.fillStyle=`RGB(${C[0]}, ${C[1]}, ${C[2]})`:this.material=="INTENSITY"?l.fillStyle=`RGB(${L}, ${L}, ${L})`:this.material=="CLASSIFICATION"?l.fillStyle=`RGB(${h.classification_colors[M].color})`:l.fillStyle=h.default_color??"",l.arc(s,n,h.point_size??0,0,2*Math.PI,!1),l.fill())}}setupPlot(t,e){if(!this.manager.config)throw new Error("Missing manager.config");if(!this.manager.config.serverConfig)throw new Error("Missing manager_.config.serverConfig");const i=E(oe()),s=i==null?void 0:i.node(),n=s==null?void 0:s.getContext("2d");if(!n||!s)throw new Error("Missing ctx or canvas element");n.clearRect(0,0,s.getBoundingClientRect().width,s.getBoundingClientRect().height);const r=this.manager.config.clientConfig.margin,a=fe(),l=E(a),h=l==null?void 0:l.node(),d=(h==null?void 0:h.getBoundingClientRect().width)??0,g=(h==null?void 0:h.getBoundingClientRect().height)??0;this.width=d-(r.left+r.right),this.height=g-(r.top+r.bottom),this.material=this.manager.config.serverConfig.default_attribute??"",i.attr("height",this.height).attr("width",this.width).style("background-color","black").style("z-index",0).style("position","absolute").style("margin-left",`${r.left.toString()}px`).style("margin-top",`${r.top.toString()}px`);const p=t[1]-t[0],u=e[1]-e[0],m=p/u,f=this.width,b=this.height,w=f/b;let y;if(m<w){const T=w/m,Q=p*T;this.scaleX=Ue(),this.scaleX.domain([0,Q]),this.scaleX.range([0,this.width]),this.scaleY=Ue(),this.scaleY.domain(e),this.scaleY.range([this.height,0])}else{y=m/w;const T=u*y,Q=(e[1]+e[0])/2;this.scaleX=Ue(),this.scaleX.domain(t),this.scaleX.range([0,this.width]),this.scaleY=Ue(),this.scaleY.domain([Q-T/2,Q+T/2]),this.scaleY.range([this.height,0])}const k=Ns().scaleExtent([-10,100]).translateExtent([[0,0],[this.width,this.height]]).extent([[0,0],[this.width,this.height]]).on("zoom",T=>this.zoomed(T));k.on("end",T=>this.zoomEnd(T)),this.previousDomainX=this.scaleX.domain(),this.updateScaleX=this.scaleX,this.updateScaleY=this.scaleY;const C=E(Se());C.call(k).on("dblclick.zoom",null),C.selectAll("*").remove(),C.attr("width",this.width+r.left).attr("height",this.height+r.top+r.bottom),C.on("mousemove",T=>{this.pointHighlight(T)});const L=gi(this.scaleX),M=ui(this.scaleY).tickSize(-this.width);C.select(".y.axis").selectAll("g.tick line").style("stroke","#b7cff7"),C.append("g").attr("class","y axis").call(M),C.append("g").attr("class","x axis").call(L),C.select(".y.axis").attr("transform",`translate(${r.left}, ${r.top})`),C.select(".x.axis").attr("transform",`translate(${r.left}, ${this.height+r.top})`),C.select(".y.axis").selectAll("g.tick line").style("opacity","0.5").style("stroke","#b7cff7")}zoomEnd(t){if(t.sourceEvent&&this.moved===!1){this.manager.updateData();return}this.moved=!1;const e=oe(),i=E(e),s=i==null?void 0:i.node(),n=s==null?void 0:s.getContext("2d");if(!n)throw new Error("Missing ctx");n.clearRect(0,0,this.width,this.height),this.manager.updateData()}zoomed(t){if(!this.manager.measure)throw new Error("Missing manager.measure");if(!this.scaleX)throw new Error("Missing scaleX");if(!this.scaleY)throw new Error("Missing scaleY");if(t.sourceEvent&&t.sourceEvent.type==="mousemove"&&(this.moved=!0,t.sourceEvent.movementX==0&&t.sourceEvent.movementY==0))return;this.manager.measure.clearMeasure();const e=t.transform,i=E(Se()),s=gi(this.scaleX),n=ui(this.scaleY).tickSize(-this.width),r=e.rescaleX(this.scaleX),a=e.rescaleY(this.scaleY),l=i.select(".x.axis"),h=i.select(".y.axis");l.call(s.scale(r)),h.call(n.scale(a));const d=E(oe()),g=d==null?void 0:d.node(),p=g==null?void 0:g.getContext("2d");if(!p)throw new Error("Missing ctx");p.clearRect(0,0,this.width,this.height),i.select(".y.axis").selectAll("g.tick line").style("opacity","0.5").style("stroke","#b7cff7"),this.updateScaleX=r,this.updateScaleY=a}pointHighlight(t){if(!this.manager.config)throw new Error("Missing manager.config");if(!this.manager.config.serverConfig)throw new Error("Missing manager_.config.serverConfig");const e=fe();if(!e){console.error("No container element.");return}const i=E(e.querySelector("svg.lidar-svg")),s=E(e.querySelector(".lidar-info")),n=this.manager.config.serverConfig.point_size??0,r=this.manager.config.clientConfig.margin,a=this.manager.config.clientConfig.tolerance??0,h=E(e.querySelector(".lidar-canvas")).node(),d=Ut(t,h),g=this.manager.config.serverConfig.classification_colors??[];let p,u;const m=this.manager.utils.getClosestPoint(this.manager.profilePoints,d[0],d[1],a,this.updateScaleX,this.updateScaleY,g),f=this.manager.lidarPointHighlight.getSource();if(m!=null){p=this.updateScaleX((m==null?void 0:m.distance)??0)+r.left,u=this.updateScaleY((m==null?void 0:m.altitude)??0)+r.top,i.selectAll("#highlightCircle").remove(),i.append("circle").attr("id","highlightCircle").attr("cx",p).attr("cy",u).attr("r",n+1).style("fill","orange");const b=m.classification??-1,w=g[b]||{},y=this.getInfoHTML(m,w,1);s.html(y),this.manager.cartoHighlight.setElement(void 0);const k=document.createElement("div");k.className+="tooltip gmf-tooltip-measure",k.innerHTML=y;const C=m.coords??[];this.manager.cartoHighlight.setElement(k),this.manager.cartoHighlight.setPosition([C[0],C[1]]),f==null||f.clear();const L=new q([C[0],C[1]]),M=new N(L);w.color!==void 0&&M.setStyle(new ce({image:new ei({fill:new te({color:`rgba(${w.color}, 1)`}),radius:3})})),f==null||f.addFeature(M)}else f==null||f.clear(),i.select("#highlightCircle").remove(),s.html(""),this.manager.cartoHighlight.setPosition(void 0)}getInfoHTML(t,e,i){const s=[],n=t.distance,r=t.altitude,a=this.i18nManager.getTranslation(e.name??""),l=t.intensity;if(n!==void 0){const h=this.i18nManager.getTranslation("Distance: ");s.push(`${h+this.formatDecimals(n,i)}`)}if(r!==void 0){const h=this.i18nManager.getTranslation("Altitude: ");s.push(`${h+this.formatDecimals(r,i)}`)}if(a.length>0){const h=this.i18nManager.getTranslation("Classification: ");s.push(`${h+a}`)}if(l!==void 0){const h=this.i18nManager.getTranslation("Intensity: ");s.push(`${h+this.formatDecimals(l,0)}`)}return s.join("</br>")}formatDecimals(t,e){return Number((Math.round(t*100)/100).toFixed(e))}changeStyle(t){this.material=t;const e=E(oe()),i=e==null?void 0:e.node(),s=i==null?void 0:i.getContext("2d");if(!s||!i)throw new Error("Missing ctx or canvas element.");s.clearRect(0,0,i.width,i.height),this.drawPoints(this.manager.profilePoints)}setClassActive(t,e){if(!this.manager.config)throw new Error("Missing manager.config");if(!this.manager.config.serverConfig)throw new Error("Missing manager_.config.serverConfig");this.manager.config.serverConfig.classification_colors=t,this.changeStyle(e)}}class er{constructor(t){o(this,"manager");o(this,"pStart");o(this,"pEnd");this.manager=t,this.pStart={},this.pEnd={}}clearMeasure(){this.pStart={},this.pEnd={};const t=E(Se());t.selectAll("#text_m").remove(),t.selectAll("#start_m").remove(),t.selectAll("#end_m").remove(),t.selectAll("#line_m").remove(),t.on("click",null),t.style("cursor","default")}setMeasureActive(){const t=E(Se());t.style("cursor","pointer"),t.on("click",e=>this.measureHeight(e))}measureHeight(t){if(!this.manager.config)throw new Error("Missing manager.config");if(!this.manager.plot)throw new Error("Missing manager.plot");const e=E(Se()),i=e.node(),n=E(oe()).node(),r=Ut(t,i),a=Ut(t,n),l=this.manager.config.clientConfig.margin,h=r[0],d=r[1],g=2,p=this.manager.plot.updateScaleX,u=this.manager.plot.updateScaleY,m=3;if(!this.manager.config.serverConfig)throw new Error("Missing manager_.config.serverConfig");const f=this.manager.utils.getClosestPoint(this.manager.profilePoints,a[0],a[1],g,this.manager.plot.updateScaleX,this.manager.plot.updateScaleY,this.manager.config.serverConfig.classification_colors??[]),b=p.invert(h),w=u.invert(d);if(this.pStart.set?this.pEnd.set||(f?(this.pEnd.distance=f.distance,this.pEnd.altitude=f.altitude,this.pEnd.cx=p(f.distance??0)+l.left,this.pEnd.cy=u(f.altitude??0)+l.top):(this.pEnd.distance=b,this.pEnd.altitude=w,this.pEnd.cx=h,this.pEnd.cy=d),this.pEnd.set=!0,e.append("circle").attr("id","end_m").attr("cx",this.pEnd.cx).attr("cy",this.pEnd.cy).attr("r",m).style("fill","red"),e.append("line").attr("id","line_m").attr("x1",this.pStart.cx??0).attr("y1",this.pStart.cy??0).attr("x2",this.pEnd.cx).attr("y2",this.pEnd.cy).attr("stroke-width",2).attr("stroke","red")):(f?(this.pStart.distance=f.distance,this.pStart.altitude=f.altitude,this.pStart.cx=p(f.distance??0)+l.left,this.pStart.cy=u(f.altitude??0)+l.top):(this.pStart.distance=b,this.pStart.altitude=w,this.pStart.cx=h,this.pStart.cy=d),this.pStart.set=!0,e.append("circle").attr("id","start_m").attr("cx",this.pStart.cx).attr("cy",this.pStart.cy).attr("r",m).style("fill","red")),this.pStart.set&&this.pEnd.set){const y=(this.pEnd.altitude??0)-(this.pStart.altitude??0),k=(this.pEnd.distance??0)-(this.pStart.distance??0),C=Math.round(10*Math.sqrt(Math.pow(y,2)+Math.pow(k,2)))/10;isNaN(C)||e.append("text").attr("id","text_m").attr("x",10+((this.pStart.cx??0)+(this.pEnd.cx??0))/2).attr("y",((this.pStart.cy??0)+(this.pEnd.cy??0))/2).text(`${C} m`).attr("font-family","sans-serif").attr("font-size","14px").style("font-weight","bold").attr("fill","red"),this.pEnd.set=!1,this.pStart.set=!1}}}class tr{constructor(){o(this,"plot");o(this,"measure");o(this,"config");o(this,"cartoHighlight");o(this,"lidarPointHighlight");o(this,"lidarBuffer");o(this,"profilePoints");o(this,"isPlotSetup");o(this,"line");o(this,"i18nManager",null);o(this,"utils");o(this,"debouncer",Yt(()=>this.updateData_(),200));this.plot=null,this.measure=null,this.config=null,this.line=null,this.isPlotSetup=!1,this.utils=new Qn,this.cartoHighlight=new Gs({offset:[0,-15],positioning:"bottom-center"}),this.lidarPointHighlight=new me({className:"canvas2d",source:new Pe({}),style:new ce({image:new ei({fill:new te({color:"rgba(0, 0, 255, 1)"}),radius:3})})}),this.lidarBuffer=new me({className:"canvas2d",source:new Pe({})}),this.profilePoints=this.getEmptyProfilePoints_()}init(t,e){this.i18nManager=ae.getInstance(),this.config=t,this.plot=new Zn(this),this.measure=new er(this),this.setMap(e)}clearBuffer(){var t;this.lidarBuffer&&((t=this.lidarBuffer.getSource())==null||t.clear())}setLine(t){this.line=t}setMap(t){this.cartoHighlight.setMap(t),this.lidarPointHighlight.setMap(t),this.lidarBuffer.setMap(t)}getEmptyProfilePoints_(){return{distance:[],altitude:[],color_packed:[],intensity:[],classification:[],coords:[]}}getProfileByLOD(t,e,i,s){var g;if(!this.config)throw new Error("Missing config");if(!this.plot)throw new Error("Missing plot");if(!this.line)throw new Error("Missing line");if(!this.config.serverConfig)throw new Error("Missing config.serverConfig");this.profilePoints=this.getEmptyProfilePoints_(),i&&(this.isPlotSetup=!1),E(bi()).style("visibility","hidden");let n=this.utils.getPytreeLinestring(this.line),r;const a=this.config.serverConfig.max_levels??[];if(e==0)r=this.utils.getNiceLOD(this.line.getLength(),a);else{const p=this.plot.updateScaleX.domain();n="";for(const u of t)n+=`{${u[0]},${u[1]}},`;n=n.substring(0,n.length-1),r=this.utils.getNiceLOD(p[1]-p[0],a)}E(yi()).html(""),this.config.clientConfig.pointSum=0;const l=this.config.clientConfig.autoWidth?r.width:this.config.serverConfig.width??0,h=(g=this.i18nManager)==null?void 0:g.getTranslation("Profile width: ");E(Jn()).html(`${h} ${l}m`);const d=this.config.serverConfig.initialLOD??0;for(let p=0;p<r.maxLOD;p++)p==0?(this.queryPytree(s,d,p,n,e,l,i),p+=d-1):p<r.maxLOD-1?this.queryPytree(s+p,s+p+1,p,n,e,l,!1):this.queryPytree(s+p,s+p+1,p,n,e,l,!1)}queryPytree(t,e,i,s,n,r,a){var p;if(!this.config)throw new Error("Missing config");if(!this.config.serverConfig)throw new Error("Missing config.serverConfig");const l=E(yi());if(this.config.serverConfig.debug){let u=l.html();const m=(p=this.i18nManager)==null?void 0:p.getTranslation("Loading LOD: ");u+=`${m} ${t}-${e}..<br>`,l.html(u)}const h=this.config.serverConfig.default_point_cloud,d=`${this.config.pytreeLidarProfileJsonUrl}/profile/get?minLOD=${t}&maxLOD=${e}&width=${r}&coordinates=${s}&pointCloud=${h}&attributes=`;fetch(d,{method:"GET",headers:{"Content-Type":"text/plain; charset=x-user-defined"},responseType:"arraybuffer"}).then(u=>u.arrayBuffer()).then(u=>{var m,f;if(!this.config)throw new Error("Missing config");if(!this.config.serverConfig)throw new Error("Missing config.serverConfig");if(this.config.serverConfig.debug){let b=l.html();const w=(m=this.i18nManager)==null?void 0:m.getTranslation("LOD: "),y=(f=this.i18nManager)==null?void 0:f.getTranslation("loaded");b+=`${w} ${t}-${e} ${y}<br>`,l.html(b)}this.processBuffer(u,i,n,a)}).catch(u=>{throw new Error(`Error on pytree query: ${u.message}`)})}processBuffer(t,e,i,s){if(!this.config)throw new Error("Missing config");if(!this.config.serverConfig)throw new Error("Missing config.serverConfig");if(!this.plot)throw new Error("Missing plot");if(!this.line)throw new Error("Missing line");const n=E(bi()),a=new Int32Array(t,0,4)[0],l=new Uint8Array(t,4,a);let h="";for(const Z of l)h+=String.fromCharCode(Z);try{JSON.parse(h)}catch{if(!this.isPlotSetup){const Oe=E(oe()),A=Oe.node(),D=A==null?void 0:A.getContext("2d");if(!D||!A)throw new Error("Missing ctx or canvas element.");D.clearRect(0,0,A.getBoundingClientRect().width,A.getBoundingClientRect().height),Oe.selectAll("*").remove();const se=this.getHTMLError_();n.style("visibility","visible"),n.html(se)}return}n.style("visibility","hidden");const d=JSON.parse(h);(this.config.clientConfig.pointSum??0)+d.points>(this.config.serverConfig.max_point_number??0)&&console.warn("Number of points is higher than Pytree configuration max value !");const p=d.pointAttributes,u=[],m=this.config.serverConfig.point_attributes??{};for(const Z of p)m[Z]!=null&&u.push(m[Z]);const f=d.scale;if(d.points<3)return;const b=this.getEmptyProfilePoints_(),w=d.bytesPerPoint,y=t.slice(4+a),k=this.profilePoints.distance??[],C=this.profilePoints.classification??[],L=this.profilePoints.intensity??[],M=this.profilePoints.color_packed??[],T=this.profilePoints.altitude??[],Q=this.profilePoints.coords??[],is=b.distance??[],ss=b.classification??[],ns=b.intensity??[],rs=b.color_packed??[],Lt=b.altitude??[],os=b.coords??[];for(let Z=0;Z<d.points;Z++){const Oe=w*Z,A=new DataView(y,Oe,w);let D=0;for(const se of u){if(se.value=="POSITION_PROJECTED_PROFILE"){const he=A.getUint32(D,!0)*f,ne=Math.round(100*(i+he))/100;is.push(ne),k.push(ne)}else if(se.value=="CLASSIFICATION"){const O=A.getUint8(D);ss.push(O),C.push(O)}else if(se.value=="INTENSITY"){const O=A.getUint8(D);ns.push(O),L.push(O)}else if(se.value=="COLOR_PACKED"){const O=A.getUint8(D),he=A.getUint8(D+1),ne=A.getUint8(D+2);rs.push([O,he,ne]),M.push([O,he,ne])}else if(se.value=="POSITION_CARTESIAN"){const O=d.boundingBox.lx;if(typeof O!="number")throw new Error("Wrong lx type");const he=d.boundingBox.ly;if(typeof he!="number")throw new Error("Wrong ly type");const ne=d.boundingBox.lz;if(typeof ne!="number")throw new Error("Wrong lz type");const ni=A.getInt32(D,!0)*f+O,ri=A.getInt32(D+4,!0)*f+he,oi=A.getInt32(D+8,!0)*f+ne;os.push([ni,ri]),Lt.push(oi),T.push(oi),Q.push([ni,ri])}D=D+(se.bytes??0)}}const as=[0,this.line.getLength()],ls=[this.utils.arrayMin(Lt),this.utils.arrayMax(Lt)];(e==0&&s||!this.isPlotSetup)&&(this.plot.setupPlot(as,ls),this.isPlotSetup=!0),this.plot.drawPoints(b)}getHTMLError_(){var n,r,a,l;const t=(n=this.i18nManager)==null?void 0:n.getTranslation("LiDAR profile service error"),e=(r=this.i18nManager)==null?void 0:r.getTranslation("It might be offline"),i=(a=this.i18nManager)==null?void 0:a.getTranslation("Or did you attempt to draw a profile outside data extent?"),s=(l=this.i18nManager)==null?void 0:l.getTranslation("Or did you attempt to draw such a small profile that no point was returned?");return`
      <div class="lidarprofile-error">
      <p class="bold">${t}</p>
      <p>${e}</p>
      <p>${i}</p>
      <p>${s}</p>
    `}updateData(){this.debouncer()}updateData_(){if(!this.config)throw new Error("Missing config");if(!this.config.serverConfig)throw new Error("Missing config.serverConfig");if(!this.plot)throw new Error("Missing plot");if(!this.line)throw new Error("Missing line");const t=this.plot.updateScaleX.domain(),e=this.utils.clipLineByMeasure(this.line,t[0],t[1]),i=this.lidarBuffer.getSource();if(!i){console.error("No source to update data.");return}i.clear(),i.addFeature(e.bufferGeom),this.lidarBuffer.setStyle(e.bufferStyle);const s=t[1]-t[0],n=this.utils.getNiceLOD(s,this.config.serverConfig.max_levels??[]),r=.2;Math.abs(t[0]-this.plot.previousDomainX[0])<r&&Math.abs(t[1]-this.plot.previousDomainX[1])<r?this.plot.drawPoints(this.profilePoints):n.maxLOD<=(this.config.serverConfig.initialLOD??0)?this.plot.drawPoints(this.profilePoints):this.getProfileByLOD(e.clippedLine,e.distanceOffset,!1,0),this.plot.previousDomainX=t}}const Xi=new tr;class ir{constructor(t,e){o(this,"profileConfig",null);o(this,"profileManager");o(this,"csvManager");o(this,"line",null);this.profileConfig=t,this.csvManager=e,this.profileManager=Xi}setLine(t){this.line=t}clearProfile(){this.profileManager.setLine(null),this.profileManager.cartoHighlight.setPosition(void 0),this.profileManager.measure&&this.clearMeasure(),this.resetPlot()}setMeasureActive(){if(!this.profileManager.measure){console.error("Missing profile.measure");return}this.profileManager.measure.clearMeasure(),this.profileManager.measure.setMeasureActive()}clearMeasure(){if(!this.profileManager.measure){console.error("Missing profile.measure");return}this.profileManager.measure.clearMeasure()}resetPlot(){this.profileManager.clearBuffer(),this.line&&this.profileManager.getProfileByLOD([],0,!0,0)}setClassification(t,e){var s;if(!this.profileManager.plot){console.error("Missing profile.plot");return}if(!((s=this==null?void 0:this.profileConfig)!=null&&s.serverConfig)){console.error("Missing profileConfig.serverConfig");return}const i=this.profileConfig.serverConfig.classification_colors??[];i[e].visible=t.visible,this.line&&this.profileManager.plot.setClassActive(i,this.profileConfig.serverConfig.default_attribute??"")}selectPointAttribute(t){var s,n,r;const i=(((r=(n=(s=this.profileConfig)==null?void 0:s.clientConfig)==null?void 0:n.pointAttributes)==null?void 0:r.availableOptions)??[]).find(a=>a.name===t);i&&this.setSelectedPointAttribute(i)}updateProfile(){var t;if(this.profileManager.clearBuffer(),!((t=this.profileConfig)!=null&&t.serverConfig)){console.error("Missing profileConfig.serverConfig");return}this.profileManager.setLine(this.line),this.profileManager.getProfileByLOD([],0,!0,this.profileConfig.serverConfig.minLOD??0)}exportFile(t){switch(t){case"csv":return this.csvExport();case"png":return this.pngExport();case"kml":return this.kmlExport()}}csvExport(){const t=this.profileManager.utils.getFlatPointsByDistance(this.profileManager.profilePoints)||[],e=this.profileManager.utils.getCSVData(t),s=Object.keys(t[0]).map(n=>({name:n}));this.csvManager.startDownload(e,s,"LIDAR_profile.csv")}pngExport(){var e;const t=(e=this.profileConfig)==null?void 0:e.clientConfig;t&&this.profileManager.utils.downloadProfileAsImageFile(t)}kmlExport(){if(this.line){const t=new ti().writeFeatures([new N({geometry:this.line})],{dataProjection:"EPSG:4326",featureProjection:W.getInstance().state.projection});Vi.saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),"profile.kml")}else console.warn("A line should be drawn before being exporting to KML")}setSelectedPointAttribute(t){var e;if(!((e=this.profileConfig)!=null&&e.clientConfig.pointAttributes)){console.error("Missing pointAttributes");return}if(!this.profileManager.plot){console.error("Missing plot");return}this.profileConfig.clientConfig.pointAttributes.selectedOption=t,this.profileManager.plot.changeStyle(t.value??"")}}const sr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20576%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M290.7%2057.4L57.4%20290.7c-25%2025-25%2065.5%200%2090.5l80%2080c12%2012%2028.3%2018.7%2045.3%2018.7H288h9.4H512c17.7%200%2032-14.3%2032-32s-14.3-32-32-32H387.9L518.6%20285.3c25-25%2025-65.5%200-90.5L381.3%2057.4c-25-25-65.5-25-90.5%200zM297.4%20416H288l-105.4%200-80-80L227.3%20211.3%20364.7%20348.7%20297.4%20416z'/%3e%3c/svg%3e",nr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M142.9%20142.9c62.2-62.2%20162.7-62.5%20225.3-1L327%20183c-6.9%206.9-8.9%2017.2-5.2%2026.2s12.5%2014.8%2022.2%2014.8H463.5c0%200%200%200%200%200H472c13.3%200%2024-10.7%2024-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2%205.2L413.4%2096.6c-87.6-86.5-228.7-86.2-315.8%201C73.2%20122%2055.6%20150.7%2044.8%20181.4c-5.9%2016.7%202.9%2034.9%2019.5%2040.8s34.9-2.9%2040.8-19.5c7.7-21.8%2020.2-42.3%2037.8-59.8zM16%20312v7.6%20.7V440c0%209.7%205.8%2018.5%2014.8%2022.2s19.3%201.7%2026.2-5.2l41.6-41.6c87.6%2086.5%20228.7%2086.2%20315.8-1c24.4-24.4%2042.1-53.1%2052.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9%202.9-40.8%2019.5c-7.7%2021.8-20.2%2042.3-37.8%2059.8c-62.2%2062.2-162.7%2062.5-225.3%201L185%20329c6.9-6.9%208.9-17.2%205.2-26.2s-12.5-14.8-22.2-14.8H48.4h-.7H40c-13.3%200-24%2010.7-24%2024z'/%3e%3c/svg%3e";class rr extends P{constructor(){super("lidar-panel");o(this,"template",()=>v`<style>
#panel{position:absolute;top:0;left:0;right:0;bottom:0;height:100%;overflow:auto;min-width:20rem}.hidden{display:none}#content{background:var(--bkg-color);padding:1.5rem;margin:0;color:var(--text-color)}#content button{margin-top:1rem;height:3rem;background-color:var(--bkg-color);color:var(--text-color);border-radius:3px;outline:0;border:solid 1px var(--text-color);cursor:pointer}#content button:hover{background-color:var(--bkg-color-grad2)}#content button img{width:1rem;height:1rem}select{font-family:Arial,sans-serif;appearance:none;outline:0;box-shadow:none;padding:.5rem;color:var(--text-color);background-color:var(--bkg-color);border:solid 1px var(--text-color);background-image:none;cursor:pointer}.select{position:relative;display:flex;width:13rem;height:2.5rem;border-radius:3px;overflow:hidden;flex-grow:1}.select select{flex-grow:1}.select::after{content:'\u25bc';position:absolute;top:0;right:0;padding:.7rem;border:solid 1px var(--text-color);border-left-width:0;color:var(--text-color);pointer-events:none}#content .no-margin{margin:0}#content .margin-top{margin-top:.5rem}#content .active{background-color:var(--bkg-color-grad1)}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="panel">
  <div id="content">
    <div class="${this.isConfigLoaded()?"hidden":""}">
      Error, can not fetch the config. Please try again later.
    </div>

    <div class="${this.isConfigLoaded()?"":"hidden"}">
      <div>
        <button
          class="${this.isDrawActive()?"no-margin active":"no-margin"}"
          onclick="${()=>this.toggleDrawLine()}"
          i18n="Draw LiDAR profile line"></button>
      </div>

      ${this.isDrawActive()?v`
      <div class="margin-top">
        <em
          class="small"
          i18n="Draw a line on the map to display the corresponding LiDAR profile. Use double-click to finish the drawing.">
        </em>
      </div>
      `:v``} ${this.isLineDrawn()?v`
      <div>
        <button class="btn btn-default" onclick="${()=>this.exportFile("csv")}" i18n="CSV export"></button>
        <button class="btn btn-default" onclick="${()=>this.exportFile("png")}" i18n="PNG export"></button>
        <button class="btn btn-default" onclick="${()=>this.exportFile("kml")}" i18n="KML export"></button>
        <button class="btn btn-default" title="Reset profile" onclick="${()=>this.resetPlot()}">
          <img src="${this.rotateSvgUrl}" alt="Reset profile" />
        </button>
      </div>
      <hr />
      <button class="btn btn-default" onclick="${()=>this.setMeasureActive()}" i18n="Take measure"></button>
      <button class="btn btn-default" title="Clear measure" onclick="${()=>this.clearMeasure()}">
        <img src="${this.eraserSvgUrl}" alt="Clear measure" />
      </button>
      `:v``}

      <div>
        <hr />
        <p i18n="Material"></p>
        <div class="select">
          <select id="select-attributes" onchange="${e=>this.selectPointAttribute(e)}">
            ${this.getAvailablePointAttributes().map(e=>v`
            <option value="${e.name}" .selected="${this.isPointAttributeSelected(e.name)}">
              ${e.name}
            </option>
            `)}
          </select>
        </div>
      </div>
      <hr />
      <p i18n="Classes"></p>
      ${Object.entries(this.getClassifications()).map(([e,i])=>v`
      <div>
        <input
          type="checkbox"
          id="${i.name}"
          .checked="${!!i.visible}"
          oninput="${()=>this.toggleClassificationVisibility(i,e)}" />
        <label for="${i.name}">${i.name}</label>
      </div>
      `)}
    </div>
  </div>
</div>
`);o(this,"eraserSvgUrl",sr);o(this,"rotateSvgUrl",nr);o(this,"csvManager");o(this,"profileConfig",null);o(this,"profileManager");o(this,"visible",!1);o(this,"drawLine");o(this,"lidarInterface");o(this,"mapManager");o(this,"eventsCallbacks",[]);o(this,"isVisibleComponentSetup",!1);this.csvManager=Pi.getInstance(),this.mapManager=xt.getInstance(),this.profileManager=Xi,this.drawLine=new Kn(this.state)}connectedCallback(){this.render(),this.registerVisibilityEvents()}render(){this.visible?this.renderComponent():this.renderEmptyComponent()}isConfigLoaded(){var e;return!!((e=this.profileConfig)!=null&&e.serverConfig)}isLineDrawn(){return!!this.state.lidar.line}isDrawActive(){return this.state.lidar.drawActive}getAvailablePointAttributes(){var e,i,s;return((s=(i=(e=this.profileConfig)==null?void 0:e.clientConfig)==null?void 0:i.pointAttributes)==null?void 0:s.availableOptions)||[]}getClassifications(){var e,i;return((i=(e=this.profileConfig)==null?void 0:e.serverConfig)==null?void 0:i.classification_colors)||[]}isPointAttributeSelected(e){var s,n;const i=(n=(s=this.profileConfig)==null?void 0:s.clientConfig.pointAttributes)==null?void 0:n.selectedOption;return e===(i==null?void 0:i.name)}toggleDrawLine(){this.drawLine.setActive(!this.isDrawActive()),this.render()}exportFile(e){var i;this.isLineDrawn()&&((i=this.lidarInterface)==null||i.exportFile(e))}toggleClassificationVisibility(e,i){var s;e.visible=e.visible===0?1:0,(s=this.lidarInterface)==null||s.setClassification(e,parseInt(i))}setMeasureActive(){var e;(e=this.lidarInterface)==null||e.setMeasureActive()}clearMeasure(){var e;(e=this.lidarInterface)==null||e.clearMeasure()}resetPlot(){var e;(e=this.lidarInterface)==null||e.resetPlot()}selectPointAttribute(e){var s,n;const i=(s=e.target)==null?void 0:s.value;(n=this.lidarInterface)==null||n.selectPointAttribute(i)}renderComponent(){super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end"),this.renderComponentConfigPart()}async renderComponentConfigPart(){if(!this.isConfigLoaded()){if(!await this.initComponentConfig())return;this.render();return}this.isVisibleComponentSetup||(this.setupVisibleComponent(),this.render())}setupVisibleComponent(){this.state.selection.enabled=!1,this.registerEvents(),this.drawLine.setMap(this.mapManager.getMap()),this.drawLine.setActive(!0),this.isVisibleComponentSetup=!0}renderEmptyComponent(){var e;this.state.selection.enabled=!0,this.isVisibleComponentSetup=!1,this.drawLine.setActive(!1),this.stateManager.unsubscribe(this.eventsCallbacks),this.eventsCallbacks.length=0,(e=this.lidarInterface)==null||e.clearProfile(),this.renderEmpty()}async initComponentConfig(){const e=this.configManager.Config.lidar.url;return this.profileConfig=new Hn(e),await this.loadConfig(),await this.profileConfig.initProfileConfig(),this.profileManager.init(this.profileConfig,this.mapManager.getMap()),this.lidarInterface=new ir(this.profileConfig,this.csvManager),this.isConfigLoaded()}registerVisibilityEvents(){this.stateManager.subscribe("interface.lidarPanelVisible",(e,i)=>this.togglePanel(i))}async togglePanel(e){this.visible=e,this.render()}registerEvents(){this.eventsCallbacks.push(this.stateManager.subscribe("lidar.line",(e,i)=>{var s,n,r;e!==i&&((s=this.lidarInterface)==null||s.setLine(i),this.drawLine.setLine(i),i?(n=this.lidarInterface)==null||n.updateProfile():(r=this.lidarInterface)==null||r.clearProfile(),this.render())})),this.eventsCallbacks.push(this.stateManager.subscribe("lidar.drawActive",(e,i)=>{e===null||e===i||this.render()}))}}class ii extends P{constructor(e,i){super(e);o(this,"gutter");o(this,"hideButton");o(this,"closeButton");o(this,"dock");o(this,"prevX",0);o(this,"prevY",0);o(this,"toggleSize",0);o(this,"lastWidth",0);o(this,"minWidth");o(this,"maxWidth");o(this,"lastHeight",0);o(this,"minHeight");o(this,"maxHeight");const s=i??this.getAttribute("dock");if(!s)this.dock="right";else if(s==="left"||s==="right"||s==="bottom")this.dock=s;else throw new Error(`Invalid value for the attribute dock: ${s}. Should be one of [left, right, bottom]`)}render(){this.restoreLastDimensions(),super.render(),this.makeResizable()}makeResizable(){this.gutter=this.shadow.querySelector("#gutter"),this.gutter.onmousedown=e=>this.mousedown(e),this.gutter.ondblclick=()=>this.togglePanelInternal(),this.hideButton=this.shadow.getElementById("hide")||void 0,this.hideButton&&(this.hideButton.onclick=()=>this.togglePanelInternal()),this.closeButton=this.shadow.getElementById("close")||void 0,this.closeButton&&(this.closeButton.onclick=()=>this.closePanel()),this.toggleSize=this.dock==="bottom"?this.gutter.getBoundingClientRect().height:this.gutter.getBoundingClientRect().width,this.initSizeLimits()}initSizeLimits(){const e=getComputedStyle(this),i=parseFloat(e.minWidth);this.minWidth=isNaN(i)?void 0:i;const s=parseFloat(e.maxWidth);this.maxWidth=isNaN(s)?void 0:s;const n=parseFloat(e.minHeight);this.minHeight=isNaN(n)?void 0:n;const r=parseFloat(e.maxHeight);this.maxHeight=isNaN(r)?void 0:r}mousedown(e){e.preventDefault(),document.onmousemove=i=>this.mousemove(i),document.onmouseup=()=>this.mouseup(),this.prevX=e.x,this.prevY=e.y,this.lastWidth=parseFloat(getComputedStyle(this).width),this.lastHeight=parseFloat(getComputedStyle(this).height)}mousemove(e){e.preventDefault();const i=this.prevX-e.x,s=this.prevY-e.y;this.dock==="left"?this.resizePanelLeft(i):this.dock==="right"?this.resizePanelRight(i):this.dock==="bottom"&&this.resizePanelBottom(s)}mouseup(){document.onmouseup=null,document.onmousemove=null}closePanel(){throw new Error("This function must be overriden to close and clean the associated panel")}clean(){this.style.width="",this.style.height=""}restoreLastDimensions(){this.lastWidth&&(this.style.width=this.lastWidth+"px"),this.lastHeight&&(this.style.height=this.lastHeight+"px")}togglePanelInternal(){this.dock==="left"||this.dock==="right"?this.togglePanelVertically():this.togglePanelHorizontally()}togglePanelVertically(){const e=this.getBoundingClientRect().width;e<=this.toggleSize?(this.style.width=this.lastWidth+"px",this.style.minWidth=this.minWidth+"px",this.hideButton&&this.hideButton.classList.remove("closed")):(this.lastWidth=e,this.style.width=this.toggleSize+"px",this.style.minWidth="0",this.hideButton&&this.hideButton.classList.add("closed"))}togglePanelHorizontally(){const e=this.getBoundingClientRect().height;e<=this.toggleSize?(this.style.height=this.lastHeight+"px",this.style.minWidth=this.minHeight+"px",this.hideButton&&this.hideButton.classList.remove("closed")):(this.lastHeight=e,this.style.height=this.toggleSize+"px",this.style.minHeight="0",this.hideButton&&this.hideButton.classList.add("closed"))}getLimitedWidth(e){return this.minWidth&&e<this.minWidth?this.minWidth:this.maxWidth&&e>this.maxWidth?this.maxWidth:e}getLimitedHeight(e){return this.minHeight&&e<this.minHeight?this.minHeight:this.maxHeight&&e>this.maxHeight?this.maxHeight:e}resizePanelLeft(e){const i=this.getLimitedWidth(this.lastWidth-e);this.style.width=i+"px"}resizePanelRight(e){const i=this.getLimitedWidth(this.lastWidth+e);this.style.width=i+"px"}resizePanelBottom(e){const i=this.getLimitedHeight(this.lastHeight+e);this.style.height=i+"px"}}const or='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>';class ar extends ii{constructor(){super("lidar-profile");o(this,"template",()=>v`<style>
#panel,:host{min-height:10rem;height:16rem;background:var(--bkg-color)}#panel{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden}#gutter{border:none;height:6px;width:100%;background:var(--bkg-color);position:absolute;top:0;left:0;cursor:row-resize}#close{border:none;padding:0;margin:.5rem;width:1rem;height:1rem;position:absolute;top:0;right:0;cursor:pointer;background-color:transparent}#close svg{fill:#777}#close svg:hover{fill:#000}#content{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bkg-color);padding:0;margin:.5rem;overflow:hidden;display:flex;flex-direction:column}#gmf-lidarprofile-container{position:relative;overflow:hidden;padding:.5rem;background:var(--bkg-color);height:20rem;display:flex}#gmf-lidarprofile-container .lidarprofile{width:calc(100% - 10rem);background:var(--bkg-color)}#gmf-lidarprofile-container .lidar-legend{list-style-type:none;width:10rem;padding:.5rem}#gmf-lidarprofile-container .close{height:.62rem;cursor:pointer}#gmf-lidarprofile-container .lidar-error{visibility:hidden;position:absolute;z-index:10;margin:.5rem;padding-left:6.25rem;padding-top:6.25rem;width:calc(100% - 3.12rem - 10rem);height:calc(20rem - 3.12rem);font-size:1.5em;opacity:1;background:var(--bkg-color);color:var(--text-color)}#gmf-lidarprofile-container .lod-info{max-height:6.25rem;overflow-y:auto}.gmf-lidarprofile-automatic-width{color:var(--text-color)}.gmf-lidarprofile-chart-active main{height:calc(100% - 20rem)}.gmf-tooltip-measure{font-weight:700}
</style>
<div id="panel">
  <div id="content">
    <div id="gmf-lidarprofile-container">
      <div class="lidarprofile">
        <div class="lidar-error"></div>
        <canvas class="lidar-canvas"></canvas>
        <svg class="lidar-svg" style="fill: #ffff00; position: absolute; z-index: 1"></svg>
      </div>
      <div class="lidar-legend">
        <div class="width-info"></div>
        <div class="lod-info"></div>
        <div class="lidar-info"></div>
      </div>
    </div>
  </div>
  <div id="gutter"></div>
  <button id="close" onclick="${()=>this.closePanel()}">${this.htmlUnsafe(this.closeSvg)}</button>
</div>
`);o(this,"closeSvg",or);o(this,"visible",!1)}connectedCallback(){this.render(),this.registerVisibilityEvents()}render(){this.visible?super.render():this.renderEmpty()}closePanel(){this.state.lidar.line=null}registerVisibilityEvents(){this.stateManager.subscribe("lidar.line",(e,i)=>this.togglePanel(i))}async togglePanel(e){this.visible=!!e,this.render()}}class mt{constructor(t,e){o(this,"eventsCallbacks",[]);o(this,"togglePaths");this.stateManager=e,this.togglePaths=mt.filterValidTogglePaths(this.stateManager,t),this.initToggle(),this.watchToggle()}get state(){return this.stateManager.state}destroy(){this.stateManager.unsubscribe(this.eventsCallbacks)}toggle(t,e){this.togglePaths.filter(i=>i!==t).forEach(i=>{this.stateManager.setPropertyByPath(this.state,i,!1)}),this.stateManager.setPropertyByPath(this.state,t,e)}deactivateAll(){this.toggle(this.togglePaths[0],!1)}initToggle(){let t=!1;this.togglePaths.forEach(e=>{const i=this.stateManager.getPropertyByPath(this.state,e);t&&this.stateManager.setPropertyByPath(this.state,e,!1),i.object===!0&&(t=!0)})}watchToggle(){this.togglePaths.forEach(t=>{this.eventsCallbacks.push(this.stateManager.subscribe(t,(e,i)=>{e!=null&&e!==i&&this.toggle(t,i)}))})}static filterValidTogglePaths(t,e){return e.filter(i=>{const s=t.getPropertyByPath(t.state,i);return s.found&&(s.object===!0||s.object===!1)?!0:(console.warn(`Configured state toggle path "${i}" doesn't lead to a boolean property. Skip it.`),!1)})}}class lr extends ii{constructor(){super("lr-panel");o(this,"template",()=>v`<style>
#gutter,#panel,slot{height:100%}#panel{position:relative;background:var(--bkg-color)}#gutter{z-index:1;width:6px;height:100%;background:var(--bkg-color);position:absolute;top:0;cursor:col-resize}#panel.left #gutter{border-right:solid 1px #999;right:0}#panel.right #gutter{border-left:solid 1px #999;left:0}#close,#hide{z-index:100;border:solid 1px #999;color:var(--text-color-grad2);padding:.7rem .5rem;width:.8rem;height:2rem;line-height:2rem;position:absolute;top:1rem;background-color:var(--bkg-color);cursor:pointer}#panel.left #hide{right:-1.2rem;border-left:none;border-radius:0 10px 10px 0;padding-left:0}#panel.right #close{left:-1.2rem;border-right:none;border-radius:10px 0 0 10px;padding-right:0}#hide i:before{content:'\uf104'}#close i:before{content:'\uf00d'}#hide.closed{left:5px!important}#panel.left #hide.closed{left:5px!important}#panel.right #close.closed{right:5px!important}#hide.closed i:before{content:'\uf105'}#close:hover,#hide:hover{border-color:#000;color:var(--text-color)}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="panel">
  <div id="gutter"></div>
  <slot name="main"></slot>
  ${this.dock==="left"?v`
  <div id="hide" class="hide">
    <i class="fa-solid"></i>
  </div>
  `:v`
  <div id="close" class="close">
    <i class="fa-solid"></i>
  </div>
  `}
</div>
`);o(this,"stateToggleManager");this.render();const e=this.shadow.getElementById("panel");e==null||e.classList.add(this.dock);const i=this.retrieveTogglePaths();this.stateToggleManager=new mt(i,this.stateManager),this.showOnChildChange(i)}closePanel(){this.stateToggleManager.deactivateAll(),this.hide()}retrieveTogglePaths(){const e=this.shadow.querySelectorAll("slot")[0].assignedNodes(),i=[];for(const s of e){const n=s.dataset.togglePath;n&&i.push(n)}return mt.filterValidTogglePaths(this.stateManager,i)}showOnChildChange(e){e.forEach(i=>{this.stateManager.subscribe(i,(s,n)=>{s!==n&&(n?this.show():this.hide())})})}}const vi=0,$e=1,wi=[0,0,0,0],Le=[],Dt={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};class $t extends Zt{constructor(t,e,i){super(t),this.features=e,this.mapBrowserEvent=i}}class cr extends Kt{constructor(t){super(t),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=t.condition?t.condition:Os,this.defaultDeleteCondition_=function(i){return Hs(i)&&js(i)},this.deleteCondition_=t.deleteCondition?t.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=t.insertVertexCondition?t.insertVertexCondition:Ht,this.vertexFeature_=null,this.vertexSegments_=null,this.lastPixel_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new Ni,this.pixelTolerance_=t.pixelTolerance!==void 0?t.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new me({source:new Pe({useSpatialIndex:!1,wrapX:!!t.wrapX}),style:t.style?t.style:dr(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.hitDetection_=null;let e;if(t.features?e=t.features:t.source&&(this.source_=t.source,e=new ht(this.source_.getFeatures()),this.source_.addEventListener(dt.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(dt.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!e)throw new Error("The modify interaction requires features, a source or a layer");t.hitDetection&&(this.hitDetection_=t.hitDetection),this.features_=e,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(gt.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(gt.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=t.snapToPointer===void 0?!this.hitDetection_:t.snapToPointer}addFeature_(t){const e=t.getGeometry();if(e){const s=this.SEGMENT_WRITERS_[e.getType()];s&&s(t,e)}const i=this.getMap();i&&i.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastPixel_,i),t.addEventListener(at.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(t,e){if(!this.featuresBeingModified_){this.featuresBeingModified_=new ht;const i=this.featuresBeingModified_.getArray();for(let s=0,n=e.length;s<n;++s){const r=e[s];for(let a=0,l=r.length;a<l;++a){const h=r[a].feature;h&&!i.includes(h)&&this.featuresBeingModified_.push(h)}}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new $t(Dt.MODIFYSTART,this.featuresBeingModified_,t))}}removeFeature_(t){this.removeFeatureSegmentData_(t),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.removeEventListener(at.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(t){const e=this.rBush_,i=[];e.forEach(function(s){t===s.feature&&i.push(s)});for(let s=i.length-1;s>=0;--s){const n=i[s];for(let r=this.dragSegments_.length-1;r>=0;--r)this.dragSegments_[r][0]===n&&this.dragSegments_.splice(r,1);e.remove(n)}}setActive(t){this.vertexFeature_&&!t&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(t)}setMap(t){this.overlay_.setMap(t),super.setMap(t)}getOverlay(){return this.overlay_}handleSourceAdd_(t){t.feature&&this.features_.push(t.feature)}handleSourceRemove_(t){t.feature&&this.features_.remove(t.feature)}handleFeatureAdd_(t){this.addFeature_(t.element)}handleFeatureChange_(t){if(!this.changingFeature_){const e=t.target;this.removeFeature_(e),this.addFeature_(e)}}handleFeatureRemove_(t){this.removeFeature_(t.element)}writePointGeometry_(t,e){const i=e.getCoordinates(),s={feature:t,geometry:e,segment:[i,i]};this.rBush_.insert(e.getExtent(),s)}writeMultiPointGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s],a={feature:t,geometry:e,depth:[s],index:s,segment:[r,r]};this.rBush_.insert(e.getExtent(),a)}}writeLineStringGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length-1;s<n;++s){const r=i.slice(s,s+2),a={feature:t,geometry:e,index:s,segment:r};this.rBush_.insert(B(r),a)}}writeMultiLineStringGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length-1;a<l;++a){const h=r.slice(a,a+2),d={feature:t,geometry:e,depth:[s],index:a,segment:h};this.rBush_.insert(B(h),d)}}}writePolygonGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length-1;a<l;++a){const h=r.slice(a,a+2),d={feature:t,geometry:e,depth:[s],index:a,segment:h};this.rBush_.insert(B(h),d)}}}writeMultiPolygonGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length;a<l;++a){const h=r[a];for(let d=0,g=h.length-1;d<g;++d){const p=h.slice(d,d+2),u={feature:t,geometry:e,depth:[a,s],index:d,segment:p};this.rBush_.insert(B(p),u)}}}}writeCircleGeometry_(t,e){const i=e.getCenter(),s={feature:t,geometry:e,index:vi,segment:[i,i]},n={feature:t,geometry:e,index:$e,segment:[i,i]},r=[s,n];s.featureSegments=r,n.featureSegments=r,this.rBush_.insert(Tt(i),s);let a=e;this.rBush_.insert(a.getExtent(),n)}writeGeometryCollectionGeometry_(t,e){const i=e.getGeometriesArray();for(let s=0;s<i.length;++s){const n=i[s],r=this.SEGMENT_WRITERS_[n.getType()];r(t,n)}}createOrUpdateVertexFeature_(t,e,i){let s=this.vertexFeature_;return s?s.getGeometry().setCoordinates(t):(s=new N(new q(t)),this.vertexFeature_=s,this.overlay_.getSource().addFeature(s)),s.set("features",e),s.set("geometries",i),s}handleEvent(t){if(!t.originalEvent)return!0;this.lastPointerEvent_=t;let e;return!t.map.getView().getInteracting()&&t.type==j.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(t),this.vertexFeature_&&this.deleteCondition_(t)&&(t.type!=j.SINGLECLICK||!this.ignoreNextSingleClick_?e=this.removePoint():e=!0),t.type==j.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(t)&&!e}handleDragEvent(t){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(t,this.dragSegments_);const e=[t.coordinate[0]+this.delta_[0],t.coordinate[1]+this.delta_[1]],i=[],s=[];for(let n=0,r=this.dragSegments_.length;n<r;++n){const a=this.dragSegments_[n],l=a[0],h=l.feature;i.includes(h)||i.push(h);const d=l.geometry;s.includes(d)||s.push(d);const g=l.depth;let p;const u=l.segment,m=a[1];for(;e.length<d.getStride();)e.push(u[m][e.length]);switch(d.getType()){case"Point":p=e,u[0]=e,u[1]=e;break;case"MultiPoint":p=d.getCoordinates(),p[l.index]=e,u[0]=e,u[1]=e;break;case"LineString":p=d.getCoordinates(),p[l.index+m]=e,u[m]=e;break;case"MultiLineString":p=d.getCoordinates(),p[g[0]][l.index+m]=e,u[m]=e;break;case"Polygon":p=d.getCoordinates(),p[g[0]][l.index+m]=e,u[m]=e;break;case"MultiPolygon":p=d.getCoordinates(),p[g[1]][g[0]][l.index+m]=e,u[m]=e;break;case"Circle":if(u[0]=e,u[1]=e,l.index===vi)this.changingFeature_=!0,d.setCenter(e),this.changingFeature_=!1;else{this.changingFeature_=!0,t.map.getView().getProjection();let f=lt(I(d.getCenter()),I(e));d.setRadius(f),this.changingFeature_=!1}break}p&&this.setGeometryCoordinates_(d,p)}this.createOrUpdateVertexFeature_(e,i,s)}handleDownEvent(t){if(!this.condition_(t))return!1;const e=t.coordinate;this.handlePointerAtPixel_(t.pixel,t.map,e),this.dragSegments_.length=0,this.featuresBeingModified_=null;const i=this.vertexFeature_;if(i){t.map.getView().getProjection();const s=[],n=i.getGeometry().getCoordinates(),r=B([n]),a=this.rBush_.getInExtent(r),l={};a.sort(hr);for(let h=0,d=a.length;h<d;++h){const g=a[h],p=g.segment;let u=K(g.geometry);const m=g.depth;if(m&&(u+="-"+m.join("-")),l[u]||(l[u]=new Array(2)),g.geometry.getType()==="Circle"&&g.index===$e){const f=Ci(e,g);ge(f,n)&&!l[u][0]&&(this.dragSegments_.push([g,0]),l[u][0]=g);continue}if(ge(p[0],n)&&!l[u][0]){this.dragSegments_.push([g,0]),l[u][0]=g;continue}if(ge(p[1],n)&&!l[u][1]){if(l[u][0]&&l[u][0].index===0){let f=g.geometry.getCoordinates();switch(g.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":f=f[m[1]];case"Polygon":if(g.index!==f[m[0]].length-2)continue;break}}this.dragSegments_.push([g,1]),l[u][1]=g;continue}K(p)in this.vertexSegments_&&!l[u][0]&&!l[u][1]&&this.insertVertexCondition_(t)&&s.push(g)}s.length&&this.willModifyFeatures_(t,[s]);for(let h=s.length-1;h>=0;--h)this.insertVertex_(s[h],n)}return!!this.vertexFeature_}handleUpEvent(t){for(let e=this.dragSegments_.length-1;e>=0;--e){const i=this.dragSegments_[e][0],s=i.geometry;if(s.getType()==="Circle"){const n=s.getCenter(),r=i.featureSegments[0],a=i.featureSegments[1];r.segment[0]=n,r.segment[1]=n,a.segment[0]=n,a.segment[1]=n,this.rBush_.update(Tt(n),r);let l=s;this.rBush_.update(l.getExtent(),a)}else this.rBush_.update(B(i.segment),i)}return this.featuresBeingModified_&&(this.dispatchEvent(new $t(Dt.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null),!1}handlePointerMove_(t){this.lastPixel_=t.pixel,this.handlePointerAtPixel_(t.pixel,t.map,t.coordinate)}handlePointerAtPixel_(t,e,i){const s=i||e.getCoordinateFromPixel(t);e.getView().getProjection();const n=function(l,h){return xi(s,l)-xi(s,h)};let r,a;if(this.hitDetection_){const l=typeof this.hitDetection_=="object"?h=>h===this.hitDetection_:void 0;e.forEachFeatureAtPixel(t,(h,d,g)=>{g&&g.getType()==="Point"&&(g=new q(ut(g.getCoordinates())));const p=g||h.getGeometry();if(h instanceof N&&this.features_.getArray().includes(h)){a=p;const u=h.getGeometry().getFlatCoordinates().slice(0,2);r=[{feature:h,geometry:a,segment:[u,u]}]}return!0},{layerFilter:l})}if(!r){const l=Us(Tt(s,wi)),h=e.getView().getResolution()*this.pixelTolerance_,d=Gi(Oi(l,h,wi));r=this.rBush_.getInExtent(d)}if(r&&r.length>0){const l=r.sort(n)[0],h=l.segment;let d=Ci(s,l);const g=e.getPixelFromCoordinate(d);let p=lt(t,g);if(a||p<=this.pixelTolerance_){const u={};if(u[K(h)]=!0,this.snapToPointer_||(this.delta_[0]=d[0]-s[0],this.delta_[1]=d[1]-s[1]),l.geometry.getType()==="Circle"&&l.index===$e)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(d,[l.feature],[l.geometry]);else{const m=e.getPixelFromCoordinate(h[0]),f=e.getPixelFromCoordinate(h[1]),b=le(g,m),w=le(g,f);p=Math.sqrt(Math.min(b,w)),this.snappedToVertex_=p<=this.pixelTolerance_,this.snappedToVertex_&&(d=b>w?h[1]:h[0]),this.createOrUpdateVertexFeature_(d,[l.feature],[l.geometry]);const y={};y[K(l.geometry)]=!0;for(let k=1,C=r.length;k<C;++k){const L=r[k].segment;if(ge(h[0],L[0])&&ge(h[1],L[1])||ge(h[0],L[1])&&ge(h[1],L[0])){const M=K(r[k].geometry);M in y||(y[M]=!0,u[K(L)]=!0)}else break}}this.vertexSegments_=u;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(t,e){const i=t.segment,s=t.feature,n=t.geometry,r=t.depth,a=t.index;let l;for(;e.length<n.getStride();)e.push(0);switch(n.getType()){case"MultiLineString":l=n.getCoordinates(),l[r[0]].splice(a+1,0,e);break;case"Polygon":l=n.getCoordinates(),l[r[0]].splice(a+1,0,e);break;case"MultiPolygon":l=n.getCoordinates(),l[r[1]][r[0]].splice(a+1,0,e);break;case"LineString":l=n.getCoordinates(),l.splice(a+1,0,e);break;default:return}this.setGeometryCoordinates_(n,l);const h=this.rBush_;h.remove(t),this.updateSegmentIndices_(n,a,r,1);const d={segment:[i[0],e],feature:s,geometry:n,depth:r,index:a};h.insert(B(d.segment),d),this.dragSegments_.push([d,1]);const g={segment:[e,i[1]],feature:s,geometry:n,depth:r,index:a+1};h.insert(B(g.segment),g),this.dragSegments_.push([g,0]),this.ignoreNextSingleClick_=!0}removePoint(){if(this.lastPointerEvent_&&this.lastPointerEvent_.type!=j.POINTERDRAG){const t=this.lastPointerEvent_;this.willModifyFeatures_(t,this.dragSegments_);const e=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new $t(Dt.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null,e}return!1}removeVertex_(){const t=this.dragSegments_,e={};let i=!1,s,n,r,a,l,h,d,g,p,u,m;for(l=t.length-1;l>=0;--l)r=t[l],u=r[0],m=K(u.feature),u.depth&&(m+="-"+u.depth.join("-")),m in e||(e[m]={}),r[1]===0?(e[m].right=u,e[m].index=u.index):r[1]==1&&(e[m].left=u,e[m].index=u.index+1);for(m in e){switch(p=e[m].right,d=e[m].left,h=e[m].index,g=h-1,d!==void 0?u=d:u=p,g<0&&(g=0),a=u.geometry,n=a.getCoordinates(),s=n,i=!1,a.getType()){case"MultiLineString":n[u.depth[0]].length>2&&(n[u.depth[0]].splice(h,1),i=!0);break;case"LineString":n.length>2&&(n.splice(h,1),i=!0);break;case"MultiPolygon":s=s[u.depth[1]];case"Polygon":s=s[u.depth[0]],s.length>4&&(h==s.length-1&&(h=0),s.splice(h,1),i=!0,h===0&&(s.pop(),s.push(s[0]),g=s.length-1));break}if(i){this.setGeometryCoordinates_(a,n);const f=[];if(d!==void 0&&(this.rBush_.remove(d),f.push(d.segment[0])),p!==void 0&&(this.rBush_.remove(p),f.push(p.segment[1])),d!==void 0&&p!==void 0){const b={depth:u.depth,feature:u.feature,geometry:u.geometry,index:g,segment:f};this.rBush_.insert(B(b.segment),b)}this.updateSegmentIndices_(a,h,u.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.length=0}}return i}setGeometryCoordinates_(t,e){this.changingFeature_=!0,t.setCoordinates(e),this.changingFeature_=!1}updateSegmentIndices_(t,e,i,s){this.rBush_.forEachInExtent(t.getExtent(),function(n){n.geometry===t&&(i===void 0||n.depth===void 0||qs(n.depth,i))&&n.index>e&&(n.index+=s)})}}function hr(c,t){return c.index-t.index}function xi(c,t,e){const i=t.geometry;if(i.getType()==="Circle"){let n=i;if(t.index===$e){const r=le(n.getCenter(),I(c)),a=Math.sqrt(r)-n.getRadius();return a*a}}const s=I(c);return Le[0]=I(t.segment[0]),Le[1]=I(t.segment[1]),Ws(s,Le)}function Ci(c,t,e){const i=t.geometry;if(i.getType()==="Circle"&&t.index===$e)return ut(i.getClosestPoint(I(c)));const s=I(c);return Le[0]=I(t.segment[0]),Le[1]=I(t.segment[1]),ut(Hi(s,Le))}function dr(){const c=zi();return function(t,e){return c.Point}}const gr={SNAP:"snap"};class ur extends Zt{constructor(t,e){super(t),this.vertex=e.vertex,this.vertexPixel=e.vertexPixel,this.feature=e.feature,this.segment=e.segment}}function ki(c){return c.feature?c.feature:c.element?c.element:null}const zt=[];class pr extends Kt{constructor(t){t=t||{};const e=t;e.handleDownEvent||(e.handleDownEvent=Di),e.stopDown||(e.stopDown=Ri),super(e),this.on,this.once,this.un,this.source_=t.source?t.source:null,this.vertex_=t.vertex!==void 0?t.vertex:!0,this.edge_=t.edge!==void 0?t.edge:!0,this.features_=t.features?t.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=t.pixelTolerance!==void 0?t.pixelTolerance:10,this.rBush_=new Ni,this.GEOMETRY_SEGMENTERS_={Point:this.segmentPointGeometry_.bind(this),LineString:this.segmentLineStringGeometry_.bind(this),LinearRing:this.segmentLineStringGeometry_.bind(this),Polygon:this.segmentPolygonGeometry_.bind(this),MultiPoint:this.segmentMultiPointGeometry_.bind(this),MultiLineString:this.segmentMultiLineStringGeometry_.bind(this),MultiPolygon:this.segmentMultiPolygonGeometry_.bind(this),GeometryCollection:this.segmentGeometryCollectionGeometry_.bind(this),Circle:this.segmentCircleGeometry_.bind(this)}}addFeature(t,e){e=e!==void 0?e:!0;const i=K(t),s=t.getGeometry();if(s){const n=this.GEOMETRY_SEGMENTERS_[s.getType()];if(n){this.indexedFeaturesExtents_[i]=s.getExtent(Ys());const r=[];if(n(r,s),r.length===1)this.rBush_.insert(B(r[0]),{feature:t,segment:r[0]});else if(r.length>1){const a=r.map(h=>B(h)),l=r.map(h=>({feature:t,segment:h}));this.rBush_.load(a,l)}}}e&&(this.featureChangeListenerKeys_[i]=Fe(t,at.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let t;return this.features_?t=this.features_:this.source_&&(t=this.source_.getFeatures()),t}handleEvent(t){const e=this.snapTo(t.pixel,t.coordinate,t.map);return e&&(t.coordinate=e.vertex.slice(0,2),t.pixel=e.vertexPixel,this.dispatchEvent(new ur(gr.SNAP,{vertex:t.coordinate,vertexPixel:t.pixel,feature:e.feature,segment:e.segment}))),super.handleEvent(t)}handleFeatureAdd_(t){const e=ki(t);e&&this.addFeature(e)}handleFeatureRemove_(t){const e=ki(t);e&&this.removeFeature(e)}handleFeatureChange_(t){const e=t.target;if(this.handlingDownUpSequence){const i=K(e);i in this.pendingFeatures_||(this.pendingFeatures_[i]=e)}else this.updateFeature_(e)}handleUpEvent(t){const e=Object.values(this.pendingFeatures_);return e.length&&(e.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1}removeFeature(t,e){const i=e!==void 0?e:!0,s=K(t),n=this.indexedFeaturesExtents_[s];if(n){const r=this.rBush_,a=[];r.forEachInExtent(n,function(l){t===l.feature&&a.push(l)});for(let l=a.length-1;l>=0;--l)r.remove(a[l])}i&&(It(this.featureChangeListenerKeys_[s]),delete this.featureChangeListenerKeys_[s])}setMap(t){const e=this.getMap(),i=this.featuresListenerKeys_,s=this.getFeatures_();e&&(i.forEach(It),i.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(It),this.featureChangeListenerKeys_={}),super.setMap(t),t&&(this.features_?i.push(Fe(this.features_,gt.ADD,this.handleFeatureAdd_,this),Fe(this.features_,gt.REMOVE,this.handleFeatureRemove_,this)):this.source_&&i.push(Fe(this.source_,dt.ADDFEATURE,this.handleFeatureAdd_,this),Fe(this.source_,dt.REMOVEFEATURE,this.handleFeatureRemove_,this)),s.forEach(n=>this.addFeature(n)))}snapTo(t,e,i){i.getView().getProjection();const s=I(e),n=Gi(Oi(B([s]),i.getView().getResolution()*this.pixelTolerance_)),r=this.rBush_.getInExtent(n),a=r.length;if(a===0)return null;let l,h=1/0,d,g=null;const p=this.pixelTolerance_*this.pixelTolerance_,u=()=>{if(l){const m=i.getPixelFromCoordinate(l);if(le(t,m)<=p)return{vertex:l,vertexPixel:[Math.round(m[0]),Math.round(m[1])],feature:d,segment:g}}return null};if(this.vertex_){for(let f=0;f<a;++f){const b=r[f];b.feature.getGeometry().getType()!=="Circle"&&b.segment.forEach(w=>{const y=I(w),k=le(s,y);k<h&&(l=w,h=k,d=b.feature)})}const m=u();if(m)return m}if(this.edge_){for(let f=0;f<a;++f){let b=null;const w=r[f];if(w.feature.getGeometry().getType()==="Circle"){let y=w.feature.getGeometry();b=Xs(s,y)}else{const[y,k]=w.segment;k&&(zt[0]=I(y),zt[1]=I(k),b=Hi(s,zt))}if(b){const y=le(s,b);y<h&&(l=ut(b),g=w.feature.getGeometry().getType()==="Circle"?null:w.segment,h=y)}}const m=u();if(m)return m}return null}updateFeature_(t){this.removeFeature(t,!1),this.addFeature(t,!1)}segmentCircleGeometry_(t,e){this.getMap().getView().getProjection();const n=Qt(e).getCoordinates()[0];for(let r=0,a=n.length-1;r<a;++r)t.push(n.slice(r,r+2))}segmentGeometryCollectionGeometry_(t,e){const i=e.getGeometriesArray();for(let s=0;s<i.length;++s){const n=this.GEOMETRY_SEGMENTERS_[i[s].getType()];n&&n(t,i[s])}}segmentLineStringGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length-1;s<n;++s)t.push(i.slice(s,s+2))}segmentMultiLineStringGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length-1;a<l;++a)t.push(r.slice(a,a+2))}}segmentMultiPointGeometry_(t,e){e.getCoordinates().forEach(i=>{t.push([i])})}segmentMultiPolygonGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length;a<l;++a){const h=r[a];for(let d=0,g=h.length-1;d<g;++d)t.push(h.slice(d,d+2))}}}segmentPointGeometry_(t,e){t.push([e.getCoordinates()])}segmentPolygonGeometry_(t,e){const i=e.getCoordinates();for(let s=0,n=i.length;s<n;++s){const r=i[s];for(let a=0,l=r.length-1;a<l;++a)t.push(r.slice(a,a+2))}}}class mr extends P{constructor(){super("menubutton");o(this,"template",()=>v`<style>
.container{position:relative}.hidden{display:none}.menu-content{position:absolute;display:flex;font-size:0;background:var(--bkg-color)}.open-bottom{flex-direction:column;top:100%;left:0;border-top:solid 1px #fff;height:max-content;width:fit-content}.open-bottom-left{flex-direction:row;top:100%;right:0;border-top:solid 1px #fff;height:max-content;width:fit-content}.open-up{flex-direction:column;bottom:100%;right:0;border-bottom:solid 1px #fff;height:max-content;width:fit-content}.open-left{flex-direction:row;right:100%;bottom:0;width:max-content;height:fit-content}
</style>
<div class="container">
  <slot
    name="menu-button"
    onclick="${()=>this.toggleMenu()}"
    onkeydown="${e=>this.simulateClick(e)}"></slot>

  <div class="${this.getClass()}">
    <slot name="menu-content"></slot>
  </div>
</div>
`);o(this,"open",!1);o(this,"openDirection","bottom");o(this,"closeMenuHandler",()=>this.closeMenu(!0))}render(){this.openDirection=this.hasAttribute("open")?this.getAttribute("open"):"bottom",super.render()}listenChildButtons(){const i=this.shadow.querySelector('slot[name="menu-content"]').assignedNodes(),s=this.findAllAssignedButtons(i);for(const n of s)n.removeEventListener("click",this.closeMenuHandler),n.addEventListener("click",this.closeMenuHandler)}getClass(){return this.open?"menu-content open-"+this.openDirection:"hidden"}toggleMenu(){this.open?this.closeMenu():this.openMenu()}openMenu(){this.listenChildButtons(),this.open=!0,super.render()}closeMenu(e=!1){if(this.open=!1,e){const i=super.getParentOfType("GIRAFE-MENU-BUTTON",this.shadow.host.parentNode);i!==null&&i.toggleMenu()}super.render()}findAllAssignedButtons(e){const i=[];for(const s of e)s.nodeName==="BUTTON"&&i.push(s),s.hasChildNodes()&&i.push(...this.findAllAssignedButtons(Array.from(s.childNodes)));return i}connectedCallback(){super.loadConfig().then(()=>{this.render(),super.girafeTranslate()})}}const wt=class wt{constructor(t,e){o(this,"name");o(this,"position");if(!wt.BOOKMARKNAMEPATTERN.test(t))throw new Error("Bookmark name is not valid: it can only contain alphanumeric characters and the dash (-) underscore (_) and space characters.");this.name=t,this.position=e}};o(wt,"BOOKMARKNAMEPATTERN",/^[A-Za-zÀ-ž0-9_ -]+$/);let ft=wt;class Ki extends P{constructor(e){super("navbookmarks");o(this,"template",()=>v`<style>
.content{display:flex}input{border:solid 1px var(--bkg-color-grad1);border-radius:.25rem;background-color:var(--bkg-color);padding-left:1rem;color:var(--text-color);font-size:.9rem}button{border:none;border-right:solid 1px var(--bkg-color);width:2.3rem;height:2.3rem;line-height:2.3rem;background-color:var(--text-color-grad2);color:var(--text-color);padding:0;cursor:pointer;margin:0;display:inline-block}button:hover{background-color:var(--text-color-grad1)}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div class="content">
  <input
    id="name"
    type="text"
    placeholder="Enter name..."
    onkeydown="${e=>{e.key==="Enter"&&this.saveBookmark()}}" />

  <button tip="Add bookmark" onclick="${()=>this.saveBookmark()}">
    <i class="fa-sm fa-solid fa-check"></i>
  </button>
</div>
`);o(this,"navHelper");o(this,"nameInput",null);this.navHelper=e}render(){super.render(),this.nameInput=this.shadow.getElementById("name"),this.nameInput.focus()}saveBookmark(){if(this.nameInput)try{const e=new ft(this.nameInput.value,this.state.position);this.navHelper.addBookmark(e),this.nameInput.value=""}catch(e){alert(e)}}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate()})}}const fr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M256%2080c0-17.7-14.3-32-32-32s-32%2014.3-32%2032V224H48c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032H192V432c0%2017.7%2014.3%2032%2032%2032s32-14.3%2032-32V288H400c17.7%200%2032-14.3%2032-32s-14.3-32-32-32H256V80z'/%3e%3c/svg%3e",br="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20384%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M0%2048V487.7C0%20501.1%2010.9%20512%2024.3%20512c5%200%209.9-1.5%2014-4.4L192%20400%20345.7%20507.6c4.1%202.9%209%204.4%2014%204.4c13.4%200%2024.3-10.9%2024.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5%200%200%2021.5%200%2048z'/%3e%3c/svg%3e",yr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M438.6%20278.6c12.5-12.5%2012.5-32.8%200-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3%200s-12.5%2032.8%200%2045.3L338.8%20224%2032%20224c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032l306.7%200L233.4%20393.4c-12.5%2012.5-12.5%2032.8%200%2045.3s32.8%2012.5%2045.3%200l160-160z'/%3e%3c/svg%3e",vr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M9.4%20233.4c-12.5%2012.5-12.5%2032.8%200%2045.3l160%20160c12.5%2012.5%2032.8%2012.5%2045.3%200s12.5-32.8%200-45.3L109.2%20288%20416%20288c17.7%200%2032-14.3%2032-32s-14.3-32-32-32l-306.7%200L214.6%20118.6c12.5-12.5%2012.5-32.8%200-45.3s-32.8-12.5-45.3%200l-160%20160z'/%3e%3c/svg%3e",wr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M135.2%2017.7L128%2032H32C14.3%2032%200%2046.3%200%2064S14.3%2096%2032%2096H416c17.7%200%2032-14.3%2032-32s-14.3-32-32-32H320l-7.2-14.3C307.4%206.8%20296.3%200%20284.2%200H163.8c-12.1%200-23.2%206.8-28.6%2017.7zM416%20128H32L53.2%20467c1.6%2025.3%2022.6%2045%2047.9%2045H346.9c25.3%200%2046.3-19.7%2047.9-45L416%20128z'/%3e%3c/svg%3e";var Ge,H,z,Ee;class xr extends P{constructor(){super("navhelper");o(this,"template",()=>v`<style>
.content-horizontal{display:flex;flex-direction:row}.content-vertical{display:flex;flex-direction:column}.menu-content{display:inline-flex;flex-direction:column;width:max-content;background-color:var(--bkg-color)}.border-top{border-top:solid 1px var(--bkg-color)}.hidden{display:none}.grow{flex-grow:1}
</style><style>
.hidden{display:none}.rotate90{transform:rotate(90deg)}.rotate180{transform:rotate(180deg)}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#999}.gg-button{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.gg-button:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.gg-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.gg-small img{overflow:hidden}.gg-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.gg-check{padding:.2rem}.gg-label{text-align:left;padding-left:0;white-space:nowrap}.gg-grab:hover{cursor:grab}.gg-spacer{padding:0}.gg-opacity{opacity:.5}.gg-opacity:hover{background-color:transparent;opacity:1}.gg-selected{font-weight:700;opacity:1}.girafe-button-big,.girafe-button-large,.girafe-button-medium,.girafe-button-small,.girafe-button-tiny{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.girafe-button-big:hover,.girafe-button-large:hover,.girafe-button-medium:hover,.girafe-button-small:hover,.girafe-button-tiny:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.girafe-button-big.dark,.girafe-button-large.dark,.girafe-button-medium.dark,.girafe-button-small.dark,.girafe-button-tiny.dark{background-color:var(--bkg-color);filter:invert(1)}img{filter:var(--svg-filter)}.girafe-button-big{width:4rem;height:4rem;align-items:center;padding:1rem}.girafe-button-big img{overflow:hidden}.girafe-button-medium{flex-direction:column;width:4rem;align-items:center}.girafe-button-medium img{margin:1rem;width:1.5rem}.girafe-button-medium span{display:block;margin-top:-.8rem;margin-bottom:.8rem}.girafe-button-large{flex-direction:row}.girafe-button-large img{margin:.3rem;height:2rem}.girafe-button-large span{line-height:2rem;height:2rem;margin:.3rem}.girafe-button-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.girafe-button-small img{overflow:hidden}.girafe-button-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.girafe-button-tiny{width:1rem;height:1rem;align-items:center;padding:0}.girafe-button-tiny img{overflow:hidden}
</style>
<div class="content">
  <div class="content-horizontal">
    <div class="content-vertical">
      <button id="add-bookmark" class="girafe-button-small">
        <img alt="add-icon" src="${this.iconAdd}" />
      </button>

      <button class="girafe-button-small" onclick="${()=>this.navigateBack()}">
        <img alt="previous-icon" src="${this.iconPrevious}" />
      </button>
    </div>
    <div class="content-vertical">
      <girafe-menu-button open="bottom-left">
        <button slot="menu-button" class="girafe-button-small">
          <img alt="menu-icon" src="${this.iconBookmark}" />
        </button>

        <div slot="menu-content" class="${this.hasBookmark?"menu-content":"hidden"}">
          ${Object.values(this.bookmarks).map(e=>U(e,e.name)`
          <div class="content-horizontal">
            <button
              slot="menu-button"
              class="girafe-button-large grow"
              onclick="${()=>this.navigateToPosition(e.position)}">
              <span>${e.name}</span>
            </button>
            <button slot="menu-button" class="girafe-button-small" onclick="${()=>this.removeBookmark(e)}">
              <img alt="menu-icon" src="${this.iconTrash}" />
            </button>
          </div>
          `)}
        </div>
        <div slot="menu-content" class="${this.hasBookmark?"hidden":"menu-content"}">
          <span i18n="No bookmark">No bookmark.</span>
        </div>
      </girafe-menu-button>

      <button slot="menu-button" class="girafe-button-small" onclick="${()=>this.navigateForward()}">
        <img alt="menu-icon" src="${this.iconNext}" />
      </button>
    </div>
  </div>
</div>
`);o(this,"iconAdd",fr);o(this,"iconBookmark",br);o(this,"iconNext",yr);o(this,"iconPrevious",vr);o(this,"iconTrash",wr);be(this,Ge);be(this,H,[]);be(this,z,-1);o(this,"bookmarks",[]);o(this,"bookmarkStorage","localStorage");be(this,Ee,!1)}get hasBookmark(){return this.bookmarks.length>0}render(){super.render(),this.createBookmarkTooltip()}createBookmarkTooltip(){const e=this.shadow.getElementById("add-bookmark");de(this,Ge,pt(e,{trigger:"click",arrow:!0,interactive:!0,theme:"light",placement:"bottom",appendTo:document.body,content:i=>new Ki(this)}))}addBookmark(e){this.bookmarks.push(e),this.saveBookmarks(),super.render(),super.girafeTranslate(),_(this,Ge).hide()}removeBookmark(e){const i=this.bookmarks.indexOf(e);i>=0&&this.bookmarks.splice(i,1),this.saveBookmarks(),super.render(),super.girafeTranslate()}async saveBookmarks(){if(this.bookmarkStorage==="localStorage")localStorage.setItem("bookmarks",JSON.stringify(this.bookmarks));else if(this.bookmarkStorage==="server"){const e=this.configManager.Config.bookmarks.post,s=await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.bookmarks)})).json();console.log(s)}}async loadBookmarks(){this.bookmarks=[];let e="";if(this.bookmarkStorage==="localStorage")e=localStorage.getItem("bookmarks");else if(this.bookmarkStorage==="server"){const i=this.configManager.Config.bookmarks.get;e=await(await fetch(i)).json()}if(e){const i=JSON.parse(e);for(const s of i){const n=new ds;n.center=s.position.center,n.zoom=s.position.zoom,n.resolution=s.position.resolution,n.scale=s.position.scale,this.bookmarks.push(new ft(s.name,n))}}}registerEvents(){this.stateManager.subscribe("position",(e,i)=>this.onPositionChanged(i))}onPositionChanged(e){if(!_(this,Ee)){if(!e.isValid)return;_(this,z)!==_(this,H).length-1&&_(this,H).splice(_(this,z)+1),_(this,H).push(e),de(this,z,_(this,H).length-1)}}navigateBack(){let e=_(this,H)[_(this,z)];_(this,z)>0&&(Mt(this,z)._--,e=_(this,H)[_(this,z)],console.log("Navigating back to:",e)),this.navigateToPosition(e)}navigateForward(){let e=_(this,H)[_(this,z)];_(this,z)<_(this,H).length-1&&(Mt(this,z)._++,e=_(this,H)[_(this,z)],console.log("Navigating forward to:",e)),this.navigateToPosition(e)}navigateToPosition(e){de(this,Ee,!0);try{this.state.position=e}finally{de(this,Ee,!1)}}connectedCallback(){this.loadConfig().then(()=>{this.bookmarkStorage=this.configManager.Config.bookmarks?this.configManager.Config.bookmarks.service:"localStorage",this.loadBookmarks(),this.render(),super.girafeTranslate(),this.registerEvents()})}}Ge=new WeakMap,H=new WeakMap,z=new WeakMap,Ee=new WeakMap;const bt=(c,t)=>c.opacity===0?!1:t===void 0?!0:t>=(c.minResolution??-1)&&t<=(c.maxResolution??1/0);class yt{}o(yt,"getWMSLegendURL",(t,e,i)=>{if(!t)return;const s={FORMAT:"image/png",TRANSPARENT:!0,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetLegendGraphic",LAYER:e},n=i==null?void 0:i.scale,r=i==null?void 0:i.legendRule,a=i==null?void 0:i.legendWidth,l=i==null?void 0:i.legendHeight,h=i==null?void 0:i.serverType,d=i==null?void 0:i.dpi,g=i==null?void 0:i.bbox,p=i==null?void 0:i.srs,u=i==null?void 0:i.additionalQueryString;return n!==void 0&&(s.SCALE=n),r!==void 0&&(s.RULE=r,a!==void 0&&(s.WIDTH=a),l!==void 0&&(s.HEIGHT=l)),h=="qgis"&&(d!=null&&(s.DPI=d),g!=null&&p!=null&&n!=null&&d!=null&&r==null&&(s.BBOX=g.join(","),s.SRS=p,s.SRCWIDTH=Math.round((g[2]-g[0])/n*39.37*d),s.SRCHEIGHT=Math.round((g[3]-g[1])/n*39.37*d),delete s.SCALE)),u&&Object.assign(s,u),Ks(t,s)}),o(yt,"getWMTSLegendURL",t=>{const e=t.get("capabilitiesStyles");if(!Array.isArray(e)||e.length<=0)return;const i=e[0].LegendURL;if(!(!Array.isArray(i)||i.length<=0))return i[0].href});class Cr{constructor(){o(this,"options");o(this,"defaultOptions",{useExtent:!0,label:{},params:{},showGroupsTitle:!0})}setOptions(t){this.options={...this.defaultOptions,...t}}encodeLegend(t){this.setOptions(t);const i={classes:this.encodeLayersLegend(t.state.layers.layersList)};return i.classes.length>0?i:null}encodeLayersLegend(t){const e=[];return[...t].forEach(i=>{const s=this.encodeLayerLegendClasses(i);s&&this.addClassItemToArray(e,s)}),e}encodeLayerLegendClasses(t){return t.children?this.encodeLayerGroupLegendClasses(t):t.className===Y.name?this.encodeLayerWmsLegendClasses(t):t.className===rt.name?this.encodeLayerWmtsLegendClasses(t):null}encodeLayerGroupLegendClasses(t){var s,n;const e={};(s=this.options)!=null&&s.showGroupsTitle&&(e.name=(n=this.options)==null?void 0:n.i18nManager.getTranslation(t.name));const i=[];return e.classes=i,t.children.forEach(r=>{const a=this.encodeLayerLegendClasses(r);a&&this.addClassItemToArray(i,a)}),this.tryToSimplifyLegendGroup(e)}encodeLayerWmtsLegendClasses(t){var i,s;if(!bt(t,(i=this.options)==null?void 0:i.printResolution)||t.inactive)return null;let e=this.getMetadataLegendImage(t);if(!e&&t._olayer){const n=yt.getWMTSLegendURL(t._olayer);n&&(e={url:n,dpi:F.SCREEN_DOTS_PER_INCH})}return e?{name:(s=this.options)==null?void 0:s.i18nManager.getTranslation(t.name),icons:[e.url]}:null}encodeLayerWmsLegendClasses(t){var d,g,p,u,m,f,b;if(!bt(t,(d=this.options)==null?void 0:d.printResolution)||t.inactive)return null;const e=(g=this.options)==null?void 0:g.state.ogcServers,i=e?e[t.ogcServer.name]:void 0,s=(i==null?void 0:i.type)??"",n=((p=this.options)==null?void 0:p.dpi)??F.SCREEN_DOTS_PER_INCH,r=this.getMetadataLegendImage(t);if(r)return this.getLegendClassForWMS(t.name,r,s);const a=[],l={classes:a};if((u=this.options)!=null&&u.showGroupsTitle&&(l.name=(m=this.options)==null?void 0:m.i18nManager.getTranslation(t.name)),(((f=t.layers)==null?void 0:f.split(","))??[]).forEach(w=>{var C,L,M,T,Q;const y=yt.getWMSLegendURL(t.ogcServer.url,w,{dpi:n,serverType:s,scale:(C=this.options)==null?void 0:C.scale,bbox:(L=this.options)==null?void 0:L.extent,srs:(M=this.options)==null?void 0:M.mapManager.getMap().getView().getProjection().getCode(),additionalQueryString:(T=this.options)!=null&&T.params?(Q=this.options)==null?void 0:Q.params[s]:void 0});if(!y){console.error("Missing legend url for wms: ",t.name);return}const k={url:y,dpi:s==="qgisserver"?n:F.SCREEN_DOTS_PER_INCH};a.push(this.getLegendClassForWMS(w,k,s))}),a.length===1){const w=a[0];return delete w.classes,w.name=(b=this.options)==null?void 0:b.i18nManager.getTranslation(t.name),w}return this.tryToSimplifyLegendGroup(l)}getLegendClassForWMS(t,e,i){var n;const s={name:this.mustHideLabel(i)?"":(n=this.options)==null?void 0:n.i18nManager.getTranslation(t),icons:[e.url]};return e.dpi!==F.SCREEN_DOTS_PER_INCH&&Object.assign(s,{dpi:e.dpi}),s}getMetadataLegendImage(t){var a;let e=((a=this.options)==null?void 0:a.dpi)??-1;e===-1&&(e=F.SCREEN_DOTS_PER_INCH);let i=e,s=t.legendImage;const n=t.hiDPILegendImages;let r=Number.MAX_VALUE;if(s&&(r=Math.abs(Math.log(F.SCREEN_DOTS_PER_INCH/e)),i=F.SCREEN_DOTS_PER_INCH),n)for(const l in n){const h=parseFloat(l),d=Math.abs(Math.log(h/e));d<r&&(r=d,i=h,s=n[l])}return s?{url:s,dpi:i}:null}mustHideLabel(t){var i;const e=(i=this.options)==null?void 0:i.label;return!!e&&e[t]===!1}addClassItemToArray(t,e){e&&(!e.classes||e.classes.length>0)&&t.push(e)}tryToSimplifyLegendGroup(t){var e;return((e=t.classes)==null?void 0:e.length)===1&&t.classes[0].name===t.name?t.classes[0]:t}}class kr{constructor(){o(this,"printResolution",100);o(this,"options")}setOptions(t){this.options=t}encodeMap(t){this.setOptions(t);const e=t.mapManager,i=e.getMap().getView(),s=i.getCenter()??[0,0],n=i.getProjection().getCode(),r=ji(i.getRotation());this.printResolution=i.getResolution()||100;const a=this.getAllLayers(t.state),l=this.encodeLayers(a);return l.unshift(...this.encodeSpecialLayers(e,t.customizer)),{center:s,dpi:t.dpi,projection:n,rotation:r,scale:t.scale,layers:l}}getAllLayers(t){var s;const e=this.getFlatLayers(t.layers.layersList).filter(n=>n.active),i=((s=t.activeBasemap)==null?void 0:s.layersList)??[];return[...e,...i]}getFlatLayers(t){return t.reduce((e,i)=>{if(i.children){const s=this.getFlatLayers(i.children);e.push(...s)}else e.push(i);return e},[])}encodeSpecialLayers(t,e){return[...t.getLayersToPrint()].sort((s,n)=>{const r=s.getZIndex()??0;return(n.getZIndex()??0)-r}).map(s=>s instanceof me?new Js(s.getLayerState(),e).encodeVectorLayer(this.printResolution):null).filter(s=>s!==null)}encodeLayers(t){const e=[];for(const i of t){const s=this.encodeLayer(i);s&&(Array.isArray(s)?e.push(...s):e.push(s))}return e}encodeLayer(t){return t.className===Y.name?this.encodeImageLayer(t):t.className===rt.name?this.encodeTileWmtsLayer(t):null}encodeImageLayer(t){var d,g,p,u;if(!bt(t,(d=this.options)==null?void 0:d.printResolution))return null;let e=t.ogcServer.url;t.ogcServer.url.startsWith("//")&&(e=window.location.protocol+e);const i=new URL(e),s={TRANSPARENT:"true"};i.searchParams&&i.searchParams.forEach((m,f)=>{s[f]=m});const n=(g=this.options)==null?void 0:g.state.ogcServers[t.ogcServer.name];let r=n==null?void 0:n.type;r==="arcgis"&&(r=void 0);const a=((p=t.layers)==null?void 0:p.split(","))??[""];let l=(u=t.style)==null?void 0:u.split(",");for(l||(l=[""]);a.length>l.length;)l.push("");return{baseURL:Qs(i.origin+i.pathname),imageFormat:t.ogcServer.imageType??"image/png",layers:a,customParams:s,serverType:r,type:"wms",opacity:t.opacity,useNativeAngle:t.printNativeAngle,styles:l}}encodeTileWmtsLayer(t){var r;if(!bt(t,(r=this.options)==null?void 0:r.printResolution))return null;if(t.printLayers||t.wmsLayers){const a=this.encodeWmsFromWmtsLayer(t);if(a)return a}const e=t._olayer,i=e==null?void 0:e.getSource();if(!e||!i)return console.warn("Can not encode tile layer: ",t),null;const s=i.getDimensions(),n=Object.keys(s);return{baseURL:Zs(i),dimensions:n,dimensionParams:s,imageFormat:i.getFormat(),layer:i.getLayer(),matrices:en(i),matrixSet:i.getMatrixSet(),name:t.name,opacity:t.opacity,requestEncoding:i.getRequestEncoding(),style:i.getStyle(),type:"wmts",version:i.getVersion()}}encodeWmsFromWmtsLayer(t){if(!t.ogcServer)return console.error("Missing ogcServer"),null;const e=t.printLayers??t.wmsLayers??"",i=new Y(0,e,0,t.ogcServer,{layers:e});return i.opacity=t.opacity,this.encodeImageLayer(i)}}const Sr=c=>{c.forEach(t=>tn(t))},Lr=(c,t)=>c.getAllLayers().find(e=>e.get("name")===t),Ji=(c,t=!1)=>{const e={...c.getProperties()};return delete e.boundedBy,t||delete e[c.getGeometryName()],Object.keys(e).forEach(i=>{const s=e[i];typeof s=="object"&&(s["xsi:nil"]==="true"?e[i]=void 0:s._content_&&(e[i]=s._content_))}),e},Mr=c=>Qt(c,F.CIRCLE_TO_POLYGON_SIDES);class Si{constructor(){o(this,"legendEncoder");o(this,"encoder");o(this,"customizer");this.legendEncoder=new Cr,this.encoder=new kr,this.customizer=new sn}async requestReport(t,e){return nn(t,e)}async cancelReport(t,e){return rn(t,e)}async getDownloadUrl(t,e,i=1e3,s=3e4){return on(t,e,i,s)}encode(t){const e=t.mapManager.getMap().getView().getCenter()||[0,0];this.customizer.setPrintExtent(this.getExtent(t.pageSize,t.scale,e)||[0,0,0,0]);const s={map:this.encoder.encodeMap({state:t.state,mapManager:t.mapManager,scale:t.scale,printResolution:t.mapManager.getMap().getView().getResolution()||100,dpi:t.dpi,customizer:this.customizer})};return Object.assign(s,t.customAttributes),{attributes:s,format:t.format,layout:t.layout}}encodeLegend(t){const e=t.mapManager.getMap().getView().getCenter()||[0,0],i=this.getExtent(t.pageSize,t.scale,e)||[0,0,0,0];return t.extent=t.extent??i,this.legendEncoder.encodeLegend(t)}getExtent(t,e,i){return an(t,i,e)}static getPrintDatasourceFromSelectedFeatures(t,e,i){return t.reduce((s,n)=>{var u;const r=((u=n.getGeometry())==null?void 0:u.getExtent())??[];if(!ln(r,e))return s;const a=n.getId(),l=a===void 0?"UNKNOWN":`${a}`.split(".")[0],h=i.getTranslation(l),d=Ji(n),g=s.find(m=>m.title===h),p=Object.values(d);return g?(g.table.data.push(p),s):(s.push({title:h,table:{data:[p],columns:Object.keys(d).map(m=>i.getTranslation(m))}}),s)},[])||[]}}class _r extends cn{constructor(e={}){super({className:"printMask",...e});o(this,"context");o(this,"size",null);o(this,"scaleFn");this.context=hn(),this.context.canvas.style.opacity="0.5",this.context.canvas.style.position="absolute"}updateSize(e){this.size=e}setGetScaleFn(e){this.scaleFn=e}getRotation(){return 0}render(e){if(this.size===null)throw Error("Cannot render Mask : size has not been set.");if(!this.scaleFn)throw Error("Cannot render Mask : scaleDn has not been set.");const i=e.size[0];this.context.canvas.width=i;const s=e.size[1];this.context.canvas.height=s;const n=[i/2,s/2];this.context.beginPath(),this.context.moveTo(0,0),this.context.lineTo(i,0),this.context.lineTo(i,s),this.context.lineTo(0,s),this.context.lineTo(0,0),this.context.closePath();const r=this.size[1],a=this.size[0],l=e.viewState.resolution,h=this.scaleFn(e),d=a/F.PRINT_DOTS_PER_INCH/F.INCHES_PER_METER*h/l/2,g=r/F.PRINT_DOTS_PER_INCH/F.INCHES_PER_METER*h/l/2,p=this.getRotation!==void 0?Ui(this.getRotation()):0,u=Math.sqrt(Math.pow(d,2)+Math.pow(g,2)),m=Math.atan(g/d)-p,f=Math.atan(d/g)-p,b=n[0]-Math.cos(m)*u,w=n[1]+Math.sin(m)*u,y=n[0]+Math.sin(f)*u,k=n[1]+Math.cos(f)*u,C=n[0]+Math.cos(m)*u,L=n[1]-Math.sin(m)*u,M=n[0]-Math.sin(f)*u,T=n[1]-Math.cos(f)*u;return this.context.moveTo(b,w),this.context.lineTo(y,k),this.context.lineTo(C,L),this.context.lineTo(M,T),this.context.lineTo(b,w),this.context.closePath(),this.context.fillStyle="#000",this.context.fill(),this.context.canvas}}const Li="PrintMask",ze=class ze{constructor(t){o(this,"stateManager");o(this,"printMaskLayer",new _r({name:Li}));o(this,"map");o(this,"eventsCallbacks",[]);o(this,"possibleScales",[]);this.map=t,this.stateManager=W.getInstance(),this.printMaskLayer.setGetScaleFn(this.getScaleFn.bind(this)),this.registerEvents()}get state(){return this.stateManager.state}destroy(){this.stateManager.unsubscribe(this.eventsCallbacks),this.eventsCallbacks.length=0,this.state.print.maskVisible=!1,this.onPrintMaskVisibleChanged()}setPossibleScales(t){this.possibleScales=[...t].sort((e,i)=>i-e).reverse()}zoomToScale(t){const e=this.map.getSize()??[0,0],i=this.state.print.pageSize??[0,0],s=ze.getOptimalResolution(e,i,t);this.map.getView().setResolution(s)}registerEvents(){this.eventsCallbacks.push(this.stateManager.subscribe("print.pageSize",()=>this.onPrintFormatChanged()),this.stateManager.subscribe("print.maskVisible",()=>this.onPrintMaskVisibleChanged()))}getScaleFn(t){const e=t.size,i=t.viewState.resolution;console.assert(this.state.print.pageSize,"Can not get optimal scale without print pageSize");const s=this.state.print.pageSize??[0,0];let n=ze.getOptimalScale(e,i,s,this.possibleScales);return n<0&&(n=this.state.print.scale??1e4),this.state.print.scale=n,n}onPrintMaskVisibleChanged(){const t=Lr(this.map,Li);if(this.state.print.maskVisible&&!t){this.map.addLayer(this.printMaskLayer);return}!this.state.print.maskVisible&&t&&this.map.removeLayer(this.printMaskLayer)}onPrintFormatChanged(){this.state.print.pageSize&&(this.printMaskLayer.updateSize(this.state.print.pageSize),this.renderMask())}renderMask(){this.state.print.maskVisible&&this.printMaskLayer.changed()}static getOptimalScale(t,e,i,s){const n=t[0]*e,r=t[1]*e,a=n*F.INCHES_PER_METER*F.PRINT_DOTS_PER_INCH/i[0],l=r*F.INCHES_PER_METER*F.PRINT_DOTS_PER_INCH/i[1],h=Math.min(a,l);return s.reduce((d,g)=>h>g?g:d,-1)}};o(ze,"getOptimalResolution",(t,e,i)=>{const s=F.PRINT_DOTS_PER_INCH*F.INCHES_PER_METER,n=e[0]*i/(s*t[0]),r=e[1]*i/(s*t[1]);return Math.max(n,r)});let qt=ze;class ke extends P{constructor(){super("print");o(this,"template",()=>v`<style>
#panel{position:absolute;top:0;left:0;right:0;bottom:0;height:100%;overflow:auto;min-width:20rem}.hidden{display:none}#content{background:var(--bkg-color);padding:1.5rem;margin:0}#content .message{text-align:center;width:100%}#content .message *{margin:.25rem}#content div.option{margin-top:.5rem;display:flex;justify-content:space-between}#content #export-pdf{float:right;margin-top:1rem;height:3rem;width:8rem}#content button{background-color:var(--bkg-color);color:var(--text-color);border-radius:3px;outline:0;border:solid 1px var(--text-color);cursor:pointer}#content button:hover{background-color:var(--bkg-color-grad2)}#content #print-list{margin-top:5rem}#print-list .print-item{position:relative;padding:.5rem;margin-top:.5rem;border:solid 1px var(--text-color);color:var(--text-color)}#print-list .print-item .container{border:none;display:inline;text-align:unset;width:100%}#print-list .print-item .cancel{cursor:pointer;position:absolute;top:.5rem;right:.5rem;color:var(--text-color-grad1);border:none;background-color:transparent}.print-item .cancel i:before{content:'\uf00d'}.print-item .cancel:hover{border-color:var(--text-color);color:var(--text-color)}.print-item i.status{margin-right:1rem;float:left;width:3rem;text-align:center}.print-item:has(.success):hover{background-color:var(--bkg-color-grad2);cursor:pointer}.print-item i.status::before{line-height:3rem;display:block}.print-item p{line-height:1.3rem}.print-item p.time{position:absolute;bottom:0;right:0;margin-right:.5rem}label{color:var(--text-color);width:8rem;line-height:2.5rem;margin-right:.5rem;flex-grow:1}label~*{flex-grow:1;border-radius:3px;overflow:hidden}label:after{content:' :'}input,select,textarea{font-family:Arial,sans-serif;appearance:none;outline:0;box-shadow:none;padding:.5rem;color:var(--text-color);background-color:var(--bkg-color);border:solid 1px var(--text-color);background-image:none;cursor:pointer}textarea{height:6rem}.w-full{width:100%}.rotation{display:flex;gap:.5rem}.rotation input{appearance:auto;flex-grow:1;overflow:hidden;max-width:50%}.rotation input[type=range]{padding-left:0;padding-right:0;flex-grow:2}input[type=checkbox]{appearance:auto;flex-grow:0;max-width:6rem;overflow:visible}.select{position:relative;display:flex;width:13rem;height:2.5rem;border-radius:3px;overflow:hidden;flex-grow:1}.select select{flex-grow:1}.select::after{content:'\u25bc';position:absolute;top:0;right:0;padding:.7rem;border:solid 1px var(--text-color);border-left-width:0;color:var(--text-color);pointer-events:none}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="panel">
  <div id="content">
    <div class="${this.getRenderState()==="loading"?"":"hidden"}">
      <div class="message">
        <div i18n="Connecting to the print server, please wait."></div>
        <i class="fa-solid fa-3x fa-circle-notch fa-spin"></i>
      </div>
    </div>

    <div class="${this.getRenderState()==="error"?"":"hidden"}">
      <div class="message" i18n="The print server is unavailable. Please, try later."></div>
    </div>

    <div class="${this.getRenderState()==="setup"?"":"hidden"}">
      <div class="option">
        <label for="layout" i18n="Layout">Layout</label>
        <div class="select" onchange="${e=>this.onLayoutChanged(e)}">
          <select id="layout">
            ${this.layouts.map(e=>{var i;return v`
            <option
              i18n="${e.name}"
              ?selected="${((i=this.selectedLayout)==null?void 0:i.name)===e.name}"
              value="${e.name}">
              ${e.name}
            </option>
            `})}
          </select>
        </div>
      </div>

      <div class="option">
        <label for="scale" i18n="Scale">Scale</label>
        <div class="select" onchange="${e=>this.onScaleChanged(e)}">
          <select id="scale">
            ${this.scales.map(e=>v`
            <option ?selected="${this.getSelectedScale()===e}" value="${e}">
              <span>1&nbsp;:&nbsp;</span><span i18n="${e}" i18nFn="formatNumber">${e}</span>
            </option>
            `)}
          </select>
        </div>
      </div>

      <div class="option">
        <label for="format" i18n="Format">Format</label>
        <div class="select" onchange="${e=>this.onFormatChanged(e)}">
          <select id="format">
            ${this.printFormats.map(e=>v`
            <option ?selected="${this.getSelectedFormat()===e}" value="${e}">
              ${e.toUpperCase()}
            </option>
            `)}
          </select>
        </div>
      </div>

      ${this.dpis.length<2?null:v`
      <div class="option">
        <label for="dpi" i18n="DPI">DPI</label>
        <div class="select" onchange="${e=>this.onDpiChanged(e)}">
          <select id="dpi">
            ${this.dpis.map(e=>v`
            <option ?selected="${this.getSelectedDpi()===e}" value="${e}">${e}</option>
            `)}
          </select>
        </div>
      </div>
      `}

      <div class="option">
        <label for="rotationSlider" i18n="Rotation">Rotation</label>
        <div class="rotation">
          <input
            id="rotationSlider"
            type="range"
            min="-180"
            max="180"
            step="1"
            value="${this.getRotation()}"
            oninput="${e=>this.onInputRotationChanged(e)}" />
          <input
            id="rotationNumber"
            type="number"
            min="-180"
            max="180"
            step="1"
            value="${this.getRotation()}"
            oninput="${e=>this.onInputRotationChanged(e)}" />
        </div>
      </div>

      <!-- prettier is breaking this line because it breaks just after the return -->
      <!-- prettier-ignore -->
      ${this.attributeNames.map(e=>{var i,s,n,r;return this.getAttributeInputType(e)==="number"?v`
      <div class="option">
        <label for="${e}" i18n="${this.attrNameForI18n(e)}">${e}</label>
        <input id="${e}" type="number" value="${(i=this.getCapabilitiesAttribute(e))==null?void 0:i.default}" />
      </div>
      `:this.getAttributeInputType(e)==="checkbox"?v`
      <div class="option">
        <label for="${e}" i18n="${this.attrNameForI18n(e)}">${e}</label>
        <input id="${e}" type="checkbox" ?checked="${(s=this.getCapabilitiesAttribute(e))==null?void 0:s.default}" />
      </div>
      `:this.getAttributeInputType(e)==="textarea"?v`
      <div class="option w-full">
        <!-- prettier-ignore -->
        <textarea
          id="${e}"
          class="w-full"
          i18n="${this.attrNameForI18n(e)}"
          placeholder="${e}">${(n=this.getCapabilitiesAttribute(e))==null?void 0:n.default}</textarea>
      </div>
      `:v`
      <div class="option">
        <input
          id="${this.attrNameForI18n(e)}"
          class="w-full"
          i18n="${e}"
          placeholder="${e}"
          type="text"
          value="${(r=this.getCapabilitiesAttribute(e))==null?void 0:r.default}" />
      </div>
      `})}

      <button id="export-pdf" onclick="${()=>this.print()}" i18n="Print">Print</button>

      <div id="print-list">
        ${this.printList.map(e=>v`
        <div id="${e.id}" class="print-item" title="${e.elementTitle}">
          <button class="cancel" tabindex="0" onclick="${()=>this.onCancelPrintElementClicked(e.id)}">
            <i class="fa-solid"></i>
          </button>
          <button class="container" tabindex="0" onclick="${()=>this.onPrintElementClicked(e.id)}">
            <i class="${this.getStatusClasses(e.status)}"></i>
            <p>
              <span i18n="${e.selectedLayoutName}">${e.selectedLayoutName}</span>
              <span>(${e.selectedFormat.toUpperCase()})</span>
            </p>
            <p class="time">${e.time}</p>
          </button>
        </div>
        `)}
      </div>
    </div>
  </div>
</div>
`);o(this,"default_dpi",96);o(this,"default_scale",1e4);o(this,"default_resolution",100);o(this,"default_format","pdf");o(this,"i18nManager");o(this,"mapManager");o(this,"eventsCallbacks",[]);o(this,"eventKeys",[]);o(this,"printManager");o(this,"printList",[]);o(this,"printUrl");o(this,"capabilities");o(this,"configAttributeNames",[]);o(this,"printMaskManager");o(this,"visible",!1);o(this,"isWithCapabilitiesComponentSetup",!1);o(this,"hasErrorFetchingCapabilities",!1);o(this,"attributeNames",[]);o(this,"printFormats",[]);o(this,"layouts",[]);o(this,"selectedLayout");o(this,"scales",[]);o(this,"dpis",[]);this.mapManager=xt.getInstance(),this.i18nManager=ae.getInstance()}connectedCallback(){this.render(),this.registerVisibilityEvents()}render(){this.visible?this.renderComponent():this.renderEmptyComponent()}getRenderState(){return this.hasErrorFetchingCapabilities?"error":this.capabilities?"setup":"loading"}onLayoutChanged(e){var n;const i=(n=e.target)==null?void 0:n.value;this.selectedLayout=this.getCapabilitiesLayout(i);const s=this.getClientInfo();this.updateScales(s),this.updateDpis(s),this.updateAvailableAttributes(),this.state.print.pageSize=[s.width,s.height],this.render()}onScaleChanged(e){var i,s;this.state.print.scale=parseInt((i=e.target)==null?void 0:i.value),(s=this.printMaskManager)==null||s.zoomToScale(this.state.print.scale)}getSelectedScale(){return this.state.print.scale}getSelectedFormat(){return this.state.print.format}getSelectedDpi(){return this.state.print.dpi}onFormatChanged(e){var i;this.state.print.format=(i=e.target)==null?void 0:i.value}onDpiChanged(e){var s;const i=(s=e.target)==null?void 0:s.value;this.state.print.dpi=i?parseInt(i):this.default_dpi}getRotation(){return ji(this.mapManager.getMap().getView().getRotation())}onInputRotationChanged(e){const i=e.target;this.setRotation(i)}getCapabilitiesAttribute(e){var s;return(((s=this.selectedLayout)==null?void 0:s.attributes)??[]).find(n=>n.name===e)}getAttributeInputType(e){const i=this.getCapabilitiesAttribute(e);return(i==null?void 0:i.name)==="comments"?"textarea":(i==null?void 0:i.type)==="Number"?"number":(i==null?void 0:i.type)==="LegendAttributeValue"||(i==null?void 0:i.type)==="Boolean"?"checkbox":"text"}attrNameForI18n(e){return e==="legend"?"Legend":e}getStatusClasses(e){const i="status fa-solid fa-3x ";return e===2?i+"error fa-triangle-exclamation":e===1?i+"success fa-file-arrow-down":i+"pending fa-circle-notch fa-spin"}print(){var s,n,r;const e=this.getCustomAttributes(),i=(n=this.printManager)==null?void 0:n.encode({mapManager:this.mapManager,i18nManager:this.i18nManager,state:this.state,scale:this.getSelectedScale()??this.default_scale,printResolution:this.mapManager.getMap().getView().getResolution()??this.default_resolution,pageSize:this.state.print.pageSize??[],dpi:this.getSelectedDpi()??this.default_dpi,layout:((s=this.selectedLayout)==null?void 0:s.name)??"",format:this.getSelectedFormat()??this.default_format,customAttributes:e});if(!i){console.error("Unable to create print spec");return}(r=this.printManager)==null||r.requestReport(this.printUrl??"",i).then(a=>this.trackPrintStatus(a))}onPrintElementClicked(e){const i=this.getPrintElement(e);(i==null?void 0:i.status)===1&&window.open(i.downloadUrl,"_blank")}onCancelPrintElementClicked(e){var n;const i=this.printList.findIndex(r=>r.id===e);if(i<0)return;const s=this.printList[i];s.status===0&&((n=this.printManager)==null||n.cancelReport(this.printUrl,s.id)),this.printList.splice(i,1),this.render()}renderComponent(){super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end"),this.renderComponentCapabilitiesPart()}async renderComponentCapabilitiesPart(){var e;if(this.capabilities){this.isWithCapabilitiesComponentSetup||this.setupWithCapabilitiesComponent(),(e=this.printMaskManager)==null||e.setPossibleScales(this.scales);return}this.hasErrorFetchingCapabilities||(await this.initComponentConfig(),this.render())}setupWithCapabilitiesComponent(){var e;this.state.selection.enabled=!1,this.updateInputRotationFromMap(),this.state.print.maskVisible=!0,this.printMaskManager=new qt(this.mapManager.getMap()),(e=this.printMaskManager)==null||e.setPossibleScales(this.scales),this.setupPrintManager(),this.registerEvents(),this.isWithCapabilitiesComponentSetup=!0}renderEmptyComponent(){var e;this.state.selection.enabled=!0,this.hasErrorFetchingCapabilities=!1,this.isWithCapabilitiesComponentSetup=!1,(e=this.printMaskManager)==null||e.destroy(),Sr(this.eventKeys),this.eventKeys.length=0,this.stateManager.unsubscribe(this.eventsCallbacks),this.eventsCallbacks.length=0,this.renderEmpty()}setupPrintManager(){this.printManager||(this.printManager=new Si)}registerVisibilityEvents(){this.stateManager.subscribe("interface.printPanelVisible",(e,i)=>this.togglePanel(i))}registerEvents(){const e=this.mapManager.getMap().getView();this.eventKeys.push(e.on("change:rotation",()=>{this.updateInputRotationFromMap()})),this.eventsCallbacks.push(this.stateManager.subscribe("print.scale",(i,s)=>{const n=this.shadow.querySelector("#scale");n.value=s}))}async togglePanel(e){this.visible=e,this.render()}updateInputRotationFromMap(){const e=this.shadow.querySelector("#rotationSlider");let i=Math.round(this.getRotation());i>180&&(i-=360),i<-180&&(i+=360),this.setRotation(e,i)}setRotation(e,i=null){var a,l;const s=(a=e.parentElement)==null?void 0:a.querySelector("#rotationSlider"),n=(l=e.parentElement)==null?void 0:l.querySelector("#rotationNumber"),r=i??parseInt(e.value);s.value=`${r}`,n.value=`${r}`,i||this.mapManager.getMap().getView().setRotation(Ui(r))}getCapabilitiesUrl(){return this.printUrl+"/capabilities.json"}getPrintElement(e){return this.printList.find(i=>i.id===e)}async initComponentConfig(){await this.loadConfig(),await this.fetchCapabilities(),this.initFromCapabilities(),this.capabilities||(this.hasErrorFetchingCapabilities=!0)}async fetchCapabilities(){this.printUrl=this.configManager.Config.print.url,this.printUrl.endsWith("/")&&(this.printUrl=this.printUrl.slice(0,-1));let e;try{e=await(await fetch(this.getCapabilitiesUrl(),{referrer:""})).json()}catch(i){console.error(i)}return this.capabilities=e,e}initFromCapabilities(){var r;if(!this.capabilities)return;const e=((r=this.capabilities)==null?void 0:r.layouts)??[];if(!e.length){console.error("Can't print without any configured print layouts."),this.capabilities=void 0;return}const i=this.configManager.Config.print;this.initLayouts();const s=this.getCapabilitiesLayout(i.defaultLayout??"");this.selectedLayout=s??e[0],this.initFormats();const n=this.getClientInfo();this.updateScales(n),this.updateDpis(n),this.state.print.pageSize=[n.width,n.height],i.attributeNames&&(this.configAttributeNames=i.attributeNames),this.updateAvailableAttributes()}initFormats(){var r;const e=this.configManager.Config.print,i=e.formats;this.printFormats=ke.filterValidPrintFormats(i,(r=this.capabilities)==null?void 0:r.formats);const s=e.defaultFormat,n=ke.getValidDefaultFormat(this.printFormats,s);this.state.print.format=n??this.default_format}initLayouts(){var s;const e=(s=this.capabilities)==null?void 0:s.layouts,i=this.configManager.Config.print.layouts;this.layouts=ke.filterValidLayouts(e,i)}getCapabilitiesLayout(e){return this.layouts.find(i=>i.name===e)}updateScales(e){var i;this.scales=ke.filterValidScales(e.scales,this.configManager.Config.print.scales),(i=this.printMaskManager)==null||i.setPossibleScales(this.scales)}updateDpis(e){this.dpis=e.dpiSuggestions;const i=this.getSelectedDpi()??0;(!this.dpis.includes(i)||i>e.maxDpi)&&(this.state.print.dpi=this.dpis.length?this.dpis[0]:this.default_dpi)}updateAvailableAttributes(){var i;const e=((i=this.selectedLayout)==null?void 0:i.attributes)??[];this.attributeNames=this.configAttributeNames.filter(s=>{var n;if(e.some(r=>r.name===s))return!0;console.warn(`Configured attribute "${s}" does not exist in layout "${(n=this.selectedLayout)==null?void 0:n.name}"`)})}getClientInfo(){const e=this.getCapabilitiesAttribute("map");return e||console.error("No map client info in the current layout"),e.clientInfo}getCapabilitiesAttributeValue(e){const i=this.getCapabilitiesAttribute(e);if(!i)return"";const s=this.getAttributeInputType(e),n=this.shadow.querySelector(`#${e}`);if(s==="checkbox")return`${(n==null?void 0:n.checked)??i.default??!1}`;const r=(n==null?void 0:n.value)??i.default;return r?`${r}`:""}getCustomAttributes(){const e=this.getAttributesAndValue();if(this.getCapabilitiesAttributeValue("legend")==="true"){const i=this.encodeLegend();i&&(e.legend=i)}return this.getCapabilitiesAttribute("datasource")&&(e.datasource=this.selectedFeaturesToDatasource()),e}getAttributesAndValue(){return this.attributeNames.filter(e=>e!=="legend").reduce((e,i)=>(e[i]=this.getCapabilitiesAttributeValue(i),e),{})}encodeLegend(){var i;const e={mapManager:this.mapManager,i18nManager:this.i18nManager,state:this.state,scale:this.getSelectedScale()??this.default_scale,printResolution:this.mapManager.getMap().getView().getResolution()??this.default_resolution,pageSize:this.state.print.pageSize??[],dpi:this.getSelectedDpi()??this.default_dpi,...this.configManager.Config.print.printLegend};return((i=this.printManager)==null?void 0:i.encodeLegend(e))||null}trackPrintStatus(e){var r,a;const i=e.ref,s=new Date(Date.now()),n=pi(s.getHours(),2)+":"+pi(s.getMinutes(),2);this.printList.push({id:i,time:n,selectedFormat:this.getSelectedFormat()??this.default_format,selectedLayoutName:((r=this.selectedLayout)==null?void 0:r.name)??"",title:this.getCapabilitiesAttributeValue("title")||i,status:0}),this.render(),(a=this.printManager)==null||a.getDownloadUrl(this.printUrl??"",e,2e3).then(l=>this.printFinished(i,l)).catch(l=>this.printError(i,l))}printFinished(e,i){const s=this.getPrintElement(e);s&&(s.status=1,s.downloadUrl=i,this.render())}printError(e,i){const s=this.getPrintElement(e);s&&(s.status=2,s.elementTitle=i,this.render())}selectedFeaturesToDatasource(){var a;const e=this.mapManager.getMap().getView().getCenter()??[0,0],i=this.getSelectedScale()??-1,s=this.state.print.pageSize??[],n=((a=this.printManager)==null?void 0:a.getExtent(s,i,e))||[0,0,1/0,1/0],r=this.state.selection.selectedFeatures??[];return Si.getPrintDatasourceFromSelectedFeatures(r,n,this.i18nManager)}static filterValidPrintFormats(e,i){return e=e??[],e.filter(s=>i!=null&&i.includes(s)?!0:(console.warn(`Format ${s} is not supported.`),!1))}static getValidDefaultFormat(e,i){if(i){if(e.includes(i))return i;console.warn("Configured format does not exist: ",i)}return e.length?e[0]:void 0}static filterValidLayouts(e,i){return!i||i.length<=0?e??[]:(i.forEach(s=>{e!=null&&e.find(n=>n.name===s)||console.warn("Configured layout does not exist: ",s)}),(e==null?void 0:e.filter(s=>i.includes(s.name)))??[])}static filterValidScales(e,i){return!i||i.length<=0?e:(i.forEach(s=>{e.find(n=>n===s)&&console.warn("Configured scale does not exist: ",s)}),e==null?void 0:e.filter(s=>i.includes(s)))}}const Er=""+new URL("proj-BBBQiLl1.svg",import.meta.url).href;class Pr extends P{constructor(){super("projection");o(this,"template",()=>v`
<link rel="stylesheet" href="styles/common.css" />

<girafe-menu-button open="left">
  <button slot="menu-button" class="girafe-button-medium">
    <img alt="menu-icon" src="${this.projIcon}" />
    <span>Proj</span>
  </button>

  ${Object.entries(this.projections).map(([e,i])=>v`
  <button slot="menu-content" class="girafe-button-medium" onclick="${()=>this.changeProjection(e)}">
    <img alt="help-icon" src="${this.projIcon}" />
    <span>${i}</span></button
  >`)}
</girafe-menu-button>
`);o(this,"projIcon",Er);o(this,"projections",{})}render(){this.projections=this.configManager.Config.projections,super.render(),Object.keys(this.projections).length==1&&this.shadow.host.hide()}changeProjection(e){console.log("change projection",e),this.state.projection=e}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate()})}}class Tr extends P{constructor(){super("prototype");o(this,"template",()=>v`<style>
a{color:#fff;text-decoration:none;text-transform:uppercase}
</style>
<a href="https://doc.geomapfish.dev/" i18n="Prototype" target="_blank" rel="noopener">PROTOTYPE</a>
`)}connectedCallback(){this.render()}}class R{constructor(t,e,i,s){o(this,"property");o(this,"propertyType");o(this,"operator");o(this,"value");this.property=t,this.operator=e,this.value=i,this.propertyType=s}toOpenLayersFilter(){if(!this.propertyType)throw new Error("The type of the property should never be null !");switch(this.operator){case"eq":return this.propertyType==="string"&&He(this.value)?qe(this.property,"*"+this.value+"*"):fn(this.property,this.value);case"neq":return this.propertyType==="string"&&He(this.value)?Ft(qe(this.property,"*"+this.value+"*")):mn(this.property,this.value);case"gt":return pn(this.property,Number(this.value));case"gte":return un(this.property,Number(this.value));case"lt":return gn(this.property,Number(this.value));case"lte":return dn(this.property,Number(this.value));case"like":return qe(this.property,"*"+this.value+"*");case"nlike":return Ft(qe(this.property,"*"+this.value+"*"));case"nul":return mi(this.property);case"nnul":return Ft(mi(this.property));default:throw new Error("Unknown filter operator")}}toSimpleXmlFilter(){if(!this.propertyType)throw new Error("The type of the property should never be null !");const t=R.simpleLikeFilterGenerateWildCard(this.value);switch(this.operator){case"eq":return this.propertyType==="string"&&He(this.value)?R.simpleLikeFilter(this.property,this.value):R.simpleEqFilter(this.property,this.value);case"neq":return this.propertyType==="string"&&He(this.value)?R.simpleNlikeFilter(this.property,this.value):R.simpleNeqFilter(this.property,this.value);case"gt":return R.simpleGtFilter(this.property,this.value);case"gte":return R.simpleGteFilter(this.property,this.value);case"lt":return R.simpleLtFilter(this.property,this.value);case"lte":return R.simpleLteFilter(this.property,this.value);case"like":return R.simpleLikeFilter(this.property,t+this.value+t,t);case"nlike":return R.simpleNlikeFilter(this.property,t+this.value+t,t);case"nul":return R.simpleEqFilter(this.property,"");case"nnul":return R.simpleNeqFilter(this.property,"");default:throw new Error("Unknown filter operator")}}static simpleEqFilter(t,e){return`<Filter><PropertyIsEqualTo><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsEqualTo></Filter>`}static simpleNeqFilter(t,e){return`<Filter><Not><PropertyIsEqualTo><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsEqualTo></Not></Filter>`}static simpleLtFilter(t,e){return`<Filter><PropertyIsLessThan><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsLessThan></Filter>`}static simpleLteFilter(t,e){return`<Filter><PropertyIsLessThanOrEqualTo><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsLessThanOrEqualTo></Filter>`}static simpleGtFilter(t,e){return`<Filter><PropertyIsGreaterThan><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsGreaterThan></Filter>`}static simpleGteFilter(t,e){return`<Filter><PropertyIsGreaterThanOrEqualTo><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsGreaterThanOrEqualTo></Filter>`}static simpleInnerLikeFilter(t,e,i){return i||(i=R.simpleLikeFilterGenerateWildCard(e)),`<PropertyIsLike wildCard="${i}" singleChar="." escapeChar="!"><PropertyName>${t}</PropertyName><Literal>${e}</Literal></PropertyIsLike>`}static simpleLikeFilter(t,e,i){return"<Filter>"+this.simpleInnerLikeFilter(t,e,i)+"</Filter>"}static simpleNlikeFilter(t,e,i){return"<Filter><Not>"+this.simpleInnerLikeFilter(t,e,i)+"</Not></Filter>"}static simpleLikeFilterGenerateWildCard(t){return"WABCDEFGIJKLMNOPQRSTUVXYZ".split("").find(e=>!t.includes(e))??"*"}}class Qi extends P{constructor(e){super("querybuilder");o(this,"template",()=>v`<style>
.content{display:flex}.hidden{display:none}.loading i{margin:.8rem}.deactivated i{margin:.8rem}button{border:none;border-right:solid 1px var(--bkg-color);width:2.3rem;height:2.3rem;line-height:2.3rem;background-color:#444;color:#fff;padding:0;cursor:pointer;margin:0;display:inline-block}button:hover{background-color:#000}.custom-select{min-width:15rem;position:relative}input,select{border:solid 1px #ccc;border-radius:.25rem;background-color:#fff;padding-left:1rem;color:#000;font-size:.9rem}select{appearance:none;-webkit-appearance:none;width:100%;height:100%;cursor:pointer}.custom-select::after,.custom-select::before{content:'';position:absolute;right:1rem;pointer-events:none}.custom-select::after{border-left:.4rem solid transparent;border-right:.4rem solid transparent;border-top:.4rem solid #000;top:45%}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="wfs-filter-querybuilder">
  <div class="${this.loading?"loading":"loading hidden"}">
    <i class="fa-xl fa-solid fa-circle-notch fa-spin"></i>
    Loading server configuration...
  </div>
  <div class="${this.deactivated?"deactivated":"deactivated hidden"}">
    <i class="fa-xl fa-solid fa-xmark"></i>
    Filtering deactivated: layers in layergroup don't have identical attributes.
  </div>
  <div class="${this.loading||this.deactivated?"content hidden":"content"}">
    <div class="custom-select">
      <select id="attribute" name="attribute" onchange="${()=>this.attributeChanged()}">
        <option value="" disabled ?selected="${!this.currentLayerAttribute}">Select attribute...</option>
        ${this.layerAttributes.map(e=>{var i;return U(e,e.name)`
        <option i18n="${e.name}" value="${e.name}" ?selected="${((i=this.currentLayerAttribute)==null?void 0:i.name)==e.name}">
          ${e.name}
        </option>
        `})}
      </select>
    </div>

    <div class="custom-select">
      <select id="operator" name="operator" onchange="${()=>this.operatorChanged()}">
        <option value="" disabled selected>Select operator...</option>
        <option value="eq" class="${this.isNumber||this.isString?"":"hidden"}">equals</option>
        <option value="neq" class="${this.isNumber||this.isString?"":"hidden"}">does not equal</option>
        <option value="like" class="${this.isString?"":"hidden"}">contains</option>
        <option value="nlike" class="${this.isString?"":"hidden"}">does not contain</option>
        <option value="gt" class="${this.isNumber?"":"hidden"}">greater than</option>
        <option value="gte" class="${this.isNumber?"":"hidden"}">greater than or equal to</option>
        <option value="lt" class="${this.isNumber?"":"hidden"}">less than</option>
        <option value="lte" class="${this.isNumber?"":"hidden"}">less than or equal to</option>
        <option value="nul" class="${this.isNumber||this.isString?"":"hidden"}">is blank</option>
        <option value="nnul" class="${this.isNumber||this.isString?"":"hidden"}">is not blank</option>
      </select>
    </div>

    <input
      id="val"
      type="text"
      class="${this.showVal?"":"hidden"}"
      placeholder="Enter value..."
      onkeypress="${e=>this.onValueKeyPress(e)}" />

    <button tip="Apply filter" onclick="${()=>this.filter()}">
      <i class="fa-sm fa-solid fa-filter"></i>
    </button>

    <button tip="Remove filter" onclick="${()=>this.removeFilter()}">
      <i class="fa-sm fa-solid fa-trash"></i>
    </button>
  </div>
</div>
`);o(this,"loading",!0);o(this,"deactivated",!1);o(this,"layer");o(this,"layerAttributes",[]);o(this,"currentLayerAttribute");o(this,"showVal",!1);this.layer=e}render(){if(!this.layer.ogcServer.urlWfs)throw new Error("No WFS URL found. Please verify the Layer type.");super.render(),Ti.getInstance().getServerWfs(this.layer).then(e=>{const i=this.layer.queryLayers.split(","),s=i.map(l=>e.layers[l]),n={};for(const l of s.flat())n[l.name]===void 0&&(n[l.name]=0),n[l.name]++;const r=Object.keys(n).filter(l=>n[l]===i.length),a=s[0]?s[0].filter(l=>r.includes(l.name)):[];this.deactivated=a.length===0,this.deactivated&&console.log("Filtering for layer group "+this.layer.name+" is deactivated because the queryLayers don't have common attributes."),this.layerAttributes=a,this.loading=!1,super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end")})}get isString(){var e;return gs.includes(((e=this.currentLayerAttribute)==null?void 0:e.type)??"")}get isNumber(){var e;return us.includes(((e=this.currentLayerAttribute)==null?void 0:e.type)??"")}attributeChanged(){const e=this.shadow.getElementById("attribute"),i=this.layerAttributes.find(s=>s.name==e.value);if(!i)throw new Error("Why is this object null ? This should never happen...");this.currentLayerAttribute=i,super.render()}operatorChanged(){const e=this.shadow.getElementById("operator");this.showVal=e.value!=="nul"&&e.value!=="nnul",super.render()}onValueKeyPress(e){e.key==="Enter"&&this.filter()}getFilterElements(){const e=this.shadow.getElementById("attribute"),i=this.shadow.getElementById("operator"),s=this.shadow.getElementById("val");return[e,i,s]}getFilter(){var h;const[e,i,s]=this.getFilterElements(),n=e.value,r=i.value,a=s.value;return new R(n,r,a,(h=this.currentLayerAttribute)==null?void 0:h.type)}filter(){this.layer.filter=this.getFilter()}removeFilter(){const[e,i,s]=this.getFilterElements();this.layer.filter=void 0,e.value="",i.value="",s.value="",this.currentLayerAttribute=void 0,this.showVal=!1,super.render()}connectedCallback(){this.loadConfig().then(()=>{this.render()})}}class Ir{static getRandomName(t){return Mi[Math.floor(Math.random()*Mi.length)]+" "+t}}const Mi=["aback","abaft","abandoned","abashed","aberrant","abhorrent","abiding","abject","ablaze","able","abnormal","aboriginal","abortive","abounding","abrasive","abrupt","absent","absorbed","absorbing","abstracted","absurd","abundant","abusive","acceptable","accessible","accidental","accurate","acid","acidic","acoustic","acrid","adamant","adaptable","addicted","adhesive","adjoining","adorable","adventurous","afraid","aggressive","agonizing","agreeable","ahead","ajar","alert","alike","alive","alleged","alluring","aloof","amazing","ambiguous","ambitious","amuck","amused","amusing","ancient","angry","animated","annoyed","annoying","anxious","apathetic","aquatic","aromatic","arrogant","ashamed","aspiring","assorted","astonishing","attractive","auspicious","automatic","available","average","aware","awesome","axiomatic","bad","barbarous","bashful","bawdy","beautiful","befitting","belligerent","beneficial","bent","berserk","bewildered","big","billowy","bite-sized","bitter","bizarre","black","black-and-white","bloody","blue","blue-eyed","blushing","boiling","boorish","bored","boring","bouncy","boundless","brainy","brash","brave","brawny","breakable","breezy","brief","bright","broad","broken","brown","bumpy","burly","bustling","busy","cagey","calculating","callous","calm","capable","capricious","careful","careless","caring","cautious","ceaseless","certain","changeable","charming","cheap","cheerful","chemical","chief","childlike","chilly","chivalrous","chubby","chunky","clammy","classy","clean","clear","clever","cloistered","cloudy","closed","clumsy","cluttered","coherent","cold","colorful","colossal","combative","comfortable","common","complete","complex","concerned","condemned","confused","conscious","cooing","cool","cooperative","coordinated","courageous","cowardly","crabby","craven","crazy","creepy","crooked","crowded","cruel","cuddly","cultured","cumbersome","curious","curly","curved","curvy","cut","cute","cynical","daffy","daily","damaged","damaging","damp","dangerous","dapper","dark","dashing","dazzling","dead","deadpan","deafening","dear","debonair","decisive","decorous","deep","deeply","defeated","defective","defiant","delicate","delicious","delightful","demonic","delirious","dependent","depressed","deranged","descriptive","deserted","detailed","determined","devilish","didactic","different","difficult","diligent","direful","dirty","disagreeable","disastrous","discreet","disgusted","disgusting","disillusioned","dispensable","distinct","disturbed","divergent","dizzy","domineering","doubtful","drab","draconian","dramatic","dreary","drunk","dry","dull","dusty","dynamic","dysfunctional","eager","early","earsplitting","earthy","easy","eatable","economic","educated","efficacious","efficient","elastic","elated","elderly","electric","elegant","elfin","elite","embarrassed","eminent","empty","enchanted","enchanting","encouraging","endurable","energetic","enormous","entertaining","enthusiastic","envious","equable","equal","erect","erratic","ethereal","evanescent","evasive","even","excellent","excited","exciting","exclusive","exotic","expensive","extra-large","extra-small","exuberant","exultant","fabulous","faded","faint","fair","faithful","fallacious","false","familiar","famous","fanatical","fancy","fantastic","far","far-flung","fascinated","fast","fat","faulty","fearful","fearless","feeble","feigned","female","fertile","festive","few","fierce","filthy","fine","finicky","first","fixed","flagrant","flaky","flashy","flat","flawless","flimsy","flippant","flowery","fluffy","fluttering","foamy","foolish","foregoing","forgetful","fortunate","frail","fragile","frantic","free","freezing","frequent","fresh","fretful","friendly","frightened","frightening","full","fumbling","functional","funny","furry","furtive","future","futuristic","fuzzy","gabby","gainful","gamy","gaping","garrulous","gaudy","general","gentle","giant","giddy","gifted","gigantic","glamorous","gleaming","glib","glistening","glorious","glossy","godly","good","goofy","gorgeous","graceful","grandiose","grateful","gratis","gray","greasy","great","greedy","green","grey","grieving","groovy","grotesque","grouchy","grubby","gruesome","grumpy","guarded","guiltless","gullible","gusty","guttural","habitual","half","hallowed","halting","handsome","handy","hanging","hapless","happy","hard","hard-to-find","harmonious","harsh","hateful","heady","healthy","heartbreaking","heavenly","heavy","hellish","helpful","helpless","hesitant","hideous","high","highfalutin","high-pitched","hilarious","hissing","historical","holistic","hollow","homeless","homely","honorable","horrible","hospitable","hot","huge","hulking","humdrum","humorous","hungry","hurried","hurt","hushed","husky","hypnotic","hysterical","icky","icy","idiotic","ignorant","ill","illegal","ill-fated","ill-informed","illustrious","imaginary","immense","imminent","impartial","imperfect","impolite","important","imported","impossible","incandescent","incompetent","inconclusive","industrious","incredible","inexpensive","infamous","innate","innocent","inquisitive","insidious","instinctive","intelligent","interesting","internal","invincible","irate","irritating","itchy","jaded","jagged","jazzy","jealous","jittery","jobless","jolly","joyous","judicious","juicy","jumbled","jumpy","juvenile","keen","kind","kindhearted","kindly","knotty","knowing","knowledgeable","known","labored","lackadaisical","lacking","lame","lamentable","languid","large","last","late","laughable","lavish","lazy","lean","learned","left","legal","lethal","level","lewd","light","like","likeable","limping","literate","little","lively","living","lonely","long","longing","long-term","loose","lopsided","loud","loutish","lovely","loving","low","lowly","lucky","ludicrous","lumpy","lush","luxuriant","lying","lyrical","macabre","macho","maddening","madly","magenta","magical","magnificent","majestic","makeshift","male","malicious","mammoth","maniacal","many","marked","massive","married","marvelous","material","materialistic","mature","mean","measly","meaty","medical","meek","mellow","melodic","melted","merciful","mere","messy","mighty","military","milky","mindless","miniature","minor","miscreant","misty","mixed","moaning","modern","moldy","momentous","motionless","mountainous","muddled","mundane","murky","mushy","mute","mysterious","naive","nappy","narrow","nasty","natural","naughty","nauseating","near","neat","nebulous","necessary","needless","needy","neighborly","nervous","new","next","nice","nifty","nimble","nippy","noiseless","noisy","nonchalant","nondescript","nonstop","normal","nostalgic","nosy","noxious","numberless","numerous","nutritious","nutty","oafish","obedient","obeisant","obese","obnoxious","obscene","obsequious","observant","obsolete","obtainable","oceanic","odd","offbeat","old","old-fashioned","omniscient","onerous","open","opposite","optimal","orange","ordinary","organic","ossified","outgoing","outrageous","outstanding","oval","overconfident","overjoyed","overrated","overt","overwrought","painful","painstaking","pale","paltry","panicky","panoramic","parallel","parched","parsimonious","past","pastoral","pathetic","peaceful","penitent","perfect","periodic","permissible","perpetual","petite","phobic","physical","picayune","pink","piquant","placid","plain","plant","plastic","plausible","pleasant","plucky","pointless","poised","polite","political","poor","possessive","possible","powerful","precious","premium","present","pretty","previous","pricey","prickly","private","probable","productive","profuse","protective","proud","psychedelic","psychotic","public","puffy","pumped","puny","purple","purring","pushy","puzzled","puzzling","quaint","quarrelsome","questionable","quick","quiet","quirky","quixotic","quizzical","rabid","racial","ragged","rainy","rambunctious","rampant","rapid","rare","raspy","ratty","ready","real","rebel","receptive","recondite","red","redundant","reflective","regular","relieved","remarkable","reminiscent","repulsive","resolute","resonant","responsible","rhetorical","rich","right","righteous","rightful","rigid","ripe","ritzy","roasted","robust","romantic","roomy","rotten","rough","round","royal","ruddy","rude","rural","rustic","ruthless","sable","sad","safe","salty","same","sassy","satisfying","savory","scandalous","scarce","scared","scary","scattered","scientific","scintillating","scrawny","screeching","second","second-hand","secret","secretive","sedate","seemly","selective","selfish","separate","serious","shaggy","shaky","shallow","sharp","shiny","shivering","shocking","short","shrill","shut","shy","sick","silent","silky","silly","simple","simplistic","sincere","skillful","skinny","sleepy","slim","slimy","slippery","sloppy","slow","small","smart","smelly","smiling","smoggy","smooth","sneaky","snobbish","snotty","soft","soggy","solid","somber","sophisticated","sordid","sore","sour","sparkling","special","spectacular","spicy","spiffy","spiky","spiritual","spiteful","splendid","spooky","spotless","spotted","spotty","spurious","squalid","square","squealing","squeamish","staking","stale","standing","statuesque","steadfast","steady","steep","stereotyped","sticky","stiff","stimulating","stingy","stormy","straight","strange","striped","strong","stupendous","sturdy","subdued","subsequent","substantial","successful","succinct","sudden","sulky","super","superb","superficial","supreme","swanky","sweet","sweltering","swift","symptomatic","synonymous","taboo","tacit","tacky","talented","tall","tame","tan","tangible","tangy","tart","tasteful","tasteless","tasty","tawdry","tearful","tedious","teeny","teeny-tiny","telling","temporary","ten","tender","tense","tenuous","terrific","tested","testy","thankful","therapeutic","thick","thin","thinkable","third","thirsty","thoughtful","thoughtless","threatening","thundering","tidy","tight","tightfisted","tiny","tired","tiresome","toothsome","torpid","tough","towering","tranquil","trashy","tremendous","tricky","trite","troubled","truculent","true","truthful","typical","ubiquitous","ultra","unable","unaccountable","unadvised","unarmed","unbecoming","unbiased","uncovered","understood","undesirable","unequal","unequaled","uneven","unhealthy","uninterested","unique","unkempt","unknown","unnatural","unruly","unsightly","unsuitable","untidy","unused","unusual","unwieldy","unwritten","upbeat","uppity","upset","uptight","used","useful","useless","utopian","vacuous","vagabond","vague","valuable","various","vast","vengeful","venomous","verdant","versed","victorious","vigorous","violent","violet","vivacious","voiceless","volatile","voracious","vulgar","wacky","waggish","waiting","wakeful","wandering","wanting","warlike","warm","wary","wasteful","watery","weak","wealthy","weary","well-groomed","well-made","well-off","well-to-do","wet","whimsical","whispering","white","whole","wholesale","wicked","wide","wide-eyed","wiggly","wild","willing","windy","wiry","wise","wistful","witty","woebegone","womanly","wonderful","wooden","woozy","workable","worried","worthless","wrathful","wretched","wrong","wry","yellow","yielding","young","youthful","yummy","zany","zealous","zesty","zippy","zonked"];var x=(c=>(c[c.Point=0]="Point",c[c.Polyline=1]="Polyline",c[c.Polygon=2]="Polygon",c[c.Square=3]="Square",c[c.Rectangle=4]="Rectangle",c[c.Disk=5]="Disk",c[c.FreehandPolyline=6]="FreehandPolyline",c[c.FreehandPolygon=7]="FreehandPolygon",c))(x||{});class Fr{constructor(){o(this,"activeTool",null);o(this,"features",[])}}class V{constructor(t,e={},i=null){o(this,"_tool");o(this,"_name");o(this,"_nameColor");o(this,"_strokeColor");o(this,"_strokeWidth");o(this,"_fillColor");o(this,"_nameFontSize");o(this,"_measureFontSize");o(this,"_measureColor");o(this,"_font");o(this,"_displayName",!0);o(this,"_displayMeasure",!0);o(this,"geojson");o(this,"id",Ct());o(this,"onChange",()=>{});const s=kt.getInstance().Config.drawing;this._tool=t,this._name=i??Ir.getRandomName(x[t]),this._strokeColor=s.defaultStrokeColor,this._strokeWidth=s.defaultStrokeWidth,this._fillColor=s.defaultFillColor,this._nameFontSize=s.defaultTextSize,this._measureFontSize=s.defaultTextSize,this._font=s.defaultFont,this.geojson=e,this._nameColor="#000000",this._measureColor="#000000"}get name(){return this._name}set name(t){this._name=t,this.onChange(this)}get strokeColor(){return this._strokeColor}set strokeColor(t){this._strokeColor=t,this.onChange(this)}get strokeWidth(){return this._strokeWidth}set strokeWidth(t){this._strokeWidth=t,this.onChange(this)}get fillColor(){return this._fillColor}set fillColor(t){this._fillColor=t,this.onChange(this)}get nameFontSize(){return this._nameFontSize}set nameFontSize(t){this._nameFontSize=t,this.onChange(this)}get measureFontSize(){return this._measureFontSize}set measureFontSize(t){this._measureFontSize=t,this.onChange(this)}get font(){return this._font}set font(t){this._font=t,this.onChange(this)}get displayName(){return this._displayName}set displayName(t){this._displayName=t,this.onChange(this)}get displayMeasure(){return this._displayMeasure}set displayMeasure(t){this._displayMeasure=t,this.onChange(this)}get nameColor(){return this._nameColor}set nameColor(t){this._nameColor=t,this.onChange(this)}get measureColor(){return this._measureColor}set measureColor(t){this._measureColor=t,this.onChange(this)}get type(){return this._tool}addToState(){W.getInstance().state.extendedState.drawing.features.push(this)}serialize(){return{n:this._name,sc:this._strokeColor,sw:this._strokeWidth,fc:this._fillColor,nfz:this._nameFontSize,mfz:this._measureFontSize,f:this._font,g:this.geojson,t:this._tool,dn:this._displayName,dm:this._displayMeasure,nc:this._nameColor,mc:this._measureColor}}getLengthText(t){return this.displayMeasure?t>100?(t/1e3).toFixed(2)+" km":t.toFixed(2)+" m":""}getAreaText(t){return this.displayMeasure?t>1e4?(t/1e6).toFixed(2)+" km²":t.toFixed(2)+" m²":""}getCoordText(t){return this.displayMeasure?t.length>2?"E "+t[0].toFixed(2)+`
N `+t[1].toFixed(2)+`
H `+t[2].toFixed(2):"E "+t[0].toFixed(2)+`
N `+t[1].toFixed(2):""}isPointOrPolyline(){return this.type==0||this.type==1||this.type==6}static deserialize(t){const e=new V(t.t,t.g,t.n);return e.strokeColor=t.sc,e.strokeWidth=t.sw,e.fillColor=t.fc,e.nameFontSize=t.nfz,e.measureFontSize=t.mfz,e.font=t.f,e.geojson=t.g,e.displayName=t.dn,e.displayMeasure=t.dm,e.nameColor=t.nc,e.measureColor=t.mc,e.addToState(),e}static circleToPolygon(t,e,i=300){const s=[];for(let n=0;n<2*Math.PI;n+=2*Math.PI/i)s.push([t[0]+e*Math.cos(n),t[1]+e*Math.sin(n)]);return[...s,s[0]]}}function X(c){return new G(c).getLength()}function Qe(c){return c.getArea()}function ve(c){return new q(new G(c).getCoordinateAt(.5))}function Ze(c,t,e=1){const i=t;if(i.length>1&&c>0){const s=[i[i.length-2],i[i.length-1]];i[i.length-1]=new G(s).getCoordinateAt(c/(X(s)*e))}}class Ar{constructor(t){o(this,"map");o(this,"state");o(this,"drawingSource");o(this,"draw",null);o(this,"snap");o(this,"currentShape",null);o(this,"featuresMap",new Map);o(this,"fixedLength",0);this.map=t,this.state=W.getInstance().state,this.drawingSource=new Pe({features:new ht}),this.drawingSource.on("addfeature",e=>this.onFeatureAdded(e)),this.map.olMap.addLayer(new me({source:this.drawingSource,zIndex:1001,properties:{addToPrintedLayers:!0,altitudeMode:"clampToGround"}})),this.map.stateManager.subscribe("extendedState.drawing.activeTool",(e,i)=>i===null?this.deactivateTool():this.activateTool(i)),W.getInstance().subscribe("globe.loaded",()=>{var e;this.state.globe.loaded&&((e=this.drawingSource.getListeners("addfeature"))==null||e.forEach(i=>this.drawingSource.removeEventListener("addfeature",i)),this.drawingSource.on("addfeature",i=>this.onFeatureAdded(i)))})}addFeatures(t){t.forEach(e=>{var s;let i=(s=this.featuresMap.get(e.id))==null?void 0:s.feature;i==null&&(i=this.createOlFeature(e),this.featuresMap.set(e.id,{feature:i,shape:e.type}),this.drawingSource.addFeature(i)),e.onChange=n=>i.setStyle(this.getStyle(n,i)),e.onChange(e)})}deleteFeatures(t){t.forEach(e=>{var s;const i=(s=this.featuresMap.get(e.id))==null?void 0:s.feature;i!=null&&(this.drawingSource.removeFeature(i),this.featuresMap.delete(e.id))})}onFeatureAdded(t){if(t.feature&&this.currentShape!==null&&!Array.from(this.featuresMap.values()).map(e=>e.feature).includes(t.feature)){let e={};if(this.currentShape==x.Disk){const s=t.feature.getGeometry();e={type:"Feature",geometry:{type:"Disk",center:s.getCenter(),radius:s.getRadius()}}}else e=JSON.parse(new Ve().writeFeature(t.feature));const i=new V(this.currentShape,e);this.featuresMap.set(i.id,{feature:t.feature,shape:i.type}),i.addToState()}}createOlFeature(t){const e=t.geojson.geometry;let i;return e.type=="Disk"?i=new N(new Be(e.center,e.radius)):i=new N(new Ve().readFeatures(t.geojson)[0].getGeometry()),i.setStyle(this.getStyle(t,i)),i}setFixedLength(t){this.fixedLength=Number.isNaN(t)?0:t}createLineStringFixedLength(t,e){return Ze(this.fixedLength,t),e=e??new G(t),e.setCoordinates(t),e}createSquareFixedLength(t,e,i){return Ze(this.fixedLength,t,Math.SQRT2),Wn(4)(t,e,i)}createPolygonFixedLength(t,e){const i=t[0];return Ze(this.fixedLength,i),e=e??new Ie([i]),e.setCoordinates([i]),e}createDiskFixedLength(t,e){const i=t;return Ze(this.fixedLength,i),e=e??new Be(i[0],X(i)),e.setCenterAndRadius(i[0],X(i)),e}activateTool(t){this.deactivateTool(),this.state.selection.enabled=!1,this.currentShape=t;let e,i;switch(t){case x.Point:i="Point";break;case x.Polyline:i="LineString",e=this.createLineStringFixedLength.bind(this);break;case x.Polygon:i="Polygon",e=this.createPolygonFixedLength.bind(this);break;case x.Disk:i="Circle",e=this.createDiskFixedLength.bind(this);break;case x.Square:i="Circle",e=this.createSquareFixedLength.bind(this);break;case x.Rectangle:i="Circle",e=Yn();break;case x.FreehandPolyline:i="LineString";break;case x.FreehandPolygon:i="Polygon";break}this.draw=new Yi({source:this.drawingSource,type:i,freehand:t==x.FreehandPolyline||t==x.FreehandPolygon,geometryFunction:e,style:s=>this.getStyle(new V(t,{},""),s)}),this.map.olMap.on("dblclick",()=>{var s,n;(s=this.draw)==null||s.removeLastPoint(),(n=this.draw)==null||n.finishDrawing()}),this.map.olMap.addInteraction(this.draw),this.map.olMap.addInteraction(new cr({source:this.drawingSource})),this.snap=new pr({source:this.drawingSource}),this.map.olMap.addInteraction(this.snap)}deactivateTool(){this.state.selection.enabled=!0,this.draw&&this.map.olMap.removeInteraction(this.draw),this.snap&&this.map.olMap.removeInteraction(this.snap)}centerViewOnFeature(t){var i;const e=(i=this.featuresMap.get(t.id))==null?void 0:i.feature;e!=null&&this.map.olMap.getView().fit(e.getGeometry())}getStyle(t,e){if(t==null){const d=Array.from(this.featuresMap.values()).filter(g=>g.feature==e)[0].shape;t=new V(d,{},"")}const i=e.getGeometry(),s="Bold "+t.measureFontSize+"px/1 "+t.font,n="Bold "+t.nameFontSize+"px/1 "+t.font,r=new ce({stroke:new De({color:t.strokeColor,width:t.strokeWidth}),fill:new te({color:t.fillColor}),image:new ei({radius:t.strokeWidth,fill:new te({color:t.strokeColor})}),text:new fi({text:t.displayName?t.name:"",font:n,fill:new te({color:t.nameColor})})}),a=new ce({text:new fi({font:s,padding:[2,2,2,2],textBaseline:"bottom",offsetY:-12,fill:new te({color:t.measureColor})}),image:new jt({radius:6,points:3,angle:Math.PI,displacement:[0,8],fill:new te({color:"rgba(0, 0, 0, 0.4)"})})}),l=[r],h=(d,g)=>{if(g!=""){const p=a.clone();p.setGeometry(d),p.getText().setText(g),l.push(p)}};if(i.getType()=="LineString"&&t.type!==x.Polyline&&t.type!==x.FreehandPolyline)return[];if(t.type==x.Point||i.getType()==="Point")h(i,t.getCoordText(i.getCoordinates()));else if(t.type==x.Polyline)i.forEachSegment((d,g)=>h(ve([d,g]),t.getLengthText(X([d,g]))));else if(t.type==x.Polygon){const d=i,g=this.ensurePolygonIsProperlyClosed(d);new G(g).forEachSegment((p,u)=>h(ve([p,u]),t.getLengthText(X([p,u])))),h(d.getInteriorPoint(),t.getAreaText(Qe(d)))}else if(t.type==x.Disk){const d=i.getRadius(),g=i.getCenter(),p=[g,[g[0]+d,g[1]]],u=r.clone();u.getText().setText(""),u.setGeometry(new G(p)),l.push(u),h(ve(p),t.getLengthText(d))}else if(t.type==x.FreehandPolygon){const d=i;this.ensurePolygonIsProperlyClosed(d),h(d.getInteriorPoint(),t.getAreaText(Qe(d))),h(new q(d.getCoordinates()[0][0]),t.getLengthText(X(d.getCoordinates()[0])))}else if(t.type==x.FreehandPolyline){const d=i;h(new q(d.getCoordinates()[0]),t.getLengthText(X(d.getCoordinates())))}else if(t.type==x.Rectangle){const d=i,g=[d.getCoordinates()[0][0],d.getCoordinates()[0][1]],p=[d.getCoordinates()[0][1],d.getCoordinates()[0][2]];h(ve(g),t.getLengthText(X(g))),h(ve(p),t.getLengthText(X(p))),h(d.getInteriorPoint(),t.getAreaText(Qe(d)))}else if(t.type==x.Square){const d=i,g=[d.getCoordinates()[0][0],d.getCoordinates()[0][1]];h(ve(g),t.getLengthText(X(g))),h(d.getInteriorPoint(),t.getAreaText(Qe(d)))}return l}ensurePolygonIsProperlyClosed(t){const e=t.getCoordinates()[0];let i=[...e];return e.length>2&&e[0][0]!=e[e.length-1][0]&&(i=[...e,e[0]],t.setCoordinates([i])),i}}const Zi=ps.CLAMP_TO_GROUND;function vt(c){const t=re.fromCartesian(c),e=[ot.toDegrees(t.longitude),ot.toDegrees(t.latitude),t.height];return Re("EPSG:4326",W.getInstance().state.projection,e)}function nt(c,t){return new Ii(re.fromCartesian(c),re.fromCartesian(t)).surfaceDistance}function ee(c,t=null,e=-15,i=null){if(t==null){const s=new V(x.Point);t=s.nameFontSize+"px"+s.font}return{text:c,font:t,pixelOffset:new ms(0,e),fillColor:i??pe.fromCssColorString("#000000"),heightReference:Zi}}function Bt(c=null){return c==null&&(c=pe.fromCssColorString(new V(x.Point).strokeColor)),{color:c,pixelSize:5,heightReference:Zi}}function Vt(c){return S.divideByScalar(c.reduce((t,e)=>S.add(t,e,new S),new S),c.length,new S)}function Ae(c,t,e){return t.slice(0,-1).map((i,s)=>new $({position:S.lerp(t[s],t[s+1],.5,new S),label:ee(c.getLengthText(nt(t[s],t[s+1])),e)}))}function Nt(c){let t=0;for(let e=0;e<c.length-1;e++){const i=vt(c[e]),s=vt(c[e+1]);t+=i[0]*s[1]-s[0]*i[1]}return Math.abs(t)/2}function et(c,t){return{positions:new Ne(()=>c,!1),clampToGround:!0,width:t.strokeWidth,material:pe.fromCssColorString(t.strokeColor)}}function tt(c,t){return new $({polygon:{hierarchy:new Ne(()=>new fs(c),!1),material:pe.fromCssColorString(t.fillColor)},polyline:{positions:new Ne(()=>[...c,c[0]],!1),clampToGround:!0,width:t.strokeWidth,material:pe.fromCssColorString(t.strokeColor)}})}class Rr{constructor(t){o(this,"state");o(this,"activeShapePoints",[]);o(this,"activeShapes",[]);o(this,"floatingPoint");o(this,"scene");o(this,"handler");o(this,"entities");o(this,"fixedLength",0);this.state=W.getInstance().state,W.getInstance().subscribe("globe.loaded",()=>{this.state.globe.loaded&&(this.scene=t.map3d.getCesiumScene(),this.handler=new Cn(this.scene.canvas),this.entities=t.map3d.getDataSourceDisplay().defaultDataSource.entities,t.stateManager.subscribe("extendedState.drawing.activeTool",(e,i)=>i===null?this.deactivateTool():this.activateTool(i)))})}setFixedLength(t){this.fixedLength=Number.isNaN(t)?0:t}activateTool(t){this.state.selection.enabled=!1,this.handler.setInputAction(this.addPoint(t),ye.LEFT_CLICK),this.handler.setInputAction(this.updateShape(t),ye.MOUSE_MOVE),this.handler.setInputAction(this.removeLastPointAndTerminateShape(t),ye.LEFT_DOUBLE_CLICK),this.floatingPoint&&this.entities.remove(this.floatingPoint),this.floatingPoint=new $({position:new S,point:Bt(),label:ee("",null,-30)}),this.entities.add(this.floatingPoint)}deactivateTool(){this.state.selection.enabled=!0,this.handler.removeInputAction(ye.LEFT_CLICK),this.handler.removeInputAction(ye.MOUSE_MOVE),this.handler.removeInputAction(ye.LEFT_DOUBLE_CLICK),this.floatingPoint&&this.entities.remove(this.floatingPoint),this.floatingPoint=void 0}pickOnGlobe(t){const e=this.scene.camera.getPickRay(t);return e==null?void 0:this.scene.globe.pick(e,this.scene)}removeLastPointAndTerminateShape(t){return()=>{this.activeShapePoints=this.activeShapePoints.slice(0,-1),this.terminateShape(t)}}terminateShape(t){var n,r;const e=this.activeShapePoints.slice(0,-1),i=this.getShapes(t,e,new V(t));this.activeShapes.forEach(a=>this.entities.remove(a));const s=new V(t);if(t==x.Disk){const a=_t.WGS84.cartesianToCartographic(i[0].position.getValue(ci.now())),l=[ot.toDegrees(a.longitude),ot.toDegrees(a.latitude)];s.geojson={type:"Feature",geometry:{type:"Disk",center:Re("EPSG:4326",this.state.projection,l),radius:(r=(n=i[0].ellipse)==null?void 0:n.semiMajorAxis)==null?void 0:r.getValue(ci.now())}},s.addToState()}else{const a=new kn;a.add(i[0]),Sn({entities:a}).then(l=>{const h=new ti().readFeatures(l.kml,{dataProjection:"EPSG:4326",featureProjection:this.state.projection});s.geojson=JSON.parse(new Ve().writeFeature(h[0]));const d=s.geojson;d.geometry.type=="GeometryCollection"&&(d.geometry=d.geometry.geometries[1]),s.addToState()})}this.activeShapes=[],this.activeShapePoints=[]}fixLastLength(t,e,i){if(this.fixedLength>0&&t!=x.Rectangle){const s=t==x.Square?Math.SQRT2/2:1,n=new Ii(re.fromCartesian(i[i.length-2]),re.fromCartesian(i[i.length-1])).interpolateUsingSurfaceDistance(e*s);i[i.length-1]=re.toCartesian(n)}}updateShape(t){return e=>{var s,n;const i=this.pickOnGlobe(e.endPosition);i&&(this.activeShapes.length>0&&(t==x.FreehandPolyline||t==x.FreehandPolygon?this.activeShapePoints.push(i):(this.activeShapePoints[this.activeShapePoints.length-1]=i,this.fixLastLength(t,this.fixedLength,this.activeShapePoints)),this.activeShapes.forEach(r=>this.entities.remove(r)),this.activeShapes=this.getShapes(t,this.activeShapePoints,new V(t)),this.activeShapes.forEach(r=>this.entities.add(r))),((s=this.floatingPoint)==null?void 0:s.position).setValue(i),((n=this.floatingPoint)==null?void 0:n.label.text).setValue(new V(t).getCoordText(vt(i))))}}addPoint(t){return e=>{const i=this.pickOnGlobe(e.position);i&&(this.activeShapePoints.push(i),this.activeShapePoints.length===1&&(this.activeShapePoints.push(i),this.activeShapes=this.getShapes(t,this.activeShapePoints,new V(t)),this.activeShapes.forEach(s=>this.entities.add(s))),(t===x.Point&&this.activeShapePoints.length===2||t===x.Disk&&this.activeShapePoints.length===3||t===x.Square&&this.activeShapePoints.length===3||t===x.Rectangle&&this.activeShapePoints.length===3)&&this.terminateShape(t))}}leveledCenterToMouse(t){const e=S.normalize(t[0],new S),i=S.subtract(t[1],t[0],new S),s=-(i.x*e.x+i.y*e.y+i.z*e.z);return S.add(i,S.multiplyByScalar(e,s,new S),i)}makeRectangle(t){if(t.length<2)return[t[0],t[0],t[0],t[0]];const e=_t.WGS84.cartesianToCartographic(t[0]),i=_t.WGS84.cartesianToCartographic(t[1]),s=e.clone();s.latitude=i.latitude;const n=e.clone();return n.longitude=i.longitude,[t[0],re.toCartesian(s),t[1],re.toCartesian(n),t[0]]}makeRegularPolygon(t,e,i){if(e.equals(t))return[t];const s=this.leveledCenterToMouse([t,e]),n=S.normalize(s,new S),r=S.normalize(S.cross(t,n,new S),new S),a=S.magnitude(s),l=[];for(let h=0;h<2*Math.PI;h+=2*Math.PI/i){const d=S.multiplyByScalar(n,a*Math.cos(h),new S),g=S.multiplyByScalar(r,a*Math.sin(h),new S);l.push(S.add(t,S.add(d,g,new S),new S))}return[...l,l[0]]}getShapes(t,e,i){const s=pe.fromCssColorString(i.strokeColor),n=i.nameFontSize+"px"+i.font;e=e.map(a=>a.clone());const r=[...e,e[0]];switch(t){case x.Point:return[new $({position:e[0],point:Bt(s),label:ee(i.getCoordText(vt(e[0])),n)})];case x.Polyline:return[new $({polyline:et(e,i)}),...Ae(i,e,n)];case x.Polygon:return[tt(e,i),...Ae(i,r,n),new $({position:Vt(e),label:ee(e.length<4?"":i.getAreaText(Nt(r)),n)})];case x.FreehandPolyline:return[new $({polyline:et(e,i)}),new $({position:e[Math.ceil(e.length/2)],label:ee(i.getLengthText(e.slice(0,-1).map((a,l)=>nt(e[l],e[l+1])).reduce((a,l)=>a+l,0)),n)})];case x.FreehandPolygon:return[tt(e,i),new $({position:Vt(e),label:ee(e.length<4?"":i.getAreaText(Nt(r)),n)}),new $({position:e[Math.ceil(e.length/2)],label:ee(i.getLengthText(r.slice(0,-1).map((a,l)=>nt(r[l],r[l+1])).reduce((a,l)=>a+l,0)),n)})];case x.Disk:return[new $({position:e[0],ellipse:{semiMinorAxis:new Ne(()=>S.magnitude(this.leveledCenterToMouse(e)),!1),semiMajorAxis:new Ne(()=>S.magnitude(this.leveledCenterToMouse(e)),!1),material:pe.fromCssColorString(i.fillColor)},polyline:et(this.makeRegularPolygon(e[0],e[e.length-1],300),i),point:Bt(s)}),new $({polyline:et(r,i)}),...Ae(i,r,n)];case x.Square:{const a=this.makeRegularPolygon(e[0],e[e.length-1],4);return[tt(a,i),...a.length>=2?Ae(i,[a[0],a[1]],n):[],new $({position:e[0],label:ee(i.getAreaText(Math.pow(Math.SQRT2*nt(e[0],e[1]),2)),n)})]}case x.Rectangle:{const a=this.makeRectangle(e);return[tt(a,i),...a.length>=2?Ae(i,[a[0],a[1],a[2]],n):[],new $({position:Vt(e),label:ee(i.getAreaText(Nt(this.makeRectangle(e))),n)})]}default:throw Error(`Unrecognized tool : ${t}`)}}}const Dr='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>',$r='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M256 0c17.7 0 32 14.3 32 32V66.7C368.4 80.1 431.9 143.6 445.3 224H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H445.3C431.9 368.4 368.4 431.9 288 445.3V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V445.3C143.6 431.9 80.1 368.4 66.7 288H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H66.7C80.1 143.6 143.6 80.1 224 66.7V32c0-17.7 14.3-32 32-32zM128 256a128 128 0 1 0 256 0 128 128 0 1 0 -256 0zm128-80a80 80 0 1 1 0 160 80 80 0 1 1 0-160z"/></svg>',we='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/></svg>',it='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c8.4-19.3 10.6-41.4 4.8-63.3c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zM373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5L373 389.9z"/></svg>';function Gt(c="",t="",e="",i=()=>{}){const s=document.createElement("div");return s.id=c,s.className=t,s.innerHTML=e,s.onclick=i,s}class zr extends P{constructor(){super("drawing");o(this,"template",()=>{var e,i,s,n;return v`<style>
input{border:1px solid var(--bkg-color-grad1);width:inherit;padding-right:0;background-color:var(--bkg-color-input)}input:focus{border:1px solid var(--lt-color-gray-900)}button{border:solid 1px var(--bkg-color);color:var(--text-color);padding:0;background-color:var(--bkg-color);cursor:pointer}button:hover{border:solid 1px var(--text-color-grad2)}button.selected{border:solid 1px var(--text-color-grad2);background-color:var(--text-color-grad2);color:var(--bkg-color)}#toolbar button{height:2.4rem;width:2.4rem}.icon{width:16px;height:16px;fill:var(--text-color);margin:3px;flex-shrink:0}.icon:hover{fill:var(--text-color-grad2)}.colorPicker{border-radius:5px;border:1px solid var(--text-color)}.picker_wrapper{transform:translateX(-250px)}.picker_arrow{transform:translateX(200px) rotate(90deg) scaleX(-1)!important}.picker_arrow::after,.picker_arrow::before,.picker_wrapper{background-color:var(--bkg-color)!important}.picker_arrow::before,.picker_wrapper{box-shadow:0 0 10px 1px var(--text-color-grad1)!important}.disabled{pointer-events:none;opacity:.5}#panel{display:flex;flex-direction:column;height:100%;color:var(--text-color)}#panel>div{padding:1rem 1.5rem 1rem 1.5rem}#toolParameters{display:grid;grid-template-columns:auto auto 60px auto;align-items:center;padding-top:0;margin-top:10px}#drawingListContainer{overflow-y:auto;overflow-x:hidden;flex-grow:1}#drawingList{display:flex;flex-flow:column;gap:.15rem}#drawingList div.selected{box-shadow:0 0 3px 2px var(--text-color-grad2)}#drawingList .girafe{position:relative;display:flex;flex-wrap:wrap;align-items:center;padding:.3rem;border:solid 1px var(--text-color)}#drawingList .girafe span{flex-grow:1;padding-left:5px}#options{display:flex;flex-direction:column;box-shadow:0 -2px 3px -1px var(--text-color-grad1);position:relative;z-index:100}#optionsTitle{margin-bottom:20px;text-align:center;font-size:1.2rem}#options hr{width:100%;margin:8px}#optionsColorLine,#optionsExportLine,#optionsLineLines,#optionsTextLines{display:grid;align-items:center}#optionsText{margin:auto}#optionsTextLines{grid-template-columns:65px 40px 35px 40px 20px 25px}#optionsTextLines button:hover{border:none}#optionsColor,#optionsExport,#optionsLine{margin:auto}#optionsColorLine{grid-template-columns:77px 70px 56px 26px}#optionsLineLines{grid-template-columns:60px 40px 20px}#optionsExportLine{grid-template-columns:60px 60px 45px 45px}
</style>
<link rel="stylesheet" href="lib/font-gis/font-gis.css" />
<link rel="stylesheet" href="lib/vanilla-picker/vanilla-picker.csp.css" />
<div id="panel">
  <div id="toolbar">
    <button id="disable" tip="Disable drawing" class="selected"><i class="fg-arrow-o fg-lg"></i></button>
    <button id="point" tip="Point"><i class="fg-point fg-lg"></i></button>
    <button id="line" tip="Line"><i class="fg-polyline-pt fg-lg"></i></button>
    <button id="polygon" tip="Polygon"><i class="fg-polygon-pt fg-lg"></i></button>
    <button id="square" tip="Square"><i class="fg-square-pt fg-lg"></i></button>
    <button id="rectangle" tip="Rectangle"><i class="fg-rectangle-pt fg-lg"></i></button>
    <button id="circle" tip="Circle"><i class="fg-circle-o fg-lg"></i></button>
    <button id="freeline" tip="Freehand line"><i class="fg-polyline fg-lg"></i></button>
    <button id="freepolygon" tip="Freehand polygon"><i class="fg-polygon-o fg-lg"></i></button>
    <div id="toolParameters">
      <input type="checkbox" id="fixedLengthEnabled" />
      <label class="fixedLengthElement disabled" for="fixedLengthValue">Fix length to </label>
      <input class="fixedLengthElement disabled" type="number" id="fixedLengthValue" />
      <label class="fixedLengthElement disabled" for="fixedLengthValue">meters</label>
    </div>
  </div>
  <div id="drawingListContainer">
    <div id="drawingList"></div>
  </div>
  <div id="options" class="disabled">
    <input id="optionsTitle" type="text" value="${(e=this.curFeature)==null?void 0:e.name}" />
    <div id="optionsText">
      <div id="optionsTextLines">
        <span>Name</span>
        <button class="icon" id="visibleIconName" onclick="${()=>this.toggleNameVisibility()}"></button>
        <span>Font</span>
        <input
          id="optionsNameFontSize"
          type="number"
          min="1"
          value="${(i=this.curFeature)==null?void 0:i.nameFontSize}"
          oninput="${()=>this.onOptionsChange()}" />
        <span>pt</span>
        <div class="icon colorPicker" id="nameColorPicker"></div>
        <span>Measures</span>
        <button class="icon" id="visibleIconMeasure" onclick="${()=>this.toggleMeasureVisibility()}"></button>
        <span>Font</span>
        <input
          id="optionsMeasuresFontSize"
          type="number"
          min="1"
          value="${(s=this.curFeature)==null?void 0:s.measureFontSize}"
          oninput="${()=>this.onOptionsChange()}" />
        <span>pt</span>
        <div class="icon colorPicker" id="measureColorPicker"></div>
      </div>
    </div>
    <hr />
    <div id="optionsColor">
      <div id="optionsColorLine">
        <span>Stroke color</span>
        <div class="icon colorPicker" id="strokePicker"></div>
        <span id="fillPickerSpan">Fill color</span>
        <div class="icon colorPicker" id="fillPicker"></div>
      </div>
    </div>
    <hr />
    <div id="optionsLine">
      <div id="optionsLineLines">
        <span>Line width</span>
        <input
          id="optionsStrokeWidth"
          type="number"
          min="1"
          value="${(n=this.curFeature)==null?void 0:n.strokeWidth}"
          oninput="${()=>this.onOptionsChange()}" />
        <span>px</span>
      </div>
    </div>
    <hr />
    <div id="optionsExport">
      <div id="optionsExportLine">
        <span>Export</span>
        <button onclick='${()=>this.exportFeature(this.curFeature,"geojson")}'>GeoJson</button>
        <button onclick='${()=>this.exportFeature(this.curFeature,"kml")}'>KML</button>
        <button onclick='${()=>this.exportFeature(this.curFeature,"gpx")}'>GPX</button>
      </div>
    </div>
  </div>
</div>
`});o(this,"visible",!1);o(this,"renderedOnce",!1);o(this,"drawingState");o(this,"colorPickers",[]);o(this,"buttons",[{id:"disable",tool:null},{id:"point",tool:x.Point},{id:"line",tool:x.Polyline},{id:"square",tool:x.Square},{id:"rectangle",tool:x.Rectangle},{id:"polygon",tool:x.Polygon},{id:"circle",tool:x.Disk},{id:"freeline",tool:x.FreehandPolyline},{id:"freepolygon",tool:x.FreehandPolygon}]);o(this,"toolSelected",null);o(this,"curFeature",null);o(this,"olDrawing");o(this,"cesiumDrawing");this.state.extendedState.drawing=new Fr,this.drawingState=this.state.extendedState.drawing;const e=this.componentManager.getComponents(Fi)[0];this.olDrawing=new Ar(e),this.cesiumDrawing=new Rr(e),this.stateManager.subscribe("extendedState.drawing.features",(i,s)=>this.onFeaturesChanged(i,s)),this.stateManager.subscribe("projection",(i,s)=>this.onProjectionChanged(i,s))}render(){super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end"),this.visible?this.renderComponent():this.hide(),this.state.selection.enabled=!this.visible,this.setTool()}renderComponent(){this.show(),this.renderedOnce||(this.renderedOnce=!0,this.buttons.forEach(e=>{this.getById(e.id).addEventListener("click",()=>this.setTool(e.tool))}),this.getById("visibleIconName").innerHTML=we,this.getById("visibleIconMeasure").innerHTML=we,this.addColorPicker("nameColorPicker",e=>this.curFeature.nameColor=e.hex,()=>this.curFeature.nameColor),this.addColorPicker("measureColorPicker",e=>this.curFeature.measureColor=e.hex,()=>this.curFeature.measureColor),this.addColorPicker("fillPicker",e=>this.curFeature.fillColor=e.hex,()=>this.curFeature.fillColor),this.addColorPicker("strokePicker",e=>this.curFeature.strokeColor=e.hex,()=>this.curFeature.strokeColor),this.getById("optionsTitle").oninput=e=>{this.curFeature.name=e.target.value,this.getById("name-f-"+this.curFeature.id).innerHTML=this.curFeature.name,this.render()},this.getById("fixedLengthValue").oninput=e=>{const i=parseFloat(e.target.value);this.olDrawing.setFixedLength(i),this.cesiumDrawing.setFixedLength(i)},this.getById("fixedLengthEnabled").onchange=e=>{var s;const i=Array.from((s=this.shadowRoot)==null?void 0:s.querySelectorAll(".fixedLengthElement"));e.target.checked?(i.forEach(n=>n.classList.remove("disabled")),this.getById("fixedLengthValue").dispatchEvent(new Event("input"))):(i.forEach(n=>n.classList.add("disabled")),this.olDrawing.setFixedLength(0),this.cesiumDrawing.setFixedLength(0))})}addColorPicker(e,i,s){const n=new bn({parent:this.getById(e),popup:"top"}),r=a=>{i(a),this.getById(e).style.backgroundColor=a.hex};n.onChange=r,n.onDone=r,this.colorPickers.push([n,s])}serialize(){return this.drawingState.features.map(e=>e.serialize())}deserialize(e){e.forEach(i=>this.drawingState.features.push(V.deserialize(i)))}setTool(e=null){this.toolSelected!==null&&(this.toolSelected.className=""),this.toolSelected=this.getById(this.buttons.find(i=>i.tool==e).id),this.toolSelected.className="selected",this.drawingState.activeTool=e}connectedCallback(){this.loadConfig().then(()=>{this.render(),this.stateManager.subscribe("interface.drawingPanelVisible",(e,i)=>this.togglePanel(i))})}togglePanel(e){this.visible=e,this.render()}onFeaturesChanged(e,i){e=e??[];const s=i.map(l=>l.id),n=e.map(l=>l.id),r=e.filter(l=>!s.includes(l.id)),a=i.filter(l=>!n.includes(l.id));r.forEach(l=>this.getById("f-"+l.id).remove()),a.forEach(l=>this.addFeatureToList(l)),this.olDrawing.deleteFeatures(r),this.olDrawing.addFeatures(a)}onProjectionChanged(e,i){if(e!=null&&e!=i){const s=new Ve,n=[...this.drawingState.features];n.forEach(r=>{r.geojson=s.writeFeatureObject(s.readFeature(r.geojson,{dataProjection:e,featureProjection:i}))}),this.drawingState.features=[],this.drawingState.features=n}}addFeatureToList(e){const i=Gt("f-"+e.id,"girafe");i.onclick=()=>{this.drawingState.features.map(n=>n.id).includes(e.id)&&(Array.from(this.getById("drawingList").children).forEach(n=>n.classList.remove("selected")),i.classList.add("selected"),this.curFeature=e,this.updateOptionPanel())},i.appendChild(Gt("","icon",$r,()=>this.olDrawing.centerViewOnFeature(e)));const s=document.createElement("span");s.id="name-f-"+e.id,s.innerHTML=e.name,i.appendChild(s),i.appendChild(Gt("","icon",Dr,()=>this.deleteFeature(e))),this.getById("drawingList").appendChild(i)}updateOptionPanel(){this.curFeature!=null&&(this.getById("options").classList.remove("disabled"),this.colorPickers.forEach(e=>e[0].setColor(e[1]())),this.getById("visibleIconName").innerHTML=this.curFeature.displayName?we:it,this.getById("visibleIconMeasure").innerHTML=this.curFeature.displayMeasure?we:it,this.curFeature.isPointOrPolyline()?(this.getById("fillPickerSpan").classList.add("disabled"),this.getById("fillPicker").classList.add("disabled")):(this.getById("fillPickerSpan").classList.remove("disabled"),this.getById("fillPicker").classList.remove("disabled")),this.render())}deleteFeature(e){confirm(`Do you want to remove "${e.name}" ?`)&&(this.drawingState.features=this.drawingState.features.filter(i=>i.id!=e.id),this.curFeature=null,this.getById("options").classList.add("disabled"))}onOptionsChange(){this.curFeature!=null&&(this.curFeature.nameFontSize=parseInt(this.getById("optionsNameFontSize").value),this.curFeature.measureFontSize=parseInt(this.getById("optionsMeasuresFontSize").value),this.curFeature.strokeWidth=parseInt(this.getById("optionsStrokeWidth").value))}toggleNameVisibility(){this.curFeature!=null&&(this.curFeature.displayName=!this.curFeature.displayName,this.getById("visibleIconName").innerHTML=this.curFeature.displayName?we:it)}toggleMeasureVisibility(){this.curFeature!=null&&(this.curFeature.displayMeasure=!this.curFeature.displayMeasure,this.getById("visibleIconMeasure").innerHTML=this.curFeature.displayMeasure?we:it)}exportFeature(e,i){if(e!=null){let s=this.olDrawing.createOlFeature(e);if(e.type==x.Disk){const n=e.geojson,r=s.getStyle();s=new N(new Ie([V.circleToPolygon(n.geometry.center,n.geometry.radius)])),s.setStyle(r)}switch(i){case"geojson":return Et(JSON.stringify(new Ve().writeFeatureObject(s,{featureProjection:this.state.projection})),e.name+".geojson",".geojson");case"kml":return Et(new ti().writeFeatures([s],{featureProjection:this.state.projection}),e.name+".kml",".kml");case"gpx":return e.isPointOrPolyline()?Et(new yn().writeFeatures([s],{featureProjection:this.state.projection}),e.name+".gpx",".gpx"):this.state.infobox.elements.push({id:Ct(),text:"Warning : The GPX format only supports points and polylines",type:"warning"})}}}}class Br extends P{constructor(){super("scale");o(this,"template",()=>v`<style>
#content{background:var(--t-bkg);color:var(--text-color);width:fit-content;white-space:nowrap;padding:0 .5rem;font-size:1rem}label:after{content:':';height:2.3rem;line-height:2.3rem}span{font-weight:700;height:2.3rem;line-height:2.3rem}girafe-menu-button{display:inline-block}#container{display:inline-flex;flex-direction:column;width:max-content}
</style>
<link rel="stylesheet" href="styles/common.css" />

<div id="content">
  <label for="scale" i18n="scale">Scale</label>
  <span id="scale">${this.getFormatedScale()}</span>

  <girafe-menu-button open="up">
    <button slot="menu-button" class="girafe-button-small">
      <img alt="menu-icon" src="icons/caret-up.svg" />
    </button>

    ${this.configManager.Config.map.scales.map(e=>v`
    <button slot="menu-content" class="girafe-button-large" onclick="${()=>this.state.position.scale=e}">
      <span>${this.getFormatedScale(e)}</span></button
    >`)}
  </girafe-menu-button>
</div>
`)}render(){this.configManager.loadConfig().then(()=>{super.render()})}registerEvents(){this.stateManager.subscribe("position",()=>this.onScaleChanged())}onScaleChanged(){super.render()}getFormatedScale(e){const i=e??this.state.position.scale;return i?"1:"+Math.floor(i).toLocaleString(this.configManager.Config.general.locale):"No scale"}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}}class ue{constructor(t){o(this,"options");this.options={keepGeomProperty:!1,removeEmptyColumns:!0,...t}}toGridDataById(t){const e=t.reduce((i,s)=>this.addFeatureToGridDataById(i,s),{});return this.options.removeEmptyColumns&&Object.values(e).forEach(i=>ue.removeEmptyColumns(i)),e}addFeatureToGridDataById(t,e){const i=ue.getUserFeatureType(e),s=Ji(e,this.options.keepGeomProperty);if(!Object.keys(s).length)return t;Object.keys(t).includes(i)||(t[i]=ue.createGridDataWithColumns(s));const n=t[i];n.features.push(e),n.notOlProperties.push(s);const r=n.columns.map(a=>s[a]);return n.data.push(r),t}static createGridDataWithColumns(t){return{columns:Object.keys(t),notOlProperties:[],data:[],features:[]}}static removeEmptyColumns(t){const e=ue.findEmptyColumnIndexOf(t.data);t.columns=t.columns.filter((i,s)=>!e.includes(s)),t.data.forEach((i,s)=>{t.data[s]=t.data[s].filter((n,r)=>!e.includes(r))})}static findEmptyColumnIndexOf(t){if(!t[0])return[];const e=Array.from({length:t[0].length},(i,s)=>s);return t.forEach(i=>{const s=[];e.forEach(n=>{i[n]&&s.push(n)}),s.forEach(n=>{const r=e.findIndex(a=>a===n);e.splice(r,1)})}),e}static getUserFeatureId(t){const e=t.getId();return e===void 0?"UNKNOWN":`${e}`}static getUserFeatureType(t){const e=t.getId();if(!e)return"UNKNOWN";const i=`${e}`.split(".");return i.length<=1?`${e}`:(i.pop(),i.join("."))}}const Vr=""+new URL("center-DeU3lDk5.svg",import.meta.url).href;class Nr{constructor(){o(this,"iconCenter",Vr);o(this,"locale","")}getGeometryIcons(t,e){this.locale=e;const i=this.getGeometryIconsInfo(t);if(!i[0])return;let s=i[0];const n=i[1];return s+=`<button class="girafe-button-tiny tiny-margin"
                      tip="Pan to geometry"
                      tip-placement="right"
                      onclick="document.geogirafe.state.position.center = [${n[0]},${n[1]}]">
                <img alt="recenter-icon" src="${this.iconCenter}" />
              </button>`,s}getGeometryIconsInfo(t){return t instanceof q?this.getGeometryIconsInfoPoint(t):t instanceof $i?this.getGeometryIconsInfoMultiPoint(t):t instanceof G||t instanceof ct?this.getGeometryIconsInfoLine(t):t instanceof Ie||t instanceof Jt?this.getGeometryIconsInfoPolygon(t):t instanceof Be?this.getGeometryIconsInfoPolygon(Mr(t)):(console.error("Unknown geometry type",t==null?void 0:t.getType()),[null,null])}getGeometryIconsInfoPoint(t){let e='<i class="geo-type fg-point fg-lg"></i>';const i=t.getFlatCoordinates(),s=Ot(i,this.locale);return e+=`<span>E ${s[0]} / N ${s[1]}</span>`,[e,i]}getGeometryIconsInfoMultiPoint(t){let e='<i class="geo-type fg-multipoint fg-lg"></i>';if(t.getPoints.length===1){const s=t.getPoint(0).getFlatCoordinates(),n=Ot(s,this.locale);return e+=`<span>E ${n[0]} / N ${n[1]}</span>`,[e,s]}const i=st(t.getExtent());return e+="<span>Multipoint</span>",[e,i]}getGeometryIconsInfoLine(t){let e='<i class="geo-type fg-polyline-pt fg-lg"></i>',i;t instanceof ct?i=t.getLineStrings().reduce((r,a)=>r+a.getLength(),0):i=t.getLength();const s=(Math.round(i*100)/100).toLocaleString(this.locale,{minimumFractionDigits:2});e+=`<span>${s}&nbsp;m</span>`;const n=st(t.getExtent());return[e,n]}getGeometryIconsInfoPolygon(t){let e='<i class="geo-type fg-polygon-pt fg-lg"></i>';const i=(Math.round(t.getArea()*100)/100).toLocaleString(this.locale,{minimumFractionDigits:2});e+=`<span>${i}&nbsp;m<sup>2</sup></span>`;const s=st(t.getExtent());return[e,s]}}class Gr{constructor(){o(this,"formatGridGeomValue",new Nr);o(this,"configManager");o(this,"featureToGridData",new ue({keepGeomProperty:!0}));o(this,"idTab",{});o(this,"tabHeaders",[]);o(this,"table",null);o(this,"element","");o(this,"data",{});this.configManager=kt.getInstance()}setElement(t){this.element=t}replaceData(t){var i,s;const e=this.columnsToGridColumns(this.data[t].columns);(i=this.table)==null||i.setColumns(e),(s=this.table)==null||s.replaceData(this.data[t].notOlProperties)}activateTab(t){var i,s;(i=this.tabHeaders)==null||i.forEach(n=>n.active=!1);const e=(s=this.tabHeaders)==null?void 0:s.find(n=>n.id===t);e&&(e.active=!0)}displayGrid(t){this.element&&(this.table=new vn(this.element,{data:this.data[t].notOlProperties,columns:this.columnsToGridColumns(this.data[t].columns),selectableRows:!0,layout:"fitColumns",headerSortElement:function(e,i){switch(i){case"asc":return"<i class='fas fa-sort-up'>";case"desc":return"<i class='fas fa-sort-down'>";default:return"<i class='fas fa-sort'>"}}}))}featuresToGridData(t){this.idTab={};const e=this.featureToGridData.toGridDataById(t);Object.keys(e).forEach(i=>this.gridDataToGridTab(i,e[i])),this.tabHeaders=Object.keys(this.idTab).map(i=>({id:i,text:ae.getInstance().getTranslation(i),active:!1})),this.data=this.filterEmptyColumnsOnData(e)}gridDataToGridTab(t,e){t in this.idTab||(this.idTab[t]={columns:e.columns.map(i=>this.createGridColumn(i)),data:e.data.map(i=>this.createGridData(i)),features:e.features})}columnsToGridColumns(t){const e=[];return t.map(i=>e.push({title:ae.getInstance().getTranslation(i),field:i,formatter:"html"})),e.forEach(i=>{(i.field==="the_geom"||i.field==="geom"||i.field==="geometry")&&(i.formatter=s=>this.formatGridGeomValue.getGeometryIcons(s.getValue(),this.getLocale())??s.getValue())}),e}filterEmptyColumnsOnData(t){for(const[e,i]of Object.entries(t)){const s=i.columns,n=i.notOlProperties;for(const[r,a]of Object.entries(n))for(const[l,h]of Object.entries(a))s.some(d=>d===l)||delete a[l]}return t}createGridColumn(t){return{id:t,name:ae.getInstance().getTranslation(t)}}createGridData(t){return t.map(e=>e instanceof wn?this.formatGridGeomValue.getGeometryIcons(e,this.getLocale()):e)}getLocale(){return this.configManager.Config.general.locale}}class Or extends ii{constructor(){super("selectiongrid");o(this,"template",()=>v`<style>
#panel,:host{min-height:10rem;height:16rem;background:var(--bkg-color)}#panel{top:0;left:0;right:0;bottom:0;overflow:hidden}#gutter{border:none;height:6px;width:100%;background:var(--bkg-color);position:absolute;top:0;left:0;cursor:row-resize}#close{border:none;color:#777;padding:0;margin:.5rem;width:1rem;height:1rem;line-height:1rem;position:absolute;top:0;right:0;background-color:var(--bkg-color);cursor:pointer}#close i:before{content:'\uf00d'}#close:hover{border-color:#000;color:#000}#content{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bkg-color);padding:0;margin:.5rem;overflow:hidden;display:flex;flex-direction:column}#header{flex:0;display:flex}.tab{border:solid 1px #ccc;display:inline-block;height:2rem;line-height:2rem;padding:0 1rem;margin-right:.2rem;margin-bottom:.2rem;cursor:pointer;background-color:var(--bkg-color-grad2)}.tab.active{color:var(--text-color);background-color:var(--bkg-color)}#grid{overflow:hidden;flex:1}.geo-type{margin-right:.5rem}button{float:right;margin-left:.5rem}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-thumb{background:#999}.tiny-margin{margin:.1rem}.tabulator-col[aria-sort=none] .tabulator-col-sorter i{color:#999}.tabulator-col[aria-sort=asc] .tabulator-col-sorter i{color:red}.tabulator-col[aria-sort=desc] .tabulator-col-sorter i{color:red;transform:scaleY(-1)}#tabulator{background-color:var(--bkg-color)}#tabulator .tabulator-header .tabulator-col-content{background-color:var(--bkg-color);color:var(--text-color)}#tabulator .tabulator-header .tabulator-col,#tabulator .tabulator-header .tabulator-col-row-handle{white-space:normal}#tabulator .tabulator-tableholder .tabulator-table .tabulator-row{background-color:var(--bkg-color);color:var(--text-color)}#tabulator .tabulator-tableholder .tabulator-table .tabulator-row:nth-child(2n){background-color:var(--bkg-color-grad1)}#tabulator .tabulator-tableholder .tabulator-table .tabulator-row.tabulator-selected{background-color:#9abcea}@media (hover:hover) and (pointer:fine){#tabulator .tabulator-tableholder .tabulator-table .tabulator-row:hover{cursor:pointer;background-color:var(--bkg-color-grad2)}}
</style>
<link rel="stylesheet" href="styles/common.css" />
<link rel="stylesheet" href="lib/tabulator-tables/tabulator.min.css" />
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />
<link rel="stylesheet" href="lib/font-gis/font-gis.css" />
<link rel="stylesheet" href="../../../node_modules/tabulator-tables/dist/css/tabulator.css" />

<div id="panel">
  <div id="content">
    <div id="header">
      ${this.getTabHeaders().map(e=>v`
      <button
        id="${e.id}"
        i18n="${e.text}"
        class="${e.active?"tab active":"tab"}"
        .active="${e.active}"
        onclick="${()=>this.displayGrid(e.id,!0)}"></button>
      `)}
    </div>
    <div id="tabulator"></div>
  </div>
  <div id="gutter"></div>
  <button id="close" onclick="this.closePanel()">
    <i class="fa-solid"></i>
  </button>
</div>
`);o(this,"eventsCallbacks",[]);o(this,"selectionTabulatorManager",new Gr);o(this,"isVisibleComponentSetup",!1);o(this,"debounceOnFeaturesSelected",Yt(this.onFeaturesSelected.bind(this),200));o(this,"visible",!1)}connectedCallback(){this.render(),this.registerVisibilityEvents()}render(){this.visible?this.renderComponent():this.renderComponentEmpty()}getTabHeaders(){return this.selectionTabulatorManager.tabHeaders}displayGrid(e,i=!1){i&&this.selectionTabulatorManager.replaceData(e),this.selectionTabulatorManager.activateTab(e),this.render(),this.selectionTabulatorManager.displayGrid(e)}closePanel(){this.state.interface.selectionComponentVisible=!1,this.state.selection.selectedFeatures=[],super.clean()}renderComponent(){super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end"),this.isVisibleComponentSetup||this.setupVisibleComponent()}setupVisibleComponent(){this.isVisibleComponentSetup=!0,this.registerEvents()}renderComponentEmpty(){this.stateManager.unsubscribe(this.eventsCallbacks),this.eventsCallbacks.length=0,this.isVisibleComponentSetup=!1,this.renderEmpty()}registerVisibilityEvents(){this.stateManager.subscribe("interface.selectionComponentVisible",(e,i)=>this.togglePanel(i))}registerEvents(){this.eventsCallbacks.push(this.stateManager.subscribe("selection.selectedFeatures",(e,i)=>{this.debounceOnFeaturesSelected(i)}))}onFeaturesSelected(e){if(this.selectionTabulatorManager.tabHeaders=[],this.isNullOrUndefined(e)||e.length<=0){this.closePanel();return}this.selectionTabulatorManager.featuresToGridData(e);const i=Object.keys(this.selectionTabulatorManager.idTab);this.selectionTabulatorManager.setElement(this.shadow.querySelector("#tabulator")),i.length||this.closePanel(),this.displayGrid(i[0])}togglePanel(e){if(this.state.interface.selectionComponent!=="grid"){if(!this.visible)return;e=!1}this.visible=e,e?this.onFeaturesSelected(this.state.selection.selectedFeatures):this.render()}}const Hr=""+new URL("center-DeU3lDk5.svg",import.meta.url).href;class jr{constructor(t){o(this,"directions",["tl","t","tr","r","br","b","bl","l"]);o(this,"shadow");o(this,"host");o(this,"top",0);o(this,"left",0);o(this,"minHeight",0);o(this,"maxHeight",0);o(this,"minWidth",0);o(this,"maxWidth",0);o(this,"height",0);o(this,"width",0);o(this,"originX",0);o(this,"originY",0);o(this,"elements",[]);this.shadow=t,this.host=this.shadow.getRootNode().host,this.init()}init(){this.destroy(),this.elements=this.directions.map(t=>this.attachEvent(t))}destroy(){this.elements.filter(t=>t!==null).forEach(t=>t.onmousedown=null),this.elements=[]}attachEvent(t){const e=this.shadow.querySelector(`.resizer.${t}`);return e?(e.onmousedown=i=>{this.onResizeStarts(i,t)},e):null}onResizeStarts(t,e){this.originX=t.clientX,this.originY=t.clientY;const i=this.host.getBoundingClientRect();this.width=i.width,this.height=i.height;const s=getComputedStyle(this.host);this.minHeight=parseInt(s.minHeight)||0,this.maxHeight=parseInt(s.maxHeight)||1/0,this.minWidth=parseInt(s.minWidth)||0,this.maxWidth=parseInt(s.maxWidth)||1/0,this.top=parseInt(s.top)||0,this.left=parseInt(s.left)||0,document.onmousemove=n=>this.resize(n,e),document.onmouseup=()=>this.stopResize()}resize(t,e){const[i,s,n,r]=this.getNewSizeAndPosition(t.clientX,t.clientY,e);this.host.style.top=`${i}px`,this.host.style.left=`${s}px`,this.host.style.width=`${r}px`,this.host.style.height=`${n}px`}getNewSizeAndPosition(t,e,i){let s=this.height,n=this.width,r=this.top,a=this.left,l=t-this.originX,h=e-this.originY;if(i.includes("t")){const d=this.height-h;s=je(d,this.minHeight,this.maxHeight),s!==d&&(h=(s-this.height)*-1),r=this.top+h}else i.includes("b")&&(s=je(this.height+h,this.minHeight,this.maxHeight));if(i.includes("l")){const d=this.width-l;n=je(d,this.minWidth,this.maxWidth),n!==d&&(l=(n-this.width)*-1),a=this.left+l}else i.includes("r")&&(n=je(this.width+l,this.minWidth,this.maxWidth));return[r,a,s,n]}stopResize(){document.onmousemove=null,document.onmouseup=null}}class si extends St{constructor(){super("selectionwindow");o(this,"template",()=>{var e;return v`<style>
.ctx{--window-header-height:2rem;--window-footer-height:2rem}.hidden{display:none!important}#draggable{border:solid 1px var(--text-color-grad1);border-radius:3px;box-shadow:0 1px 2px rgba(60,64,67,.3),0 1px 3px 1px rgba(60,64,67,.15);background:var(--bkg-color);width:100%;height:100%}#header{height:var(--window-header-height);padding:0 .5rem;cursor:move;z-index:10;background-color:var(--text-color-grad2);color:var(--bkg-color);text-align:center}#header p{line-height:var(--window-header-height);margin:0}#close{border:none;color:var(--text-color);padding:0;margin:.5rem;width:1rem;height:1rem;line-height:1rem;position:absolute;top:0;right:0;background-color:transparent;cursor:pointer}#close i:before{content:'\uf00d'}#close:hover{border-color:#000;color:#000}#content{width:100%;height:calc(100% - (var(--window-header-height) + var(--window-footer-height)));overflow-y:auto;scrollbar-width:thin;color:var(--text-color)}#content div{padding:1rem 2rem}table{border-collapse:collapse;width:100%}td.label{text-align:right;padding-right:1rem;color:var(--text-color-grad1);width:8rem;vertical-align:top}td.label:after{content:' :'}#footer{height:var(--window-footer-height);color:var(--text-color-grad1);border-top:solid 1px var(--text-color-grad1);display:flex;justify-content:space-around}button{flex-grow:1;border:none;background-color:unset;color:var(--text-color-grad1);padding:.5rem;cursor:pointer}button>img{max-height:calc(var(--window-header-height)/ 2)}#previous i{float:left}#next i{float:right}#tools{display:flex;justify-content:space-around}#counter{line-height:var(--window-footer-height);height:var(--window-footer-height);text-align:center;margin-top:0}.resizer{--resize-size:6px;--negative-resize-size:-6px}button.resizer{position:absolute;background-color:transparent;border:none}.resizer.corner{width:var(--resize-size);height:var(--resize-size)}.resizer.top-bottom{width:calc(100% - (2 * var(--resize-size)));height:var(--resize-size)}.resizer.left-right{width:var(--resize-size);height:calc(100% - (2 * var(--resize-size)))}.resizer.br:hover,.resizer.tl:hover{cursor:nw-resize}.resizer.bl:hover,.resizer.tr:hover{cursor:ne-resize}.resizer.top-bottom:hover{cursor:n-resize}.resizer.left-right:hover{cursor:e-resize}.resizer.tl{top:var(--negative-resize-size);left:var(--negative-resize-size)}.resizer.t{top:var(--negative-resize-size);left:var(--resize-size)}.resizer.tr{top:var(--negative-resize-size);right:var(--negative-resize-size)}.resizer.r{top:var(--resize-size);right:var(--negative-resize-size)}.resizer.br{bottom:var(--negative-resize-size);right:var(--negative-resize-size)}.resizer.b{bottom:var(--negative-resize-size);left:var(--resize-size)}.resizer.bl{bottom:var(--negative-resize-size);left:var(--negative-resize-size)}.resizer.l{top:var(--resize-size);left:var(--negative-resize-size)}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="draggable" class="${this.visible?"ctx":"hidden"}">
  <button tabindex="-1" class="resizer tl corner"></button>
  <button tabindex="-1" class="resizer t top-bottom"></button>
  <button tabindex="-1" class="resizer tr corner"></button>
  <button tabindex="-1" class="resizer r left-right"></button>
  <button tabindex="-1" class="resizer br corner"></button>
  <button tabindex="-1" class="resizer b top-bottom"></button>
  <button tabindex="-1" class="resizer bl corner"></button>
  <button tabindex="-1" class="resizer l left-right"></button>
  <div id="header">
    <p i18n="${(e=this.getWindowFeature())==null?void 0:e.id}"></p>
    <button id="close" onclick="${()=>this.closeWindow()}">
      <i class="fa-solid"></i>
    </button>
  </div>
  <div id="content">
    <div>
      <table>
        <tr class="hidden">
          <th>Label</th>
          <th>Value</th>
        </tr>
        ${this.displayedProperties.map(i=>v`
        <tr>
          <td class="label" i18n="${i[0]}"></td>
          <td class="value">${this.htmlUnsafe(i[1])}</td>
        </tr>
        `)}
      </table>
    </div>
  </div>
  <div id="footer">
    <button
      id="previous"
      class="${this.maxIndex>0?"":"hidden"}"
      onclick="${()=>this.onFocusWindowFeature(this.focusedIndex-1)}">
      <i class="fa-solid fa-xl fa-circle-arrow-left"></i>
    </button>
    <div id="counter" class="${this.maxIndex>0?"":"hidden"}">
      <span class="${this.maxIndex>0?"":"hidden"}">
        <span>${this.focusedIndex+1}</span>
        <span>/</span>
        <span>${this.maxIndex+1}</span>
      </span>
    </div>
    <div class="tools">
      <button onclick="${()=>this.recenter()}">
        <img alt="recenter-icon" src="${this.iconCenter}" />
      </button>
    </div>
    <button
      id="next"
      class="${this.maxIndex>0?"":"hidden"}"
      onclick="${()=>this.onFocusWindowFeature(this.focusedIndex+1)}">
      <i class="fa-solid fa-xl fa-circle-arrow-right"></i>
    </button>
  </div>
</div>
`});o(this,"eventsCallbacks",[]);o(this,"isVisibleComponentSetup",!1);o(this,"debounceOnFeaturesSelected",Yt(this.onFeaturesSelected.bind(this),200));o(this,"resizeWindow",null);o(this,"featureToGridData",new ue({removeEmptyColumns:!1}));o(this,"windowFeatures",[]);o(this,"visible",!1);o(this,"focusedIndex",0);o(this,"maxIndex",0);o(this,"iconCenter",Hr);o(this,"displayedProperties",[])}connectedCallback(){this.render(),this.registerVisibilityEvents()}render(){this.visible?this.renderComponent():this.renderComponentEmpty()}getWindowFeature(){return this.windowFeatures[this.focusedIndex]}recenter(){var s,n;const e=this.getWindowFeature(),i=(n=(s=e==null?void 0:e.feature)==null?void 0:s.getGeometry())==null?void 0:n.getExtent();if(!i){console.error("Invalid feature to recenter on.");return}this.state.position.center=st(i)}closeWindow(){this.visible=!1,this.state.interface.selectionComponentVisible=!1,this.state.selection.focusedFeatures=null,this.state.selection.selectedFeatures=[]}onFocusWindowFeature(e){const i=this.selectedWindowFeature(e);this.state.selection.focusedFeatures=[i.feature],this.displayedProperties=Object.entries(i.notOlProperties).filter(s=>s[1]!==void 0),this.displayedProperties.forEach(s=>{let n={};return this.configManager.Config.query.legacy&&(n={ADD_ATTR:["onclick"],ADD_URI_SAFE_ATTR:["onclick"]}),s[1]=bs.sanitize(s[1],n),s[1]}),this.render(),super.girafeTranslate()}renderComponent(){super.render(),super.girafeTranslate(),this.activateTooltips(!1,[800,0],"top-end"),this.isVisibleComponentSetup||this.setupVisibleComponent()}setupVisibleComponent(){this.isVisibleComponentSetup=!0,this.resizeWindow=new jr(this.shadow),this.makeDraggable(),this.registerEvents()}renderComponentEmpty(){var e;(e=this.resizeWindow)==null||e.destroy(),this.resizeWindow=null,this.stateManager.unsubscribe(this.eventsCallbacks),this.eventsCallbacks.length=0,this.isVisibleComponentSetup=!1,this.renderEmpty()}registerVisibilityEvents(){this.stateManager.subscribe("interface.selectionComponentVisible",(e,i)=>this.togglePanel(i))}registerEvents(){this.eventsCallbacks.push(this.stateManager.subscribe("selection.selectedFeatures",(e,i)=>{this.debounceOnFeaturesSelected(i)}))}onFeaturesSelected(e){if(!(e!=null&&e.length)){this.closeWindow();return}if(this.windowFeatures=si.createWindowFeatures(this.featureToGridData.toGridDataById(e??[])),!this.windowFeatures.length){this.closeWindow();return}this.maxIndex=this.windowFeatures.length-1,this.onFocusWindowFeature(0)}selectedWindowFeature(e){return this.focusedIndex=ys(e,this.maxIndex),this.getWindowFeature()}togglePanel(e){if(this.state.interface.selectionComponent!=="window"){if(!this.visible)return;e=!1}this.visible=e,e?this.onFeaturesSelected(this.state.selection.selectedFeatures):this.render()}static createWindowFeatures(e){const i=[];return Object.keys(e).forEach(s=>{const n=e[s];n.features.forEach((r,a)=>{i.push({id:s,feature:r,notOlProperties:n.notOlProperties[a]})})}),i}}const Ur="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.1%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M64%2032C28.7%2032%200%2060.7%200%2096V416c0%2035.3%2028.7%2064%2064%2064H384c35.3%200%2064-28.7%2064-64V96c0-35.3-28.7-64-64-64H64zm297.1%2084L257.3%20234.6%20379.4%20396H283.8L209%20298.1%20123.3%20396H75.8l111-126.9L69.7%20116h98l67.7%2089.5L313.6%20116h47.5zM323.3%20367.6L153.4%20142.9H125.1L296.9%20367.6h26.3z'/%3e%3c/svg%3e",qr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.1%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M64%2032C28.7%2032%200%2060.7%200%2096V416c0%2035.3%2028.7%2064%2064%2064h98.2V334.2H109.4V256h52.8V222.3c0-87.1%2039.4-127.5%20125-127.5c16.2%200%2044.2%203.2%2055.7%206.4V172c-6-.6-16.5-1-29.6-1c-42%200-58.2%2015.9-58.2%2057.2V256h83.6l-14.4%2078.2H255V480H384c35.3%200%2064-28.7%2064-64V96c0-35.3-28.7-64-64-64H64z'/%3e%3c/svg%3e",Wr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.1%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M416%2032H31.9C14.3%2032%200%2046.5%200%2064.3v383.4C0%20465.5%2014.3%20480%2031.9%20480H416c17.6%200%2032-14.5%2032-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4%20416H69V202.2h66.5V416zm-33.2-243c-21.3%200-38.5-17.3-38.5-38.5S80.9%2096%20102.2%2096c21.2%200%2038.5%2017.3%2038.5%2038.5%200%2021.3-17.2%2038.5-38.5%2038.5zm282.1%20243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6%200-39.9%2027-39.9%2054.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8%2030.6-34.5%2062.9-34.5%2067.2%200%2079.7%2044.3%2079.7%20101.9V416z'/%3e%3c/svg%3e",Yr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.1%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M64%2032C28.7%2032%200%2060.7%200%2096V416c0%2035.3%2028.7%2064%2064%2064H384c35.3%200%2064-28.7%2064-64V96c0-35.3-28.7-64-64-64H64zM218%20271.7L64.2%20172.4C66%20156.4%2079.5%20144%2096%20144H352c16.5%200%2030%2012.4%2031.8%2028.4L230%20271.7c-1.8%201.2-3.9%201.8-6%201.8s-4.2-.6-6-1.8zm29.4%2026.9L384%20210.4V336c0%2017.7-14.3%2032-32%2032H96c-17.7%200-32-14.3-32-32V210.4l136.6%2088.2c7%204.5%2015.1%206.9%2023.4%206.9s16.4-2.4%2023.4-6.9z'/%3e%3c/svg%3e";class Xr{constructor(t){o(this,"serviceUrl");this.serviceUrl=t}async shortenUrl(t){const e=new URLSearchParams;e.append("lsturl",t),e.append("format","json");const i={success:!1,shorturl:t};try{const n=await(await fetch(this.serviceUrl,{method:"POST",headers:new Headers({"Content-Type":"application/x-www-form-urlencoded"}),body:e})).json();if(n.success){const r=n;return{success:!0,shorturl:r.short,qrcode:`data:image/png;base64, ${r.qrcode}`}}return i}catch{return i}}}class Kr{constructor(t){o(this,"serviceUrl");this.serviceUrl=t}async shortenUrl(t){const e={success:!1,shorturl:t};try{const i=new URLSearchParams;i.append("url",t);const n=await(await fetch(this.serviceUrl,{method:"POST",headers:new Headers({"Content-Type":"application/x-www-form-urlencoded"}),body:i})).json();return n?{success:!0,shorturl:n.short_url}:e}catch{return e}}}class Jr extends St{constructor(){super("share");o(this,"template",()=>v`<style>
#draggable{border-radius:1px;box-shadow:var(--bx-shdw)}#header{padding:.5rem;cursor:grabbing;z-index:10;background:var(--bkg-color-grad2);color:var(--text-color);text-align:center}#content{padding:2rem;width:24rem;text-align:center}.hidden{display:none}#close{cursor:pointer;float:right}.loading{margin-top:8rem}.link{display:flex;height:2.3rem}.link button{border:none;border-right:solid 1px var(--bkg-color);width:2.3rem;height:2.3rem;line-height:2.3rem;background-color:var(--bkg-color-grad2);color:var(--text-color);padding:0;cursor:pointer;margin:0;display:inline-block}.qrcode{margin:auto;margin-top:2rem;display:block;width:10rem;opacity:.7}.social{display:flex}.social button{margin:auto;margin-top:3rem;cursor:pointer;border:none;background-color:transparent}.social img{width:3rem;opacity:.7;filter:var(--svg-filter)}.social img:hover{opacity:1}input{border-radius:.25rem;background-color:var(--bkg-color);padding-left:1rem;color:var(--text-color);font-size:.9rem;flex-grow:1}.error{order:3;color:var(--error-color)}
</style>
<link rel="stylesheet" href="lib/fontawesome/css/all.min.css" />

<div id="draggable">
  <div id="header">
    Share this map with a link
    <div id="close">
      <i class="fa-solid fa-xmark"></i>
    </div>
  </div>

  <div id="content">
    <div class="${this.loading?"":"hidden"}">
      <i class="fa-4x fa-solid fa-circle-notch fa-spin loading"></i>
    </div>

    <div class="${this.loading?"hidden":""}">
      <div class="link">
        <input id="link" type="text" value="${this.shareLink}" />
        <button tip="Add bookmark" onclick="${()=>this.copyToClipboard()}">
          <i class="fa-sm fa-regular fa-copy"></i>
        </button>
      </div>

      <img alt="share-qrcode" class="${this.qrCode?"qrcode":"hidden"}" src="${this.qrCode}" />
      <div class="${this.success?"hidden":"qrcode error"}">
        <i class="fa-solid fa-circle-exclamation tool error"></i>
        Error, can not fetch the shortener service. Please try again later.
      </div>

      <div class="social">
        <button onclick="${()=>this.shareFacebook()}">
          <img alt="share-facebook" src="${this.facebookLogo}" />
        </button>
        <button onclick="${()=>this.shareTwitter()}">
          <img alt="share-twitter" src="${this.twitterLogo}" />
        </button>
        <button onclick="${()=>this.shareLinkedIn()}">
          <img alt="share-linkedin" src="${this.linkedInLogo}" />
        </button>
        <button onclick="${()=>this.shareMail()}">
          <img alt="share-mail" src="${this.mailLogo}" />
        </button>
      </div>
    </div>
  </div>
</div>
`);o(this,"loading",!0);o(this,"shareLink");o(this,"qrCode");o(this,"success",!0);o(this,"twitterLogo",Ur);o(this,"facebookLogo",qr);o(this,"linkedInLogo",Wr);o(this,"mailLogo",Yr);o(this,"shareManager");o(this,"urlShortener");this.shareManager=Wt.getInstance()}registerEvents(){this.stateManager.subscribe("interface.shareVisible",(e,i)=>this.togglePopup(i))}initializeShortenerService(){switch(this.configManager.Config.share.service){case"gmf":this.urlShortener=new Kr(this.configManager.Config.share.createUrl);break;case"lstu":this.urlShortener=new Xr(this.configManager.Config.share.createUrl);break}}render(){super.render(),super.makeDraggable()}async togglePopup(e){if(this.urlShortener&&e){this.loading=!0,this.render();const i=window.location.href.split("#")[0],s=this.shareManager.getStateToShare(),n=`${i}#${s}`,r=await this.urlShortener.shortenUrl(n);this.shareLink=r.shorturl,this.success=r.success,this.qrCode=r.qrcode,this.loading=!1,this.render()}else this.renderEmpty()}closeWindow(){this.state.interface.shareVisible=!1}shareFacebook(){window.open("https://www.facebook.com/sharer/sharer.php?u="+this.shareLink,"_blank")}shareTwitter(){window.open("https://twitter.com/intent/tweet?url="+this.shareLink,"_blank")}shareLinkedIn(){window.open("https://www.linkedin.com/shareArticle?url="+this.shareLink,"_blank")}shareMail(){const e=encodeURIComponent("Check out this link"),i=encodeURIComponent("I thought you might be interested in this link: "+this.shareLink);window.location.href="mailto:?subject="+e+"&body="+i}copyToClipboard(){navigator.clipboard.writeText(this.shareLink)}connectedCallback(){this.loadConfig().then(()=>{this.render(),this.girafeTranslate(),this.initializeShortenerService(),this.registerEvents()})}}const Qr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M64%2032C28.7%2032%200%2060.7%200%2096V416c0%2035.3%2028.7%2064%2064%2064H384c35.3%200%2064-28.7%2064-64V96c0-35.3-28.7-64-64-64H64zM200%20344V280H136c-13.3%200-24-10.7-24-24s10.7-24%2024-24h64V168c0-13.3%2010.7-24%2024-24s24%2010.7%2024%2024v64h64c13.3%200%2024%2010.7%2024%2024s-10.7%2024-24%2024H248v64c0%2013.3-10.7%2024-24%2024s-24-10.7-24-24z'/%3e%3c/svg%3e",Zr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M208.5%2062.3l28.1-36.9C248.8%209.4%20267.8%200%20288%200c28.5%200%2053.6%2018.7%2061.8%2046l17.8%2059.4c10.3%2034.4%2036.1%2062%2069.8%2074.6l39.8%2014.9c20.9%207.9%2034.8%2027.9%2034.8%2050.2c0%2016.9-7.9%2032.8-21.5%2042.9l-67.3%2050.5c-24.3%2018.2-37.2%2047.9-33.8%2078.1l2.5%2022.7c4.3%2038.7-26%2072.6-65%2072.6c-14.8%200-29.3-5.1-40.8-14.3l-55.4-44.3c-4.5-3.6-9.3-6.7-14.5-9.2c-15.8-7.9-33.7-10.4-51-7.3L82.4%20451.9C47.8%20458.2%2016%20431.6%2016%20396.5c0-13.2%204.7-26%2013.1-36.2l11.2-13.4c14.6-17.4%2022.6-39.4%2022.6-62.1c0-18.8-5.5-37.2-15.8-53L8.8%20173.5C3.1%20164.7%200%20154.4%200%20143.9c0-33.4%2030.1-58.8%2063-53.2l51.3%208.7c35.9%206.1%2072.2-8.2%2094.2-37.1z'/%3e%3c/svg%3e";class _i{constructor(t){o(this,"id");o(this,"layers");o(this,"name");o(this,"icon");this.id=Ct(),this.name=t,this.layers=[],this.icon=Zr}get hasThemes(){for(const t of this.layers)if(t instanceof J)return!0;return!1}getSerialized(){return new vs().getSerializedLayerTree(this.layers)}getThemeLayer(){const t=new J(1e6,this.name,0);return t.children.push(...this.layers),t}}class eo{constructor(){o(this,"customThemes",[])}addTheme(t,e){const i=new _i(t);for(const s of e){const n=s.clone();this.manageActiveStateForClonedObject(n),i.layers.push(n)}this.customThemes.push(i),this.saveCustomThemes()}manageActiveStateForClonedObject(t){if(t instanceof Ai)t.isDefaultChecked=t.active,t.activeState="off";else if(t instanceof ie||t instanceof J)for(const e of t.children)this.manageActiveStateForClonedObject(e)}deleteTheme(t){const e=this.customThemes.findIndex(i=>i===t);if(e>=0)this.customThemes.splice(e,1),this.saveCustomThemes();else throw new Error("The custom theme to be removed cannot be found in the list of custom themes")}saveCustomThemes(){const t={};for(const e of this.customThemes)t[e.name]=e.getSerialized();localStorage.setItem("custom-themes",JSON.stringify(t))}loadCustomThemes(){try{const t=localStorage.getItem("custom-themes");if(t){const e=JSON.parse(t);for(const i in e){const s=new _i(i),n=new ws().getDeserializedLayerTree(e[i]);s.layers.push(...n),this.customThemes.push(s)}}}catch(t){console.warn("Cannot deserialize custom themes from local storage"),console.warn(t)}}}class to extends P{constructor(){super("themes");o(this,"template",()=>v`<style>
.hidden{display:none}button.main{border:none;width:4rem;height:4rem;background-color:#444;color:#fff;padding:.5rem;cursor:pointer}button.main:hover{background-color:#000}.themes{display:flex;flex-wrap:wrap;width:51rem;margin-top:0;overflow-y:auto;max-height:70vh;scrollbar-width:thin;border:solid 1px #444;border-radius:3px;padding:1rem;background-color:var(--bkg-color)}.custom-theme,.new-theme,.theme{align-content:flex-end;position:relative;width:9rem;border:none;background-color:transparent;cursor:pointer;margin:.5rem;padding:0}.custom-theme>button>img,.new-theme>img,.theme>img{width:100%}button.select{border:none;padding:0;background-color:transparent;cursor:pointer}button.select>img{height:3rem;margin-bottom:1rem}button.delete{position:absolute;top:0;right:0}button>span{display:inline-block;width:9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left;color:var(--text-color)}.spin{animation-name:spin;animation-duration:2s;animation-iteration-count:infinite;animation-timing-function:linear}
</style>
<link rel="stylesheet" href="styles/common.css" />

<button
  class="${this.state.loading?"hidden":"girafe-button-big dark"}"
  title="Theme Selection"
  onclick="${()=>this.toggleThemesList()}"
  onblur="${()=>this.onBlur()}">
  <img alt="menu-icon" src="icons/themes.svg" />
</button>
<button
  class="${this.state.loading?"girafe-button-big dark":"hidden"}"
  title="Theme Selection"
  onclick="${()=>this.toggleThemesList()}"
  onblur="${()=>this.onBlur()}">
  <img alt="menu-icon" src="icons/loading.svg" class="spin" />
</button>

<div class="${this.menuOpen?"themes":"hidden"}">
  ${Object.values(this.state.themes._allThemes??{}).map(e=>U(e,e.id)`
  <button class="theme" onmousedown="${()=>this.onThemeChanged(e)}">
    <img alt="${"Icon for "+e.name}" src="${e.icon}" />
    <span i18n="${e.name}">${e.name}</span>
  </button>
  `)} ${Object.values(this.customThemes??{}).map(e=>U(e,e.id)`
  <div class="custom-theme">
    <button class="select" onmousedown="${()=>this.onCustomThemeChanged(e)}">
      <img alt="${"Icon for "+e.name}" src="${e.icon}" />
      <span i18n="${e.name}">${e.name}</span>
    </button>
    <button class="girafe-button-small delete" onmousedown="${i=>this.onDeleteCustomTheme(e,i)}">
      <img alt="delete-icon" src="icons/close.svg" />
    </button>
  </div>
  `)}

  <div class="new-theme">
    <button class="select" onmousedown="${()=>this.onAddCustomTheme()}">
      <img alt="Create new theme" src="${this.newIcon}" tip="Save the current layer configuration as new theme" />
      <span i18n="Create new theme">Save current theme</span>
    </button>
  </div>
</div>
`);o(this,"newIcon",Qr);o(this,"mapManager");o(this,"customThemesManager",new eo);o(this,"menuOpen",!1);this.mapManager=xt.getInstance()}get customThemes(){var e;return((e=this.customThemesManager)==null?void 0:e.customThemes)??[]}registerEvents(){this.stateManager.subscribe("loading",()=>super.render()),this.stateManager.subscribe("themes.isLoaded",()=>{this.state.themes.isLoaded&&(this.customThemesManager.loadCustomThemes(),super.render(),super.girafeTranslate())})}onBlur(){this.menuOpen=!1,super.render()}toggleThemesList(){this.menuOpen=!this.menuOpen,super.render()}onThemeChanged(e){if(this.state.themes.lastSelectedTheme=e,this.onBlur(),e.location!=null||e.zoom!=null){const i=this.mapManager.getMap().getView();i.animate({center:e.location??i.getCenter(),zoom:e.zoom??i.getZoom(),duration:1e3})}}onCustomThemeChanged(e){if(e.hasThemes)for(let i=e.layers.length-1;i>=0;--i){const s=e.layers[i];if(s instanceof J)this.state.themes.lastSelectedTheme=s;else throw new Error("There is an error in the custom")}else this.state.themes.lastSelectedTheme=e.getThemeLayer()}onAddCustomTheme(){const e=prompt("Please give a name to you new custom theme:");e!==null&&e.trim().length>0&&(this.customThemesManager.addTheme(e,this.state.layers.layersList),super.render())}onDeleteCustomTheme(e,i){i.stopPropagation(),confirm("Do you want to delete this theme?")&&(this.customThemesManager.deleteTheme(e),super.render())}connectedCallback(){this.loadConfig().then(()=>{super.render(),this.activateTooltips(!1,[800,0],"top"),this.registerEvents()})}}class Te{static getSortedLayers(t){return t.slice().sort((i,s)=>i.order-s.order)??[]}static activateDefaultLayers(t){for(const e of t)this.layerManager.activateIfDefaultChecked(e),e instanceof Ai&&!e.active&&this.configManager.Config.treeview.hideLegendWhenLayerIsDeactivated&&this.layerManager.isLayerWithLegend(e)&&(e.isLegendExpanded=!1,e.wasLegendExpanded=!0),(e instanceof ie||e instanceof J)&&this.activateDefaultLayers(e.children)}}o(Te,"layerManager",Xt.getInstance()),o(Te,"configManager",kt.getInstance());class io extends P{constructor(){super("treeviewroot");o(this,"template",()=>v`<style>
.panel{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;background:var(--bkg-color)}.menu{border-top:solid 1px #bbb;background-color:var(--bkg-color);height:2rem;position:absolute;bottom:0;left:0;right:6px;z-index:1;font-size:0;display:flex}.treeview-list{position:absolute;top:0;left:0;right:5px;bottom:2.3rem;padding-left:0;padding-top:1rem;padding-bottom:1.5rem;padding-right:.7rem;margin:0;margin-top:.5rem;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin}girafe-basemap{position:absolute;right:0;top:0}
</style><style>
.hidden{display:none}.rotate90{transform:rotate(90deg)}.rotate180{transform:rotate(180deg)}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#999}.gg-button{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.gg-button:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.gg-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.gg-small img{overflow:hidden}.gg-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.gg-check{padding:.2rem}.gg-label{text-align:left;padding-left:0;white-space:nowrap}.gg-grab:hover{cursor:grab}.gg-spacer{padding:0}.gg-opacity{opacity:.5}.gg-opacity:hover{background-color:transparent;opacity:1}.gg-selected{font-weight:700;opacity:1}.girafe-button-big,.girafe-button-large,.girafe-button-medium,.girafe-button-small,.girafe-button-tiny{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.girafe-button-big:hover,.girafe-button-large:hover,.girafe-button-medium:hover,.girafe-button-small:hover,.girafe-button-tiny:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.girafe-button-big.dark,.girafe-button-large.dark,.girafe-button-medium.dark,.girafe-button-small.dark,.girafe-button-tiny.dark{background-color:var(--bkg-color);filter:invert(1)}img{filter:var(--svg-filter)}.girafe-button-big{width:4rem;height:4rem;align-items:center;padding:1rem}.girafe-button-big img{overflow:hidden}.girafe-button-medium{flex-direction:column;width:4rem;align-items:center}.girafe-button-medium img{margin:1rem;width:1.5rem}.girafe-button-medium span{display:block;margin-top:-.8rem;margin-bottom:.8rem}.girafe-button-large{flex-direction:row}.girafe-button-large img{margin:.3rem;height:2rem}.girafe-button-large span{line-height:2rem;height:2rem;margin:.3rem}.girafe-button-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.girafe-button-small img{overflow:hidden}.girafe-button-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.girafe-button-tiny{width:1rem;height:1rem;align-items:center;padding:0}.girafe-button-tiny img{overflow:hidden}
</style>
<link rel="stylesheet" href="lib/tippy.js/tippy.css" />
<link rel="stylesheet" href="lib/tippy.js/backdrop.css" />
<link rel="stylesheet" href="lib/tippy.js/border.css" />
<link rel="stylesheet" href="lib/tippy.js/svg-arrow.css" />

<div id="panel" class="panel">
  <div class="menu">
    <button
      class="gg-button gg-small"
      tip="Expand / Collapse all"
      tip-placement="top"
      onclick="${()=>this.expandAll()}">
      <img class="${this.isAllExpanded?"":"hidden"}" alt="Collapse all icon" src="icons/expand.svg" />
      <img class="${this.isAllExpanded?"hidden":""}" alt="Expand all icon" src="icons/expand-all.svg" />
    </button>

    <button
      class="gg-button gg-small"
      tip="Toggle all legends"
      tip-placement="top"
      onclick="${()=>this.toggleAllLegends()}">
      <img class="${this.areAllLegendExpanded?"":"hidden"}" alt="Toggle all legends icon" src="icons/legend.svg" />
      <img
        class="${this.areAllLegendExpanded?"hidden":"rotate90"}"
        alt="Toggle all legends icon"
        src="icons/legend.svg" />
    </button>

    <button class="gg-button gg-small" tip="Remove all layers" tip-placement="top" onclick="${()=>this.removeAll()}">
      <img alt="Remove all layers icon" src="icons/trash.svg" />
    </button>

    <girafe-basemap tip="Select basemap"></girafe-basemap>
  </div>

  <div class="treeview-list">
    <!-- prettier-ignore -->
    ${this.sortedLayers().map(e=>e instanceof J?U(e,e.treeItemId)`
    <girafe-tree-view-theme themeid="${e.treeItemId}"></girafe-tree-view-theme>
    `:e instanceof ie?U(e,e.treeItemId)`
    <girafe-tree-view-group groupid="${e.treeItemId}"></girafe-tree-view-group>
    `:U(e,e.treeItemId)`
    <girafe-tree-view-item layerid="${e.treeItemId}"></girafe-tree-view-item>
    `)}
  </div>
</div>
`);o(this,"layerManager");o(this,"isAllExpanded",!1);o(this,"areAllLegendExpanded",!0);this.layerManager=Xt.getInstance()}sortedLayers(){return Te.getSortedLayers(this.state.layers.layersList)}render(){super.render(),this.activateTooltips(!1,[800,0],"right")}registerEvents(){this.subscribe("layers.layersList",(e,i)=>this.onLayersListChanged(e,i)),this.subscribe("treeview.advanced",()=>this.refreshRender()),this.subscribe(/layers\.layersList\..*\.order/,()=>this.refreshRender())}onLayersListChanged(e,i){super.refreshRender();let s=i;e&&(s=i.filter(n=>!e.find(r=>r.treeItemId===n.treeItemId))),Te.activateDefaultLayers(s)}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}expandAll(){this.isAllExpanded=!this.isAllExpanded,this.expandAllRecursive(this.state.layers.layersList),super.refreshRender()}expandAllRecursive(e){for(const i of e)(i instanceof ie||i instanceof J)&&(i.isExpanded=this.isAllExpanded,this.expandAllRecursive(i.children))}toggleAllLegends(){this.areAllLegendExpanded=!this.areAllLegendExpanded,this.toggleAllLegendsRecursive(this.state.layers.layersList),super.refreshRender()}toggleAllLegendsRecursive(e){for(const i of e)i instanceof Y&&i.legend?i.isLegendExpanded=this.areAllLegendExpanded:(i instanceof ie||i instanceof J)&&this.toggleAllLegendsRecursive(i.children)}removeAll(){for(const e of this.stateManager.state.layers.layersList)this.layerManager.toggle(e,"off");this.state.layers.layersList=[],this.state.themes.lastSelectedTheme=null}}class Me{static checkParents(t,e){if(t.parent!==e.parent)throw Error("Layers can only be reordered if the have the same parent")}static reorderLayers(t,e,i,s){Me.checkParents(t,e),t.order=e.order;const n=t.parent?t.parent.children:W.getInstance().state.layers.layersList;for(const r of n)r.treeItemId!==t.treeItemId&&i(r.order,t.order)&&(r.order+=s)}static moveLayerAfter(t,e){const i=t.order;Me.reorderLayers(t,e,(s,n)=>s<=n&&s>=i,-1)}static moveLayerBefore(t,e){const i=t.order;Me.reorderLayers(t,e,(s,n)=>s>=n&&s<=i,1)}}class so extends Ei{constructor(){super(...arguments);o(this,"layer");o(this,"destination");o(this,"dragAfter",!1);o(this,"dragBefore",!1)}dragStart(e){this.layer=e}dragEnd(){if(this.layer&&this.destination&&this.layer.parent===this.destination.parent){if(this.layer.order<this.destination.order)Me.moveLayerAfter(this.layer,this.destination);else if(this.layer.order>this.destination.order)Me.moveLayerBefore(this.layer,this.destination);else throw Error("Orders are equal. Not managed yet");this.layer=void 0,this.destination=void 0}else console.debug("Illegal drag&drop")}dragEnter(e){var i;return this.layer!==e&&((i=this.layer)==null?void 0:i.parent)===e.parent?(this.destination=e,this.layer.order>e.order?this.dragBefore=!0:this.dragAfter=!0,!0):!1}dragLeave(e){var i,s,n,r;return((i=this.layer)==null?void 0:i.treeItemId)!==e.treeItemId&&((n=(s=this.layer)==null?void 0:s.parent)==null?void 0:n.treeItemId)===((r=e.parent)==null?void 0:r.treeItemId)?(this.dragAfter=!1,this.dragBefore=!1,!0):!1}}class es extends P{constructor(e,i){super(i);o(this,"dragManager");o(this,"layerManager");o(this,"layer");o(this,"dragButton");o(this,"container");this.layer=e,this.layerManager=Xt.getInstance(),this.dragManager=so.getInstance()}render(){super.render(),this.dragButton=this.shadow.getElementById("drag-button"),this.container=this.shadow.getElementById("container"),super.girafeTranslate(),this.initializeDrag(),this.createTooltips()}refreshRender(e){(!e||e===this.layer)&&(super.refreshRender(),this.createTooltips())}createTooltips(){super.activateTooltips(!1,[800,0],"top")}showMetadata(){this.state.metadata={title:this.layer.name,url:this.layer.metadataUrl??null},this.state.interface.metadataVisible=!0}initializeDrag(){this.dragButton.draggable=!0,this.dragButton.ondragstart=e=>this.dragStart(e),this.dragButton.ondragend=e=>this.dragEnd(e),this.ondragenter=e=>this.dragEnter(e),this.ondragleave=e=>this.dragLeave(e)}dragStart(e){this.dragManager.dragStart(this.layer),e.dataTransfer.setDragImage(this,this.offsetWidth,0)}dragEnd(e){this.dragManager.dragEnd()}dragEnter(e){this.dragManager.dragEnter(this.layer)&&this.setDragStyle()}dragLeave(e){this.dragManager.dragLeave(this.layer)&&this.setDragStyle()}setDragStyle(){this.dragManager.dragAfter?(this.container.classList.remove("dragBefore"),this.container.classList.add("dragAfter")):this.dragManager.dragBefore?(this.container.classList.remove("dragAfter"),this.container.classList.add("dragBefore")):(this.container.classList.remove("dragAfter"),this.container.classList.remove("dragBefore"))}}class no extends es{constructor(e){super(e,"treeviewitem");o(this,"template",()=>{var e;return v`<style>
header{border-top:solid 1px #ddd;display:flex;align-items:center}.tool{display:none!important;padding-left:0!important;padding-right:0!important;min-width:0!important;max-width:1.5rem!important}header:hover .tool{display:flex!important}.tool.active{display:flex!important;opacity:1!important}.label-container{display:flex;flex-grow:1;align-items:center;overflow:auto}.legend{display:flex}.children{padding-left:1.6rem;flex-basis:100%;order:10}.dragAfter{border-bottom:dashed 1rem #ccc}.dragBefore{border-top:dashed 1rem #ccc}
</style><style>
.hidden{display:none}.rotate90{transform:rotate(90deg)}.rotate180{transform:rotate(180deg)}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#999}.gg-button{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.gg-button:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.gg-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.gg-small img{overflow:hidden}.gg-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.gg-check{padding:.2rem}.gg-label{text-align:left;padding-left:0;white-space:nowrap}.gg-grab:hover{cursor:grab}.gg-spacer{padding:0}.gg-opacity{opacity:.5}.gg-opacity:hover{background-color:transparent;opacity:1}.gg-selected{font-weight:700;opacity:1}.girafe-button-big,.girafe-button-large,.girafe-button-medium,.girafe-button-small,.girafe-button-tiny{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.girafe-button-big:hover,.girafe-button-large:hover,.girafe-button-medium:hover,.girafe-button-small:hover,.girafe-button-tiny:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.girafe-button-big.dark,.girafe-button-large.dark,.girafe-button-medium.dark,.girafe-button-small.dark,.girafe-button-tiny.dark{background-color:var(--bkg-color);filter:invert(1)}img{filter:var(--svg-filter)}.girafe-button-big{width:4rem;height:4rem;align-items:center;padding:1rem}.girafe-button-big img{overflow:hidden}.girafe-button-medium{flex-direction:column;width:4rem;align-items:center}.girafe-button-medium img{margin:1rem;width:1.5rem}.girafe-button-medium span{display:block;margin-top:-.8rem;margin-bottom:.8rem}.girafe-button-large{flex-direction:row}.girafe-button-large img{margin:.3rem;height:2rem}.girafe-button-large span{line-height:2rem;height:2rem;margin:.3rem}.girafe-button-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.girafe-button-small img{overflow:hidden}.girafe-button-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.girafe-button-tiny{width:1rem;height:1rem;align-items:center;padding:0}.girafe-button-tiny img{overflow:hidden}
</style>
<link rel="stylesheet" href="lib/tippy.js/tippy.css" />
<link rel="stylesheet" href="lib/tippy.js/backdrop.css" />
<link rel="stylesheet" href="lib/tippy.js/border.css" />
<link rel="stylesheet" href="lib/tippy.js/svg-arrow.css" />

<div id="container">
  <header>
    <!-- Spacer -->
    <div class="gg-spacer gg-small"></div>

    <!-- Checkbox -->
    <button
      class="${this.layer.active?"gg-button gg-small gg-check gg-opacity gg-selected":"gg-button gg-small gg-check gg-opacity"}"
      tip="Activate / Deactivate"
      onclick="${()=>this.toggle()}">
      <img class="${this.layer.active?"":"hidden"}" alt="Expand/Collapse button" src="icons/checked-full.svg" />
      <img class="${this.layer.active?"hidden":""}" alt="Expand/Collapse button" src="icons/checked-no.svg" />
    </button>

    <!-- Error icon -->
    <button class="${this.layer.hasError?"gg-button gg-small gg-opacity":"hidden"}" tip="Error on layer">
      <img alt="Error on layer" src="icons/error.svg" />
    </button>

    <!-- Label -->
    <div class="label-container">
      <button
        class="${this.layer.active?"gg-button gg-small gg-opacity gg-label gg-selected":"gg-button gg-small gg-label gg-opacity"}"
        onclick="${()=>this.toggle()}">
        <span i18n="${this.layer.name}"> ${this.layer.name} </span>
      </button>
      <img
        class="${this.layer.active&&this.iconUrl?"":"hidden"}"
        alt="${"Icon for "+this.layer.name}"
        src="${this.iconUrl}" />
    </div>

    <!-- zoom to resolution -->
    <button
      class="${this.layer.active&&this.layer instanceof Y&&this.layer.hasRestrictedResolution()?"gg-button gg-small gg-opacity tool":"hidden"}"
      tip="Zoom to visible resolution"
      onclick="${()=>this.zoomToVisibleResolution()}">
      <img alt="Zoom to visible resolution" src="icons/zoom.svg" />
    </button>

    <!-- zoom to full extent -->
    <button
      class="${this.layer.active&&this.layer instanceof Pt?"gg-button gg-small gg-opacity tool":"hidden"}"
      tip="Zoom to full extent"
      onclick="${()=>this.zoomToFullExtent()}">
      <img alt="Zoom to full extent" src="icons/zoom.svg" />
    </button>

    <!-- swipe icons -->
    <button
      class="${this.getButtonClass("swipedLeft")}"
      tip="Swipe layer to the left"
      onclick="${()=>this.layer.swiped=this.layer.swiped==="left"?"no":"left"}">
      <img alt="Swipe layer to the left" src="icons/swipe-left.svg" />
    </button>
    <button
      class="${this.getButtonClass("swipedRight")}"
      tip="Swipe layer to the right"
      onclick="${()=>this.layer.swiped=this.layer.swiped==="right"?"no":"right"}">
      <img alt="Swipe layer to the right" src="icons/swipe-right.svg" />
    </button>

    <!-- opacity icon -->
    <button id="opacity" class="${this.getButtonClass("opacity")}" tip="Control opacity">
      <img alt="Control opacity" src="icons/opacity.svg" />
    </button>

    <!-- Filter -->
    <button id="filter" class="${this.getButtonClass("filter")}" tip="Filter layer">
      <img alt="Filter layer" src="icons/filter.svg" />
    </button>

    <!-- Legend icon -->
    <button
      class="${this.hasLegend?"gg-button gg-small gg-opacity tool":"hidden"}"
      tip="Toggle legend"
      onclick="${()=>this.toggleLegend()}">
      <img alt="Toggle legend" src="icons/legend.svg" />
    </button>

    <!-- Metadata icon -->
    <button class="gg-button gg-small gg-opacity tool" tip="Show metadata" onclick="${()=>this.showMetadata()}">
      <img alt="Remove theme" src="icons/info.svg" />
    </button>

    <!-- Drag -->
    <button id="drag-button" class="gg-button gg-small gg-grab gg-opacity tool" tip="Move">
      <img alt="Move layer" src="icons/drag.svg" />
    </button>

    <!-- Remove icon -->
    <button class="remove gg-button gg-small gg-opacity tool" tip="Remove layer" onclick="${()=>this.deleteLayer()}">
      <img alt="Remove layer" src="icons/trash.svg" />
    </button>
  </header>

  ${Object.keys(this.legendUrls).map(i=>v`
  <div class="${this.isLegendExpanded?"legend":"hidden"}">
    <div class="gg-spacer gg-small"></div>
    <img alt="${"Legend for "+i}" src="${this.legendUrls[i]}" />
  </div>
  `)}

  <div class="${this.layer instanceof Pt&&this.isLegendExpanded?"legend-file":"legend-file hidden"}">
    <span>File from </span><span>${this.layer.lastModifiedDate}</span><span> [</span
    ><span>${(e=this.layer._features)==null?void 0:e.length} </span><span>features.]</span>
  </div>
</div>
`});o(this,"iconUrl",null);o(this,"legendUrls",{});o(this,"layer");this.layer=e}get hasLegend(){return this.layerManager.isLayerWithLegend(this.layer)&&this.layer.legend}get isLegendExpanded(){return this.layerManager.isLayerWithLegend(this.layer)?this.layer.isLegendExpanded:!1}toggleLegend(){this.layerManager.isLayerWithLegend(this.layer)&&(this.layer.isLegendExpanded=!this.layer.isLegendExpanded)}render(){const e=this.getAttribute("layerid");e&&(this.layer=this.layerManager.getTreeItem(e),this.layer instanceof Y&&this.setWmsLegend(),this.layer instanceof rt&&this.setWmtsLegend()),super.render(),this.createOpacityTooltip(),this.createFilterTooltip()}setWmsLegend(){this.layer instanceof Y&&(this.layer.iconUrl?this.iconUrl=this.layer.iconUrl:this.layer.legendRule?this.iconUrl=Object.values(this.getLegendImageUrlFromWms(!0))[0]:this.iconUrl=null,this.layer.legend&&(this.layer.legendImage?this.legendUrls[this.layer.layers]=this.layer.legendImage:this.legendUrls=this.getLegendImageUrlFromWms(!1)))}setWmtsLegend(){this.layer instanceof rt&&this.layer.legend&&(this.layer.legendImage?this.legendUrls[this.layer.name]=this.layer.legendImage:console.error(`The WMTS Layer ${this.layer.name} has no legendImage.`))}getLegendImageUrlFromWms(e){if(!(this.layer instanceof Y))throw new Error(`${this.layer.name} is not a WMS layer, this method should not be called.`);const i={};for(const s of this.layer.layers.split(",")){let r=new xn({url:this.layer.ogcServer.url,params:{LAYERS:s},ratio:1}).getLegendUrl(this.state.position.resolution);if(!r){console.error(`The URL for legend of layer ${s} could not be calculated.`),i[s]="";continue}r.toLowerCase().includes("sld_version")||(r+="&SLD_Version=1.1.0"),e&&(this.isNullOrUndefined(this.layer.legendRule)||(r+="&RULE="+encodeURIComponent(this.layer.legendRule)),r+="&HEIGHT="+this.configManager.Config.treeview.defaultIconSize.height,r+="&WIDTH="+this.configManager.Config.treeview.defaultIconSize.width),i[s]=r}return i}createOpacityTooltip(){const e=this.shadow.getElementById("opacity");pt(e,{trigger:"click",arrow:!0,interactive:!0,theme:"light",placement:"bottom-end",content:i=>{const s=document.createElement("input");return s.type="range",s.className="slider",s.min="0",s.max="20",s.value=(this.layer.opacity*20).toString(),s.oninput=()=>this.layer.opacity=parseInt(s.value)/20,s}})}createFilterTooltip(){const e=this.shadow.getElementById("filter");pt(e,{trigger:"click",arrow:!0,interactive:!0,theme:"light",placement:"right",appendTo:document.body,content:i=>new Qi(this.layer)})}registerEvents(){this.subscribe(/layers\..*\.isLegendExpanded/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.activeState/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.hasError/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.errorMessage/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.filter/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.opacity/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.swiped/,(e,i,s)=>this.refreshRender(s)),this.subscribe("treeview.advanced",()=>this.refreshRender(this.layer)),this.subscribe("position.resolution",()=>this.refreshLegends())}refreshLegends(){this.layer instanceof Y&&this.setWmsLegend(),super.refreshRender()}toggle(e){this.layerManager.toggleLayer(this.layer,e)}getButtonClass(e){const i="gg-button gg-small gg-opacity tool",s=i+" active";switch(e){case"swipedLeft":return this.layer.active?this.layer.swiped==="left"?s:i:"hidden";case"swipedRight":return this.layer.active?this.layer.swiped==="right"?s:i:"hidden";case"opacity":return this.layer.active?this.layer.opacity<1?s:i:"hidden";case"filter":return this.layer.active&&this.layer instanceof Y&&this.layer.queryable?this.layer.hasFilter?s:i:"hidden";default:throw Error("Unsupported type: "+e)}}zoomToVisibleResolution(){if(!(this.layer instanceof Y))throw new Error(`${this.layer.name} is not a WMS layer, this method should not be called here.`);if(this.layer.maxResolution){const e=this.layer.maxResolution-.1*this.layer.maxResolution;this.state.position.resolution=e}}zoomToFullExtent(){if(!(this.layer instanceof Pt))throw new Error(`${this.layer.name} is not a LocalFile layer, this method should not be called here.`);xt.getInstance().zoomToExtent(this.layer.extent)}deleteLayer(){this.layerManager.toggleLayer(this.layer,"off"),setTimeout(()=>{const e=this.layer.parent.children.findIndex(i=>i===this.layer);this.layer.parent.children.splice(e,1)})}connectedCallback(){this.loadConfig().then(()=>{this.render(),this.registerEvents()})}}class ts extends es{constructor(e,i){super(e,i);o(this,"layer");this.layer=e}sortedChildren(){return Te.getSortedLayers(this.layer.children)}deactivateThemeOrGroup(e){if(e.activeState="off",e instanceof J||e instanceof ie)for(const i of e.children)this.deactivateThemeOrGroup(i)}onChildrenListChanged(e,i,s){this.refreshRender(s);const n=i.filter(r=>!e.find(a=>a.treeItemId===r.treeItemId));Te.activateDefaultLayers(n)}toggle(e){this.layerManager.toggleGroupOrTheme(this.layer,e)}}class ro extends ts{constructor(e){super(e,"treeviewgroup");o(this,"template",()=>v`<style>
header{border-top:solid 1px #ddd;display:flex;align-items:center}.tool{display:none!important;padding-left:0!important;padding-right:0!important;min-width:0!important;max-width:1.5rem!important}header:hover .tool{display:flex!important}.tool.active{display:flex!important;opacity:1!important}.label-container{display:flex;flex-grow:1;align-items:center;overflow:auto}.legend{display:flex}.children{padding-left:1.6rem;flex-basis:100%;order:10}.dragAfter{border-bottom:dashed 1rem #ccc}.dragBefore{border-top:dashed 1rem #ccc}
</style><style>
.hidden{display:none}.rotate90{transform:rotate(90deg)}.rotate180{transform:rotate(180deg)}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#999}.gg-button{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.gg-button:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.gg-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.gg-small img{overflow:hidden}.gg-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.gg-check{padding:.2rem}.gg-label{text-align:left;padding-left:0;white-space:nowrap}.gg-grab:hover{cursor:grab}.gg-spacer{padding:0}.gg-opacity{opacity:.5}.gg-opacity:hover{background-color:transparent;opacity:1}.gg-selected{font-weight:700;opacity:1}.girafe-button-big,.girafe-button-large,.girafe-button-medium,.girafe-button-small,.girafe-button-tiny{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.girafe-button-big:hover,.girafe-button-large:hover,.girafe-button-medium:hover,.girafe-button-small:hover,.girafe-button-tiny:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.girafe-button-big.dark,.girafe-button-large.dark,.girafe-button-medium.dark,.girafe-button-small.dark,.girafe-button-tiny.dark{background-color:var(--bkg-color);filter:invert(1)}img{filter:var(--svg-filter)}.girafe-button-big{width:4rem;height:4rem;align-items:center;padding:1rem}.girafe-button-big img{overflow:hidden}.girafe-button-medium{flex-direction:column;width:4rem;align-items:center}.girafe-button-medium img{margin:1rem;width:1.5rem}.girafe-button-medium span{display:block;margin-top:-.8rem;margin-bottom:.8rem}.girafe-button-large{flex-direction:row}.girafe-button-large img{margin:.3rem;height:2rem}.girafe-button-large span{line-height:2rem;height:2rem;margin:.3rem}.girafe-button-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.girafe-button-small img{overflow:hidden}.girafe-button-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.girafe-button-tiny{width:1rem;height:1rem;align-items:center;padding:0}.girafe-button-tiny img{overflow:hidden}
</style>
<link rel="stylesheet" href="lib/tippy.js/tippy.css" />
<link rel="stylesheet" href="lib/tippy.js/backdrop.css" />
<link rel="stylesheet" href="lib/tippy.js/border.css" />
<link rel="stylesheet" href="lib/tippy.js/svg-arrow.css" />

<div id="container">
  <header>
    <!-- Caret -->
    <button
      class="gg-button gg-small gg-opacity"
      tip="Expand / Collapse"
      onclick="${()=>this.layer.isExpanded=!this.layer.isExpanded}">
      <img
        class="${this.layer.isExpanded?"rotate90":""}"
        alt="Expand/Collapse button"
        src="icons/expand.svg" />
    </button>

    <!-- Checkbox -->
    <button
      class="${this.layer.activeState==="on"?"gg-button gg-small gg-check gg-opacity gg-selected":"gg-button gg-small gg-check gg-opacity"}"
      tip="Activate / Deactivate"
      onclick="${()=>this.toggle()}">
      <img
        class="${this.layer.activeState==="on"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-full.svg" />
      <img
        class="${this.layer.activeState==="semi"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-half.svg" />
      <img
        class="${this.layer.activeState==="off"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-no.svg" />
    </button>

    <!-- Error icon -->
    <button class="${this.layer.hasError?"gg-button gg-small gg-opacity":"hidden"}" tip="Error on layer">
      <img alt="Error on layer" src="icons/error.svg" />
    </button>

    <!-- Label -->
    <div class="label-container">
      <button
        class="${this.layer.activeState==="on"?"gg-button gg-small gg-label gg-opacity gg-selected":"gg-button gg-small gg-label gg-opacity"}"
        onclick="${()=>this.toggle()}">
        <span i18n="${this.layer.name}"> ${this.layer.name} </span>
      </button>
    </div>

    <!-- Metadata icon -->
    <button
      class="${this.layer.hasMetadata?"metadata gg-button gg-small gg-opacity tool":"hidden"}"
      tip="Show metadata"
      onclick="${()=>this.showMetadata()}">
      <img alt="Remove theme" src="icons/info.svg" />
    </button>

    <!-- Drag -->
    <button id="drag-button" class="gg-button gg-small gg-grab gg-opacity tool" tip="Move">
      <img alt="Move layer" src="icons/drag.svg" />
    </button>

    <!-- Remove icon -->
    <button class="remove gg-button gg-small gg-opacity tool" tip="Remove theme" onclick="${()=>this.deleteGroup()}">
      <img alt="Remove theme" src="icons/trash.svg" />
    </button>
  </header>

  <!-- Sub layers -->
  <div class="${this.layer.isExpanded?"children":"hidden"}">
    <!-- prettier-ignore -->
    ${this.sortedChildren().map(e=>e instanceof ie?U(e,e.treeItemId)`
    <girafe-tree-view-group groupid="${e.treeItemId}"></girafe-tree-view-group>
    `:U(e,e.treeItemId)`
    <girafe-tree-view-item layerid="${e.treeItemId}"></girafe-tree-view-item>
    `)}
  </div>
</div>
`);o(this,"layer");this.layer=e}render(){const e=this.getAttribute("groupid");e&&(this.layer=this.layerManager.getTreeItem(e)),super.render()}registerEvents(){this.subscribe(/layers\.layersList\..*\.isExpanded/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.activeState/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.children/,(e,i,s)=>this.onChildrenListChanged(e,i,s)),this.subscribe(/layers\.layersList\..*\.order/,(e,i,s)=>{this.refreshRender(s),this.refreshRender(s.parent)})}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}deleteGroup(){this.deactivateThemeOrGroup(this.layer),setTimeout(()=>{if(this.layer.parent){const e=this.layer.parent.children.findIndex(i=>i===this.layer);this.layer.parent.children.splice(e,1)}})}}class oo extends ts{constructor(e){super(e,"treeviewtheme");o(this,"template",()=>v`<style>
header{border-top:solid 1px #ddd;display:flex;align-items:center}.tool{display:none!important;padding-left:0!important;padding-right:0!important;min-width:0!important;max-width:1.5rem!important}header:hover .tool{display:flex!important}.tool.active{display:flex!important;opacity:1!important}.label-container{display:flex;flex-grow:1;align-items:center;overflow:auto}.legend{display:flex}.children{padding-left:1.6rem;flex-basis:100%;order:10}.dragAfter{border-bottom:dashed 1rem #ccc}.dragBefore{border-top:dashed 1rem #ccc}
</style><style>
.hidden{display:none}.rotate90{transform:rotate(90deg)}.rotate180{transform:rotate(180deg)}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#999}.gg-button{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.gg-button:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.gg-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.gg-small img{overflow:hidden}.gg-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.gg-check{padding:.2rem}.gg-label{text-align:left;padding-left:0;white-space:nowrap}.gg-grab:hover{cursor:grab}.gg-spacer{padding:0}.gg-opacity{opacity:.5}.gg-opacity:hover{background-color:transparent;opacity:1}.gg-selected{font-weight:700;opacity:1}.girafe-button-big,.girafe-button-large,.girafe-button-medium,.girafe-button-small,.girafe-button-tiny{border:none;background-color:transparent;display:flex;flex-direction:column;color:var(--text-color)}.girafe-button-big:hover,.girafe-button-large:hover,.girafe-button-medium:hover,.girafe-button-small:hover,.girafe-button-tiny:hover{background-color:var(--bkg-color-grad1);cursor:pointer}.girafe-button-big.dark,.girafe-button-large.dark,.girafe-button-medium.dark,.girafe-button-small.dark,.girafe-button-tiny.dark{background-color:var(--bkg-color);filter:invert(1)}img{filter:var(--svg-filter)}.girafe-button-big{width:4rem;height:4rem;align-items:center;padding:1rem}.girafe-button-big img{overflow:hidden}.girafe-button-medium{flex-direction:column;width:4rem;align-items:center}.girafe-button-medium img{margin:1rem;width:1.5rem}.girafe-button-medium span{display:block;margin-top:-.8rem;margin-bottom:.8rem}.girafe-button-large{flex-direction:row}.girafe-button-large img{margin:.3rem;height:2rem}.girafe-button-large span{line-height:2rem;height:2rem;margin:.3rem}.girafe-button-small{min-width:2rem;height:2rem;align-items:center;padding:.5rem}.girafe-button-small img{overflow:hidden}.girafe-button-small span{width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis}.girafe-button-tiny{width:1rem;height:1rem;align-items:center;padding:0}.girafe-button-tiny img{overflow:hidden}
</style>
<link rel="stylesheet" href="lib/tippy.js/tippy.css" />
<link rel="stylesheet" href="lib/tippy.js/backdrop.css" />
<link rel="stylesheet" href="lib/tippy.js/border.css" />
<link rel="stylesheet" href="lib/tippy.js/svg-arrow.css" />

<div id="container">
  <header>
    <!-- Caret -->
    <button
      class="gg-button gg-small gg-opacity"
      tip="Expand / Collapse"
      onclick="${()=>this.layer.isExpanded=!this.layer.isExpanded}">
      <img
        class="${this.layer.isExpanded?"rotate90":""}"
        alt="Expand/Collapse button"
        src="icons/expand.svg" />
    </button>

    <!-- Checkbox -->
    <button
      class="${this.layer.activeState==="on"?"gg-button gg-small gg-check gg-opacity gg-selected":"gg-button gg-small gg-check gg-opacity"}"
      tip="Activate / Deactivate"
      onclick="${()=>this.toggle()}">
      <img
        class="${this.layer.activeState==="on"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-full.svg" />
      <img
        class="${this.layer.activeState==="semi"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-half.svg" />
      <img
        class="${this.layer.activeState==="off"?"":"hidden"}"
        alt="Expand/Collapse button"
        src="icons/checked-no.svg" />
    </button>

    <!-- Error icon -->
    <button class="${this.layer.hasError?"error gg-button gg-small gg-opacity":"hidden"}" tip="Error on layer">
      <img alt="Error on layer" src="icons/error.svg" />
    </button>

    <!-- Label -->
    <div class="label-container">
      <button
        class="${this.layer.activeState==="on"?"gg-button gg-small gg-label gg-opacity gg-selected":"gg-button gg-small gg-label gg-opacity"}"
        onclick="${()=>this.toggle()}">
        <span i18n="${this.layer.name}"> ${this.layer.name} </span>
      </button>
    </div>

    <!-- Drag -->
    <button id="drag-button" class="gg-button gg-small gg-grab gg-opacity tool" tip="Move">
      <img alt="Move layer" src="icons/drag.svg" />
    </button>

    <!-- Remove icon -->
    <button class="remove gg-button gg-small gg-opacity tool" tip="Remove theme" onclick="${()=>this.deleteTheme()}">
      <img alt="Remove theme" src="icons/trash.svg" />
    </button>
  </header>

  <!-- Sub layers -->
  <div class="${this.layer.isExpanded?"children":"hidden"}">
    <!-- prettier-ignore -->
    ${this.sortedChildren().map(e=>e instanceof ie?U(e,e.treeItemId)`
    <girafe-tree-view-group groupid="${e.treeItemId}"></girafe-tree-view-group>
    `:U(e,e.treeItemId)`
    <girafe-tree-view-item layerid="${e.treeItemId}"></girafe-tree-view-item>
    `)}
  </div>
</div>
`);o(this,"layer");this.layer=e}render(){const e=this.getAttribute("themeid");e&&(this.layer=this.layerManager.getTreeItem(e)),super.render()}registerEvents(){this.subscribe(/layers\.layersList\..*\.isExpanded/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.activeState/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.children/,(e,i,s)=>this.onChildrenListChanged(e,i,s)),this.subscribe(/layers\.layersList\..*\.filter/,(e,i,s)=>this.refreshRender(s)),this.subscribe(/layers\.layersList\..*\.order/,(e,i,s)=>{this.refreshRender(s),this.refreshRender(s.parent)})}connectedCallback(){this.loadConfig().then(()=>{this.render(),super.girafeTranslate(),this.registerEvents()})}deleteTheme(){this.deactivateThemeOrGroup(this.layer),setTimeout(()=>{const e=this.state.layers.layersList.findIndex(i=>i===this.layer);this.state.layers.layersList.splice(e,1),this.state.themes.lastSelectedTheme=null})}}const ao="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20576%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M0%20128C0%2092.7%2028.7%2064%2064%2064H320c35.3%200%2064%2028.7%2064%2064V384c0%2035.3-28.7%2064-64%2064H64c-35.3%200-64-28.7-64-64V128zM559.1%2099.8c10.4%205.6%2016.9%2016.4%2016.9%2028.2V384c0%2011.8-6.5%2022.6-16.9%2028.2s-23%205-32.9-1.6l-96-64L416%20337.1V320%20192%20174.9l14.2-9.5%2096-64c9.8-6.5%2022.4-7.2%2032.9-1.6z'/%3e%3c/svg%3e",lo="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20384%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M0%20128C0%2092.7%2028.7%2064%2064%2064H320c35.3%200%2064%2028.7%2064%2064V384c0%2035.3-28.7%2064-64%2064H64c-35.3%200-64-28.7-64-64V128z'/%3e%3c/svg%3e",co="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3e%3c!--!Font%20Awesome%20Free%206.5.2%20by%20@fontawesome%20-%20https://fontawesome.com%20License%20-%20https://fontawesome.com/license/free%20Copyright%202024%20Fonticons,%20Inc.--%3e%3cpath%20d='M256%20464a208%20208%200%201%201%200-416%20208%20208%200%201%201%200%20416zM256%200a256%20256%200%201%200%200%20512A256%20256%200%201%200%20256%200zM376.9%20294.6c4.5-4.2%207.1-10.1%207.1-16.3c0-12.3-10-22.3-22.3-22.3H304V160c0-17.7-14.3-32-32-32l-32%200c-17.7%200-32%2014.3-32%2032v96H150.3C138%20256%20128%20266%20128%20278.3c0%206.2%202.6%2012.1%207.1%2016.3l107.1%2099.9c3.8%203.5%208.7%205.5%2013.8%205.5s10.1-2%2013.8-5.5l107.1-99.9z'/%3e%3c/svg%3e";class ho extends P{constructor(){super("videorecord");o(this,"template",()=>v`
<link rel="stylesheet" href="styles/common.css" />

<button
  class="${this.status==="downloaded"?"girafe-button-big":"hidden"}"
  onclick="${()=>this.startRecording()}">
  <img alt="help-icon" src="${this.videoIcon}" />
</button>
<button class="${this.status==="recording"?"girafe-button-big":"hidden"}" onclick="${()=>this.stopRecording()}">
  <img alt="help-icon" src="${this.stopIcon}" />
</button>
<button class="${this.status==="recorded"?"girafe-button-big":"hidden"}" onclick="${()=>this.downloadRecord()}">
  <img alt="help-icon" src="${this.downloadIcon}" />
</button>
`);o(this,"videoIcon",ao);o(this,"stopIcon",lo);o(this,"downloadIcon",co);o(this,"status","downloaded");o(this,"mediaRecorder",null);o(this,"chunks",[]);o(this,"stream",null)}connectedCallback(){this.loadConfig().then(()=>{super.render(),super.girafeTranslate()})}async startRecording(){if(this.status="recording",super.render(),this.chunks=[],this.mediaRecorder)try{this.mediaRecorder.start()}catch{this.mediaRecorder=null}this.mediaRecorder||await this.initializeMediaRecorder()&&this.mediaRecorder.start()}async initializeMediaRecorder(){try{return this.stream=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}}}),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:"video/webm; codecs:vp9",bitsPerSecond:5e6}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.chunks.push(e.data)},!0}catch(e){console.warn("Unable to activate recording : "+e),this.status="downloaded",super.render()}return!1}stopRecording(){var e;this.status="recorded",super.render(),(e=this.mediaRecorder)==null||e.stop()}downloadRecord(){this.status="downloaded",super.render();const e=new Blob(this.chunks,{type:"video/webm"}),i=Ct()+".webm",s=URL.createObjectURL(e),n=document.createElement("a");n.style.display="none",n.href=s,n.download=i,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(s)}}(navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("Android"))&&(window.location.href="mobile.html");try{window.CESIUM_BASE_URL="lib/cesium/",Re.defs("EPSG:21781","+proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=600000 +y_0=200000 +ellps=bessel +towgs84=660.077,13.551,369.344,2.484,1.783,2.939,5.66 +units=m +no_defs"),Re.defs("EPSG:2056","+proj=somerc +lat_0=46.9524055555556 +lon_0=7.43958333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs +type=crs"),xs(Re),pt.setDefaultProps({maxWidth:""}),kt.getInstance(),Cs.getInstance().initLogging().then(()=>{ks.getInstance(),Pi.getInstance(),ae.getInstance(),Ss.getInstance(),Ti.getInstance(),Ln.getInstance(),document.geogirafe={state:W.getInstance().state,stateManager:W.getInstance(),shareManager:Wt.getInstance(),offlineManager:Ls.getInstance()},customElements.define("girafe-about",_n),customElements.define("girafe-basemap",En),customElements.define("girafe-colorswitcher",Pn),customElements.define("girafe-coordinate",Tn),customElements.define("girafe-globe-select",Dn),customElements.define("girafe-help",Bn),customElements.define("girafe-metadata-window",Vn),customElements.define("girafe-infobox",Nn),customElements.define("girafe-language-select",On),customElements.define("girafe-lidar-panel",rr),customElements.define("girafe-lidar-profile",ar),customElements.define("girafe-lr-panel",lr),customElements.define("girafe-map",Fi),customElements.define("girafe-menu-button",mr),customElements.define("girafe-nav-bookmarks",Ki),customElements.define("girafe-nav-history",xr),customElements.define("girafe-print",ke),customElements.define("girafe-prototype-banner",Tr),customElements.define("girafe-proj-select",Pr),customElements.define("girafe-query-builder",Qi),customElements.define("girafe-drawing",zr),customElements.define("girafe-scale",Br),customElements.define("girafe-search",Ms),customElements.define("girafe-selection-grid",Or),customElements.define("girafe-selection-window",si),customElements.define("girafe-share",Jr),customElements.define("girafe-theme-select",to),customElements.define("girafe-tree-view",io),customElements.define("girafe-tree-view-group",ro),customElements.define("girafe-tree-view-item",no),customElements.define("girafe-tree-view-theme",oo),customElements.define("girafe-video-record",ho)})}finally{document.documentElement.style.opacity="1"}
//# sourceMappingURL=desktop-5p69HYTv.js.map
