var fe=Object.defineProperty;var pe=(c,e,t)=>e in c?fe(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var p=(c,e,t)=>(pe(c,typeof e!="symbol"?e+"":e,t),t);import{B as _e,C as Ce,r as ye,a as ve,u as Pe,l as Le,M as Se,o as Ee,b as we,c as be,d as ie,g as Te,e as Re,I as Oe,f as se,h as R,i as Fe,E as D,j as xe,k as ne,m as re,t as oe,n as Ae,p as j,q,s as Ie,v as Me,w as Ge,x as Ne,D as Y,y as Ve,z as I,A as ke,F as X,G as De,H as je,J as ze,K as W,L as z,N as Ke,T as Ue,O as He,S as We,P as Be,Q as $,U as qe,V as Ye,W as Xe,X as $e,Y as Ze,Z as B,$ as Qe,a0 as Je,a1 as et,a2 as L,a3 as K,a4 as U,a5 as tt,a6 as it,a7 as st,a8 as Z,a9 as nt,aa as Q,ab as rt,ac as ot}from"./index-3fb1374e.js";import"./lazy-af36d162.js";const v={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class at extends _e{constructor(e){super(),this.on,this.once,this.un,this.options=e,this.id=e.id,this.insertFirst=e.insertFirst!==void 0?e.insertFirst:!0,this.stopEvent=e.stopEvent!==void 0?e.stopEvent:!0,this.element=document.createElement("div"),this.element.className=e.className!==void 0?e.className:"ol-overlay-container "+Ce,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=e.autoPan===!0?{}:e.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(v.ELEMENT,this.handleElementChanged),this.addChangeListener(v.MAP,this.handleMapChanged),this.addChangeListener(v.OFFSET,this.handleOffsetChanged),this.addChangeListener(v.POSITION,this.handlePositionChanged),this.addChangeListener(v.POSITIONING,this.handlePositioningChanged),e.element!==void 0&&this.setElement(e.element),this.setOffset(e.offset!==void 0?e.offset:[0,0]),this.setPositioning(e.positioning||"top-left"),e.position!==void 0&&this.setPosition(e.position)}getElement(){return this.get(v.ELEMENT)}getId(){return this.id}getMap(){return this.get(v.MAP)||null}getOffset(){return this.get(v.OFFSET)}getPosition(){return this.get(v.POSITION)}getPositioning(){return this.get(v.POSITIONING)}handleElementChanged(){ye(this.element);const e=this.getElement();e&&this.element.appendChild(e)}handleMapChanged(){this.mapPostrenderListenerKey&&(ve(this.element),Pe(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const e=this.getMap();if(e){this.mapPostrenderListenerKey=Le(e,Se.POSTRENDER,this.render,this),this.updatePixelPosition();const t=this.stopEvent?e.getOverlayContainerStopEvent():e.getOverlayContainer();this.insertFirst?t.insertBefore(this.element,t.childNodes[0]||null):t.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(e){this.set(v.ELEMENT,e)}setMap(e){this.set(v.MAP,e)}setOffset(e){this.set(v.OFFSET,e)}setPosition(e){this.set(v.POSITION,e)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(e){const t=this.getMap();if(!t||!t.getTargetElement()||!this.get(v.POSITION))return;const i=this.getRect(t.getTargetElement(),t.getSize()),s=this.getElement(),n=this.getRect(s,[Ee(s),we(s)]);e=e||{};const r=e.margin===void 0?20:e.margin;if(!be(i,n)){const o=n[0]-i[0],a=i[2]-n[2],l=n[1]-i[1],d=i[3]-n[3],u=[0,0];if(o<0?u[0]=o-r:a<0&&(u[0]=Math.abs(a)+r),l<0?u[1]=l-r:d<0&&(u[1]=Math.abs(d)+r),u[0]!==0||u[1]!==0){const h=t.getView().getCenterInternal(),m=t.getPixelFromCoordinateInternal(h);if(!m)return;const g=[m[0]+u[0],m[1]+u[1]],f=e.animation||{};t.getView().animateInternal({center:t.getCoordinateFromPixelInternal(g),duration:f.duration,easing:f.easing})}}}getRect(e,t){const i=e.getBoundingClientRect(),s=i.left+window.pageXOffset,n=i.top+window.pageYOffset;return[s,n,s+t[0],n+t[1]]}setPositioning(e){this.set(v.POSITIONING,e)}setVisible(e){this.rendered.visible!==e&&(this.element.style.display=e?"":"none",this.rendered.visible=e)}updatePixelPosition(){const e=this.getMap(),t=this.getPosition();if(!e||!e.isRendered()||!t){this.setVisible(!1);return}const i=e.getPixelFromCoordinate(t),s=e.getSize();this.updateRenderedPosition(i,s)}updateRenderedPosition(e,t){const i=this.element.style,s=this.getOffset(),n=this.getPositioning();this.setVisible(!0);const r=Math.round(e[0]+s[0])+"px",o=Math.round(e[1]+s[1])+"px";let a="0%",l="0%";n=="bottom-right"||n=="center-right"||n=="top-right"?a="-100%":(n=="bottom-center"||n=="center-center"||n=="top-center")&&(a="-50%"),n=="bottom-left"||n=="bottom-center"||n=="bottom-right"?l="-100%":(n=="center-left"||n=="center-center"||n=="center-right")&&(l="-50%");const d=`translate(${a}, ${l}) translate(${r}, ${o})`;this.rendered.transform_!=d&&(this.rendered.transform_=d,i.transform=d)}getOptions(){return this.options}}const ct=at;let O,ae;function H(){if(O===void 0){const c=document.createElement("canvas");c.setAttribute("style","image-rendering: -moz-crisp-edges; image-rendering: pixelated;");const e=c.style.imageRendering;O=!!e,O&&(ae=e)}return O}function lt(){return H(),ae||""}function A(c){return c.get("olcs.projection")||c.getProjection()}function S(c,e,t){return c.on(e,t)}let ht=0;function y(c){return c.olcs_uid||(c.olcs_uid=++ht)}function ut(c,e){const t=c.length,i=Array(c.length);for(let s=0;s<t;s++)i[s]={index:s,value:c[s]};i.sort((s,n)=>e(s.value,n.value)||s.index-n.index);for(let s=0;s<c.length;s++)c[s]=i[s].value}function dt(c){return c&&c.parentNode?c.parentNode.removeChild(c):null}function mt(c){for(;c.lastChild;)c.removeChild(c.lastChild)}function G(c){const e=Cesium.GroundPolylinePrimitive;return e&&e.isSupported(c)}function N(c){const e=c.readyPromise;return e||(c.ready!==void 0?c.ready?Promise.resolve(c):new Promise((t,i)=>{const s=setInterval(()=>{c.ready&&(clearInterval(s),t(c))},20)}):Promise.reject("Not a readyable object"))}function gt(c){const e=c.load||ie,t=c.imageExtent,i=new Image;return c.crossOrigin!==null&&(i.crossOrigin=c.crossOrigin),()=>e(i,c.url).then(s=>{const n=Te(t)/s.width,r=Re(t)/s.height;return{image:s,extent:t,resolution:n!==r?[n,r]:r,pixelRatio:1}})}class ft extends Oe{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,i=e.imageLoadFunction!==void 0?e.imageLoadFunction:se;super({attributions:e.attributions,interpolate:e.interpolate,projection:R(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new Fe(this.imageExtent_,void 0,1,gt({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(s,n)=>(this.image.setImage(s),i(this.image,n),ie(s))})),this.image.addEventListener(D.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,i,s){return xe(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const pt=ft;class _t extends ne{constructor(e){e=e||{};const t=Object.assign({},e.params),i="TRANSPARENT"in t?t.TRANSPARENT:!0;super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,opaque:!i,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.params_=t,this.v13_=!0,this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=re(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(e,t,i,s){const n=R(i),r=this.getProjection()||n;let o=this.getTileGrid();o||(o=this.getTileGridForProjection(r));const a=oe(e,n,r),l=Ae(r,n,e,t),d=o.getZForResolution(l,this.zDirection),u=o.getResolution(d),h=o.getTileCoordForCoordAndZ(a,d);if(o.getResolutions().length<=h[0])return;let m=o.getTileCoordExtent(h,this.tmpExtent_);const g=this.gutter_;g!==0&&(m=j(m,u*g,m));const f={QUERY_LAYERS:this.params_.LAYERS};Object.assign(f,q(this.params_,"GetFeatureInfo"),s);const _=Math.floor((a[0]-m[0])/u),C=Math.floor((m[3]-a[1])/u);return f[this.v13_?"I":"X"]=_,f[this.v13_?"J":"Y"]=C,this.getRequestUrl_(h,m,1,r||n,f)}getLegendUrl(e,t){if(this.urls[0]===void 0)return;const i={SERVICE:"WMS",VERSION:Y,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t===void 0||t.LAYER===void 0){const s=this.params_.LAYERS;if(!(!Array.isArray(s)||s.length===1))return;i.LAYER=s}if(e!==void 0){const s=this.getProjection()?this.getProjection().getMetersPerUnit():1,n=28e-5;i.SCALE=e*s/n}return Object.assign(i,t),Ie(this.urls[0],i)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(e,t,i,s,n){const r=this.urls;if(!r)return;let o;if(r.length==1)o=r[0];else{const a=Me(Ge(e),r.length);o=r[a]}return Ne(t,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),i,s,o,n,this.serverType_)}getTilePixelRatio(e){return!this.hidpi_||this.serverType_===void 0?1:e}getKeyForParams_(){let e=0;const t=[];for(const i in this.params_)t[e++]=i+"-"+this.params_[i];return t.join("/")}updateParams(e){Object.assign(this.params_,e),this.updateV13_(),this.setKey(this.getKeyForParams_())}updateV13_(){const e=this.params_.VERSION||Y;this.v13_=Ve(e,"1.3")>=0}tileUrlFunction(e,t,i){let s=this.getTileGrid();if(s||(s=this.getTileGridForProjection(i)),s.getResolutions().length<=e[0])return;t!=1&&(!this.hidpi_||this.serverType_===void 0)&&(t=1);const n=s.getResolution(e[0]);let r=s.getTileCoordExtent(e,this.tmpExtent_);const o=this.gutter_;o!==0&&(r=j(r,n*o,r));const a=Object.assign({},q(this.params_,"GetMap"));return this.getRequestUrl_(e,r,t,i,a)}}const Ct=_t;class yt extends I{constructor(e){super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const i=t.getGeometry();return ke(!i||i.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),i},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,i){this.source.loadFeatures(e,t,i),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(D.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(D.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const i=e===0?0:Math.min(t,e)/e,s=e!==this.distance||this.interpolationRatio!==i;this.distance=e,this.minDistance=t,this.interpolationRatio=i,s&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=re(),t=this.distance*this.resolution,i=this.source.getFeatures(),s={};for(let n=0,r=i.length;n<r;n++){const o=i[n];if(!(X(o)in s)){const a=this.geometryFunction(o);if(a){const l=a.getCoordinates();De(l,e),j(e,t,e);const d=this.source.getFeaturesInExtent(e).filter(function(u){const h=X(u);return h in s?!1:(s[h]=!0,!0)});this.features.push(this.createCluster(d,e))}}}}createCluster(e,t){const i=[0,0];for(let o=e.length-1;o>=0;--o){const a=this.geometryFunction(e[o]);a?je(i,a.getCoordinates()):e.splice(o,1)}ze(i,1/e.length);const s=W(t),n=this.interpolationRatio,r=new z([i[0]*(1-n)+s[0]*n,i[1]*(1-n)+s[1]*n]);return this.createCustomCluster_?this.createCustomCluster_(r,e):new Ke({geometry:r,features:e})}}const ce=yt,vt=function(){const e=new Ue({projection:"EPSG:3857",wrapX:!0}).getTileCoordForTileUrlFunction([6,-31,22]);return e&&e[1]===33&&e[2]===22}();class le{constructor(e,t,i){this.source_=t,this.projection_=null,this.fallbackProj_=i||null,this.ready_=!1,this.tilingScheme_=new Cesium.WebMercatorTilingScheme,this.rectangle_=null,this.map_=e,this.shouldRequestNextLevel=!1;const s=this.source_.get("olcs.proxy");s&&(typeof s=="function"?this.proxy_={getURL:s}:typeof s=="string"&&(this.proxy_=new Cesium.DefaultProxy(s))),this.errorEvent_=new Cesium.Event,this.emptyCanvas_=document.createElement("canvas"),this.emptyCanvas_.width=1,this.emptyCanvas_.height=1,this.source_.on("change",n=>{this.handleSourceChanged_()}),this.handleSourceChanged_()}handleSourceChanged_(e){if(!this.ready_&&this.source_.getState()=="ready"){this.projection_=A(this.source_)||this.fallbackProj_;const t={numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1};if(this.source_.tileGrid!==null&&this.source_.tileGrid.forEachTileCoord(this.projection_.getExtent(),0,([i,s,n])=>{t.numberOfLevelZeroTilesX=s+1,t.numberOfLevelZeroTilesY=n+1}),this.projection_.getCode()==="EPSG:4326")this.shouldRequestNextLevel=t.numberOfLevelZeroTilesX===1&&t.numberOfLevelZeroTilesY===1,this.tilingScheme_=new Cesium.GeographicTilingScheme(t);else if(this.projection_.getCode()==="EPSG:3857")this.shouldRequestNextLevel=!1,this.tilingScheme_=new Cesium.WebMercatorTilingScheme(t);else return;this.rectangle_=this.tilingScheme_.rectangle,this.ready_=!0}}getTileCredits(e,t,i){const s=this.source_.getAttributions();if(!s)return[];const n=this.map_.getView().calculateExtent(this.map_.getSize()),r=this.map_.getView().getCenter(),o=this.shouldRequestNextLevel?i+1:i;return ue(s,o,r,n)}requestImage(e,t,i){const s=this.source_.getTileUrlFunction();if(s&&this.projection_){const n=this.shouldRequestNextLevel?i+1:i;let r=t;vt||(r=-t-1);let o=s.call(this.source_,[n,e,r],1,this.projection_);return this.proxy_&&(o=this.proxy_.getURL(o)),o?Cesium.ImageryProvider.loadImage(this,o):this.emptyCanvas_}else return this.emptyCanvas_}}Object.defineProperties(le.prototype,{ready:{get:function(){return this.ready_}},_ready:{get:function(){return this.ready_}},rectangle:{get:function(){return this.rectangle_}},tileWidth:{get:function(){const c=this.source_.getTileGrid();return c?Array.isArray(c.getTileSize(0))?c.getTileSize(0)[0]:c.getTileSize(0):256}},tileHeight:{get:function(){const c=this.source_.getTileGrid();return c?Array.isArray(c.getTileSize(0))?c.getTileSize(0)[1]:c.getTileSize(0):256}},maximumLevel:{get:function(){const c=this.source_.getTileGrid();return c?c.getMaxZoom():18}},minimumLevel:{get:function(){return 0}},tilingScheme:{get:function(){return this.tilingScheme_}},tileDiscardPolicy:{get:function(){}},errorEvent:{get:function(){return this.errorEvent_}},proxy:{get:function(){return this.proxy_}},hasAlphaChannel:{get:function(){return!0}},pickFeatures:{get:function(){}}});const Pt=new He,Lt=[new We({stroke:new Be({color:"blue",width:2})})];class St{constructor(e){this.urls=e.urls,this.ready=!0,this.readyPromise=Promise.resolve(!0),this.tileWidth=256,this.tileHeight=256,this.maximumLevel=e.maximumLevel||20,this.minimumLevel=e.minimumLevel||0,this.tilingScheme=new Cesium.WebMercatorTilingScheme,this.rectangle=e.rectangle||this.tilingScheme.rectangle,this.errorEvent=new Cesium.Event,this.credit=e.credit,this.hasAlphaChannel=!0,this.styleFunction_=e.styleFunction||(()=>Lt),this.projection_=R("EPSG:3857"),this.emptyCanvas_=document.createElement("canvas"),this.emptyCanvas_.width=1,this.emptyCanvas_.height=1,this.tileRectangle_=new Cesium.Rectangle;const t=e.cacheSize!==void 0?e.cacheSize:50;this.tileCache=new $(t),this.featureCache=e.featureCache||new $(t);const i=qe(this.projection_);this.tileFunction_=Ye(this.urls,i)}getTileCredits(){return[]}pickFeatures(){}getTileFeatures(e,t,i){const s=this.getCacheKey_(e,t,i);let n;if(this.featureCache.containsKey(s)&&(n=this.featureCache.get(s)),!n){const r=this.getUrl_(e,t,i);if(n=fetch(r).then(o=>o.ok?o:Promise.reject(o)).then(o=>o.arrayBuffer()).then(o=>this.readFeaturesFromBuffer(o)),this.featureCache.set(s,n),this.featureCache.getCount()>2*this.featureCache.highWaterMark)for(;this.featureCache.canExpireCache();)this.featureCache.pop()}return n}readFeaturesFromBuffer(e){let t;const i=Pt.readFeatures(e,t),s=this.tileWidth/4096;return i.forEach(n=>{const r=n.getFlatCoordinates();for(let o=0;o<r.length;++o)r[o]*=s}),i}getUrl_(e,t,i){return this.tileFunction_([e,t,i])}getCacheKey_(e,t,i){return`${e}_${t}_${i}`}requestImage(e,t,i,s){if(i<this.minimumLevel)return this.emptyCanvas_;try{const n=this.getCacheKey_(i,e,t);let r;if(this.tileCache.containsKey(n)&&(r=this.tileCache.get(n)),!r&&(r=this.getTileFeatures(i,e,t).then(o=>{this.tilingScheme.tileXYToNativeRectangle(e,t,i,this.tileRectangle_);const a=(this.tileRectangle_.east-this.tileRectangle_.west)/this.tileWidth;return this.rasterizeFeatures(o,this.styleFunction_,a)}),this.tileCache.set(n,r),this.tileCache.getCount()>2*this.tileCache.highWaterMark))for(;this.tileCache.canExpireCache();)this.tileCache.pop();return r}catch(n){console.trace(n),this.raiseEvent("could not render pbf to tile",n)}}rasterizeFeatures(e,t,i){const s=document.createElement("canvas"),n=Xe(s.getContext("2d"),{size:[this.tileWidth,this.tileHeight]});return e.forEach(r=>{const o=t(r,i);o&&o.forEach(a=>{n.setStyle(a),n.drawGeometry(r)})}),s}}function Et(c,e){const t=c.camera.getPickRay(e);return c.globe.pick(t,c)||c.camera.pickEllipsoid(e)}function wt(c){const e=c.canvas,t=new Cesium.Cartesian2(e.clientWidth/2,e.clientHeight/2);return Et(c,t)}function he(c,e){if(c&&e){const t=Qe(c,e,"EPSG:4326");return Cesium.Rectangle.fromDegrees(t[0],t[1],t[2],t[3])}else return null}function bt(c,e,t,i){const s=e.get("olcs_skip");if(s)return null;let n=null;if(e instanceof Je&&e.getUrl()&&e.getImageLoadFunction()===se){const r={"olcs.proxy":e.get("olcs.proxy"),"olcs.extent":e.get("olcs.extent"),"olcs.projection":e.get("olcs.projection"),"olcs.imagesource":e};e=new Ct({url:e.getUrl(),attributions:e.getAttributions(),projection:e.getProjection(),params:e.getParams()}),e.setProperties(r)}if(e instanceof ne){let r=A(e);if(r||(r=t),te(r))n=new le(c,e,t);else return null}else if(e instanceof pt){let r=A(e);if(r||(r=t),te(r)){const o=Cesium.Rectangle.fromDegrees(e.getImageExtent()[0],e.getImageExtent()[1],e.getImageExtent()[2],e.getImageExtent()[3],new Cesium.Rectangle);n=new Cesium.SingleTileImageryProvider({url:e.getUrl(),rectangle:o})}else return null}else if(e instanceof et&&i instanceof B){let r=A(e);if(r||(r=t),s===!1){const o=r.getCode().split(":")[1],a=e.urls.map(f=>f.replace(o,"3857")),l=i.getExtent(),d=he(l,r),u=e.get("olcs_minimumLevel"),h=e.getAttributions(),m=i.getStyleFunction();let g;if(l&&h){const f=W(l);g=ue(h,0,f,l)[0]}return n=new St({credit:g,rectangle:d,minimumLevel:u,styleFunction:m,urls:a}),n}return null}else return null;return n}function Tt(c,e,t){if(!(e instanceof $e)&&!(e instanceof Ze)&&!(e instanceof B))return null;const i=e.getSource();if(!i)return null;let s=i.get("olcs_provider");if(s||(s=bt(c,i,t,e)),!s)return null;const n={},o=e.get("olcs.extent")||e.getExtent();return o&&(n.rectangle=he(o,t)),new Cesium.ImageryLayer(s,n)}function J(c,e){let t=1,i=!0;[c.layer].concat(c.parents).forEach(s=>{const n=s.getOpacity();n!==void 0&&(t*=n);const r=s.getVisible();r!==void 0&&(i=i&&r)}),e.alpha=t,e.show=i}function E(c){const e=c;return e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1])}function V(c){console.assert(c!==null);const e=E,t=[];for(let i=0;i<c.length;++i)t.push(e(c[i]));return t}function F(c,e){console.assert(e);const t=R("EPSG:4326"),i=R(e);if(i.getCode()!==t.getCode()){const s=c.getProperties();c=c.clone(),c.transform(i,t),c.setProperties(s)}return c}function ee(c){if(c=c||"black",Array.isArray(c))return new Cesium.Color(Cesium.Color.byteToFloat(c[0]),Cesium.Color.byteToFloat(c[1]),Cesium.Color.byteToFloat(c[2]),c[3]);if(typeof c=="string")return Cesium.Color.fromCssColorString(c);if(c instanceof CanvasPattern||c instanceof CanvasGradient){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=e.height=256,t.fillStyle=c,t.fillRect(0,0,e.width,e.height),new Cesium.ImageMaterialProperty({image:e})}console.assert(!1,"impossible")}function te(c){const e=c.getCode()==="EPSG:3857",t=c.getCode()==="EPSG:4326";return e||t}function ue(c,e,t,i){if(!c)return[];let s=c({viewState:{zoom:e,center:t,projection:void 0,resolution:void 0,rotation:void 0},extent:i});return Array.isArray(s)||(s=[s]),s.map(n=>new Cesium.Credit(n,!0))}function Rt(c,e,t,i){const s=t.canvas,r=t.camera.frustum.fovy;console.assert(!isNaN(r));const o=i.getMetersPerUnit(),a=c*s.clientHeight,l=Math.cos(Math.abs(e));return a*o*l/2/Math.tan(r/2)}function Ot(c,e,t,i){const s=t.canvas,r=t.camera.frustum.fovy;console.assert(!isNaN(r));const o=i.getMetersPerUnit(),a=2*c*Math.tan(r/2),l=Math.cos(Math.abs(e));return a/o/l/s.clientHeight}class Ft{constructor(e){this.ol3d=e,this.scene_=e.getCesiumScene(),this.canvas_=this.scene_.canvas,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.repaintEventNames_=["mousemove","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove","wheel"],this.enable()}enable(){this.scene_.requestRenderMode=!0,this.scene_.maximumRenderTimeChange=1e3;for(const e of this.repaintEventNames_)this.canvas_.addEventListener(e,this._boundNotifyRepaintRequired,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().on("change",this._boundNotifyRepaintRequired)}disable(){for(const e of this.repaintEventNames_)this.canvas_.removeEventListener(e,this._boundNotifyRepaintRequired,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().un("change",this._boundNotifyRepaintRequired),this.scene_.requestRenderMode=!1}restartRenderLoop(){this.notifyRepaintRequired()}notifyRepaintRequired(){this.scene_.requestRender()}}function x(c){return c*180/Math.PI}function T(c){return c*Math.PI/180}class w{constructor(e,t){this.scene_=e,this.cam_=e.camera,this.map_=t,this.view_=null,this.viewListenKey_=null,this.toLonLat_=w.identityProjection,this.fromLonLat_=w.identityProjection,this.tilt_=0,this.distance_=0,this.lastCameraViewMatrix_=null,this.viewUpdateInProgress_=!1,this.map_.on("change:view",i=>{this.setView_(this.map_.getView())}),this.setView_(this.map_.getView())}destroy(){L(this.viewListenKey_),this.viewListenKey_=null}static identityProjection(e,t,i){const s=i||e.length;if(t)for(let n=0;n<s;++n)t[n]=e[n];return e}setView_(e){if(this.view_&&(L(this.viewListenKey_),this.viewListenKey_=null),this.view_=e,e){const t=K(e.getProjection(),"EPSG:4326"),i=K("EPSG:4326",e.getProjection());console.assert(t&&i),this.toLonLat_=t,this.fromLonLat_=i,this.viewListenKey_=e.on("propertychange",s=>this.handleViewEvent_(s)),this.readFromView()}else this.toLonLat_=w.identityProjection,this.fromLonLat_=w.identityProjection}handleViewEvent_(e){this.viewUpdateInProgress_||this.readFromView()}setHeading(e){this.view_&&this.view_.setRotation(e)}getHeading(){return this.view_?this.view_.getRotation()||0:void 0}setTilt(e){this.tilt_=e,this.updateCamera_()}getTilt(){return this.tilt_}setDistance(e){this.distance_=e,this.updateCamera_(),this.updateView()}getDistance(){return this.distance_}setCenter(e){this.view_&&this.view_.setCenter(e)}getCenter(){if(this.view_)return this.view_.getCenter()}setPosition(e){if(!this.toLonLat_)return;const t=this.toLonLat_(e);console.assert(t);const i=new Cesium.Cartographic(T(t[0]),T(t[1]),this.getAltitude());this.cam_.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(i)}),this.updateView()}getPosition(){if(!this.fromLonLat_)return;const e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position),t=this.fromLonLat_([x(e.longitude),x(e.latitude)]);return console.assert(t),t}setAltitude(e){const t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);t.height=e,this.cam_.position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(t),this.updateView()}getAltitude(){return Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position).height}updateCamera_(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(!e)return;const t=this.toLonLat_(e);console.assert(t);const i=new Cesium.Cartographic(T(t[0]),T(t[1]));if(this.scene_.globe){const r=this.scene_.globe.getHeight(i);i.height=r||0}const s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(i),n={pitch:this.tilt_-Cesium.Math.PI_OVER_TWO,heading:-this.view_.getRotation(),roll:void 0};this.cam_.setView({destination:s,orientation:n}),this.cam_.moveBackward(this.distance_),this.checkCameraChange(!0)}readFromView(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(e==null)return;const t=this.toLonLat_(e);console.assert(t);const i=this.view_.getResolution();this.distance_=this.calcDistanceForResolution(i||0,T(t[1])),this.updateCamera_()}updateView(){if(!this.view_||!this.fromLonLat_)return;this.viewUpdateInProgress_=!0;const e=Cesium.Ellipsoid.WGS84,t=this.scene_,i=wt(t);let s=i;if(!s){const r=t.globe,o=this.cam_.positionCartographic.clone(),a=r.getHeight(o);o.height=a||0,s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(o)}this.distance_=Cesium.Cartesian3.distance(s,this.cam_.position);const n=e.cartesianToCartographic(s);if(this.view_.setCenter(this.fromLonLat_([x(n.longitude),x(n.latitude)])),this.view_.setResolution(this.calcResolutionForDistance(this.distance_,n?n.latitude:0)),i){const r=this.cam_.position,o=new Cesium.Cartesian3;e.geocentricSurfaceNormal(i,o);const a=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r,i,a),Cesium.Cartesian3.normalize(a,a);const l=this.cam_.up,d=this.cam_.right,u=new Cesium.Cartesian3(-i.y,i.x,0),h=Cesium.Cartesian3.angleBetween(d,u),g=Cesium.Cartesian3.cross(i,l,new Cesium.Cartesian3).z;this.view_.setRotation(g<0?h:-h);const f=Math.acos(Cesium.Cartesian3.dot(o,a));this.tilt_=isNaN(f)?0:f}else this.view_.setRotation(this.cam_.heading),this.tilt_=-this.cam_.pitch+Math.PI/2;this.viewUpdateInProgress_=!1}checkCameraChange(e){const t=this.lastCameraViewMatrix_,i=this.cam_.viewMatrix;(!t||!Cesium.Matrix4.equalsEpsilon(t,i,1e-5))&&(this.lastCameraViewMatrix_=i.clone(),e!==!0&&this.updateView())}calcDistanceForResolution(e,t){return Rt(e,t,this.scene_,this.view_.getProjection())}calcResolutionForDistance(e,t){return Ot(e,t,this.scene_,this.view_.getProjection())}}class xt{constructor(e,t){p(this,"olListenKeys",[]);p(this,"context");p(this,"rootCollection_");const i=new Cesium.BillboardCollection({scene:t}),s=new Cesium.PrimitiveCollection;this.rootCollection_=new Cesium.PrimitiveCollection,this.context={projection:e,billboards:i,featureToCesiumMap:{},primitives:s},this.rootCollection_.add(i),this.rootCollection_.add(s)}destroy(){this.olListenKeys.forEach(L),this.olListenKeys.length=0}getRootPrimitive(){return this.rootCollection_}}class de{constructor(e,t){p(this,"map");p(this,"view");p(this,"scene");p(this,"olLayers");p(this,"mapLayerGroup");p(this,"layerMap",{});p(this,"olLayerListenKeys",{});p(this,"olGroupListenKeys_",{});this.map=e,this.view=e.getView(),this.scene=t,this.olLayers=e.getLayerGroup().getLayers(),this.mapLayerGroup=e.getLayerGroup()}synchronize(){this.destroyAll(),this.addLayers_(this.mapLayerGroup)}orderLayers(){}addLayers_(e){const t=[{layer:e,parents:[]}];for(;t.length>0;){const i=t.splice(0,1)[0],s=i.layer,n=y(s).toString();this.olLayerListenKeys[n]=[],console.assert(!this.layerMap[n]);let r=null;if(s instanceof U)this.listenForGroupChanges_(s),s!==this.mapLayerGroup&&(r=this.createSingleLayerCounterparts(i)),r||s.getLayers().forEach(o=>{if(o){const a={layer:o,parents:s===this.mapLayerGroup?[]:[i.layer].concat(i.parents)};t.push(a)}});else if(r=this.createSingleLayerCounterparts(i),!r){const o=n,a=i,l=()=>{const d=this.createSingleLayerCounterparts(a);d&&(a.layer.un("change",l),this.addCesiumObjects_(d,o,a.layer),this.orderLayers())};this.olLayerListenKeys[n].push(S(a.layer,"change",l))}r&&this.addCesiumObjects_(r,n,s)}this.orderLayers()}addCesiumObjects_(e,t,i){this.layerMap[t]=e,this.olLayerListenKeys[t].push(S(i,"change:zIndex",()=>this.orderLayers())),e.forEach(s=>{this.addCesiumObject(s)})}removeAndDestroySingleLayer_(e){const t=y(e).toString(),i=this.layerMap[t];return i&&(i.forEach(s=>{this.removeSingleCesiumObject(s,!1),this.destroyCesiumObject(s)}),this.olLayerListenKeys[t].forEach(L),delete this.olLayerListenKeys[t]),delete this.layerMap[t],!!i}unlistenSingleGroup_(e){if(e===this.mapLayerGroup)return;const t=y(e).toString();this.olGroupListenKeys_[t].forEach(s=>{L(s)}),delete this.olGroupListenKeys_[t],delete this.layerMap[t]}removeLayer_(e){if(e){const t=[e];for(;t.length>0;){const i=t.splice(0,1)[0],s=this.removeAndDestroySingleLayer_(i);i instanceof U&&(this.unlistenSingleGroup_(i),s||i.getLayers().forEach(n=>{t.push(n)}))}}}listenForGroupChanges_(e){const t=y(e).toString();console.assert(this.olGroupListenKeys_[t]===void 0);const i=[];this.olGroupListenKeys_[t]=i;let s=[];const n=(function(){const r=e.getLayers();r&&(s=[r.on("add",o=>{this.addLayers_(o.element)}),r.on("remove",o=>{this.removeLayer_(o.element)})],i.push(...s))}).bind(this);n(),i.push(e.on("change:layers",r=>{s.forEach(o=>{const a=i.indexOf(o);a>=0&&i.splice(a,1),L(o)}),n()}))}destroyAll(){this.removeAllCesiumObjects(!0);let e;for(e in this.olGroupListenKeys_)this.olGroupListenKeys_[e].forEach(L);for(e in this.olLayerListenKeys)this.olLayerListenKeys[e].forEach(L);this.olGroupListenKeys_={},this.olLayerListenKeys={},this.layerMap={}}}class At extends de{constructor(t,i){super(t,i);p(this,"cesiumLayers_");p(this,"ourLayers_");this.cesiumLayers_=i.imageryLayers,this.ourLayers_=new Cesium.ImageryLayerCollection}addCesiumObject(t){this.cesiumLayers_.add(t),this.ourLayers_.add(t)}destroyCesiumObject(t){t.destroy()}removeSingleCesiumObject(t,i){this.cesiumLayers_.remove(t,i),this.ourLayers_.remove(t,!1)}removeAllCesiumObjects(t){for(let i=0;i<this.ourLayers_.length;++i)this.cesiumLayers_.remove(this.ourLayers_.get(i),t);this.ourLayers_.removeAll(!1)}convertLayerToCesiumImageries(t,i){const s=Tt(this.map,t,i);return s?[s]:null}createSingleLayerCounterparts(t){const i=t.layer,s=y(i).toString(),n=this.view.getProjection();console.assert(n);const r=this.convertLayerToCesiumImageries(i,n);if(r){const o=[];if([t.layer].concat(t.parents).forEach(a=>{o.push(a.on(["change:opacity","change:visible"],()=>{console.assert(r);for(let l=0;l<r.length;++l)J(t,r[l])}))}),i instanceof tt){let a=i.getStyleFunction();o.push(i.on("change",()=>{var d;const l=i.getStyleFunction();if(a!==l){a=l;for(let u=0;u<r.length;++u){const h=r[u];h._imageryCache&&(h._imageryCache={});const m=h.imageryProvider;m&&((d=m.tileCache)==null||d.clear(),m.styleFunction_=l)}this.scene.requestRender()}}))}for(let a=0;a<r.length;++a)J(t,r[a]);o.push(i.on("change:extent",a=>{for(let l=0;l<r.length;++l)this.cesiumLayers_.remove(r[l],!0),this.ourLayers_.remove(r[l],!1);delete this.layerMap[y(i)],this.synchronize()})),o.push(i.on("change",a=>{for(let l=0;l<r.length;++l){const d=this.cesiumLayers_.indexOf(r[l]);d>=0&&(this.cesiumLayers_.remove(r[l],!1),this.cesiumLayers_.add(r[l],d))}})),this.olLayerListenKeys[s].push(...o)}return Array.isArray(r)?r:null}orderLayers(){const t=[],i={},s=[this.mapLayerGroup];for(;s.length>0;){const n=s.splice(0,1)[0];if(t.push(n),i[y(n)]=n.getZIndex()||0,n instanceof U){const r=n.getLayers();r&&s.unshift(...r.getArray())}}ut(t,(n,r)=>i[y(n)]-i[y(r)]),t.forEach(n=>{const r=y(n).toString(),o=this.layerMap[r];o&&o.forEach(a=>{this.raiseToTop(a)})})}raiseToTop(t){this.cesiumLayers_.raiseToTop(t)}}class It{constructor(e){this.scene=e,this.boundOnRemoveOrClearFeatureListener_=this.onRemoveOrClearFeature_.bind(this),this.defaultBillboardEyeOffset_=new Cesium.Cartesian3(0,0,10)}onRemoveOrClearFeature_(e){const t=e.target;console.assert(t instanceof I);const i=t.olcs_cancellers;if(i){const s=e.feature;if(s){const n=y(s),r=i[n];r&&(r(),delete i[n])}else{for(const n in i)i.hasOwnProperty(n)&&i[n]();t.olcs_cancellers={}}}}setReferenceForPicking(e,t,i){i.olLayer=e,i.olFeature=t}createColoredPrimitive(e,t,i,s,n,r){const o=function(h,m){const g=new Cesium.GeometryInstance({geometry:h});return m&&!(m instanceof Cesium.ImageMaterialProperty)&&(g.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(m)}),g},a={flat:!0,renderState:{depthTest:{enabled:!0}}};r!==void 0&&(a.renderState||(a.renderState={}),a.renderState.lineWidth=r);const l=o(s,n),d=this.getHeightReference(e,t,i);let u;if(d===Cesium.HeightReference.CLAMP_TO_GROUND){const h=l.geometry.constructor;if(h&&!h.createShadowVolume)return null;u=new Cesium.GroundPrimitive({geometryInstances:l})}else u=new Cesium.Primitive({geometryInstances:l});if(n instanceof Cesium.ImageMaterialProperty){const h=n.image.getValue().toDataURL();u.appearance=new Cesium.MaterialAppearance({flat:!0,renderState:{depthTest:{enabled:!0}},material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:h}}})})}else u.appearance=new Cesium.MaterialAppearance({...a,material:new Cesium.Material({translucent:n.alpha!==1,fabric:{type:"Color",uniforms:{color:n}}})}),(t.get("olcs_shadows")||e.get("olcs_shadows"))&&(u.shadows=1);return this.setReferenceForPicking(e,t,u),u}extractColorFromOlStyle(e,t){const i=e.getFill()?e.getFill().getColor():null,s=e.getStroke()?e.getStroke().getColor():null;let n="black";return s&&t?n=s:i&&(n=i),ee(n)}extractLineWidthFromOlStyle(e){const t=e.getStroke()?e.getStroke().getWidth():void 0;return t!==void 0?t:1}wrapFillAndOutlineGeometries(e,t,i,s,n,r){const o=this.extractColorFromOlStyle(r,!1),a=this.extractColorFromOlStyle(r,!0),l=new Cesium.PrimitiveCollection;if(r.getFill()){const d=this.createColoredPrimitive(e,t,i,s,o);console.assert(!!d),l.add(d)}if(r.getStroke()&&n){const d=this.extractLineWidthFromOlStyle(r),u=this.createColoredPrimitive(e,t,i,n,a,d);u&&l.add(u)}return l}addTextStyle(e,t,i,s,n){let r;if(n instanceof Cesium.PrimitiveCollection?r=n:(r=new Cesium.PrimitiveCollection,r.add(n)),!s.getText())return r;const o=s.getText(),a=this.olGeometry4326TextPartToCesium(e,t,i,o);return a&&r.add(a),r}csAddBillboard(e,t,i,s,n,r){t.eyeOffset||(t.eyeOffset=this.defaultBillboardEyeOffset_);const o=e.add(t);return this.setReferenceForPicking(i,s,o),o}olCircleGeometryToCesium(e,t,i,s,n){i=F(i,s),console.assert(i.getType()=="Circle");let r=i.getCenter();const o=r.length==3?r[2]:0;let a=r.slice();a[0]+=i.getRadius(),r=E(r),a=E(a);const l=Cesium.Cartesian3.distance(r,a),d=new Cesium.CircleGeometry({center:r,radius:l,height:o});let u,h;if(this.getHeightReference(e,t,i)===Cesium.HeightReference.CLAMP_TO_GROUND){const g=this.extractLineWidthFromOlStyle(n);if(g){const f=it(i.getCenter(),l),_=V(f.getLinearRing(0).getCoordinates());if(G(this.scene))u=new Cesium.GroundPolylinePrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.GroundPolylineGeometry({positions:_,width:g})}),appearance:new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)}),classificationType:Cesium.ClassificationType.TERRAIN}),N(u).then(()=>{this.setReferenceForPicking(e,t,u._primitive)});else{const C=this.extractColorFromOlStyle(n,!0);u=this.createStackedGroundCorridors(e,t,g,C,_)}}}else h=new Cesium.CircleOutlineGeometry({center:r,radius:l,extrudedHeight:o,height:o});const m=this.wrapFillAndOutlineGeometries(e,t,i,d,h,n);return u&&m.add(u),this.addTextStyle(e,t,i,n,m)}createStackedGroundCorridors(e,t,i,s,n){Array.isArray(n[0])||(n=[n]),i=Math.max(3,i);const r=[];let o=0;for(const a of[1e3,4e3,16e3,64e3,254e3,1e6,1e7]){i*=2.14;const l={width:i,vertexFormat:Cesium.VertexFormat.POSITION_ONLY};for(const d of n)l.positions=d,r.push(new Cesium.GeometryInstance({geometry:new Cesium.CorridorGeometry(l),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(s),distanceDisplayCondition:new Cesium.DistanceDisplayConditionGeometryInstanceAttribute(o,a-1)}}));o=a}return new Cesium.GroundPrimitive({geometryInstances:r})}olLineStringGeometryToCesium(e,t,i,s,n){i=F(i,s),console.assert(i.getType()=="LineString");const r=V(i.getCoordinates()),o=this.extractLineWidthFromOlStyle(n);let a;const l=this.getHeightReference(e,t,i);if(l===Cesium.HeightReference.CLAMP_TO_GROUND&&!G(this.scene)){const d=this.extractColorFromOlStyle(n,!0);a=this.createStackedGroundCorridors(e,t,o,d,r)}else{const d=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)}),u={positions:r,width:o},h={appearance:d};if(l===Cesium.HeightReference.CLAMP_TO_GROUND){const m=new Cesium.GroundPolylineGeometry(u);h.geometryInstances=new Cesium.GeometryInstance({geometry:m}),a=new Cesium.GroundPolylinePrimitive(h),N(a).then(()=>{this.setReferenceForPicking(e,t,a._primitive)})}else{u.vertexFormat=d.vertexFormat;const m=new Cesium.PolylineGeometry(u);h.geometryInstances=new Cesium.GeometryInstance({geometry:m}),a=new Cesium.Primitive(h)}}return this.setReferenceForPicking(e,t,a),this.addTextStyle(e,t,i,n,a)}olPolygonGeometryToCesium(e,t,i,s,n){i=F(i,s),console.assert(i.getType()=="Polygon");const r=this.getHeightReference(e,t,i);let o,a,l;if(i.getCoordinates()[0].length==5&&t.get("olcs.polygon_kind")==="rectangle"){const u=i.getCoordinates()[0],h=st(u),m=Cesium.Rectangle.fromDegrees(h[0],h[1],h[2],h[3]);let g=0;if(u[0].length==3)for(let _=0;_<u.length;_++)g=Math.max(g,u[_][2]);const f=t.getProperty("olcs_extruded_height");o=new Cesium.RectangleGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:m,height:g,extrudedHeight:f}),a=new Cesium.RectangleOutlineGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:m,height:g,extrudedHeight:f})}else{const u=i.getLinearRings(),h={},m=h;console.assert(u.length>0);for(let f=0;f<u.length;++f){const _=u[f].getCoordinates(),C=V(_);console.assert(C&&C.length>0),f==0?h.positions=C:(h.holes||(h.holes=[]),h.holes.push({positions:C}))}const g=t.get("olcs_extruded_height");if(o=new Cesium.PolygonGeometry({polygonHierarchy:m,perPositionHeight:!0,extrudedHeight:g}),r===Cesium.HeightReference.CLAMP_TO_GROUND){const f=this.extractLineWidthFromOlStyle(n);if(f>0){const _=[h.positions];if(h.holes)for(let C=0;C<h.holes.length;++C)_.push(h.holes[C].positions);if(G(this.scene)){const C=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)}),P=[];for(const b of _){const ge=new Cesium.GroundPolylineGeometry({positions:b,width:f});P.push(new Cesium.GeometryInstance({geometry:ge}))}const M={appearance:C,geometryInstances:P};l=new Cesium.GroundPolylinePrimitive(M),N(l).then(()=>{this.setReferenceForPicking(e,t,l._primitive)})}else{const C=this.extractColorFromOlStyle(n,!0);l=this.createStackedGroundCorridors(e,t,f,C,_)}}}else a=new Cesium.PolygonOutlineGeometry({polygonHierarchy:h,perPositionHeight:!0,extrudedHeight:g})}const d=this.wrapFillAndOutlineGeometries(e,t,i,o,a,n);return l&&d.add(l),this.addTextStyle(e,t,i,n,d)}getHeightReference(e,t,i){let s=i.get("altitudeMode");s===void 0&&(s=t.get("altitudeMode")),s===void 0&&(s=e.get("altitudeMode"));let n=Cesium.HeightReference.NONE;return s==="clampToGround"?n=Cesium.HeightReference.CLAMP_TO_GROUND:s==="relativeToGround"&&(n=Cesium.HeightReference.RELATIVE_TO_GROUND),n}createBillboardFromImage(e,t,i,s,n,r,o,a){r instanceof Z&&r.load();const l=r.getImage(1),d=function(h){return h.src!=""&&h.naturalHeight!=0&&h.naturalWidth!=0&&h.complete},u=(function(){if(!l||!(l instanceof HTMLCanvasElement||l instanceof Image||l instanceof HTMLImageElement))return;const h=i.getCoordinates(),m=E(h);let g;const f=r.getOpacity();f!==void 0&&(g=new Cesium.Color(1,1,1,f));const _=r.getScale(),C=this.getHeightReference(e,t,i),P={image:l,color:g,scale:_,heightReference:C,position:m};if(Object.assign(P,t.get("cesiumOptions")),r instanceof Z){const b=r.getAnchor();b&&(P.pixelOffset=new Cesium.Cartesian2((l.width/2-b[0])*_,(l.height/2-b[1])*_))}const M=this.csAddBillboard(o,P,e,t,i,n);a&&a(M)}).bind(this);if(l instanceof Image&&!d(l)){let h=!1;const m=e.getSource(),g=function(){h=!0};m.on(["removefeature","clear"],this.boundOnRemoveOrClearFeatureListener_);let f=m.olcs_cancellers;f||(f=m.olcs_cancellers={});const _=y(t);f[_]&&f[_](),f[_]=g;const C=function(){l.removeEventListener("load",C),!o.isDestroyed()&&!h&&u()};l.addEventListener("load",C)}else u()}olPointGeometryToCesium(e,t,i,s,n,r,o){console.assert(i.getType()=="Point"),i=F(i,s);let a=null;const l=n.getImage();if(l){const d=i.get("olcs_model")||t.get("olcs_model");if(d){a=new Cesium.PrimitiveCollection;const u=d(),h=Object.assign({},{scene:this.scene},u.cesiumOptions);if(Cesium.Model.fromGltf){const m=Cesium.Model.fromGltf(h);a.add(m)}else Cesium.Model.fromGltfAsync(h).then(m=>{a.add(m)});u.debugModelMatrix&&a.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:u.debugModelMatrix}))}else this.createBillboardFromImage(e,t,i,s,n,l,r,o)}return n.getText()?this.addTextStyle(e,t,i,n,a||new Cesium.Primitive):a}olMultiGeometryToCesium(e,t,i,s,n,r,o){const a=function(d,u){const h=new Cesium.PrimitiveCollection;return d.forEach(m=>{h.add(u(e,t,m,s,n))}),h};let l;switch(i.getType()){case"MultiPoint":if(i=i,l=i.getPoints(),n.getText()){const d=new Cesium.PrimitiveCollection;return l.forEach(u=>{console.assert(u);const h=this.olPointGeometryToCesium(e,t,u,s,n,r,o);h&&d.add(h)}),d}else return l.forEach(d=>{console.assert(d),this.olPointGeometryToCesium(e,t,d,s,n,r,o)}),null;case"MultiLineString":return i=i,l=i.getLineStrings(),a(l,this.olLineStringGeometryToCesium.bind(this));case"MultiPolygon":return i=i,l=i.getPolygons(),a(l,this.olPolygonGeometryToCesium.bind(this));default:console.assert(!1,`Unhandled multi geometry type${i.getType()}`)}}olGeometry4326TextPartToCesium(e,t,i,s){const n=s.getText();if(!n)return null;const r=new Cesium.LabelCollection({scene:this.scene}),o=W(i.getExtent());if(i instanceof nt){const g=i.getFirstCoordinate();o[2]=g.length==3?g[2]:0}const a={};a.position=E(o),a.text=n,a.heightReference=this.getHeightReference(e,t,i);const l=s.getOffsetX(),d=s.getOffsetY();if(l!=0&&d!=0){const g=new Cesium.Cartesian2(l,d);a.pixelOffset=g}a.font=s.getFont()||"10px sans-serif";let u;s.getFill()&&(a.fillColor=this.extractColorFromOlStyle(s,!1),u=Cesium.LabelStyle.FILL),s.getStroke()&&(a.outlineWidth=this.extractLineWidthFromOlStyle(s),a.outlineColor=this.extractColorFromOlStyle(s,!0),u=Cesium.LabelStyle.OUTLINE),s.getFill()&&s.getStroke()&&(u=Cesium.LabelStyle.FILL_AND_OUTLINE),a.style=u;let h;switch(s.getTextAlign()){case"left":h=Cesium.HorizontalOrigin.LEFT;break;case"right":h=Cesium.HorizontalOrigin.RIGHT;break;case"center":default:h=Cesium.HorizontalOrigin.CENTER}if(a.horizontalOrigin=h,s.getTextBaseline()){let g;switch(s.getTextBaseline()){case"top":g=Cesium.VerticalOrigin.TOP;break;case"middle":g=Cesium.VerticalOrigin.CENTER;break;case"bottom":g=Cesium.VerticalOrigin.BOTTOM;break;case"alphabetic":g=Cesium.VerticalOrigin.TOP;break;case"hanging":g=Cesium.VerticalOrigin.BOTTOM;break;default:console.assert(!1,`unhandled baseline ${s.getTextBaseline()}`)}a.verticalOrigin=g}const m=r.add(a);return this.setReferenceForPicking(e,t,m),r}olStyleToCesium(e,t,i){const s=t.getFill(),n=t.getStroke();if(i&&!n||!i&&!s)return null;let r=i?n.getColor():s.getColor();return r=ee(r),i&&n.getLineDash()?Cesium.Material.fromType("Stripe",{horizontal:!1,repeat:500,evenColor:r,oddColor:new Cesium.Color(0,0,0,0)}):Cesium.Material.fromType("Color",{color:r})}computePlainStyle(e,t,i,s){const n=t.getStyleFunction();let r=null;return n&&(r=n(t,s)),!r&&i&&(r=i(t,s)),r?Array.isArray(r)?r:[r]:null}getGeometryFromFeature(e,t,i){if(i)return i;const s=e.get("olcs.3d_geometry");if(s&&s instanceof Q)return s;if(t){const n=t.getGeometryFunction()(e);if(n instanceof Q)return n}return e.getGeometry()}olFeatureToCesium(e,t,i,s,n){let r=this.getGeometryFromFeature(t,i,n);if(!r)return null;const o=s.projection,a=function(l){const d=s.featureToCesiumMap[y(t)];d instanceof Array?d.push(l):s.featureToCesiumMap[y(t)]=[l]};switch(r.getType()){case"GeometryCollection":const l=new Cesium.PrimitiveCollection;return r.getGeometries().forEach(g=>{if(g){const f=this.olFeatureToCesium(e,t,i,s,g);f&&l.add(f)}}),l;case"Point":r=r;const u=s.billboards,h=this.olPointGeometryToCesium(e,t,r,o,i,u,a);return h||null;case"Circle":return r=r,this.olCircleGeometryToCesium(e,t,r,o,i);case"LineString":return r=r,this.olLineStringGeometryToCesium(e,t,r,o,i);case"Polygon":return r=r,this.olPolygonGeometryToCesium(e,t,r,o,i);case"MultiPoint":case"MultiLineString":case"MultiPolygon":const m=this.olMultiGeometryToCesium(e,t,r,o,i,s.billboards,a);return m||null;case"LinearRing":throw new Error("LinearRing should only be part of polygon.");default:throw new Error(`Ol geom type not handled : ${r.getType()}`)}}olVectorLayerToCesium(e,t,i){const s=t.getProjection(),n=t.getResolution();if(n===void 0||!s)throw console.assert(!1,"View not ready"),new Error("View not ready");let r=e.getSource();r instanceof ce&&(r=r.getSource()),console.assert(r instanceof I);const o=r.getFeatures(),a=new xt(s,this.scene),l=a.context;for(let d=0;d<o.length;++d){const u=o[d];if(!u)continue;const h=e.getStyleFunction(),m=this.computePlainStyle(e,u,h,n);if(!m||!m.length)continue;let g=null;for(let f=0;f<m.length;f++){const _=this.olFeatureToCesium(e,u,m[f],l);if(_){if(!g)g=_;else if(_){let C=0,P;for(;P=_.get(C);)g.add(P),C++}}}g&&(i[y(u)]=g,a.getRootPrimitive().add(g))}return a}convert(e,t,i,s){const n=t.getProjection(),r=t.getResolution();if(r==null||!n)return null;const o=e.getStyleFunction(),a=this.computePlainStyle(e,i,o,r);if(!a||!a.length)return null;s.projection=n;let l=null;for(let d=0;d<a.length;d++){const u=this.olFeatureToCesium(e,i,a[d],s);if(!l)l=u;else if(u){let h=0,m;for(;m=u.get(h);)l.add(m),h++}}return l}}class Mt extends de{constructor(t,i,s){super(t,i);p(this,"converter");p(this,"csAllPrimitives_");this.converter=s||new It(i),this.csAllPrimitives_=new Cesium.PrimitiveCollection,i.primitives.add(this.csAllPrimitives_),this.csAllPrimitives_.destroyPrimitives=!1}addCesiumObject(t){console.assert(t);const i=t.getRootPrimitive();i.counterpart=t,this.csAllPrimitives_.add(t.getRootPrimitive())}destroyCesiumObject(t){t.getRootPrimitive().destroy()}removeSingleCesiumObject(t,i){t.destroy(),this.csAllPrimitives_.destroyPrimitives=i,this.csAllPrimitives_.remove(t.getRootPrimitive()),this.csAllPrimitives_.destroyPrimitives=!1}removeAllCesiumObjects(t){if(this.csAllPrimitives_.destroyPrimitives=t,t)for(let i=0;i<this.csAllPrimitives_.length;++i)this.csAllPrimitives_.get(i).counterpart.destroy();this.csAllPrimitives_.removeAll(),this.csAllPrimitives_.destroyPrimitives=!1}updateLayerVisibility(t,i){let s=!0;[t.layer].concat(t.parents).forEach(n=>{const r=n.getVisible();r!==void 0?s=s&&r:s=!1}),i.show=s}createSingleLayerCounterparts(t){const i=t.layer;if(!(i instanceof rt)||i instanceof B)return null;console.assert(i instanceof ot);let s=i.getSource();if(s instanceof ce&&(s=s.getSource()),!s)return null;console.assert(s instanceof I),console.assert(this.view);const n=this.view,r={},o=this.converter.olVectorLayerToCesium(i,n,r),a=o.getRootPrimitive(),l=o.olListenKeys;[t.layer].concat(t.parents).forEach(h=>{l.push(S(h,"change:visible",()=>{this.updateLayerVisibility(t,a)}))}),this.updateLayerVisibility(t,a);const d=(function(h){const m=o.context,g=this.converter.convert(i,n,h,m);g&&(r[y(h)]=g,a.add(g))}).bind(this),u=(function(h){const m=y(h),g=o.context,f=g.featureToCesiumMap[m];f&&(delete g.featureToCesiumMap[m],f.forEach(C=>{C instanceof Cesium.Billboard&&g.billboards.remove(C)}));const _=r[m];delete r[m],_&&a.remove(_)}).bind(this);return l.push(S(s,"addfeature",h=>{console.assert(h.feature),d(h.feature)})),l.push(S(s,"removefeature",h=>{console.assert(h.feature),u(h.feature)})),l.push(S(s,"changefeature",h=>{const m=h.feature;console.assert(m),u(m),d(m)})),o?[o]:null}}class Gt extends ct{constructor(e){const t=e.parent;super(t.getOptions()),this.scenePostRenderListenerRemover_=null,this.scene_=e.scene,this.synchronizer_=e.synchronizer,this.parent_=t,this.positionWGS84_=void 0,this.observer_=new MutationObserver(this.handleElementChanged.bind(this)),this.attributeObserver_=[],this.listenerKeys_=[];const i=s=>this.setPropertyFromEvent_(s);this.listenerKeys_.push(this.parent_.on("change:position",i)),this.listenerKeys_.push(this.parent_.on("change:element",i)),this.listenerKeys_.push(this.parent_.on("change:offset",i)),this.listenerKeys_.push(this.parent_.on("change:position",i)),this.listenerKeys_.push(this.parent_.on("change:positioning",i)),this.setProperties(this.parent_.getProperties()),this.handleMapChanged(),this.handleElementChanged()}observeTarget_(e){if(this.observer_){this.observer_.disconnect(),this.observer_.observe(e,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),this.attributeObserver_.forEach(t=>{t.disconnect()}),this.attributeObserver_.length=0;for(let t=0;t<e.childNodes.length;t++){const i=e.childNodes[t];if(i.nodeType===1){const s=new MutationObserver(this.handleElementChanged.bind(this));s.observe(i,{attributes:!0,subtree:!0}),this.attributeObserver_.push(s)}}}}setPropertyFromEvent_(e){e.target&&e.key&&this.set(e.key,e.target.get(e.key))}getScene(){return this.scene_}handleMapChanged(){this.scenePostRenderListenerRemover_&&(this.scenePostRenderListenerRemover_(),dt(this.element)),this.scenePostRenderListenerRemover_=null;const e=this.getScene();if(e){this.scenePostRenderListenerRemover_=e.postRender.addEventListener(this.updatePixelPosition.bind(this)),this.updatePixelPosition();const t=this.stopEvent?this.synchronizer_.getOverlayContainerStopEvent():this.synchronizer_.getOverlayContainer();this.insertFirst?t.insertBefore(this.element,t.childNodes[0]||null):t.appendChild(this.element)}}handlePositionChanged(){const e=this.getPosition();if(e){const t=this.parent_.getMap().getView().getProjection();this.positionWGS84_=oe(e,t,"EPSG:4326")}else this.positionWGS84_=void 0;this.updatePixelPosition()}handleElementChanged(){function e(i,s){const n=i.cloneNode();i.nodeName==="CANVAS"&&n.getContext("2d").drawImage(i,0,0),s&&s.appendChild(n),i.nodeType!=Node.TEXT_NODE&&n.addEventListener("click",o=>{i.dispatchEvent(new MouseEvent("click",o)),o.stopPropagation()});const r=i.childNodes;for(let o=0;o<r.length;o++)r[o]&&e(r[o],n);return n}mt(this.element);const t=this.getElement();if(t&&t.parentNode&&t.parentNode.childNodes)for(const i of t.parentNode.childNodes){const s=e(i,null);this.element.appendChild(s)}t.parentNode&&this.observeTarget_(t.parentNode)}updatePixelPosition(){const e=this.positionWGS84_;if(!this.scene_||!e){this.setVisible(!1);return}let t=0;if(e.length===2){const u=this.scene_.globe.getHeight(Cesium.Cartographic.fromDegrees(e[0],e[1]));u&&this.scene_.globe.tilesLoaded&&(e[2]=u),u&&(t=u)}else t=e[2];const i=Cesium.Cartesian3.fromDegrees(e[0],e[1],t),s=this.scene_.camera,n=new Cesium.BoundingSphere(new Cesium.Cartesian3,6356752);if(!new Cesium.Occluder(n,s.position).isPointVisible(i)){this.setVisible(!1);return}if(s.frustum.computeCullingVolume(s.position,s.direction,s.up).computeVisibility(new Cesium.BoundingSphere(i))!==1){this.setVisible(!1);return}this.setVisible(!0);const a=this.scene_.cartesianToCanvasCoordinates(i),l=[a.x,a.y],d=[this.scene_.canvas.width,this.scene_.canvas.height];this.updateRenderedPosition(l,d)}destroy(){this.scenePostRenderListenerRemover_&&this.scenePostRenderListenerRemover_(),this.observer_&&this.observer_.disconnect(),L(this.listenerKeys_),this.listenerKeys_.splice(0),this.element.removeNode?this.element.removeNode(!0):this.element.remove(),this.element=null}}class Nt{constructor(e,t){this.map=e,this.overlays_=this.map.getOverlays(),this.scene=t,this.overlayContainerStopEvent_=document.createElement("DIV"),this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"].forEach(s=>{this.overlayContainerStopEvent_.addEventListener(s,n=>n.stopPropagation())}),this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_),this.overlayContainer_=document.createElement("DIV"),this.overlayContainer_.className="ol-overlaycontainer",this.scene.canvas.parentElement.appendChild(this.overlayContainer_),this.overlayMap_={}}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOverlayContainer(){return this.overlayContainer_}synchronize(){this.destroyAll(),this.addOverlays(),this.overlays_.on("add",this.addOverlayFromEvent_.bind(this)),this.overlays_.on("remove",this.removeOverlayFromEvent_.bind(this))}addOverlayFromEvent_(e){const t=e.element;this.addOverlay(t)}addOverlays(){this.overlays_.forEach(e=>{this.addOverlay(e)})}addOverlay(e){if(!e)return;const t=new Gt({scene:this.scene,synchronizer:this,parent:e}),i=y(e).toString();this.overlayMap_[i]=t}removeOverlayFromEvent_(e){const t=e.element;this.removeOverlay(t)}removeOverlay(e){const t=y(e).toString(),i=this.overlayMap_[t];i&&(i.destroy(),delete this.overlayMap_[t])}destroyAll(){Object.keys(this.overlayMap_).forEach(e=>{this.overlayMap_[e].destroy(),delete this.overlayMap_[e]})}}const k={DONE:0,PENDING:1,FAILED:2};class me{constructor(e){p(this,"autoRenderLoop_",null);p(this,"map_");p(this,"time_");p(this,"to4326Transform_");p(this,"resolutionScale_",1);p(this,"canvasClientWidth_",0);p(this,"canvasClientHeight_",0);p(this,"resolutionScaleChanged_",!0);p(this,"container_");p(this,"isOverMap_");p(this,"canvas_");p(this,"enabled_",!1);p(this,"pausedInteractions_",[]);p(this,"hiddenRootGroup_",null);p(this,"scene_");p(this,"camera_");p(this,"globe_");p(this,"dataSourceCollection_");p(this,"dataSourceDisplay_");p(this,"lastFrameTime_",0);p(this,"renderId_");p(this,"targetFrameRate_",Number.POSITIVE_INFINITY);p(this,"blockCesiumRendering_",!1);p(this,"warmingUp_",!1);p(this,"trackedFeature_",null);p(this,"trackedEntity_",null);p(this,"entityView_",null);p(this,"needTrackedEntityUpdate_",!1);p(this,"boundingSphereScratch_",new Cesium.BoundingSphere);p(this,"synchronizers_");this.map_=e.map,this.time_=e.time||function(){return Cesium.JulianDate.now()},this.to4326Transform_=K(this.map_.getView().getProjection(),"EPSG:4326");const t="position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none";this.container_=document.createElement("DIV");const i=document.createAttribute("style");i.value=`${t}visibility:hidden;`,this.container_.setAttributeNode(i);let s=e.target||this.map_.getViewport();if(typeof s=="string"&&(s=document.getElementById(s)),s.appendChild(this.container_),this.isOverMap_=!e.target,this.isOverMap_&&e.stopOpenLayersEventsPropagation){const d=["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"];for(let u=0,h=d.length;u<h;++u)this.container_.addEventListener(d[u],m=>m.stopPropagation())}this.canvas_=document.createElement("canvas");const n=document.createAttribute("style");n.value=t,this.canvas_.setAttributeNode(n),H()&&(this.canvas_.style.imageRendering=lt()),this.canvas_.oncontextmenu=function(){return!1},this.canvas_.onselectstart=function(){return!1},this.container_.appendChild(this.canvas_);const r=e.sceneOptions!==void 0?{...e.sceneOptions,canvas:this.canvas_,scene3DOnly:!0}:{canvas:this.canvas_,scene3DOnly:!0};this.scene_=new Cesium.Scene(r);const o=this.scene_.screenSpaceCameraController;Array.isArray(o.tiltEventTypes)?(o.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.SHIFT}),o.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.ALT})):console.log("sscc is not an array"),o.enableLook=!1,this.scene_.camera.constrainedAxis=Cesium.Cartesian3.UNIT_Z,this.camera_=new w(this.scene_,this.map_),this.globe_=new Cesium.Globe(Cesium.Ellipsoid.WGS84),this.globe_.baseColor=Cesium.Color.WHITE,this.scene_.globe=this.globe_,this.scene_.skyAtmosphere=new Cesium.SkyAtmosphere;const a=new Cesium.SingleTileImageryProvider({tileHeight:1,tileWidth:1,url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",rectangle:Cesium.Rectangle.fromDegrees(0,0,1,1)});this.globe_.imageryLayers.addImageryProvider(a,0),this.dataSourceCollection_=new Cesium.DataSourceCollection,this.dataSourceDisplay_=new Cesium.DataSourceDisplay({scene:this.scene_,dataSourceCollection:this.dataSourceCollection_}),this.synchronizers_=e.createSynchronizers?e.createSynchronizers(this.map_,this.scene_,this.dataSourceCollection_):[new At(this.map_,this.scene_),new Mt(this.map_,this.scene_),new Nt(this.map_,this.scene_)],this.handleResize_();for(let d=this.synchronizers_.length-1;d>=0;--d)this.synchronizers_[d].synchronize();new Cesium.EventHelper().add(this.scene_.postRender,me.prototype.updateTrackedEntity_,this)}destroy(){cancelAnimationFrame(this.renderId_),this.renderId_=void 0,this.synchronizers_.forEach(e=>e.destroyAll()),this.camera_.destroy(),this.scene_.destroy(),this.scene_._postRender=null,this.container_.remove()}render_(){this.renderId_!==void 0&&(cancelAnimationFrame(this.renderId_),this.renderId_=void 0),(this.enabled_||this.warmingUp_)&&!this.blockCesiumRendering_&&(this.renderId_=requestAnimationFrame(this.onAnimationFrame_.bind(this)))}onAnimationFrame_(e){this.renderId_=void 0;const t=1e3/this.targetFrameRate_;if(e-this.lastFrameTime_<t){this.render_();return}this.lastFrameTime_=e;const s=this.time_();if(this.scene_.initializeFrame(),this.handleResize_(),this.dataSourceDisplay_.update(s),this.entityView_){const n=this.trackedEntity_;this.dataSourceDisplay_.getBoundingSphere(n,!1,this.boundingSphereScratch_)===k.DONE&&(this.boundingSphereScratch_.radius=1,this.entityView_.update(s,this.boundingSphereScratch_))}this.scene_.render(s),this.camera_.checkCameraChange(),this.render_()}updateTrackedEntity_(){if(!this.needTrackedEntityUpdate_)return;const e=this.trackedEntity_,t=this.scene_,i=this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_);if(i===k.PENDING)return;t.screenSpaceCameraController.enableTilt=!1;const s=i!==k.FAILED?this.boundingSphereScratch_:void 0;s&&(s.radius=1),this.entityView_=new Cesium.EntityView(e,t,t.mapProjection.ellipsoid),this.entityView_.update(this.time_(),s),this.needTrackedEntityUpdate_=!1}handleResize_(){let e=this.canvas_.clientWidth,t=this.canvas_.clientHeight;if(e===0||t===0||e===this.canvasClientWidth_&&t===this.canvasClientHeight_&&!this.resolutionScaleChanged_)return;let i=this.resolutionScale_;H()||(i*=window.devicePixelRatio||1),this.resolutionScaleChanged_=!1,this.canvasClientWidth_=e,this.canvasClientHeight_=t,e*=i,t*=i,this.canvas_.width=e,this.canvas_.height=t,this.scene_.camera.frustum.aspectRatio=e/t}getCamera(){return this.camera_}getOlMap(){return this.map_}getOlView(){const e=this.map_.getView();return console.assert(e),e}getCesiumScene(){return this.scene_}getDataSources(){return this.dataSourceCollection_}getDataSourceDisplay(){return this.dataSourceDisplay_}getEnabled(){return this.enabled_}setEnabled(e){if(this.enabled_===e)return;this.enabled_=e,this.container_.style.visibility=this.enabled_?"visible":"hidden";let t;if(this.enabled_){if(this.throwOnUnitializedMap_(),this.isOverMap_){t=this.map_.getInteractions(),t.forEach((s,n,r)=>{this.pausedInteractions_.push(s)}),t.clear(),this.map_.addInteraction=s=>this.pausedInteractions_.push(s),this.map_.removeInteraction=s=>{let n=!1;return this.pausedInteractions_=this.pausedInteractions_.filter(r=>{const o=r!==s;return n||(n=o),o}),n?s:void 0};const i=this.map_.getLayerGroup();i.getVisible()&&(this.hiddenRootGroup_=i,this.hiddenRootGroup_.setVisible(!1)),this.map_.getOverlayContainer().classList.add("olcs-hideoverlay")}this.camera_.readFromView(),this.render_()}else this.isOverMap_&&(t=this.map_.getInteractions(),this.pausedInteractions_.forEach(i=>{t.push(i)}),this.pausedInteractions_.length=0,this.map_.addInteraction=i=>this.map_.getInteractions().push(i),this.map_.removeInteraction=i=>this.map_.getInteractions().remove(i),this.map_.getOverlayContainer().classList.remove("olcs-hideoverlay"),this.hiddenRootGroup_&&(this.hiddenRootGroup_.setVisible(!0),this.hiddenRootGroup_=null)),this.camera_.updateView()}warmUp(e,t){if(this.enabled_)return;this.throwOnUnitializedMap_(),this.camera_.readFromView();const i=this.globe_.ellipsoid,s=this.scene_.camera,n=i.cartesianToCartographic(s.position);n.height<e&&(n.height=e,s.position=i.cartographicToCartesian(n)),this.warmingUp_=!0,this.render_(),setTimeout(()=>{this.warmingUp_=!1},t)}setBlockCesiumRendering(e){this.blockCesiumRendering_!==e&&(this.blockCesiumRendering_=e,this.render_())}enableAutoRenderLoop(){this.autoRenderLoop_||(this.autoRenderLoop_=new Ft(this))}getAutoRenderLoop(){return this.autoRenderLoop_}setResolutionScale(e){e=Math.max(0,e),e!==this.resolutionScale_&&(this.resolutionScale_=Math.max(0,e),this.resolutionScaleChanged_=!0,this.autoRenderLoop_&&this.autoRenderLoop_.restartRenderLoop())}setTargetFrameRate(e){this.targetFrameRate_!==e&&(this.targetFrameRate_=e,this.render_())}throwOnUnitializedMap_(){const t=this.map_.getView(),i=t.getCenter();if(!t.isDef()||isNaN(i[0])||isNaN(i[1]))throw new Error(`The OpenLayers map is not properly initialized: ${i} / ${t.getResolution()}`)}get trackedFeature(){return this.trackedFeature_}set trackedFeature(e){if(this.trackedFeature_!==e){const t=this.scene_;if(!e||!e.getGeometry()){this.needTrackedEntityUpdate_=!1,t.screenSpaceCameraController.enableTilt=!0,this.trackedEntity_&&this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_),this.trackedEntity_=null,this.trackedFeature_=null,this.entityView_=null,t.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);return}this.trackedFeature_=e,this.needTrackedEntityUpdate_=!0;const i=this.to4326Transform_,s=function(){const r=e.getGeometry();console.assert(r instanceof z);const o=r instanceof z?r.getCoordinates():[],a=i(o,void 0,o.length);return E(a)},n={position:new Cesium.CallbackProperty((r,o)=>s(),!1),point:{pixelSize:1,color:Cesium.Color.TRANSPARENT}};this.trackedEntity_=this.dataSourceDisplay_.defaultDataSource.entities.add(n)}}}export{me as default};
//# sourceMappingURL=OLCesium-8d046678.js.map
