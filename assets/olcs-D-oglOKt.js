var fe=Object.defineProperty;var pe=(o,e,t)=>e in o?fe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var l=(o,e,t)=>pe(o,typeof e!="symbol"?e+"":e,t);import{a as O,bg as Ce,E as V,a7 as Z,a6 as _e,ac as ye,cX as ve,cY as we,aP as K,i as N,h as Se,ag as be,cZ as te,cT as Le,cU as Ee,c_ as Re,c$ as Pe,aT as M,d0 as Te,ax as Ae,cu as xe,cx as Fe,S as Oe,H as Me,bH as Y,cG as Ie,cd as Ge,d1 as ke,d2 as De,d3 as Ve,aS as Ne,d4 as Ue,c8 as He,cp as B,c6 as ze,c4 as Ke,ar as w,d5 as U,d6 as H,d7 as Be,d8 as je,e as We,cy as X,d9 as qe,aR as $,V as Ze,ay as Ye,_ as Xe,cD as $e,da as Qe}from"./lazy-CNpw-HpO.js";import{kx as Je}from"./component-DmEB9E06.js";class ie extends O{constructor(e){super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const i=t.getGeometry();return Ce(!i||i.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),i},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,i){this.source.loadFeatures(e,t,i),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(V.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(V.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const i=e===0?0:Math.min(t,e)/e,s=e!==this.distance||this.interpolationRatio!==i;this.distance=e,this.minDistance=t,this.interpolationRatio=i,s&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=be(),t=this.distance*this.resolution,i=this.source.getFeatures(),s={};for(let n=0,r=i.length;n<r;n++){const a=i[n];if(!(Z(a)in s)){const c=this.geometryFunction(a);if(c){const u=c.getCoordinates();_e(u,e),ye(e,t,e);const d=this.source.getFeaturesInExtent(e).filter(function(h){const m=Z(h);return m in s?!1:(s[m]=!0,!0)});this.features.push(this.createCluster(d,e))}}}}createCluster(e,t){const i=[0,0];for(let a=e.length-1;a>=0;--a){const c=this.geometryFunction(e[a]);c?ve(i,c.getCoordinates()):e.splice(a,1)}we(i,1/e.length);const s=K(t),n=this.interpolationRatio,r=new N([i[0]*(1-n)+s[0]*n,i[1]*(1-n)+s[1]*n]);return this.createCustomCluster_?this.createCustomCluster_(r,e):new Se({geometry:r,features:e})}}function et(o){const e=o.load||te,t=o.imageExtent,i=new Image;return o.crossOrigin!==null&&(i.crossOrigin=o.crossOrigin),()=>e(i,o.url).then(s=>{const n=Le(t)/s.width,r=Ee(t)/s.height;return{image:s,extent:t,resolution:n!==r?[n,r]:r,pixelRatio:1}})}class tt extends Re{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,i=e.imageLoadFunction!==void 0?e.imageLoadFunction:Pe;super({attributions:e.attributions,interpolate:e.interpolate,projection:M(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new Te(this.imageExtent_,void 0,1,et({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(s,n)=>(this.image.setImage(s),i(this.image,n),te(s))})),this.image.addEventListener(V.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,i,s){return Ae(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const it=tt;let P,se;function z(){if(P===void 0){const o=document.createElement("canvas");o.setAttribute("style","image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; image-rendering: pixelated;");const e=o.style.imageRendering;P=!!e,P&&(se=e)}return P}function st(){return z(),se||""}function F(o){return o.get("olcs_projection")||o.getProjection()}let nt=0;function y(o){return o.olcs_uid||(o.olcs_uid=++nt)}function G(o){const e=o,t=e.readyPromise;return t||(e.ready!==void 0?e.ready?Promise.resolve(o):new Promise((i,s)=>{const n=setInterval(()=>{e.ready&&(clearInterval(n),i(o))},20)}):Promise.reject("Not a readyable object"))}function ne(){const o=document.createElement("canvas");return o.width=1,o.height=1,o}class rt{constructor(e,t,i){l(this,"source_");l(this,"projection_");l(this,"fallbackProj_");l(this,"map_");l(this,"shouldRequestNextLevel");l(this,"emptyCanvas_",ne());l(this,"emptyCanvasPromise_",Promise.resolve(this.emptyCanvas_));l(this,"tilingScheme_");l(this,"ready_");l(this,"rectangle_");l(this,"errorEvent",new Cesium.Event);l(this,"credit");l(this,"proxy");this.source_=t,this.projection_=null,this.ready_=!1,this.fallbackProj_=i||null,this.tilingScheme_=new Cesium.WebMercatorTilingScheme,this.rectangle_=null,this.map_=e,this.shouldRequestNextLevel=!1;const s=this.source_.get("olcs_proxy");s&&(typeof s=="function"?this.proxy={getURL:s}:typeof s=="string"&&(this.proxy=new Cesium.DefaultProxy(s))),this.source_.on("change",n=>{this.handleSourceChanged_()}),this.handleSourceChanged_()}get ready(){return this.ready_}get rectangle(){return this.rectangle_}get tilingScheme(){return this.tilingScheme_}get _ready(){return this.ready_}get tileWidth(){const e=this.source_.getTileGrid();if(e){const t=e.getTileSize(0);return Array.isArray(t)?t[0]:t}return 256}get tileHeight(){const e=this.source_.getTileGrid();if(e){const t=e.getTileSize(0);return Array.isArray(t)?t[1]:t}return 256}get maximumLevel(){const e=this.source_.getTileGrid();return e?e.getMaxZoom():18}get minimumLevel(){return 0}get tileDiscardPolicy(){}get hasAlphaChannel(){return!0}pickFeatures(e,t,i,s,n){}handleSourceChanged_(){if(!this.ready_&&this.source_.getState()=="ready"){this.projection_=F(this.source_)||this.fallbackProj_;const e={numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1};if(this.source_.tileGrid!==null&&this.source_.tileGrid.forEachTileCoord(this.projection_.getExtent(),0,([t,i,s])=>{e.numberOfLevelZeroTilesX=i+1,e.numberOfLevelZeroTilesY=s+1}),this.projection_.getCode()==="EPSG:4326")this.shouldRequestNextLevel=e.numberOfLevelZeroTilesX===1&&e.numberOfLevelZeroTilesY===1,this.tilingScheme_=new Cesium.GeographicTilingScheme(e);else if(this.projection_.getCode()==="EPSG:3857")this.shouldRequestNextLevel=!1,this.tilingScheme_=new Cesium.WebMercatorTilingScheme(e);else return;this.rectangle_=this.tilingScheme_.rectangle,this.ready_=!0}}getTileCredits(e,t,i){const s=this.source_.getAttributions();if(!s)return[];const n=this.map_.getView().calculateExtent(this.map_.getSize()),r=this.map_.getView().getCenter(),a=this.shouldRequestNextLevel?i+1:i;return ue(s,a,r,n)}requestImage(e,t,i,s){const n=this.source_.getTileUrlFunction();if(n&&this.projection_){const r=this.shouldRequestNextLevel?i+1:i;let a=n.call(this.source_,[r,e,t],1,this.projection_);return this.proxy&&(a=this.proxy.getURL(a)),a?Cesium.ImageryProvider.loadImage(this,a):this.emptyCanvasPromise_}else return this.emptyCanvasPromise_}}const ot=new xe({featureClass:Fe}),at=[new Oe({stroke:new Me({color:"blue",width:2})})];class ct{constructor(e){l(this,"urls");l(this,"emptyCanvas_",ne());l(this,"emptyCanvasPromise_",Promise.resolve(this.emptyCanvas_));l(this,"tilingScheme_",new Cesium.WebMercatorTilingScheme);l(this,"ready_",!0);l(this,"rectangle_");l(this,"tileRectangle_");l(this,"tileWidth",256);l(this,"tileHeight",256);l(this,"maximumLevel",20);l(this,"minimumLevel_",0);l(this,"featureCache");l(this,"tileCache");l(this,"tileFunction_");l(this,"styleFunction_");l(this,"projection_",M("EPSG:3857"));l(this,"errorEvent",new Cesium.Event);l(this,"credit");l(this,"proxy");this.urls=e.urls,this.rectangle_=e.rectangle||this.tilingScheme.rectangle,this.credit=e.credit,this.styleFunction_=e.styleFunction||(()=>at),this.tileRectangle_=new Cesium.Rectangle;const t=e.cacheSize!==void 0?e.cacheSize:50;this.tileCache=new Y(t),this.featureCache=e.featureCache||new Y(t),this.minimumLevel_=e.minimumLevel||0;const i=Ie(this.projection_);this.tileFunction_=Ge(this.urls,i)}get minimumLevel(){return this.minimumLevel_}get ready(){return this.ready_}get rectangle(){return this.rectangle_}get tilingScheme(){return this.tilingScheme_}getTileCredits(e,t,i){return[]}get _ready(){return this.ready_}get tileDiscardPolicy(){}get hasAlphaChannel(){return!0}pickFeatures(e,t,i,s,n){}getTileFeatures(e,t,i){const s=this.getCacheKey_(e,t,i);let n;if(this.featureCache.containsKey(s)&&(n=this.featureCache.get(s)),!n){const r=this.getUrl_(e,t,i);if(n=fetch(r).then(a=>a.ok?a:Promise.reject(a)).then(a=>a.arrayBuffer()).then(a=>this.readFeaturesFromBuffer(a)),this.featureCache.set(s,n),this.featureCache.getCount()>2*this.featureCache.highWaterMark)for(;this.featureCache.canExpireCache();)this.featureCache.pop()}return n}readFeaturesFromBuffer(e){const t=ot.readFeatures(e),i=this.tileWidth/4096;return t.forEach(s=>{const n=s.getFlatCoordinates();for(let r=0;r<n.length;++r)n[r]*=i}),t}getUrl_(e,t,i){return this.tileFunction_([e,t,i],1,this.projection_)}getCacheKey_(e,t,i){return`${e}_${t}_${i}`}requestImage(e,t,i,s){if(i<this.minimumLevel_)return this.emptyCanvasPromise_;try{const n=this.getCacheKey_(i,e,t);let r;if(this.tileCache.containsKey(n)&&(r=this.tileCache.get(n)),!r&&(r=this.getTileFeatures(i,e,t).then(a=>{this.tilingScheme.tileXYToNativeRectangle(e,t,i,this.tileRectangle_);const c=(this.tileRectangle_.east-this.tileRectangle_.west)/this.tileWidth;return this.rasterizeFeatures(a,this.styleFunction_,c)}),this.tileCache.set(n,r),this.tileCache.getCount()>2*this.tileCache.highWaterMark))for(;this.tileCache.canExpireCache();)this.tileCache.pop();return r}catch(n){console.trace(n),this.errorEvent.raiseEvent("could not render pbf to tile",n)}}rasterizeFeatures(e,t,i){const s=document.createElement("canvas"),n=ke(s.getContext("2d"),{size:[this.tileWidth,this.tileHeight]});return e.forEach(r=>{const a=t(r,i);a&&(Array.isArray(a)?a.forEach(c=>{n.setStyle(c),n.drawGeometry(r)}):(n.setStyle(a),n.drawGeometry(r)))}),s}}function lt(o,e){const t=o.camera,i=o.canvas,s=t.frustum,n=Cesium.Cartesian3.magnitude(Cesium.Cartesian3.subtract(t.position,e,new Cesium.Cartesian3));return s.getPixelDimensions(i.clientWidth,i.clientHeight,n,o.pixelRatio,new Cesium.Cartesian2)}function kt(o,e,t){const i=lt(o,e),s=Cesium.Transforms.eastNorthUpToFixedFrame(e),n=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(-i.x*t,-i.y*t,0),new Cesium.Cartesian3),r=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(i.x*t,i.y*t,0),new Cesium.Cartesian3);return Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray([n,r])}function Dt(o,e){o.applyTransform((t,i,s)=>{if(console.assert(t===i),s!==void 0&&s>=3)for(let n=0;n<i.length;n+=s)i[n+2]=i[n+2]+e;return i})}function Vt(o,e=0,t=Cesium.Cartesian3.ZERO,i=new Cesium.Cartesian3(1,1,1)){const s=b(o),n=Cesium.Transforms.eastNorthUpToFixedFrame(s),r=Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Z,-e),a=Cesium.Matrix4.fromTranslationQuaternionRotationScale(t,r,i);return Cesium.Matrix4.multiply(n,a,new Cesium.Matrix4)}function j(o,e,t,i,s){const n=Cesium.Math.clamp,r=Cesium.defaultValue,a=s,c=r(a==null?void 0:a.duration,500),u=r(a==null?void 0:a.easing,De),d=a==null?void 0:a.callback;let h=0;const m=new Cesium.Matrix4,g=Date.now(),f=function(){const C=Date.now()-g,_=u(n(C/c,0,1));console.assert(_>=h),o.transform.clone(m);const v=(_-h)*e;h=_,o.lookAtTransform(i),o.rotate(t,v),o.lookAtTransform(m),_<1?window.requestAnimationFrame(f):d&&d()};window.requestAnimationFrame(f)}function re(o,e,t,i){const s=o.camera,n=ce(o,t),r=s.right,a=Cesium.Quaternion.fromAxisAngle(r,n),c=Cesium.Matrix3.fromQuaternion(a),u=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(s.position,t,u);const d=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,u,d),Cesium.Cartesian3.add(d,t,d);const h=Cesium.Matrix4.fromTranslation(d);j(s,e,d,h,i)}function oe(o,e){const t=o.camera.getPickRay(e);return o.globe.pick(t,o)||o.camera.pickEllipsoid(e)}function W(o){const e=o.canvas,t=new Cesium.Cartesian2(e.clientWidth/2,e.clientHeight);return oe(o,t)}function ut(o){const e=o.canvas,t=new Cesium.Cartesian2(e.clientWidth/2,e.clientHeight/2);return oe(o,t)}function ht(o){const e=o.camera,t=new Cesium.Ray(e.position,e.direction);let i=o.globe.pick(t,o);if(!i){const a=Cesium.Ellipsoid.WGS84,c=Cesium.IntersectionTests.rayEllipsoid(t,a);c&&(i=Cesium.Ray.getPoint(t,c.start))}if(!i)return;const s=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(i,s);const r=ae(e.direction,s,e.right)-Math.PI;return Cesium.Math.convertLongitudeRange(r)}function dt(o){const e=o.camera,t=e.frustum.fovy/2,i=e.direction,s=Cesium.Quaternion.fromAxisAngle(e.right,t),n=Cesium.Matrix3.fromQuaternion(s),r=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(n,i,r),new Cesium.Ray(e.position,r)}function ae(o,e,t){const i=new Cesium.Cartesian3,s=new Cesium.Cartesian3,n=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(o,i),Cesium.Cartesian3.normalize(e,s),Cesium.Cartesian3.cross(i,s,n);const r=Cesium.Cartesian3.dot(i,s),a=Cesium.Cartesian3.magnitude(n),c=Cesium.Cartesian3.dot(t,n),u=Math.atan2(a,r);return c>=0?u:-u}function ce(o,e){const t=o.camera,i=t.frustum.fovy/2,s=dt(o),n=Cesium.Cartesian3.clone(s.direction);Cesium.Cartesian3.negate(n,n);const r=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(e,r);const a=new Cesium.Cartesian3;return Cesium.Cartesian3.negate(t.right,a),ae(r,n,a)+i}function le(o,e){if(o&&e){const t=Ve(o,e,"EPSG:4326");return Cesium.Rectangle.fromDegrees(t[0],t[1],t[2],t[3])}else return null}function mt(o,e,t,i){const s=e.get("olcs_skip");if(s)return null;let n=null;if(e instanceof Ne&&e.getUrl()){const r={olcs_proxy:e.get("olcs_proxy"),olcs_extent:e.get("olcs_extent"),olcs_projection:e.get("olcs_projection"),"olcs.imagesource":e},a=e.getImageLoadFunction(),c=e.get("olcs_tileLoadFunction")||function(d,h){a(d,h)};e=new Ue({url:e.getUrl(),attributions:e.getAttributions(),projection:e.getProjection(),tileLoadFunction:c,params:e.getParams()}),e.setProperties(r)}if(e instanceof He){let r=F(e);if(r||(r=t),ee(r))n=new rt(o,e,t);else return null}else if(e instanceof it){let r=F(e);if(r||(r=t),ee(r)){const a=Cesium.Rectangle.fromDegrees(e.getImageExtent()[0],e.getImageExtent()[1],e.getImageExtent()[2],e.getImageExtent()[3],new Cesium.Rectangle);n=new Cesium.SingleTileImageryProvider({url:e.getUrl(),rectangle:a})}else return null}else if(e instanceof Je&&i instanceof B){let r=F(e);if(r||(r=t),s===!1){const a=r.getCode().split(":")[1],c=e.urls.map(p=>p.replace(a,"3857")),u=i.getExtent(),d=le(u,r),h=e.get("olcs_minimumLevel"),m=e.getAttributions(),g=i.getStyleFunction();let f;if(u&&m){const p=K(u);f=ue(m,0,p,u)[0]}return n=new ct({credit:f,rectangle:d,minimumLevel:h,styleFunction:g,urls:c}),n}return null}else return null;return n}function gt(o,e,t){if(!(e instanceof ze)&&!(e instanceof Ke)&&!(e instanceof B))return null;const i=e.getSource();if(!i)return null;let s=i.get("olcs_provider");if(s||(s=mt(o,i,t,e)),!s)return null;const n={},a=e.get("olcs_extent")||e.getExtent();return a&&(n.rectangle=le(a,t)),new Cesium.ImageryLayer(s,n)}function Q(o,e){let t=1,i=!0;[o.layer].concat(o.parents).forEach(s=>{const n=s.getOpacity();n!==void 0&&(t*=n);const r=s.getVisible();r!==void 0&&(i=i&&r)}),e.alpha=t,e.show=i}function b(o){const e=o;return e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1])}function k(o){console.assert(o!==null);const e=b,t=[];for(let i=0;i<o.length;++i)t.push(e(o[i]));return t}function T(o,e){console.assert(e);const t=M("EPSG:4326"),i=M(e);if(i.getCode()!==t.getCode()){const s=o.getProperties();o=o.clone(),o.transform(i,t),o.setProperties(s)}return o}function J(o){if(o=o||"black",Array.isArray(o))return new Cesium.Color(Cesium.Color.byteToFloat(o[0]),Cesium.Color.byteToFloat(o[1]),Cesium.Color.byteToFloat(o[2]),o[3]);if(typeof o=="string")return Cesium.Color.fromCssColorString(o);if(o instanceof CanvasPattern||o instanceof CanvasGradient){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=e.height=256,t.fillStyle=o,t.fillRect(0,0,e.width,e.height),new Cesium.ImageMaterialProperty({image:e})}console.assert(!1,"impossible")}function Nt(o){let e="";const t=/\{(\d|[a-z])-(\d|[a-z])\}/,i=t.exec(o);if(i){o=o.replace(t,"{s}");const s=i[1].charCodeAt(0),n=i[2].charCodeAt(0);let r;for(r=s;r<=n;++r)e+=String.fromCharCode(r)}return{url:o,subdomains:e}}function ft(o,e){return new Promise((t,i)=>{const s=e.camera,n=W(e);if(!n){i("Could not get bottom pivot");return}const r=o.getView().getRotation();if(r===void 0){i("The view is not initialized");return}const a=ce(e,n);re(e,r,n);const c=Cesium.Matrix4.fromTranslation(n),u=s.right,d={callback:()=>{const h=o.getView();Ct(h),t(void 0)}};j(s,-a,u,c,d)})}function pt(o,e){return new Promise((t,i)=>{const s=o.camera,n=W(o);if(!n){i("could not get bottom pivot");return}const r={callback:()=>t(void 0)},a=Cesium.Matrix4.fromTranslation(n),c=s.right;j(s,-e,c,a,r)})}function Ct(o,e=0){const t=o.getResolution();o.setRotation(e),o.constrainResolution?o.setResolution(o.constrainResolution(t)):o.setResolution(o.getConstrainedResolution(t))}function ee(o){const e=o.getCode()==="EPSG:3857",t=o.getCode()==="EPSG:4326";return e||t}function ue(o,e,t,i){if(!o)return[];let s=o({viewState:{zoom:e,center:t,projection:void 0,resolution:void 0,rotation:void 0},extent:i});return Array.isArray(s)||(s=[s]),s.map(n=>new Cesium.Credit(n,!0))}function _t(o,e,t,i){const s=t.canvas,r=t.camera.frustum.fovy;console.assert(!isNaN(r));const a=i.getMetersPerUnit(),c=o*s.clientHeight,u=Math.cos(Math.abs(e));return c*a*u/2/Math.tan(r/2)}function yt(o,e,t,i){const s=t.canvas,r=t.camera.frustum.fovy;console.assert(!isNaN(r));const a=i.getMetersPerUnit(),c=2*o*Math.tan(r/2),u=Math.cos(Math.abs(e));return c/a/u/s.clientHeight}function vt(o,e,t){let i=!1;return function(){if(!i){const s=o.position,n=Cesium.Cartographic.fromCartesian(s);if(Cesium.Cartesian3.distance(e.center,s)>e.radius*t(n.height)){if(o.flying===!0)return;{i=!0;const a=()=>i=!1;o.flyToBoundingSphere(e,{complete:a,cancel:a})}}}}}class wt{constructor(e){l(this,"ol3d");l(this,"scene_");l(this,"canvas_");l(this,"_boundNotifyRepaintRequired");l(this,"repaintEventNames_",["mousemove","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove","wheel"]);this.ol3d=e,this.scene_=e.getCesiumScene(),this.canvas_=this.scene_.canvas,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.enable()}enable(){this.scene_.requestRenderMode=!0,this.scene_.maximumRenderTimeChange=1e3;for(const e of this.repaintEventNames_)this.canvas_.addEventListener(e,this._boundNotifyRepaintRequired,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().on("change",this._boundNotifyRepaintRequired)}disable(){for(const e of this.repaintEventNames_)this.canvas_.removeEventListener(e,this._boundNotifyRepaintRequired,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().un("change",this._boundNotifyRepaintRequired),this.scene_.requestRenderMode=!1}restartRenderLoop(){this.notifyRepaintRequired()}notifyRepaintRequired(){this.scene_.isDestroyed()||this.scene_.requestRender()}}function A(o){return o*180/Math.PI}function L(o){return o*Math.PI/180}function x(o,e,t){const i=t||o.length;if(e)for(let s=0;s<i;++s)e[s]=o[s];return o}class St{constructor(e,t){l(this,"scene_");l(this,"cam_");l(this,"map_");l(this,"view_");l(this,"viewListenKey_",null);l(this,"toLonLat_",x);l(this,"fromLonLat_",x);l(this,"tilt_",0);l(this,"distance_",0);l(this,"lastCameraViewMatrix_",null);l(this,"viewUpdateInProgress_",!1);this.scene_=e,this.cam_=e.camera,this.map_=t,this.map_.on("change:view",i=>{this.setView_(this.map_.getView())}),this.setView_(this.map_.getView())}destroy(){w(this.viewListenKey_),this.viewListenKey_=null}setView_(e){if(w(this.viewListenKey_),this.viewListenKey_=null,this.view_=e,e){const t=U(e.getProjection(),"EPSG:4326"),i=U("EPSG:4326",e.getProjection());console.assert(t&&i),this.toLonLat_=t,this.fromLonLat_=i,this.viewListenKey_=e.on("propertychange",s=>this.handleViewChangedEvent_()),this.readFromView()}else this.toLonLat_=x,this.fromLonLat_=x}handleViewChangedEvent_(){this.viewUpdateInProgress_||this.readFromView()}setHeading(e){this.view_&&this.view_.setRotation(e)}getHeading(){return this.view_?this.view_.getRotation()||0:void 0}setTilt(e){this.tilt_=e,this.updateCamera_()}getTilt(){return this.tilt_}setDistance(e){this.distance_=e,this.updateCamera_(),this.updateView()}getDistance(){return this.distance_}setCenter(e){this.view_&&this.view_.setCenter(e)}getCenter(){if(this.view_)return this.view_.getCenter()}setPosition(e){if(!this.toLonLat_)return;const t=this.toLonLat_(e);console.assert(t);const i=new Cesium.Cartographic(L(t[0]),L(t[1]),this.getAltitude());this.cam_.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(i)}),this.updateView()}getPosition(){if(!this.fromLonLat_)return;const e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position),t=this.fromLonLat_([A(e.longitude),A(e.latitude)]);return console.assert(t),t}setAltitude(e){const t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);t.height=e,this.cam_.position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(t),this.updateView()}getAltitude(){return Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position).height}updateCamera_(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(!e)return;const t=this.toLonLat_(e);console.assert(t);const i=new Cesium.Cartographic(L(t[0]),L(t[1]));if(this.scene_.globe){const r=this.scene_.globe.getHeight(i);i.height=r||0}const s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(i),n={pitch:this.tilt_-Cesium.Math.PI_OVER_TWO,heading:-this.view_.getRotation(),roll:void 0};this.cam_.setView({destination:s,orientation:n}),this.cam_.moveBackward(this.distance_),this.checkCameraChange(!0)}readFromView(){if(!this.view_||!this.toLonLat_)return;const e=this.view_.getCenter();if(e==null)return;const t=this.toLonLat_(e);console.assert(t);const i=this.view_.getResolution();this.distance_=this.calcDistanceForResolution(i||0,L(t[1])),this.updateCamera_()}updateView(){if(!this.view_||!this.fromLonLat_)return;this.viewUpdateInProgress_=!0;const e=Cesium.Ellipsoid.WGS84,t=this.scene_,i=ut(t);let s=i;if(!s){const r=t.globe,a=this.cam_.positionCartographic.clone(),c=r.getHeight(a);a.height=c||0,s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)}this.distance_=Cesium.Cartesian3.distance(s,this.cam_.position);const n=e.cartesianToCartographic(s);if(this.view_.setCenter(this.fromLonLat_([A(n.longitude),A(n.latitude)])),this.view_.setResolution(this.calcResolutionForDistance(this.distance_,n?n.latitude:0)),i){const r=this.cam_.position,a=new Cesium.Cartesian3;e.geocentricSurfaceNormal(i,a);const c=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r,i,c),Cesium.Cartesian3.normalize(c,c);const u=this.cam_.up,d=this.cam_.right,h=new Cesium.Cartesian3(-i.y,i.x,0),m=Cesium.Cartesian3.angleBetween(d,h),f=Cesium.Cartesian3.cross(i,u,new Cesium.Cartesian3).z;this.view_.setRotation(f<0?m:-m);const p=Math.acos(Cesium.Cartesian3.dot(a,c));this.tilt_=isNaN(p)?0:p}else this.view_.setRotation(this.cam_.heading),this.tilt_=-this.cam_.pitch+Math.PI/2;setTimeout(()=>this.viewUpdateInProgress_=!1,1e3)}checkCameraChange(e){const t=this.lastCameraViewMatrix_,i=this.cam_.viewMatrix;(!t||!Cesium.Matrix4.equalsEpsilon(t,i,1e-7))&&(this.lastCameraViewMatrix_=i.clone(),e!==!0&&this.updateView())}calcDistanceForResolution(e,t){return _t(e,t,this.scene_,this.view_.getProjection())}calcResolutionForDistance(e,t){return yt(e,t,this.scene_,this.view_.getProjection())}}class he{constructor(e,t){l(this,"map");l(this,"view");l(this,"scene");l(this,"olLayers");l(this,"mapLayerGroup");l(this,"layerMap",{});l(this,"olLayerListenKeys",{});l(this,"olGroupListenKeys_",{});this.map=e,this.view=e.getView(),this.scene=t,this.olLayers=e.getLayerGroup().getLayers(),this.mapLayerGroup=e.getLayerGroup()}synchronize(){this.destroyAll(),this.addLayers_(this.mapLayerGroup)}orderLayers(){}addLayers_(e){const t=[{layer:e,parents:[]}];for(;t.length>0;){const i=t.splice(0,1)[0],s=i.layer,n=y(s).toString();this.olLayerListenKeys[n]=[],console.assert(!this.layerMap[n]);let r=null;if(s instanceof H)this.listenForGroupChanges_(s),s!==this.mapLayerGroup&&(r=this.createSingleLayerCounterparts(i)),r||s.getLayers().forEach(a=>{if(a){const c={layer:a,parents:s===this.mapLayerGroup?[]:[i.layer].concat(i.parents)};t.push(c)}});else if(r=this.createSingleLayerCounterparts(i),!r){const a=n,c=i,u=()=>{const d=this.createSingleLayerCounterparts(c);d&&(c.layer.un("change",u),this.addCesiumObjects_(d,a,c.layer),this.orderLayers())};this.olLayerListenKeys[n].push(c.layer.on("change",u))}r&&this.addCesiumObjects_(r,n,s)}this.orderLayers()}addCesiumObjects_(e,t,i){this.layerMap[t]=e,this.olLayerListenKeys[t].push(i.on("change:zIndex",()=>this.orderLayers())),e.forEach(s=>{this.addCesiumObject(s)})}removeAndDestroySingleLayer_(e){const t=y(e).toString(),i=this.layerMap[t];return i&&(i.forEach(s=>{this.removeSingleCesiumObject(s,!1),this.destroyCesiumObject(s)}),this.olLayerListenKeys[t].forEach(w),delete this.olLayerListenKeys[t]),delete this.layerMap[t],!!i}unlistenSingleGroup_(e){if(e===this.mapLayerGroup)return;const t=y(e).toString();this.olGroupListenKeys_[t].forEach(s=>{w(s)}),delete this.olGroupListenKeys_[t],delete this.layerMap[t]}removeLayer_(e){if(e){const t=[e];for(;t.length>0;){const i=t.splice(0,1)[0],s=this.removeAndDestroySingleLayer_(i);i instanceof H&&(this.unlistenSingleGroup_(i),s||i.getLayers().forEach(n=>{t.push(n)}))}}}listenForGroupChanges_(e){const t=y(e).toString();console.assert(this.olGroupListenKeys_[t]===void 0);const i=[];this.olGroupListenKeys_[t]=i;let s=[];const n=(function(){const r=e.getLayers();r&&(s=[r.on("add",a=>{this.addLayers_(a.element)}),r.on("remove",a=>{this.removeLayer_(a.element)})],i.push(...s))}).bind(this);n(),i.push(e.on("change:layers",r=>{s.forEach(a=>{const c=i.indexOf(a);c>=0&&i.splice(c,1),w(a)}),n()}))}destroyAll(){this.removeAllCesiumObjects(!0);let e;for(e in this.olGroupListenKeys_)this.olGroupListenKeys_[e].forEach(w);for(e in this.olLayerListenKeys)this.olLayerListenKeys[e].forEach(w);this.olGroupListenKeys_={},this.olLayerListenKeys={},this.layerMap={}}}class bt extends he{constructor(t,i){super(t,i);l(this,"cesiumLayers_");l(this,"ourLayers_");this.cesiumLayers_=i.imageryLayers,this.ourLayers_=new Cesium.ImageryLayerCollection}addCesiumObject(t){this.cesiumLayers_.add(t),this.ourLayers_.add(t)}destroyCesiumObject(t){t.destroy()}removeSingleCesiumObject(t,i){this.cesiumLayers_.remove(t,i),this.ourLayers_.remove(t,!1)}removeAllCesiumObjects(t){for(let i=0;i<this.ourLayers_.length;++i)this.cesiumLayers_.remove(this.ourLayers_.get(i),t);this.ourLayers_.removeAll(!1)}convertLayerToCesiumImageries(t,i){const s=gt(this.map,t,i);return s?[s]:null}createSingleLayerCounterparts(t){const i=t.layer,s=y(i).toString(),n=this.view.getProjection();console.assert(n);const r=this.convertLayerToCesiumImageries(i,n);if(r){const a=[];if([t.layer].concat(t.parents).forEach(c=>{a.push(c.on(["change:opacity","change:visible"],()=>{console.assert(r);for(let u=0;u<r.length;++u)Q(t,r[u])}))}),i instanceof Be){let c=i.getStyleFunction();a.push(i.on("change",()=>{var d;const u=i.getStyleFunction();if(c!==u){c=u;for(let h=0;h<r.length;++h){const m=r[h];m._imageryCache&&(m._imageryCache={});const g=m.imageryProvider;g&&((d=g.tileCache)==null||d.clear(),g.styleFunction_=u)}this.scene.requestRender()}}))}for(let c=0;c<r.length;++c)Q(t,r[c]);a.push(i.on("change:extent",c=>{for(let u=0;u<r.length;++u)this.cesiumLayers_.remove(r[u],!0),this.ourLayers_.remove(r[u],!1);delete this.layerMap[y(i)],this.synchronize()})),a.push(i.on("change",c=>{for(let u=0;u<r.length;++u){const d=this.cesiumLayers_.indexOf(r[u]);d>=0&&(this.cesiumLayers_.remove(r[u],!1),this.cesiumLayers_.add(r[u],d))}})),this.olLayerListenKeys[s].push(...a)}return Array.isArray(r)?r:null}orderLayers(){const t=[],i={},s=[this.mapLayerGroup];for(;s.length>0;){const n=s.splice(0,1)[0];if(t.push(n),i[y(n)]=n.getZIndex()||0,n instanceof H){const r=n.getLayers();r&&s.unshift(...r.getArray())}}t.sort((n,r)=>i[y(n)]-i[y(r)]),t.forEach(n=>{const r=y(n).toString(),a=this.layerMap[r];a&&a.forEach(c=>{this.raiseToTop(c)})})}raiseToTop(t){this.cesiumLayers_.raiseToTop(t)}}class Lt{constructor(e,t){l(this,"olListenKeys",[]);l(this,"context");l(this,"rootCollection_");const i=new Cesium.BillboardCollection({scene:t}),s=new Cesium.PrimitiveCollection;this.rootCollection_=new Cesium.PrimitiveCollection,this.context={projection:e,billboards:i,featureToCesiumMap:{},primitives:s},this.rootCollection_.add(i),this.rootCollection_.add(s)}destroy(){this.olListenKeys.forEach(w),this.olListenKeys.length=0}getRootPrimitive(){return this.rootCollection_}}class Et{constructor(e){l(this,"scene");l(this,"boundOnRemoveOrClearFeatureListener_",this.onRemoveOrClearFeature_.bind(this));l(this,"defaultBillboardEyeOffset_",new Cesium.Cartesian3(0,0,10));this.scene=e,this.scene=e}onRemoveOrClearFeature_(e){const t=e.target;console.assert(t instanceof O);const i=t.olcs_cancellers;if(i){const s=e.feature;if(s){const n=y(s),r=i[n];r&&(r(),delete i[n])}else{for(const n in i)i.hasOwnProperty(n)&&i[n]();t.olcs_cancellers={}}}}setReferenceForPicking(e,t,i){i.olLayer=e,i.olFeature=t}createColoredPrimitive(e,t,i,s,n,r){const a=function(m,g){const f=new Cesium.GeometryInstance({geometry:m});return g&&!(g instanceof Cesium.ImageMaterialProperty)&&(f.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(g)}),f},c={flat:!0,renderState:{depthTest:{enabled:!0}}};r!==void 0&&(c.renderState.lineWidth=r);const u=a(s,n),d=this.getHeightReference(e,t,i);let h;if(d===Cesium.HeightReference.CLAMP_TO_GROUND){if(!("createShadowVolume"in u.geometry.constructor))return null;h=new Cesium.GroundPrimitive({geometryInstances:u})}else h=new Cesium.Primitive({geometryInstances:u});if(n instanceof Cesium.ImageMaterialProperty){const m=n.image.getValue().toDataURL();h.appearance=new Cesium.MaterialAppearance({flat:!0,renderState:{depthTest:{enabled:!0}},material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:m}}})})}else h.appearance=new Cesium.MaterialAppearance({...c,material:new Cesium.Material({translucent:n.alpha!==1,fabric:{type:"Color",uniforms:{color:n}}})}),h instanceof Cesium.Primitive&&(t.get("olcs_shadows")||e.get("olcs_shadows"))&&(h.shadows=1);return this.setReferenceForPicking(e,t,h),h}extractColorFromOlStyle(e,t){var r;const i=(r=e.getFill())==null?void 0:r.getColor(),s=e.getStroke()?e.getStroke().getColor():null;let n="black";return s&&t?n=s:i&&(n=i),J(n)}extractLineWidthFromOlStyle(e){const t=e.getStroke()?e.getStroke().getWidth():void 0;return t!==void 0?t:1}wrapFillAndOutlineGeometries(e,t,i,s,n,r){const a=this.extractColorFromOlStyle(r,!1),c=this.extractColorFromOlStyle(r,!0),u=new Cesium.PrimitiveCollection;if(r.getFill()){const d=this.createColoredPrimitive(e,t,i,s,a);console.assert(!!d),u.add(d)}if(r.getStroke()&&n){const d=this.extractLineWidthFromOlStyle(r),h=this.createColoredPrimitive(e,t,i,n,c,d);h&&u.add(h)}return u}addTextStyle(e,t,i,s,n){let r;if(n instanceof Cesium.PrimitiveCollection?r=n:(r=new Cesium.PrimitiveCollection,r.add(n)),!s.getText())return r;const a=s.getText(),c=this.olGeometry4326TextPartToCesium(e,t,i,a);return c&&r.add(c),r}csAddBillboard(e,t,i,s,n,r){t.eyeOffset||(t.eyeOffset=this.defaultBillboardEyeOffset_);const a=e.add(t);return this.setReferenceForPicking(i,s,a),a}olCircleGeometryToCesium(e,t,i,s,n){i=T(i,s),console.assert(i.getType()=="Circle");const r=i.getCenter(),a=r.length==3?r[2]:0,c=r.slice();c[0]+=i.getRadius();const u=b(r),d=b(c),h=Cesium.Cartesian3.distance(u,d),m=new Cesium.CircleGeometry({center:u,radius:h,height:a});let g,f;if(this.getHeightReference(e,t,i)===Cesium.HeightReference.CLAMP_TO_GROUND){const C=this.extractLineWidthFromOlStyle(n);if(C){const _=je(i.getCenter(),h),v=k(_.getLinearRing(0).getCoordinates()),S=g=new Cesium.GroundPolylinePrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.GroundPolylineGeometry({positions:v,width:C})}),appearance:new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)}),classificationType:Cesium.ClassificationType.TERRAIN});G(g).then(()=>{this.setReferenceForPicking(e,t,S._primitive)})}}else f=new Cesium.CircleOutlineGeometry({center:u,radius:h,extrudedHeight:a,height:a});const p=this.wrapFillAndOutlineGeometries(e,t,i,m,f,n);return g&&p.add(g),this.addTextStyle(e,t,i,n,p)}olLineStringGeometryToCesium(e,t,i,s,n){i=T(i,s),console.assert(i.getType()=="LineString");const r=k(i.getCoordinates()),a=this.extractLineWidthFromOlStyle(n);let c;const u=this.getHeightReference(e,t,i),d=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)});if(u===Cesium.HeightReference.CLAMP_TO_GROUND){const h=new Cesium.GroundPolylineGeometry({positions:r,width:a}),m=c=new Cesium.GroundPolylinePrimitive({appearance:d,geometryInstances:new Cesium.GeometryInstance({geometry:h})});G(c).then(()=>{this.setReferenceForPicking(e,t,m._primitive)})}else{const h=new Cesium.PolylineGeometry({positions:r,width:a,vertexFormat:d.vertexFormat});c=new Cesium.Primitive({appearance:d,geometryInstances:new Cesium.GeometryInstance({geometry:h})})}return this.setReferenceForPicking(e,t,c),this.addTextStyle(e,t,i,n,c)}olPolygonGeometryToCesium(e,t,i,s,n){i=T(i,s),console.assert(i.getType()=="Polygon");const r=this.getHeightReference(e,t,i);let a,c,u;if(i.getCoordinates()[0].length==5&&t.get("olcs_polygon_kind")==="rectangle"){const h=i.getCoordinates()[0],m=We(h),g=Cesium.Rectangle.fromDegrees(m[0],m[1],m[2],m[3]);let f=0;if(h[0].length==3)for(let C=0;C<h.length;C++)f=Math.max(f,h[C][2]);const p=t.get("olcs_extruded_height");a=new Cesium.RectangleGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:g,height:f,extrudedHeight:p}),c=new Cesium.RectangleOutlineGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:g,height:f,extrudedHeight:p})}else{const h=i.getLinearRings(),m={positions:[],holes:[]},g=m;console.assert(h.length>0);for(let p=0;p<h.length;++p){const C=h[p].getCoordinates(),_=k(C);console.assert(_&&_.length>0),p===0?m.positions=_:m.holes.push({positions:_,holes:[]})}const f=t.get("olcs_extruded_height");if(a=new Cesium.PolygonGeometry({polygonHierarchy:g,perPositionHeight:!0,extrudedHeight:f}),r===Cesium.HeightReference.CLAMP_TO_GROUND){const p=this.extractLineWidthFromOlStyle(n);if(p>0){const C=[m.positions];if(m.holes)for(let S=0;S<m.holes.length;++S)C.push(m.holes[S].positions);const _=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(t,n,!0)}),v=[];for(const S of C){const E=new Cesium.GroundPolylineGeometry({positions:S,width:p});v.push(new Cesium.GeometryInstance({geometry:E}))}u=new Cesium.GroundPolylinePrimitive({appearance:_,geometryInstances:v}),G(u).then(()=>{this.setReferenceForPicking(e,t,u._primitive)})}}else c=new Cesium.PolygonOutlineGeometry({polygonHierarchy:m,perPositionHeight:!0,extrudedHeight:f})}const d=this.wrapFillAndOutlineGeometries(e,t,i,a,c,n);return u&&d.add(u),this.addTextStyle(e,t,i,n,d)}getHeightReference(e,t,i){let s=i.get("altitudeMode");s===void 0&&(s=t.get("altitudeMode")),s===void 0&&(s=e.get("altitudeMode"));let n=Cesium.HeightReference.NONE;return s==="clampToGround"?n=Cesium.HeightReference.CLAMP_TO_GROUND:s==="relativeToGround"&&(n=Cesium.HeightReference.RELATIVE_TO_GROUND),n}createBillboardFromImage(e,t,i,s,n,r,a,c){r instanceof X&&r.load();const u=r.getImage(1),d=function(m){return m.src!=""&&m.naturalHeight!=0&&m.naturalWidth!=0&&m.complete},h=(function(){if(!u||!(u instanceof HTMLCanvasElement||u instanceof Image||u instanceof HTMLImageElement))return;const m=i.getCoordinates(),g=b(m);let f;const p=r.getOpacity();p!==void 0&&(f=new Cesium.Color(1,1,1,p));const C=r.getScale(),_=this.getHeightReference(e,t,i),v={image:u,color:f,scale:C,heightReference:_,position:g};if(Object.assign(v,t.get("cesiumOptions")),r instanceof X){const E=r.getAnchor();if(E){const me=Array.isArray(C)?C[0]:C,ge=Array.isArray(C)?C[1]:C;v.pixelOffset=new Cesium.Cartesian2((u.width/2-E[0])*me,(u.height/2-E[1])*ge)}}const S=this.csAddBillboard(a,v,e,t,i,n);c&&c(S)}).bind(this);if(u instanceof Image&&!d(u)){let m=!1;const g=e.getSource(),f=function(){m=!0};g.on(["removefeature","clear"],this.boundOnRemoveOrClearFeatureListener_);let p=g.olcs_cancellers;p||(p=g.olcs_cancellers={});const C=y(t);p[C]&&p[C](),p[C]=f;const _=function(){u.removeEventListener("load",_),!a.isDestroyed()&&!m&&h()};u.addEventListener("load",_)}else h()}olPointGeometryToCesium(e,t,i,s,n,r,a){console.assert(i.getType()=="Point"),i=T(i,s);let c=null;const u=n.getImage();if(u){const d=i.get("olcs_model")||t.get("olcs_model");if(d){c=new Cesium.PrimitiveCollection;const h=d(),m=Object.assign({},{scene:this.scene},h.cesiumOptions);if("fromGltf"in Cesium.Model){const g=Cesium.Model.fromGltf(m);c.add(g)}else Cesium.Model.fromGltfAsync(m).then(g=>{c.add(g)});h.debugModelMatrix&&c.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:h.debugModelMatrix}))}else this.createBillboardFromImage(e,t,i,s,n,u,r,a)}return n.getText()?this.addTextStyle(e,t,i,n,c||new Cesium.Primitive):c}olMultiGeometryToCesium(e,t,i,s,n,r,a){switch(i.getType()){case"MultiPoint":{const c=i.getPoints();if(n.getText()){const u=new Cesium.PrimitiveCollection;return c.forEach(d=>{console.assert(d);const h=this.olPointGeometryToCesium(e,t,d,s,n,r,a);h&&u.add(h)}),u}else return c.forEach(u=>{console.assert(u),this.olPointGeometryToCesium(e,t,u,s,n,r,a)}),null}case"MultiLineString":{const c=i.getLineStrings(),u=new Cesium.PrimitiveCollection;return c.forEach(d=>{const h=this.olLineStringGeometryToCesium(e,t,d,s,n);u.add(h)}),u}case"MultiPolygon":{const c=i.getPolygons(),u=new Cesium.PrimitiveCollection;return c.forEach(d=>{const h=this.olPolygonGeometryToCesium(e,t,d,s,n);u.add(h)}),u}default:console.assert(!1,`Unhandled multi geometry type${i.getType()}`)}}olGeometry4326TextPartToCesium(e,t,i,s){const n=s.getText();if(!n)return null;const r=new Cesium.LabelCollection({scene:this.scene}),a=K(i.getExtent());if(i instanceof qe){const f=i.getFirstCoordinate();a[2]=f.length==3?f[2]:0}const c={};c.position=b(a),c.text=n,c.heightReference=this.getHeightReference(e,t,i);const u=s.getOffsetX(),d=s.getOffsetY();if(u!=0||d!=0){const f=new Cesium.Cartesian2(u,d);c.pixelOffset=f}c.font=s.getFont()||"10px sans-serif";let h;s.getFill()&&(c.fillColor=this.extractColorFromOlStyle(s,!1),h=Cesium.LabelStyle.FILL),s.getStroke()&&(c.outlineWidth=this.extractLineWidthFromOlStyle(s),c.outlineColor=this.extractColorFromOlStyle(s,!0),h=Cesium.LabelStyle.OUTLINE),s.getFill()&&s.getStroke()&&(h=Cesium.LabelStyle.FILL_AND_OUTLINE),c.style=h;let m;switch(s.getTextAlign()){case"left":m=Cesium.HorizontalOrigin.LEFT;break;case"right":m=Cesium.HorizontalOrigin.RIGHT;break;case"center":default:m=Cesium.HorizontalOrigin.CENTER}if(c.horizontalOrigin=m,s.getTextBaseline()){let f;switch(s.getTextBaseline()){case"top":f=Cesium.VerticalOrigin.TOP;break;case"middle":f=Cesium.VerticalOrigin.CENTER;break;case"bottom":f=Cesium.VerticalOrigin.BOTTOM;break;case"alphabetic":f=Cesium.VerticalOrigin.TOP;break;case"hanging":f=Cesium.VerticalOrigin.BOTTOM;break;default:console.assert(!1,`unhandled baseline ${s.getTextBaseline()}`)}c.verticalOrigin=f}const g=r.add(c);return this.setReferenceForPicking(e,t,g),r}olStyleToCesium(e,t,i){const s=t.getFill(),n=t.getStroke();if(i&&!n||!i&&!s)return null;const r=i?n.getColor():s.getColor(),a=J(r),c=n.getLineDash();return i&&c?Cesium.Material.fromType("PolylineDash",{dashPattern:Rt(c),color:a}):Cesium.Material.fromType("Color",{color:a})}computePlainStyle(e,t,i,s){const n=t.getStyleFunction();let r=null;return n&&(r=n(t,s)),!r&&i&&(r=i(t,s)),r?Array.isArray(r)?r:[r]:null}getGeometryFromFeature(e,t,i){if(i)return i;const s=e.get("olcs_3d_geometry");if(s&&s instanceof $)return s;if(t){const n=t.getGeometryFunction()(e);if(n instanceof $)return n}return e.getGeometry()}olFeatureToCesium(e,t,i,s,n){const r=this.getGeometryFromFeature(t,i,n);if(!r)return null;const a=s.projection,c=function(u){const d=s.featureToCesiumMap[y(t)];d instanceof Array?d.push(u):s.featureToCesiumMap[y(t)]=[u]};switch(r.getType()){case"GeometryCollection":const u=new Cesium.PrimitiveCollection;return r.getGeometriesArray().forEach(m=>{if(m){const g=this.olFeatureToCesium(e,t,i,s,m);g&&u.add(g)}}),u;case"Point":const d=s.billboards,h=this.olPointGeometryToCesium(e,t,r,a,i,d,c);return h||null;case"Circle":return this.olCircleGeometryToCesium(e,t,r,a,i);case"LineString":return this.olLineStringGeometryToCesium(e,t,r,a,i);case"Polygon":return this.olPolygonGeometryToCesium(e,t,r,a,i);case"MultiPoint":return this.olMultiGeometryToCesium(e,t,r,a,i,s.billboards,c)||null;case"MultiLineString":return this.olMultiGeometryToCesium(e,t,r,a,i,s.billboards,c)||null;case"MultiPolygon":return this.olMultiGeometryToCesium(e,t,r,a,i,s.billboards,c)||null;case"LinearRing":throw new Error("LinearRing should only be part of polygon.");default:throw new Error(`Ol geom type not handled : ${r.getType()}`)}}olVectorLayerToCesium(e,t,i){const s=t.getProjection(),n=t.getResolution();if(n===void 0||!s)throw console.assert(!1,"View not ready"),new Error("View not ready");let r=e.getSource();r instanceof ie&&(r=r.getSource()),console.assert(r instanceof O);const a=r.getFeatures(),c=new Lt(s,this.scene),u=c.context;for(let d=0;d<a.length;++d){const h=a[d];if(!h)continue;const m=e.getStyleFunction(),g=this.computePlainStyle(e,h,m,n);if(!g||!g.length)continue;let f=null;for(let p=0;p<g.length;p++){const C=this.olFeatureToCesium(e,h,g[p],u);if(C){if(!f)f=C;else if(C){let _=0,v;for(;v=C.get(_);)f.add(v),_++}}}f&&(i[y(h)]=f,c.getRootPrimitive().add(f))}return c}convert(e,t,i,s){const n=t.getProjection(),r=t.getResolution();if(r==null||!n)return null;const a=e.getStyleFunction(),c=this.computePlainStyle(e,i,a,r);if(!c||!c.length)return null;s.projection=n;let u=null;for(let d=0;d<c.length;d++){const h=this.olFeatureToCesium(e,i,c[d],s);if(!u)u=h;else if(h){let m=0,g;for(;g=h.get(m);)u.add(g),m++}}return u}}function Rt(o){o.length<2&&(o=[1,1]);const e=o.length%2===0?o:[...o,...o],i=e.reduce((n,r)=>n+r,0)/16;let s=e.map((n,r)=>{const a=r%2===0?"1":"0";let c=Math.round(n/i);return r===0&&c===0&&(c=1),a.repeat(c)}).join("");return s.length<16?s=s.padEnd(16,"0"):s.length>16&&(s=s.substring(0,16)),s[15]==="1"&&(s=s.substring(0,15)+"0"),console.assert(s.length===16),parseInt(s,2)}class Pt extends he{constructor(t,i,s){super(t,i);l(this,"converter");l(this,"csAllPrimitives_");this.converter=s||new Et(i),this.csAllPrimitives_=new Cesium.PrimitiveCollection,i.primitives.add(this.csAllPrimitives_),this.csAllPrimitives_.destroyPrimitives=!1}addCesiumObject(t){console.assert(t);const i=t.getRootPrimitive();i.counterpart=t,this.csAllPrimitives_.add(t.getRootPrimitive())}destroyCesiumObject(t){t.getRootPrimitive().destroy()}removeSingleCesiumObject(t,i){t.destroy(),this.csAllPrimitives_.destroyPrimitives=i,this.csAllPrimitives_.remove(t.getRootPrimitive()),this.csAllPrimitives_.destroyPrimitives=!1}removeAllCesiumObjects(t){if(this.csAllPrimitives_.destroyPrimitives=t,t)for(let i=0;i<this.csAllPrimitives_.length;++i)this.csAllPrimitives_.get(i).counterpart.destroy();this.csAllPrimitives_.removeAll(),this.csAllPrimitives_.destroyPrimitives=!1}updateLayerVisibility(t,i){let s=!0;[t.layer].concat(t.parents).forEach(n=>{const r=n.getVisible();r!==void 0?s=s&&r:s=!1}),i.show=s}createSingleLayerCounterparts(t){const i=t.layer;if(!(i instanceof Ze)||i instanceof B)return null;console.assert(i instanceof Ye);let s=i.getSource();if(s instanceof ie&&(s=s.getSource()),!s)return null;console.assert(s instanceof O),console.assert(this.view);const n=this.view,r={},a=this.converter.olVectorLayerToCesium(i,n,r),c=a.getRootPrimitive(),u=a.olListenKeys;[t.layer].concat(t.parents).forEach(m=>{u.push(m.on("change:visible",()=>{this.updateLayerVisibility(t,c)}))}),this.updateLayerVisibility(t,c);const d=m=>{const g=a.context,f=this.converter.convert(i,n,m,g);f&&(r[y(m)]=f,c.add(f))},h=m=>{const g=y(m),f=a.context,p=f.featureToCesiumMap[g];p&&(delete f.featureToCesiumMap[g],p.forEach(_=>{_ instanceof Cesium.Billboard&&f.billboards.remove(_)}));const C=r[g];delete r[g],C&&c.remove(C)};return u.push(s.on("addfeature",m=>{console.assert(m.feature),d(m.feature)})),u.push(s.on("removefeature",m=>{console.assert(m.feature),h(m.feature)})),u.push(s.on("changefeature",m=>{const g=m.feature;console.assert(g),h(g),d(g)})),a?[a]:null}}function Tt(o){return o&&o.parentNode?o.parentNode.removeChild(o):null}function At(o){for(;o.lastChild;)o.removeChild(o.lastChild)}function de(o,e){const t=o.cloneNode();o.nodeName==="CANVAS"&&t.getContext("2d").drawImage(o,0,0),e&&e.appendChild(t),o.nodeType!==Node.TEXT_NODE&&t.addEventListener("click",s=>{o.dispatchEvent(new MouseEvent("click",s)),s.stopPropagation()});const i=o.childNodes;for(let s=0;s<i.length;s++)i[s]&&de(i[s],t);return t}class xt extends Xe{constructor(t){const i=t.parent;super(i.getOptions());l(this,"scenePostRenderListenerRemover_",null);l(this,"scene_");l(this,"synchronizer_");l(this,"parent_");l(this,"positionWGS84_");l(this,"observer_");l(this,"attributeObserver_",[]);l(this,"listenerKeys_");this.scene_=t.scene,this.synchronizer_=t.synchronizer,this.parent_=i,this.positionWGS84_=void 0,this.observer_=new MutationObserver(this.handleElementChanged.bind(this)),this.attributeObserver_=[],this.listenerKeys_=[];const s=n=>this.setPropertyFromEvent_(n);this.listenerKeys_.push(this.parent_.on("change:element",s)),this.listenerKeys_.push(this.parent_.on("change:offset",s)),this.listenerKeys_.push(this.parent_.on("change:position",s)),this.listenerKeys_.push(this.parent_.on("change:positioning",s)),this.setProperties(this.parent_.getProperties()),this.handleMapChanged(),this.handleElementChanged(),this.handlePositionChanged()}observeTarget_(t){if(this.observer_){this.observer_.disconnect(),this.observer_.observe(t,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),this.attributeObserver_.forEach(i=>{i.disconnect()}),this.attributeObserver_.length=0;for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];if(s.nodeType===1){const n=new MutationObserver(this.handleElementChanged.bind(this));n.observe(s,{attributes:!0,subtree:!0}),this.attributeObserver_.push(n)}}}}setPropertyFromEvent_(t){t.target&&t.key&&this.set(t.key,t.target.get(t.key))}getScene(){return this.scene_}handleMapChanged(){this.scenePostRenderListenerRemover_&&(this.scenePostRenderListenerRemover_(),Tt(this.element)),this.scenePostRenderListenerRemover_=null;const t=this.getScene();if(t){this.scenePostRenderListenerRemover_=t.postRender.addEventListener(this.updatePixelPosition.bind(this)),this.updatePixelPosition();const i=this.stopEvent?this.synchronizer_.getOverlayContainerStopEvent():this.synchronizer_.getOverlayContainer();this.insertFirst?i.insertBefore(this.element,i.childNodes[0]||null):i.appendChild(this.element)}}handlePositionChanged(){if(!this.parent_)return;const t=this.getPosition();if(t){const i=this.parent_.getMap().getView().getProjection();this.positionWGS84_=$e(t,i,"EPSG:4326")}else this.positionWGS84_=void 0;this.updatePixelPosition()}handleElementChanged(){At(this.element);const t=this.getElement();if(t&&t.parentNode&&t.parentNode.childNodes)for(const i of Array.from(t.parentNode.childNodes)){const s=de(i,null);this.element.appendChild(s)}t.parentNode&&this.observeTarget_(t.parentNode)}updatePixelPosition(){const t=this.positionWGS84_;if(!this.scene_||!t){this.setVisible(!1);return}let i=0;if(t.length===2){const m=this.scene_.globe.getHeight(Cesium.Cartographic.fromDegrees(t[0],t[1]));m&&this.scene_.globe.tilesLoaded&&(t[2]=m),m&&(i=m)}else i=t[2];const s=Cesium.Cartesian3.fromDegrees(t[0],t[1],i),n=this.scene_.camera,r=new Cesium.BoundingSphere(new Cesium.Cartesian3,6356752);if(!new Cesium.Occluder(r,n.position).isPointVisible(s)){this.setVisible(!1);return}if(n.frustum.computeCullingVolume(n.position,n.direction,n.up).computeVisibility(new Cesium.BoundingSphere(s))!==1){this.setVisible(!1);return}this.setVisible(!0);const u=this.scene_.cartesianToCanvasCoordinates(s),d=[u.x,u.y],h=[this.scene_.canvas.width,this.scene_.canvas.height];this.updateRenderedPosition(d,h)}destroy(){this.scenePostRenderListenerRemover_&&this.scenePostRenderListenerRemover_(),this.observer_&&this.observer_.disconnect(),w(this.listenerKeys_),this.listenerKeys_.splice(0),"removeNode"in this.element?this.element.removeNode(!0):this.element.remove(),this.element=null}}class Ft{constructor(e,t){l(this,"map");l(this,"scene");l(this,"overlayCollection_");l(this,"overlayContainerStopEvent_");l(this,"overlayContainer_");l(this,"overlayMap_",new Map);l(this,"overlayEvents",["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"]);l(this,"listenerKeys_",[]);this.map=e,this.scene=t,this.map=e,this.overlayCollection_=this.map.getOverlays(),this.scene=t,this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.overlayEvents.forEach(i=>{this.overlayContainerStopEvent_.addEventListener(i,s=>s.stopPropagation())}),this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_),this.overlayContainer_=document.createElement("div"),this.overlayContainer_.className="ol-overlaycontainer",this.scene.canvas.parentElement.appendChild(this.overlayContainer_)}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOverlayContainer(){return this.overlayContainer_}synchronize(){this.destroyAll(),this.overlayCollection_.forEach(e=>{this.addOverlay(e)}),this.listenerKeys_.push(this.overlayCollection_.on("add",e=>this.addOverlay(e.element))),this.listenerKeys_.push(this.overlayCollection_.on("remove",e=>this.removeOverlay(e.element)))}addOverlay(e){if(!e)return;const t=new xt({scene:this.scene,synchronizer:this,parent:e});this.overlayMap_.set(y(e),t)}removeOverlay(e){const t=y(e),i=this.overlayMap_.get(t);i&&(i.destroy(),this.overlayMap_.delete(t))}destroyAll(){this.overlayMap_.forEach(e=>{e.destroy()}),this.overlayMap_.clear(),w(this.listenerKeys_),this.listenerKeys_.length=0}}const D={DONE:0,PENDING:1,FAILED:2};class q{constructor(e){l(this,"autoRenderLoop_",null);l(this,"map_");l(this,"time_");l(this,"to4326Transform_");l(this,"resolutionScale_",1);l(this,"canvasClientWidth_",0);l(this,"canvasClientHeight_",0);l(this,"resolutionScaleChanged_",!0);l(this,"container_");l(this,"isOverMap_");l(this,"canvas_");l(this,"enabled_",!1);l(this,"pausedInteractions_",[]);l(this,"hiddenRootGroup_",null);l(this,"scene_");l(this,"camera_");l(this,"globe_");l(this,"dataSourceCollection_");l(this,"dataSourceDisplay_");l(this,"lastFrameTime_",0);l(this,"renderId_");l(this,"targetFrameRate_",Number.POSITIVE_INFINITY);l(this,"blockCesiumRendering_",!1);l(this,"warmingUp_",!1);l(this,"trackedFeature_",null);l(this,"trackedEntity_",null);l(this,"entityView_",null);l(this,"needTrackedEntityUpdate_",!1);l(this,"boundingSphereScratch_",new Cesium.BoundingSphere);l(this,"synchronizers_");l(this,"refresh2DAfterCameraMoveEndOnly",!1);l(this,"moveEndRemoveCallback_");this.map_=e.map,this.time_=e.time||function(){return Cesium.JulianDate.now()},this.to4326Transform_=U(this.map_.getView().getProjection(),"EPSG:4326");const t="position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;";this.container_=document.createElement("DIV");const i=document.createAttribute("style");i.value=`${t}visibility:hidden;`,this.container_.setAttributeNode(i);let s=e.target||this.map_.getViewport();if(typeof s=="string"&&(s=document.getElementById(s)),s.appendChild(this.container_),this.isOverMap_=!e.target,this.isOverMap_&&e.stopOpenLayersEventsPropagation){const d=["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"];for(let h=0,m=d.length;h<m;++h)this.container_.addEventListener(d[h],g=>g.stopPropagation())}this.canvas_=document.createElement("canvas");const n=document.createAttribute("style");n.value=t,this.canvas_.setAttributeNode(n),z()&&(this.canvas_.style.imageRendering=st()),this.canvas_.oncontextmenu=function(){return!1},this.canvas_.onselectstart=function(){return!1},this.container_.appendChild(this.canvas_);const r=e.sceneOptions!==void 0?{...e.sceneOptions,canvas:this.canvas_,scene3DOnly:!0}:{canvas:this.canvas_,scene3DOnly:!0};this.scene_=new Cesium.Scene(r);const a=this.scene_.screenSpaceCameraController;Array.isArray(a.tiltEventTypes)?(a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.SHIFT}),a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.ALT})):console.log("sscc is not an array"),a.enableLook=!1,this.scene_.camera.constrainedAxis=Cesium.Cartesian3.UNIT_Z,this.camera_=new St(this.scene_,this.map_),this.globe_=new Cesium.Globe(Cesium.Ellipsoid.WGS84),this.globe_.baseColor=Cesium.Color.WHITE,this.scene_.globe=this.globe_,this.scene_.skyAtmosphere=new Cesium.SkyAtmosphere;const c=new Cesium.SingleTileImageryProvider({tileHeight:1,tileWidth:1,url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",rectangle:Cesium.Rectangle.fromDegrees(0,0,1,1)});this.globe_.imageryLayers.addImageryProvider(c,0),this.dataSourceCollection_=new Cesium.DataSourceCollection,this.dataSourceDisplay_=new Cesium.DataSourceDisplay({scene:this.scene_,dataSourceCollection:this.dataSourceCollection_}),this.synchronizers_=e.createSynchronizers?e.createSynchronizers(this.map_,this.scene_,this.dataSourceCollection_):[new bt(this.map_,this.scene_),new Pt(this.map_,this.scene_),new Ft(this.map_,this.scene_)],this.handleResize_();for(let d=this.synchronizers_.length-1;d>=0;--d)this.synchronizers_[d].synchronize();new Cesium.EventHelper().add(this.scene_.postRender,q.prototype.updateTrackedEntity_,this),this.moveEndRemoveCallback_=this.scene_.camera.moveEnd.addEventListener(()=>{this.refresh2DAfterCameraMoveEndOnly&&this.camera_.checkCameraChange()})}destroy(){cancelAnimationFrame(this.renderId_),this.renderId_=void 0,this.synchronizers_.forEach(e=>e.destroyAll()),this.camera_.destroy(),this.scene_.destroy(),this.scene_._postRender=null,this.moveEndRemoveCallback_(),this.container_.remove()}render_(){this.renderId_!==void 0&&(cancelAnimationFrame(this.renderId_),this.renderId_=void 0),(this.enabled_||this.warmingUp_)&&!this.blockCesiumRendering_&&(this.renderId_=requestAnimationFrame(this.onAnimationFrame_.bind(this)))}onAnimationFrame_(e){this.renderId_=void 0;const t=1e3/this.targetFrameRate_;if(e-this.lastFrameTime_<t){this.render_();return}this.lastFrameTime_=e;const s=this.time_();if(this.scene_.initializeFrame(),this.handleResize_(),this.dataSourceDisplay_.update(s),this.entityView_){const n=this.trackedEntity_;this.dataSourceDisplay_.getBoundingSphere(n,!1,this.boundingSphereScratch_)===D.DONE&&(this.boundingSphereScratch_.radius=1,this.entityView_.update(s,this.boundingSphereScratch_))}this.scene_.render(s),this.refresh2DAfterCameraMoveEndOnly||this.camera_.checkCameraChange(),this.render_()}updateTrackedEntity_(){if(!this.needTrackedEntityUpdate_)return;const e=this.trackedEntity_,t=this.scene_,i=this.dataSourceDisplay_.getBoundingSphere(e,!1,this.boundingSphereScratch_);if(i===D.PENDING)return;t.screenSpaceCameraController.enableTilt=!1;const s=i!==D.FAILED?this.boundingSphereScratch_:void 0;s&&(s.radius=1),this.entityView_=new Cesium.EntityView(e,t,t.mapProjection.ellipsoid),this.entityView_.update(this.time_(),s),this.needTrackedEntityUpdate_=!1}handleResize_(){let e=this.canvas_.clientWidth,t=this.canvas_.clientHeight;if(e===0||t===0||e===this.canvasClientWidth_&&t===this.canvasClientHeight_&&!this.resolutionScaleChanged_)return;let i=this.resolutionScale_;z()||(i*=window.devicePixelRatio||1),this.resolutionScaleChanged_=!1,this.canvasClientWidth_=e,this.canvasClientHeight_=t,e*=i,t*=i,this.canvas_.width=e,this.canvas_.height=t,this.scene_.camera.frustum.aspectRatio=e/t}getCamera(){return this.camera_}getOlMap(){return this.map_}getOlView(){const e=this.map_.getView();return console.assert(e),e}getCesiumScene(){return this.scene_}getDataSources(){return this.dataSourceCollection_}getDataSourceDisplay(){return this.dataSourceDisplay_}getEnabled(){return this.enabled_}setEnabled(e){if(this.enabled_===e)return;this.enabled_=e,this.container_.style.visibility=this.enabled_?"visible":"hidden";let t;if(this.enabled_){if(this.throwOnUnitializedMap_(),this.isOverMap_){t=this.map_.getInteractions(),t.forEach((s,n,r)=>{this.pausedInteractions_.push(s)}),t.clear(),this.map_.addInteraction=s=>this.pausedInteractions_.push(s),this.map_.removeInteraction=s=>{let n=!1;return this.pausedInteractions_=this.pausedInteractions_.filter(r=>{const a=r!==s;return n||(n=a),a}),n?s:void 0};const i=this.map_.getLayerGroup();i.getVisible()&&(this.hiddenRootGroup_=i,this.hiddenRootGroup_.setVisible(!1)),this.map_.getOverlayContainer().classList.add("olcs-hideoverlay")}this.camera_.readFromView(),this.render_()}else this.isOverMap_&&(t=this.map_.getInteractions(),this.pausedInteractions_.forEach(i=>{t.push(i)}),this.pausedInteractions_.length=0,this.map_.addInteraction=i=>this.map_.getInteractions().push(i),this.map_.removeInteraction=i=>this.map_.getInteractions().remove(i),this.map_.getOverlayContainer().classList.remove("olcs-hideoverlay"),this.hiddenRootGroup_&&(this.hiddenRootGroup_.setVisible(!0),this.hiddenRootGroup_=null)),this.camera_.updateView()}warmUp(e,t){if(this.enabled_)return;this.throwOnUnitializedMap_(),this.camera_.readFromView();const i=this.globe_.ellipsoid,s=this.scene_.camera,n=i.cartesianToCartographic(s.position);n.height<e&&(n.height=e,s.position=i.cartographicToCartesian(n)),this.warmingUp_=!0,this.render_(),setTimeout(()=>{this.warmingUp_=!1},t)}setBlockCesiumRendering(e){this.blockCesiumRendering_!==e&&(this.blockCesiumRendering_=e,this.render_())}enableAutoRenderLoop(){this.autoRenderLoop_||(this.autoRenderLoop_=new wt(this))}getAutoRenderLoop(){return this.autoRenderLoop_}setResolutionScale(e){e=Math.max(0,e),e!==this.resolutionScale_&&(this.resolutionScale_=Math.max(0,e),this.resolutionScaleChanged_=!0,this.autoRenderLoop_&&this.autoRenderLoop_.restartRenderLoop())}setTargetFrameRate(e){this.targetFrameRate_!==e&&(this.targetFrameRate_=e,this.render_())}setRefresh2DAfterCameraMoveEndOnly(e){this.refresh2DAfterCameraMoveEndOnly=e}throwOnUnitializedMap_(){const t=this.map_.getView(),i=t.getCenter();if(!t.isDef()||isNaN(i[0])||isNaN(i[1]))throw new Error(`The OpenLayers map is not properly initialized: ${i} / ${t.getResolution()}`)}get trackedFeature(){return this.trackedFeature_}set trackedFeature(e){if(this.trackedFeature_!==e){const t=this.scene_;if(!e||!e.getGeometry()){this.needTrackedEntityUpdate_=!1,t.screenSpaceCameraController.enableTilt=!0,this.trackedEntity_&&this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_),this.trackedEntity_=null,this.trackedFeature_=null,this.entityView_=null,t.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);return}this.trackedFeature_=e,this.needTrackedEntityUpdate_=!0;const i=this.to4326Transform_,s=function(){const r=e.getGeometry();console.assert(r instanceof N);const a=r instanceof N?r.getCoordinates():[],c=i(a,void 0,a.length);return b(c)},n={position:new Cesium.CallbackProperty((r,a)=>s(),!1),point:{pixelSize:1,color:Cesium.Color.TRANSPARENT}};this.trackedEntity_=this.dataSourceDisplay_.defaultDataSource.entities.add(n)}}}function Ut(o,e,t){const i=e/t;let s;return i>1?(s=[o.width,o.width/i],s[1]>o.height&&(s=[o.height*i,o.height])):(s=[o.height*i,o.height],s[0]>o.width&&(s=[o.width,o.width/i])),{scaling:[s[0]/o.width,s[1]/o.height],width:s[0],height:s[1],offsetX:(o.width-s[0])/2,offsetY:(o.height-s[1])/2}}let R=null;class I{constructor(e){l(this,"gl");l(this,"programInfo");l(this,"positionBuffer");this.gl=e;const t=this.initShaderProgram();this.programInfo={program:t,attribLocations:{vertexPosition:e.getAttribLocation(t,"aVertexPosition")},uniformLocations:{uScaling:e.getUniformLocation(t,"uScaling")}},this.positionBuffer=e.createBuffer();const i=[1,1,-1,1,1,-1,-1,-1];e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)}getVertexShaderSource(){return`
      attribute vec4 aVertexPosition;
      uniform vec2 uScaling;
      void main() {
        gl_Position = vec4(aVertexPosition[0] * uScaling[0], aVertexPosition[1] * uScaling[1], -1.0, 1.0);
      }
    `}getFragmentShaderSource(){return`
      precision highp float;
      void main() {
        gl_FragColor = vec4(.5, .5, .5, .6);
      }
  `}initShaderProgram(){const e=this.gl,t=this.getVertexShaderSource(),i=this.getFragmentShaderSource(),s=I.loadShader(e,e.VERTEX_SHADER,t),n=I.loadShader(e,e.FRAGMENT_SHADER,i),r=e.createProgram();if(e.attachShader(r,s),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error(`Unable to initialize the shader program: ${e.getProgramInfoLog(r)}`);return r}drawMask(e){const t=this.gl,i=this.programInfo;t.enable(t.BLEND),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(i.attribLocations.vertexPosition,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i.attribLocations.vertexPosition),t.useProgram(i.program),t.enable(t.STENCIL_TEST),t.stencilFunc(t.ALWAYS,1,255),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE),t.uniform2fv(i.uniformLocations.uScaling,e),t.blendFunc(t.ZERO,t.ONE),t.drawArrays(t.TRIANGLE_STRIP,0,4),t.stencilFunc(t.EQUAL,0,255),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.uniform2fv(i.uniformLocations.uScaling,[1,1]),t.blendFunc(t.ZERO,t.SRC_ALPHA),t.drawArrays(t.TRIANGLE_STRIP,0,4)}static loadShader(e,t,i){const s=e.createShader(t);if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(`An error occurred compiling the shaders: ${e.getShaderInfoLog(s)}`);return s}}function Ht(o,e){const t=o.canvas,i=t.getContext("webgl2")||t.getContext("webgl");if(e){if(!R){const s=new I(i);R=o.postRender.addEventListener(()=>{s.drawMask(e())})}}else R&&(R(),R=null);o.requestRender()}function zt(o,e){return new Promise((t,i)=>{const s=o.postRender.addEventListener(()=>{s();try{let n;if(e){const r=document.createElement("canvas");r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(o.canvas,e.offsetX,e.offsetY,e.width,e.height,0,0,e.width,e.height),n=r.toDataURL()}else n=o.canvas.toDataURL();t(n)}catch(n){i(n)}});o.requestRender()})}class Ot{constructor(e){l(this,"promise");l(this,"url_");this.url_=e}load(){return this.promise||(this.promise=new Promise((e,t)=>{const i=document.createElement("script");i.onload=()=>e(),i.onerror=()=>t(),document.head.appendChild(i),i.src=this.url_})),this.promise}}class Kt extends Qe{constructor(t,{map:i,cameraExtentInRadians:s,cesiumIonDefaultAccessToken:n}){super();l(this,"cesiumUrl_");l(this,"boundingSphere_");l(this,"promise_");l(this,"cesiumIonDefaultAccessToken_");l(this,"map");l(this,"cameraExtentInRadians");l(this,"ol3d");l(this,"cesiumInitialTilt_",L(50));l(this,"fogDensity",1e-4);l(this,"fogSSEFactor",25);l(this,"minimumZoomDistance",2);l(this,"maximumZoomDistance",1e7);l(this,"limitCameraToBoundingSphereRatio",t=>t>3e3?9:3);this.cesiumUrl_=t,console.assert(i),this.map=i,this.cameraExtentInRadians=s||null,this.cesiumIonDefaultAccessToken_=n}load(){if(!this.promise_){const t=new Ot(this.cesiumUrl_);this.promise_=t.load().then(()=>this.onCesiumLoaded())}return this.promise_}onCesiumLoaded(){if(this.cameraExtentInRadians){const i=new Cesium.Rectangle(...this.cameraExtentInRadians);Cesium.Camera.DEFAULT_VIEW_RECTANGLE=i,this.boundingSphere_=Cesium.BoundingSphere.fromRectangle3D(i,Cesium.Ellipsoid.WGS84,300)}this.cesiumIonDefaultAccessToken_&&(Cesium.Ion.defaultAccessToken=this.cesiumIonDefaultAccessToken_),this.ol3d=this.instantiateOLCesium();const t=this.ol3d.getCesiumScene();return this.configureForUsability(t),this.configureForPerformance(t),this.dispatchEvent("load"),this.ol3d}instantiateOLCesium(){const t=new q({map:this.map}),i=t.getCesiumScene();return Cesium.createWorldTerrainAsync().then(s=>i.terrainProvider=s),t}configureForPerformance(t){const i=t.fog;i.enabled=!0,i.density=this.fogDensity,i.screenSpaceErrorFactor=this.fogSSEFactor}configureForUsability(t){const i=t.screenSpaceCameraController;i.minimumZoomDistance=this.minimumZoomDistance,i.maximumZoomDistance=this.maximumZoomDistance,t.globe.depthTestAgainstTerrain=!0,t.globe.baseColor=Cesium.Color.WHITE,t.backgroundColor=Cesium.Color.WHITE,this.boundingSphere_&&t.postRender.addEventListener(this.limitCameraToBoundingSphere.bind(this)),this.ol3d.enableAutoRenderLoop()}limitCameraToBoundingSphere(){const t=this.ol3d.getCesiumScene();vt(t.camera,this.boundingSphere_,this.limitCameraToBoundingSphereRatio)}toggle3d(){return this.load().then(t=>{const i=t.getEnabled(),s=t.getCesiumScene();return i?(console.assert(this.map),ft(this.map,s).then(()=>{t.setEnabled(!1),this.dispatchEvent("toggle")})):(t.setEnabled(!0),this.dispatchEvent("toggle"),pt(s,this.cesiumInitialTilt_))})}set3dWithView(t,i,s,n,r){return this.load().then(a=>{const c=a.getEnabled(),d=a.getCesiumScene().camera,h=Cesium.Cartesian3.fromDegrees(t,i,s),m=Cesium.Math.toRadians(n),g=Cesium.Math.toRadians(r),p={heading:m,pitch:g,roll:0};c||(a.setEnabled(!0),this.dispatchEvent("toggle")),d.setView({destination:h,orientation:p})})}is3dEnabled(){return!!this.ol3d&&this.ol3d.getEnabled()}getHeading(){return this.map&&this.map.getView().getRotation()||0}getTiltOnGlobe(){const t=this.ol3d.getCesiumScene();return-ht(t)}setHeading(t){const i=this.ol3d.getCesiumScene(),s=W(i);s&&re(i,t,s)}getOl3d(){return this.ol3d}getCesiumViewMatrix(){return this.ol3d.getCesiumScene().camera.viewMatrix}getCesiumScene(){return this.ol3d.getCesiumScene()}flyToRectangle(t,i=0){const s=this.getCesiumScene().camera,n=s.getRectangleCameraCoordinates(t),r=Cesium.Cartesian3.magnitude(n)+i;return Cesium.Cartesian3.normalize(n,n),Cesium.Cartesian3.multiplyByScalar(n,r,n),new Promise((a,c)=>{if(!this.cameraExtentInRadians){c();return}s.flyTo({destination:n,complete:()=>a(),cancel:()=>c(),endTransform:Cesium.Matrix4.IDENTITY})})}}export{he as AbstractSynchronizer,Ot as ContribLazyLoader,Kt as ContribManager,Et as FeatureConverter,I as MaskDrawer,St as OLCSCamera,rt as OLImageryProvider,Ft as OverlaySynchronizer,bt as RasterSynchronizer,Lt as VectorLayerCounterpart,Pt as VectorSynchronizer,Dt as applyHeightOffsetToGeometry,ue as attributionsFunctionToCredits,Ht as autoDrawMask,dt as bottomFovRay,_t as calcDistanceForResolution,yt as calcResolutionForDistance,ce as computeAngleToZenith,kt as computeBoundingBoxAtTarget,lt as computePixelSizeAtCoordinate,Ut as computeRectangle,ht as computeSignedTiltAngleOnGlobe,J as convertColorToCesium,Nt as convertUrlToCesium,Vt as createMatrixAtCoordinates,q as default,le as extentToRectangle,ee as isCesiumProjection,vt as limitCameraToBoundingSphere,Ct as normalizeView,k as ol4326CoordinateArrayToCsCartesians,b as ol4326CoordinateToCesiumCartesian,T as olGeometryCloneTo4326,W as pickBottomPoint,ut as pickCenterPoint,oe as pickOnTerrainOrEllipsoid,ft as resetToNorthZenith,j as rotateAroundAxis,pt as rotateAroundBottomCenter,re as setHeadingUsingBottomCenter,ae as signedAngleBetween,mt as sourceToImageryProvider,zt as takeScreenshot,gt as tileLayerToImageryLayer,Q as updateCesiumLayerProperties};
//# sourceMappingURL=olcs-D-oglOKt.js.map
